<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	笔记仓库
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="笔记仓库" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}
	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
					
					<h1><a href="index.html">笔记仓库</a></h1>
					<p class="subtitle"></p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="archives.html">Archives</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">













								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-13T20:11:12+08:00" itemprop="datePublished">2017/9/13</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15053046720339.html" itemprop="url">
		卅七、zabbix自主监控与分布式监控</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<blockquote>
<p>被动模式：服务端主动去客户端抓取数据，站在客户端的立场，是被抓了数据，所以叫被动模式。</p>

<p>主动模式：客户端主动把数据发送给服务端 《==》自动注册</p>
</blockquote>

<ol>
<li><p>自动发现 </p>

<p>原理：Zabbix Server固定周期去全网（局域网）扫描，如果发现某台主机不在自己的监控主机中，那么他会将这台主机添加进来。 被动模式</p>

<ol>
<li><p>客户端布置</p>

<p>所有客户端需要做的事情<br/>
前提：客户端能被服务端找到，第一个是机器在同一局域网，第二个是客户端的配置文件指定“Server=服务端IP”</p>

<pre><code>[root@web01 ~]# ping 172.16.1.61
PING 172.16.1.61 (172.16.1.61) 56(84) bytes of data.
64 bytes from 172.16.1.61: icmp_seq=1 ttl=64 time=2.39 ms
</code></pre>

<p>更改客户端配置文件</p>

<pre><code>[root@web01 ~]# sed -i &#39;s#ServerActive=127.0.0.1#ServerActive=172.16.1.61#g&#39; /etc/zabbix/zabbix_agentd.conf
[root@web01 ~]# grep ^Server= /etc/zabbix/zabbix_agentd.conf
Server=172.16.1.61
</code></pre></li>
<li><p>服务端检测服务是否正常</p>

<p>服务端的命令行的Zabbix Server进程要正常工作</p>

<pre><code>[root@m01 ~]# /etc/init.d/zabbix-server status
zabbix_server (pid  38640) is running...
</code></pre></li>
<li><p>网页配置</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/53270416.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/44858859.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/57803556.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/76739842.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/7895197.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/95726366.jpg" alt=""/></p></li>
</ol></li>
<li><p>自动注册</p>

<p>自动发现是服务端去主动找客户端，比较费劲。<br/>
自动注册：客户端自己主动跑到服务端，说，我是新来的，请多关照（监控）</p>

<ol>
<li><p>客户端开启主动模式</p>

<pre><code>[root@web01 ~]# vim /etc/zabbix/zabbix_agentd.conf
Server=172.16.1.61  ===》 被动模式参数
ServerActive=127.0.0.1 ===》 主动模式参数
Hostname=Zabbix server  ===》 自动注册需要告诉服务端自己的主机名
HostMetadataItem=system.uname   ===》 作为server区分客户端的标志
</code></pre>

<p>客户端两步操作</p>

<pre><code>sed -i &#39;s#ServerActive=127.0.0.1#ServerActive=172.16.1.61#g;s#Hostname=Zabbix server#Hostname=web01#;176a HostMetadataItem=system.uname&#39; /etc/zabbix/zabbix_agentd.conf
</code></pre>

<p>重启客户端</p>

<pre><code>/etc/init.d/zabbix-agent restart
</code></pre></li>
<li><p>网页实现自动注册</p>

<p>先把自动发现功能禁用</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/52062377.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/11309909.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/52583684.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/29432115.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/49548437.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/10158818.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/61672884.jpg" alt=""/></p></li>
<li><p>小结</p>

<ol>
<li>工作中，只选自动发现或自动注册两者之一</li>
<li>如果选择自动发现时，客户端配置就是正常配置，需要的操作是在网页开启2处功能，第一处是“配置--自动发现”，第二处是“配置--动作--自动发现”</li>
<li>如果选择自动注册时，客户端需要额外添加三个配置，ServerActive，Hostname（注意，每台主机的主机名不一样），HostMetadataItem；然后在网页上“配置--动作--自动注册”</li>
</ol></li>
</ol></li>
<li><p>分布式监控</p>

<ol>
<li><p>分布式</p>

<p>① 分担压力，负载均衡<br/><br/>
② 由于地理位置分开（北京，上海，广州各有一个机房），分布式为了减轻每个机房压力。然后还能提高访问效率。比如广州用户只需要访问广州机房即可。</p></li>
<li><p>zabbix为什么需要用到分布式</p>

<p>① 分担server端的压力，比如需要监控的主机上千台，此时server压力山大<br/><br/>
② server只能够监控同一个局域网的主机，如果我们很多机房，每个机房的网络都是独立，可以使用vpn技术或者专线是每个机房的网络打通。所以最经济的方法是使用zabbix提供的分布式功能。</p></li>
<li><p>环境统一（3台）</p>

<blockquote>
<p>Zabbix Server--m01<br/>
公网:10.0.0.61<br/>
内网：172.16.1.61</p>
</blockquote>

<blockquote>
<p>Zabbix Proxy--web01<br/>
公网：10.0.0.8<br/>
内网：192.168.1.8</p>
</blockquote>

<blockquote>
<p>proxy-agent -- db01<br/>
内网：192.168.1.51<br/>
（公网：10.0.0.51）</p>
</blockquote>

<p>配置LAN区段</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/72163034.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/77169734.jpg" alt=""/></p></li>
<li><p>host解析统一</p>

<pre><code>[root@m01 ~]# grep web01 /etc/hosts
10.0.0.8      web01
</code></pre>

<pre><code>[root@web01 ~]# egrep &#39;^192|^10&#39; /etc/hosts
192.168.1.8      web01
192.168.1.51     db01 db01.etiantian.org
10.0.0.61     m01
</code></pre>

<pre><code>[root@db01 ~]# grep &#39;^192&#39; /etc/hosts
192.168.1.8      web01
192.168.1.51     db01 db01.etiantian.org
</code></pre></li>
<li><p>安装zabbix proxy（在Zabbix Proxy--web01上操作）<br/>
正常安装方法：</p>

<pre><code>rpm -ivh http://repo.zabbix.com/zabbix/3.0/rhel/6/x86_64/zabbix-release-3.0-1.el6.noarch.rpm
yum -y install zabbix-proxy-mysql 
</code></pre>

<p>网络不好的解决方法：<br/>
阿里云公网</p>

<pre><code>wget https://mirrors.aliyun.com/zabbix/zabbix/3.0/rhel/6/x86_64/zabbix-proxy-mysql-3.0.9-1.el6.x86_64.rpm
yum localinstall zabbix-proxy-mysql-3.0.9-1.el6.x86_64.rpm
</code></pre>

<p>学校仓库</p>

<pre><code>wget  http://192.168.14.200/zabbix/zabbix/3.0/rhel/6/x86_64/zabbix-proxy-mysql-3.0.9-1.el6.x86_64.rpm
yum localinstall zabbix-proxy-mysql-3.0.9-1.el6.x86_64.rpm
</code></pre>

<pre><code># 使用内网仓库
echo &quot;192.168.14.200 mirrors.aliyun.com&quot; &gt;&gt;/etc/hosts
# 配置yum源
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
</code></pre></li>
<li><p>安装MySQL<br/>
zabbix proxy需要数据库。但是proxy不会再数据库存数据</p>

<pre><code>[root@web01 ~]# yum -y install mysql-server
[root@web01 ~]# /etc/init.d/mysqld start
# 创建数据库
[root@web01 ~]# mysql -e &quot;create database zabbix_proxy character set utf8 collate utf8_bin;&quot;
# 授权及设置密码
[root@web01 ~]# mysql -e &quot;grant all privileges on zabbix_proxy.* to zabbix@&#39;localhost&#39; identified by &#39;zabbix&#39;;&quot;
# 导入sql文件
[root@web01 ~]# zcat /usr/share/doc/zabbix-proxy-mysql-3.0.9/schema.sql.gz |mysql -uzabbix -pzabbix zabbix_proxy
</code></pre></li>
<li><p>web01配置proxy</p>

<pre><code>sed -i &#39;s#Server=127.0.0.1#Server=10.0.0.61#;s#Hostname=Zabbix proxy#Hostname=web01#;155a DBPassword=zabbix&#39; /etc/zabbix/zabbix_proxy.conf
</code></pre></li>
<li><p>启动proxy</p>

<pre><code>/etc/init.d/zabbix-proxy start
</code></pre></li>
<li><p>将web01通过proxy监控起来<br/>
修改zabbix_agent配置文件</p>

<pre><code>[root@web01 ~]# sed -i &#39;s#172.16.1.61#192.168.1.8#&#39; /etc/zabbix/zabbix_agentd.conf
[root@web01 ~]# /etc/init.d/zabbix-agent restart
</code></pre></li>
<li><p>将db01通过proxy监控起来<br/>
修改zabbix_agent配置文件<br/>
<code><br/>
[root@db01 ~]# sed -i &#39;s#172.16.1.61#192.168.1.8#&#39; /etc/zabbix/zabbix_agentd.conf<br/>
[root@db01 ~]# /etc/init.d/zabbix-agent restart<br/>
</code></p></li>
<li><p>网页配置</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/19633410.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/34014924.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/18053578.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/83453635.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/48119909.jpg" alt=""/></p></li>
</ol></li>
<li><p>SNMP监控</p>

<p>前面讲的都是属于zabbix客户端监控方式，这种监控方式的特色：每一台机器都得装agent。</p>

<p>但是我们的交换机，<mark>路由器等智能设备无法安装agent</mark>。<br/>
但是我们有监控需求！</p>

<p><mark>zabbix提供另外一种方法，帮助我们监控那些无法安装agent的设备。<br/>
这种方法叫做SNMP监控，SNMP==simple network manager protocol 简单网络管理协议</mark></p>

<ol>
<li><p>安装SNMP服务</p>

<p>用学校的仓库下载 <mark>生产环境中用阿里云的源下载 wget -O</mark></p>

<pre><code>[root@db01 ~]# echo &quot;192.168.14.200 mirrors.aliyun.com&quot; &gt;&gt;/etc/hosts
[root@db01 ~]# yum -y install net-snmp net-snmp-utils
</code></pre></li>
<li><p>配置snmp</p>

<pre><code>sed -i.ori &#39;57a view systemview   included  .1&#39; /etc/snmp/snmpd.conf
/etc/init.d/snmpd start
</code></pre></li>
<li><p>使用SNMP</p>

<pre><code>[root@db01 ~]# snmpwalk -v 2c -c public 127.0.0.1 sysname
SNMPv2-MIB::sysName.0 = STRING: db01
</code></pre>

<p>-v 指定当前使用snmp协议的版本号，2c就是版本号，snmp有三个版本 v1 v2 v3(需要认证)<br/>
-c 指定团体号（暗号）<br/>
sysname 理解为key</p>

<p>常用/通用的key值：<a href="http://www.ttlsa.com/monitor/snmp-oid/">http://www.ttlsa.com/monitor/snmp-oid/</a></p></li>
<li><p>网页配置</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/12510597.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/58966681.jpg" alt=""/></p></li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-13T19:48:45+08:00" itemprop="datePublished">2017/9/13</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15053033256965.html" itemprop="url">
		卅六、zabbix自定义监控</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>自定义监控</p>

<p>一台主机可以添加多个模板, 一个模板中可以包含多个应用集, 一个应用集中可以包含多个监控项</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/66952784.jpg" alt=""/></p>

<ol>
<li><p>自定义监控项键值</p>

<p>客户端添加自定义的监控项--在自定义的监控项配置文件中添加键值</p>

<pre><code>echo &quot;UserParameter=login-user,who|wc -l&quot; \
&gt;&gt;/etc/zabbix/zabbix_agentd.d/userparameter_oldboy.conf
cat /etc/zabbix/zabbix_agentd.d/userparameter_oldboy.conf
/etc/init.d/zabbix-agent restart
</code></pre>

<p>服务端检查键值</p>

<pre><code>[root@m01 x86_64]# zabbix_get -s 172.16.1.41 -p 10050 -k &quot;login-user&quot;
1
[root@m01 x86_64]# zabbix_get -s 172.16.1.61 -p 10050 -k &quot;login-user&quot;
1
</code></pre></li>
<li><p>添加模板<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/80986302.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/27564849.jpg" alt=""/></p>

<ol>
<li><p>添加应用集</p>

<p>（监控项的存放的文件夹）：相同功能的监控项放在一起，这个地方起个名字叫做应用集</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/73557311.jpg" alt=""/></p></li>
<li><p>添加监控项</p>

<p>实现一个你需要监控的功能<br/>
名称：自己起个有意义名字<br/>
键值：填入自己定义的key<br/>
数据更新间隔(秒)：服务端去客户端抓取数据的时间间隔<br/>
历史数据保留时长(单位天)：收集到的数据保留时长；机器越多，时间越长，占用的数据库空间越大<br/>
趋势数据存储周期(单位天)</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/12658311.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/8244268.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/60424906.jpg" alt=""/></p></li>
<li><p>添加触发器</p>

<p>可选项，触发器就像地雷的引信，一旦收集到的数据达到预定值，就会触发报警</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/49792766.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/9281037.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/82820812.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/80286061.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/48522185.jpg" alt=""/></p></li>
<li><p>添加图形<br/>
将枯燥的数字转成图形，易于理解<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/60646548.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/93138961.jpg" alt=""/></p></li>
</ol></li>
<li><p>使用模板--关联模板</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/97664828.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/11737030.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/62097666.jpg" alt=""/></p>

<ol>
<li><p>测试告警</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/68284788.jpg" alt=""/></p></li>
</ol></li>
<li><p>使用自定义监控MySQL</p>

<p>因为mysql有密码，所以我们首先得改userparameter_mysql.conf 的用户密码</p>

<pre><code>[root@m01 ~]# vim /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf 
UserParameter=mysql.ping,/application/mysql/bin/mysqladmin -uroot -poldboy123 ping 2&gt;/dev/null| grep -c alive
</code></pre>

<pre><code>/etc/init.d/zabbix-agent restart
</code></pre>

<pre><code>[root@mysql-db01 ~]# mysqladmin -uroot -poldboy123 ping 2&gt;/dev/null | grep -c alive
1
</code></pre></li>
</ol></li>
<li><p>集群监控--多模板</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/99826767.jpg" alt=""/></p></li>
<li><p>WEB监控</p>

<p>监控你们网站指定URL地址，打开网页，能够看到指定内容，就可以确信我们网站是正常。</p>

<p>因为我们是使用服务端的系统监控所有内网主机的url地址，因此我们需要在m01机器做hosts解析</p>

<p>第一步：确保web01的Nginx服务正常访问<br/>
第二步：修改m01的hosts解析</p>

<pre><code>[root@m01 ~]# tail -2 /etc/hosts
10.0.0.8 bbs.etiantian.org blog.etiantian.org www.etiantian.org status.etiantian.org
[root@m01 ~]# curl http://www.etiantian.org/oldboy.html
www web01
</code></pre>

<p>第三步，网页上配置</p>

<p>web检测本质：是在服务端这台机器上执行了类似“curl 网站地址”的功能</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/64356140.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/79279633.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/62076512.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/22728563.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/43706920.jpg" alt=""/></p>

<blockquote>
<p>实现监控三个站点的效果</p>
</blockquote>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/8580229.jpg" alt=""/></p></li>
<li><p>主机、模版共享</p>

<p>导出主机设置的作用：共享、备份<br/>
<a href="https://share.zabbix.com/">https://share.zabbix.com/</a> </p></li>
<li><p>监控可视化</p>

<ol>
<li><p>聚合图形</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/3967639.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/27500446.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/78426135.jpg" alt=""/></p>

<p>添加至首页</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/65378452.jpg" alt=""/></p></li>
<li><p>幻灯片演示</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/78282733.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/81138038.jpg" alt=""/></p></li>
</ol></li>
<li><p>监控告警</p>

<ol>
<li><p>zabbix报警媒介</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/23771636.jpg" alt=""/></p></li>
<li><p>onealert第三方报警工具</p>

<p>zabbix监控其他主机，但是onealert监控zabbix的报警信息，一旦有报警，onealert会将报警内容发送给onealert服务器，然后onealert服务器通过你设置的报警方式进行报警<br/>
触发报警原理：状态改变才会触发----好变坏，坏变好</p></li>
<li><p>安装</p>

<pre><code>AppKey=???? Plugin=zabbix sh -c &quot;$(curl -L https://raw.githubusercontent.com/oneapm/onealert-agent-installer/master/onealert-zabbix-install-centos6.sh)&quot;
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/58919326.jpg" alt=""/></p></li>
<li><p>在zabbix中检查</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/56546116.jpg" alt=""/></p>

<p>补充: 重启onealert</p>

<pre><code>initctl restart onealert
</code></pre></li>
</ol></li>
<li><p>排错</p>

<ol>
<li><p>防火墙没关导致m01的客户端无法连接</p></li>
<li><p>中文字符乱码问题解决</p>

<pre><code>wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
yum -y install wqy-microhei-fonts
\cp /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf
</code></pre></li>
<li><p>备份自定义配置文件后,服务启动失败<br/>
故障重现</p>

<pre><code>cd /etc/zabbix/zabbix_agentd.d/
cp userparameter_mysql.conf{,.bak}
</code></pre>

<pre><code>[root@db01 zabbix_agentd.d]# /etc/init.d/zabbix-agent restart
Shutting down Zabbix agent:                                [FAILED]
Starting Zabbix agent: zabbix_agentd [8667]: ERROR: cannot add user parameter &quot;mysql.status[*],echo &quot;show global status where Variable_name=&#39;$1&#39;;&quot; | HOME=/var/lib/zabbix mysql -N | awk &#39;{print $$2}&#39;&quot;: key &quot;mysql.status&quot; already exists
</code></pre>

<p>解决方法：修改 /etc/zabbix/zabbix_agentd.conf<br/>
将：</p>

<pre><code>Include=/etc/zabbix/zabbix_agentd.d/
</code></pre>

<p>修改为：</p>

<pre><code>Include=/etc/zabbix/zabbix_agentd.d/*.conf
</code></pre></li>
<li><p>普通用户使用netstat -lntup取值失败</p>

<pre><code>[laowang@db01 ~]$ netstat -lntup
(No info could be read for &quot;-p&quot;: geteuid()=503 but you should be root.)
Active Internet connections (only servers)
</code></pre>

<p>解决办法：</p>

<pre><code>chmod u+s /bin/netstat
</code></pre></li>
<li><p>数据类型不一致的</p>

<p>如果自定义监控项取出的值为字符串，然后在添加监控项的时候，信息类型如果不是字符串类型，则会报错</p>

<pre><code>Received value [lixxxxx] is not suitable for value type [Numeric (unsigned)] and data type [Decimal]
```
</code></pre></li>
<li><p>监控mysql</p>

<p>第一步：<br/>
在db01:监控mysql，自定义监控项的配置文件</p>

<pre><code>[root@db01 zabbix_agentd.d]# cat userparameter_mysql.conf
UserParameter=mysql.status[*],echo &quot;show global status where Variable_name=&#39;$1&#39;;&quot; | HOME=/var/lib/zabbix /application/mysql/bin/mysql -uroot -poldboy123 -N 2&gt;/dev/null| awk &#39;{print $$2}&#39;
UserParameter=mysql.ping,/application/mysql/bin/mysqladmin -uroot -poldboy123 ping 2&gt;/dev/null| grep -c alive
UserParameter=mysql.version,mysql -V
</code></pre>

<p>第二步：</p>

<pre><code>[root@oldboyedu38 ~]# zabbix_get -s 10.0.0.51 -k &quot;mysql.ping&quot;
1
</code></pre>

<p>第三步：<br/>
添加db01的主机，并连接Template App MySQL</p></li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-13T19:37:15+08:00" itemprop="datePublished">2017/9/13</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15053026350545.html" itemprop="url">
		卅五、centOS6.9部署zabbix</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>网站可用性</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/46156257.jpg" alt=""/></p></li>
<li><p>硬件层的监控工具--远程管理卡</p>

<p>温度--风扇转速<br/>
电压电流<br/>
Dell远程管理卡 IDRAC (性价比高)      HP ILO            IBM IMM (最好最贵)<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/75643206.jpg" alt=""/></p></li>
<li><p>服务端部署zabbix-server</p>

<ol>
<li><p>安装环境检查</p>

<pre><code>[root@m01 ~]# cat /etc/redhat-release 
CentOS release 6.9 (Final)
[root@m01 ~]# uname -r
2.6.32-696.el6.x86_64
[root@m01 ~]# getenforce 
Disabled
[root@m01 ~]# /etc/init.d/iptables status
iptables: Firewall is not running.
[root@m01 ~]# hostname -I
10.0.0.61 172.16.1.61 
[root@m01 ~]# netstat -tunlp|grep 80 #检查占用80端口的程序,然后关闭
</code></pre></li>
<li><p>安装</p>

<pre><code>cd /server/tools/
tar xfP zabbix3.0.9_yum.tar.gz
yum -y --nogpgcheck -C install httpd mysql-server php55w php55w-mysql php55w-common php55w-gd php55w-mbstring php55w-mcrypt php55w-devel php55w-xml php55w-bcmath
yum -y --nogpgcheck -C install zabbix-web zabbix-server-mysql zabbix-web-mysql
</code></pre></li>
<li><p>配置</p>

<pre><code>\cp /usr/share/mysql/my-medium.cnf /etc/my.cnf
/etc/init.d/mysqld start
mysql -uroot -e&quot;create database zabbix character set utf8 collate utf8_bin;&quot;
mysql -uroot -e&quot;grant all on zabbix.* to zabbix@&#39;localhost&#39; identified by &#39;zabbix&#39;;&quot;
mysql -uroot -e&quot;flush privileges;&quot;
#导入zabbix数据库
zcat /usr/share/doc/zabbix-server-mysql-3.0.9/create.sql.gz|mysql -uzabbix -pzabbix zabbix
#修改PHP配置
sed -i.ori &#39;s#max_execution_time = 30#max_execution_time = 300#;s#max_input_time = 60#max_input_time = 300#;s#post_max_size = 8M#post_max_size = 16M#;910a date.timezone = Asia/Shanghai&#39; /etc/php.ini
diff /etc/php.ini{,.ori}
#修改zabbix-server配置
sed -i.ori &#39;115a DBPassword=zabbix&#39; /etc/zabbix/zabbix_server.conf
cp -R /usr/share/zabbix/ /var/www/html/
chmod -R 755 /etc/zabbix/web
chown -R apache.apache /etc/zabbix/web 
echo &quot;ServerName 127.0.0.1:80&quot;&gt;&gt;/etc/httpd/conf/httpd.conf
</code></pre></li>
<li><p>启动</p>

<pre><code>/etc/init.d/zabbix-server restart
</code></pre></li>
<li><p>页面</p>

<p><a href="http://10.0.0.61/zabbix/setup.php">http://10.0.0.61/zabbix/setup.php</a></p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/72415429.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/90921705.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/12897652.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/81333023.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/15262336.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/65659059.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/45739796.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/26205922.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/76601220.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/30085429.jpg" alt=""/></p></li>
</ol></li>
<li><p>客户端部署zabbix-agent</p>

<ol>
<li><p>安装</p>

<p>常规安装方法</p>

<pre><code>rpm -ivh http://repo.zabbix.com/zabbix/3.0/rhel/6/x86_64/zabbix-release-3.0-1.el6.noarch.rpm
yum -y install zabbix-agent
</code></pre>

<p>快速方法</p>

<pre><code>rpm -ivh http://mirrors.aliyun.com/zabbix/zabbix/3.0/rhel/6/x86_64/zabbix-agent-3.0.9-1.el6.x86_64.rpm
</code></pre></li>
<li><p>配置</p>

<pre><code>sed -i.ori &#39;s#Server=127.0.0.1#Server=172.16.1.61#&#39; /etc/zabbix/zabbix_agentd.conf
</code></pre>

<p>配置结果</p>

<pre><code>[root@m01 ~]# grep -Ev &quot;^$|#&quot; /etc/zabbix/zabbix_agentd.conf
PidFile=/var/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=0
Server=172.16.1.61
ServerActive=127.0.0.1
Hostname=Zabbix server
Include=/etc/zabbix/zabbix_agentd.d/
</code></pre></li>
<li><p>启动</p>

<pre><code>echo &#39;/etc/init.d/zabbix-agent start&#39; &gt;&gt;/etc/rc.local
tail -2 /etc/rc.local
/etc/init.d/zabbix-agent start
ss -lntup|grep zabbix
</code></pre></li>
</ol></li>
<li><p>m01部署zabbix-agent<br/>
过程同上, 配置文件中有一点不同(安装完成后不需要修改, 默认是127.0.0.1)</p>

<pre><code>Server=127.0.0.1
</code></pre></li>
<li><p>服务端访问检查工具</p>

<p>-s 指定访问的IP地址<br/>
-p 指定访问的端口，默认10050<br/>
-k 查询key值</p>

<pre><code>yum -y --nogpgcheck -C install zabbix-get
</code></pre>

<p>检查结果示例</p>

<pre><code>[root@m01 ~]# zabbix_get -s 172.16.1.41 -p 10050 -k &quot;system.cpu.load[all,avg1]&quot;
1.000000
</code></pre>

<p>在m01也需要安装客户端(参考上一章步骤), 访问检查失败时, 检查链路和防火墙等</p>

<pre><code>[root@m01 ~]#  zabbix_get -s 172.16.1.61 -p 10050 -k &quot;system.cpu.load[all,avg1]&quot;
zabbix_get [82642]: Check access restrictions in Zabbix agent configuration
[root@m01 ~]# /etc/init.d/iptables stop
iptables: Setting chains to policy ACCEPT: nat             [  OK  ]
iptables: Flushing firewall rules:                         [  OK  ]
iptables: Unloading modules:                               [  OK  ]
[root@m01 ~]#  zabbix_get -s 172.16.1.61 -p 10050 -k &quot;system.cpu.load[all,avg1]&quot;
0.090000
</code></pre></li>
<li><p>添加zabbix主机</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/40557940.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/66236646.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/9216194.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/66457779.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/3711939.jpg" alt=""/></p></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-13T18:11:32+08:00" itemprop="datePublished">2017/9/13</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15052974923145.html" itemprop="url">
		卅三、PPTP实现VPN</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>PPTP实现VPN</p>

<ol>
<li><p>为什么需要VPN</p>

<p>VPN(全称Virtual Private Network)虚拟专用网络。为了安全传输数据--将数据加密传输</p>

<p>①ssh secure shell</p>

<p>②vpn：在我们公共网络（网线）偷偷的建一条隧道, 然后我们所有数据从这个隧道传输, 这个隧道名字叫做vpn==虚拟专用网络</p>

<p>③专用网络：专线, 自己拉一条网线或者光纤, 这个专线自己独享（公司-机房, 北京-广州）</p>

<p>公司有钱--专线, 没钱-vpn</p>

<p>vpn的优点：方便, 省钱; 缺点是：借助公网, 受公网的网络环境影响大</p>

<p>专线优点：网络环境好, 速度快, 传输距离远; 缺点：成本高</p>

<p>中间的解决方案：租用运营商专线</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/2956070.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/88146659.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/2525307.jpg" alt=""/></p></li>
<li><p>安装部署PPTP（需要epel源）</p>

<pre><code>[root@m01 ~]# yum install -y pptpd
[root@m01 ~]# rpm -qa|grep pptp
pptpd-1.4.0-3.el6.x86_64
[root@m01 ~]# rpm -qa|grep ppp
ppp-2.4.5-10.el6.x86_64
</code></pre>

<ol>
<li><p>内核转发<br/>
我们Windows连接pptp服务器是通过外网卡（eth0）,但是内网是eth1。默认情况, 发给eth0的数据不会给eth1。开启ip内核转发, 可以让eth0将数据包转发给eth1</p>

<pre><code>[root@lb02 ~]# grep &#39;forward&#39; /etc/sysctl.conf
# Controls IP packet forwarding
net.ipv4.ip_forward = 0
[root@lb02 ~]# sed -i &#39;s#net.ipv4.ip_forward = 0#net.ipv4.ip_forward = 1#&#39; /etc/sysctl.conf
[root@lb02 ~]# grep &#39;forward&#39; /etc/sysctl.conf
# Controls IP packet forwarding
net.ipv4.ip_forward = 1
[root@m01 ~]# sysctl -p
</code></pre></li>
<li><p>主要配置<br/>
设定VPN可以使用的ip范围</p>

<pre><code>[root@m01 ~]# sed -i.ori &#39;$a localip 10.0.0.61\nremoteip 172.16.1.100-110&#39; /etc/pptpd.conf 
[root@m01 ~]# tail -2 /etc/pptpd.conf
localip 10.0.0.61
remoteip 172.16.1.100-110
[root@m01 ~]# diff /etc/pptpd.conf{,.ori}
107,108d106
&lt; localip 10.0.0.61
&lt; remoteip 172.16.1.100-110
</code></pre></li>
<li><p>账号密码文件---添加账号密码<br/>
修改此文件无需重启pptp服务，当用户登录时，pptp进程都会读取一次这个文件；密码是明文的，注意600权限</p>

<pre><code>[root@m01 ~]# cat /etc/ppp/chap-secrets
oldboy * 123456 *
[root@m01 ~]# ll /etc/ppp/chap-secrets
-rw------- 1 root root 96 Aug 25 11:43 /etc/ppp/chap-secrets
</code></pre>

<blockquote>
<p>第1列：用户名, 账号<br/>
第2列：* 代表所有, 作用是可以连接的服务器<br/>
第3列：密码<br/>
第4列：* 所有, 随机分配ip地址, 这一列可以指定这个的用户的分配的ip地址</p>
</blockquote></li>
<li><p>启动服务</p>

<pre><code>[root@m01 ~]# /etc/init.d/pptpd
Usage: /etc/init.d/pptpd {start|stop|restart|restart-kill|status}
[root@m01 ~]# /etc/init.d/pptpd start
Starting pptpd:                                            [  OK  ]
</code></pre>

<p>检查</p>

<pre><code>[root@m01 ~]# tailf /var/log/messages
Aug 25 11:32:45 oldboyedu38 pptpd[37609]: MGR: Maximum of 100 connections reduced to 11, not enough IP addresses given
Aug 25 11:32:45 oldboyedu38 pptpd[37610]: MGR: Manager process started
Aug 25 11:32:45 oldboyedu38 pptpd[37610]: MGR: Maximum of 11 connections available
[root@m01 ~]# netstat -tunlp|grep pptp
tcp    0    0 0.0.0.0:1723          0.0.0.0:*         LISTEN      37610/pptpd
</code></pre></li>
<li><p>window启用VPN<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/77134922.jpg" alt=""/></p></li>
</ol></li>
<li><p>企业案例: VPN日志审计----记录登录用户名日志</p>

<p>实现原理<br/>
两个可执行文件: /etc/ppp/ip-up和/etc/ppp/ip-down, 其实是用户登录和下线时,PPTP服务会执行的脚本<br/>
修改这两个脚本, 可以记录用户登录和下线时的详细信息</p>

<pre><code>sed -i.ori &#39;$i echo &quot;$PEERNAME 分配IP: $5 登录IP: $6 登录时间: `date -d today +%F_%T`&quot; &gt;&gt; /var/log/pptpd.log&#39; /etc/ppp/ip-up
sed -i.ori &#39;$i echo &quot;$PEERNAME 下线IP: $6 下线时间: `date -d today +%F_%T`&quot; &gt;&gt; /var/log/pptpd.log&#39; /etc/ppp/ip-down
</code></pre>

<p>实验结果</p>

<pre><code>[root@m01 ~]# cat /var/log/pptpd.log
oldboy 下线IP: 10.0.0.1 下线时间: 2017-08-25_12:20:44
oldboy 分配IP: 172.16.1.100 登录IP: 10.0.0.1 登录时间: 2017-08-25_12:21:13
oldboy 下线IP: 10.0.0.1 下线时间: 2017-08-25_12:21:37
oldboy 分配IP: 172.16.1.100 登录IP: 10.0.0.1 登录时间: 2017-08-25_12:21:45
oldboy 下线IP: 10.0.0.1 下线时间: 2017-08-25_21:03:36
</code></pre></li>
<li><p>企业案例: 如何通过外网访问内网服务器？</p>

<p>子公司内部只有一台服务器, 只有内网地址, 没有公网IP, 但可以通过路由器访问公网, 但是这种模式, 无法从外网访问这台服务器.能找到的解决方法：</p>

<blockquote>
<p>①给笔记本一个公网ip, 但是现在给不了;<br/>
②端口映射, 在路由器上配置, 但是不允许你用;<br/>
③vpn, 作用是让出差的员工访问内网, 但是vpn需要账号, 没有权限开通;<br/>
④teamviewer, 或者向日葵, 能够穿透内网, 不安全...</p>
</blockquote>

<blockquote>
<p>所有网络设备都归总公司管辖, 子公司没有合理理由无法申请。公司内部也有VPN服务器, 但VPN帐号也需要申请。在此种场景, 如何通过外网访问内网服务器？</p>

<blockquote>
<p>解答：在外部有公网IP的机器上部署vpn服务, 内网服务器拨号登录vpn, 外部人员也登录vpn。只要vpn服务器不禁止客户端互联, 外部用户就能访问内部服务器。</p>
</blockquote>
</blockquote>

<blockquote>
<p>建议使用OpenVPN, 比较稳定<br/>
OpenVPN的参数<br/>
client-to-client允许多个VPN client互相通信<br/>
pptp服务器设置防火墙转发规则, 也能让客户端互相访问<br/>
还有一个openswan也能实现</p>
</blockquote></li>
<li><p>PPTP的局限和不足</p>

<p>由微软开发,系统自带(客户端), 端口1723, 使用GRE协议<br/>
pptp只能支持100个用户---利用反向代理<br/>
如果家里的网络连接不上pptp服务器, 怎么办？----手机开热点, 移动4G</p></li>
<li><p>排错</p>

<p>WIN10,VPN,PPTP,连接VPN后无法上网, VPN连接右键属性--网络--IPV4, 点属性没反应不会弹出对话框 </p>

<p>可以尝试一下下面的方法。<br/>
<code>C:\Users\用户名\AppData\Roaming\Microsoft\Network\Connections\Pbk</code><br/>
用记事本打开<code>rasphone.pbk</code>找到<code>IpPrioritizeRemote=1</code></p>

<p>改成0就取消 “从远程网络上使用默认网关”<br/>
改DNS方法</p>

<p>可以修改<code>C:\Users\用户名\AppData\Roaming\Microsoft\Network\Connections\Pbk</code>下面的<code>rasphone.pbk</code>用文本打开<br/>
改 <code>IpDnsAddress=</code>要设置的DNS</p></li>
</ol></li>
<li><p>内网ip上网</p>

<ol>
<li><p>m01启用IP转发功能</p>

<pre><code>#修改系统配置文件开机生效
sed -i &#39;s#net.ipv4.ip_forward = 0#net.ipv4.ip_forward = 1#&#39; /etc/sysctl.conf
#查看确认修改成功
grep &quot;net.ipv4.ip_forward&quot; /etc/sysctl.conf
#重新加载配置文件,使修改生效
sysctl -p
# 添加iptables规则--转发网段请求
iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -j MASQUERADE
## iptables另两种设置方法:(暂时没搞懂) 
## iptables  -t nat -A POSTROUTING -s 172.16.1.0/24 -o eth1 -j SNAT --to-source 10.0.0.200
# 表示将来自172.16.1.0 网段的请求, 全部从10.0.0.61 出去访问互联网
## iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -j SNAT --to-source 10.0.0.61
## iptables -A FORWARD -s 172.16.1.0/24 -j ACCEPT
## iptables -A FORWARD -d 172.16.1.0/24 -j ACCEPT
</code></pre>

<p>另一种使IP转发设置生效的方法(内存中临时生效,重启失效)</p>

<pre><code>## sysctl -w net.ipv4.ip_forward=1
</code></pre></li>
<li><p>测试主机</p>

<pre><code>sed -i &#39;s#ONBOOT=yes#ONBOOT=no#g&#39; /etc/sysconfig/network-scripts/ifcfg-eth0 #eth0不启动
#eth1网关设置为 m01的172.16.1.61 地址
cat &gt;&gt;/etc/sysconfig/network-scripts/ifcfg-eth1&lt;&lt;EOF
GATEWAY=172.16.1.61
DNS1=223.5.5.5
EOF
/etc/init.d/network restart
ping www.bing.com #测试
</code></pre></li>
</ol></li>
<li><p>bash切换zsh</p>

<ol>
<li><p>安装zsh</p>

<pre><code>yum install -y git zsh 
#切换成zsh 
chsh -s `which zsh` 
#把oh-my-zsh插件克隆到本地 
git clone git://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh 
#把oh-my-zsh的zsh模板复制出来一份 
cp ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc
</code></pre></li>
<li><p>修改主题</p>

<pre><code>#修改~/.zshrc
vim ~/.zshrc
# ZSH_THEME=&quot;ys&quot;
#退出重新登录
#1.github是一个在线的代码仓库（网站）, 里面有各种开发者提交的代码
#2.git是将github上面的代码下载下来的工具
#3.zsh就是我们需要把bash替换的一个shell
#4.oh-my-zsh是一个强大的zsh插件, 里面有很多主题, 可以使我们显示, 操作, git的使用更加方便
#5.ys就是一个很常用的主题, 其他主题: awesomepanda agnoster wedisagree simple
</code></pre></li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-13T17:46:58+08:00" itemprop="datePublished">2017/9/13</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15052960182182.html" itemprop="url">
		卅四、openvpn安装与使用</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>openvpn原理</p>

<blockquote>
<p>openvpn通过使用公开密钥（非对称密钥，加密解密使用不同的key，一个称为Publice key，另外一个是Private key）对数据进行加密，这种方式称为TLS加密。</p>
</blockquote>

<blockquote>
<p>openvpn使用TLS加密的工作过程是，首先VPN Sevrver端和VPN Client端要有相同的CA证书，双方通过交换证书验证双方的合法性，用于决定是否建立VPN连接。</p>
</blockquote>

<blockquote>
<p>然后使用对方的CA证书，把自己目前使用的数据加密方法加密后发送给对方，由于使用的是对方CA证书加密，所以只有对方CA证书对应的Private key才能解密该数据，这样就保证了此密钥的安全性，并且此密钥是定期改变的，对于窃听者来说，可能还没有破解出此密钥，VPN通信双方可能就已经更换密钥了。</p>
</blockquote></li>
<li><p>安装openvpn</p>

<ol>
<li><p>环境准备</p>

<p>yum方式安装，此处统一使用aliyun的base和epel源</p>

<pre><code>wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</code></pre>

<p>为避免出现错误关闭selinux</p>

<pre><code>[root@centos7 ~]# cat /etc/redhat-release 
CentOS Linux release 7.2.1511 (Core) 
[root@centos7 ~]# getenforce 
Disabled
[root@centos7 ~]#
</code></pre></li>
<li><p>安装openvpn server</p>

<pre><code>yum install -y openvpn
#查看版本
[root@centos7 yum.repos.d]# openvpn --version
OpenVPN 2.4.3 x86_64-redhat-linux-gnu [Fedora EPEL patched] [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Jun 21 2017
library versions: OpenSSL 1.0.1e-fips 11 Feb 2013, LZO 2.06
Originally developed by James Yonan
</code></pre></li>
<li><p>安装easy-rsa用来制作openvpn相关证书</p>

<pre><code>yum install -y easy-rsa
#查看easy-rsa安装的详细信息
[root@centos7 ~]# rpm -qa easy-rsa
easy-rsa-2.2.2-1.el7.noarch
[root@centos7 ~]# rpm -ql easy-rsa
/usr/share/doc/easy-rsa-2.2.2
/usr/share/doc/easy-rsa-2.2.2/COPYING
/usr/share/doc/easy-rsa-2.2.2/COPYRIGHT.GPL
/usr/share/doc/easy-rsa-2.2.2/doc
/usr/share/doc/easy-rsa-2.2.2/doc/Makefile.am
/usr/share/doc/easy-rsa-2.2.2/doc/README-2.0
/usr/share/easy-rsa
/usr/share/easy-rsa/2.0
/usr/share/easy-rsa/2.0/build-ca
/usr/share/easy-rsa/2.0/build-dh
/usr/share/easy-rsa/2.0/build-inter
/usr/share/easy-rsa/2.0/build-key
/usr/share/easy-rsa/2.0/build-key-pass
/usr/share/easy-rsa/2.0/build-key-pkcs12
/usr/share/easy-rsa/2.0/build-key-server
/usr/share/easy-rsa/2.0/build-req
/usr/share/easy-rsa/2.0/build-req-pass
/usr/share/easy-rsa/2.0/clean-all
/usr/share/easy-rsa/2.0/inherit-inter
/usr/share/easy-rsa/2.0/list-crl
/usr/share/easy-rsa/2.0/openssl-0.9.6.cnf
/usr/share/easy-rsa/2.0/openssl-0.9.8.cnf
/usr/share/easy-rsa/2.0/openssl-1.0.0.cnf
/usr/share/easy-rsa/2.0/pkitool
/usr/share/easy-rsa/2.0/revoke-full
/usr/share/easy-rsa/2.0/sign-req
/usr/share/easy-rsa/2.0/vars
/usr/share/easy-rsa/2.0/whichopensslcnf
</code></pre></li>
</ol></li>
<li><p>制作相关证书</p>

<ol>
<li><p>生成CA证书</p>

<blockquote>
<p>openvpn与easy-rsa安装完毕后，我们可以直接在/usr/share/easy-rsa/2.0 制作相关的证书，但是为了后续的管理证书的方便，我们需要在/etc/openvpn/目录下创建easy-rsa文件夹， 然后把/usr/share/easy-rsa/目录下的所有文件全部复制到/etc/openvpn/easy-rsa/下：</p>
</blockquote>

<pre><code>[root@centos7 ~]# mkdir /etc/openvpn/easy-rsa
[root@centos7 ~]# cp -a /usr/share/easy-rsa/2.0/* /etc/openvpn/easy-rsa/
[root@centos7 ~]# ls -l /etc/openvpn/easy-rsa/
总用量 112
-rwxr-xr-x 1 root root   119 11月  9 2013 build-ca
-rwxr-xr-x 1 root root   352 11月  9 2013 build-dh
-rwxr-xr-x 1 root root   188 11月  9 2013 build-inter
-rwxr-xr-x 1 root root   163 11月  9 2013 build-key
-rwxr-xr-x 1 root root   157 11月  9 2013 build-key-pass
-rwxr-xr-x 1 root root   249 11月  9 2013 build-key-pkcs12
-rwxr-xr-x 1 root root   268 11月  9 2013 build-key-server
-rwxr-xr-x 1 root root   213 11月  9 2013 build-req
-rwxr-xr-x 1 root root   158 11月  9 2013 build-req-pass
-rwxr-xr-x 1 root root   449 11月  9 2013 clean-all
-rwxr-xr-x 1 root root  1471 11月  9 2013 inherit-inter
-rwxr-xr-x 1 root root   302 11月  9 2013 list-crl
-rw-r--r-- 1 root root  7791 11月  9 2013 openssl-0.9.6.cnf
-rw-r--r-- 1 root root  8348 11月  9 2013 openssl-0.9.8.cnf
-rw-r--r-- 1 root root  8245 11月  9 2013 openssl-1.0.0.cnf
-rwxr-xr-x 1 root root 12966 11月  9 2013 pkitool
-rwxr-xr-x 1 root root   928 11月  9 2013 revoke-full
-rwxr-xr-x 1 root root   178 11月  9 2013 sign-req
-rw-r--r-- 1 root root  2077 11月  9 2013 vars
-rwxr-xr-x 1 root root   740 11月  9 2013 whichopensslcnf
#编辑vars文件，修改生成证书需要的信息
[root@centos7 ~]# cd /etc/openvpn/easy-rsa/
[root@centos7 easy-rsa]# cp vars{,.bak}
[root@centos7 easy-rsa]# vim vars
...
export KEY_COUNTRY=&quot;CN&quot;            #国家
export KEY_PROVINCE=&quot;BJ&quot;           #省
export KEY_CITY=&quot;Beijing&quot;          #市
export KEY_ORG=&quot;user&quot;              #组织
export KEY_EMAIL=&quot;123@qq.com&quot;      #邮件
export KEY_CN=oldboy
export KEY_NAME=beyond
export KEY_OU=beyond
...
#用source命令使配置生效
[root@centos7 easy-rsa]# source vars
NOTE: If you run ./clean-all, I will be doing a rm -rf on /etc/openvpn/easy-rsa/keys
[root@centos7 easy-rsa]# ./clean-all    #清除所有证书相关内容
[root@centos7 easy-rsa]# #开始生成CA证书 一路回车即可
[root@centos7 easy-rsa]# ./build-ca
Generating a 2048 bit RSA private key
..........................................+++
.................................+++
writing new private key to &#39;ca.key&#39;
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [CN]:
State or Province Name (full name) [BJ]:
Locality Name (eg, city) [Beijing]:
Organization Name (eg, company) [user]:
Organizational Unit Name (eg, section) [beyond]:
Common Name (eg, your name or your server&#39;s hostname) [oldboy]:
Name [beyond]:
Email Address [123@qq.com]:
#查看生成的证书
[root@centos7 easy-rsa]# ll keys/
总用量 12
-rw-r--r-- 1 root root 1635 9月  10 18:31 ca.crt
-rw------- 1 root root 1704 9月  10 18:31 ca.key
-rw-r--r-- 1 root root    0 9月  10 18:30 index.txt
-rw-r--r-- 1 root root    3 9月  10 18:30 serial
#我们可以看到已经生成了ca.crt和ca.key两个文件，其中ca.crt就是我们所说的CA证书，把该CA证书的ca.crt文件复制到openvpn的启动目录/etc/openvpn下：
[root@centos7 easy-rsa]# cp keys/ca.crt /etc/openvpn/
[root@centos7 easy-rsa]# ll /etc/openvpn/
总用量 8
-rw-r--r-- 1 root root 1635 9月  10 18:37 ca.crt
drwxr-x--- 2 root root    6 6月  21 18:23 client
drwxr-xr-x 3 root root 4096 9月  10 18:30 easy-rsa
drwxr-x--- 2 root root    6 6月  21 18:23 server
</code></pre></li>
<li><p>生成server端证书和秘钥</p>

<pre><code>[root@centos7 easy-rsa]# ./build-key-server vpnserver
Generating a 2048 bit RSA private key
.........+++
.......................................................................................................................................................................................................................................................................................................................................................................+++
writing new private key to &#39;vpnserver.key&#39;
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [CN]:
State or Province Name (full name) [BJ]:
Locality Name (eg, city) [Beijing]:
Organization Name (eg, company) [user]:
Organizational Unit Name (eg, section) [beyond]:
Common Name (eg, your name or your server&#39;s hostname) [vpnserver]:
Name [beyond]:
Email Address [123@qq.com]:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:123456                #发送证书请求需要的密码 可以为空
An optional company name []:oldboy            #可选的组织名   可以为空
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
countryName           :PRINTABLE:&#39;CN&#39;
stateOrProvinceName   :PRINTABLE:&#39;BJ&#39;
localityName          :PRINTABLE:&#39;Beijing&#39;
organizationName      :PRINTABLE:&#39;user&#39;
organizationalUnitName:PRINTABLE:&#39;beyond&#39;
commonName            :PRINTABLE:&#39;vpnserver&#39;
name                  :PRINTABLE:&#39;beyond&#39;
emailAddress          :IA5STRING:&#39;123@qq.com&#39;
Certificate is to be certified until Sep  8 10:46:28 2027 GMT (3650 days)
Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
[root@centos7 easy-rsa]# #查看生成的证书
[root@centos7 easy-rsa]# ll keys/
总用量 48
-rw-r--r-- 1 root root 5337 9月  10 18:46 01.pem
-rw-r--r-- 1 root root 1635 9月  10 18:31 ca.crt
-rw------- 1 root root 1704 9月  10 18:31 ca.key
-rw-r--r-- 1 root root  116 9月  10 18:46 index.txt
-rw-r--r-- 1 root root   21 9月  10 18:46 index.txt.attr
-rw-r--r-- 1 root root    0 9月  10 18:30 index.txt.old
-rw-r--r-- 1 root root    3 9月  10 18:46 serial
-rw-r--r-- 1 root root    3 9月  10 18:30 serial.old
-rw-r--r-- 1 root root 5337 9月  10 18:46 vpnserver.crt
-rw-r--r-- 1 root root 1119 9月  10 18:46 vpnserver.csr
-rw------- 1 root root 1704 9月  10 18:46 vpnserver.key
</code></pre></li>
<li><p>创建迪菲・赫尔曼密钥 生成传输进行秘钥交换时用到的交换秘钥协议文件</p>

<pre><code>[root@centos7 easy-rsa]# ./build-dh 
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
...................................................................................................................................................................+..............................................................................
#查看生成的文件
[root@centos7 easy-rsa]# ll keys/
总用量 52
-rw-r--r-- 1 root root 5337 9月  10 18:46 01.pem
-rw-r--r-- 1 root root 1635 9月  10 18:31 ca.crt
-rw------- 1 root root 1704 9月  10 18:31 ca.key
-rw-r--r-- 1 root root  424 9月  10 18:54 dh2048.pem
-rw-r--r-- 1 root root  116 9月  10 18:46 index.txt
-rw-r--r-- 1 root root   21 9月  10 18:46 index.txt.attr
-rw-r--r-- 1 root root    0 9月  10 18:30 index.txt.old
-rw-r--r-- 1 root root    3 9月  10 18:46 serial
-rw-r--r-- 1 root root    3 9月  10 18:30 serial.old
-rw-r--r-- 1 root root 5337 9月  10 18:46 vpnserver.crt
-rw-r--r-- 1 root root 1119 9月  10 18:46 vpnserver.csr
-rw------- 1 root root 1704 9月  10 18:46 vpnserver.key

已经生成了dh文件dh2048.pem。 把vpnserver.crt、vpnserver.key、dh2048.pem复制到/etc/openvpn/目录下
[root@centos7 easy-rsa]# cp keys/dh2048.pem keys/vpnserver.crt keys/vpnserver.key /etc/openvpn/
</code></pre></li>
<li><p>生成client客户端证书和key</p>

<pre><code>[root@centos7 easy-rsa]# ./build-key vpnclient      #拨号时不需要密码
Generating a 2048 bit RSA private key
....................................................................+++
.....................................+++
writing new private key to &#39;vpnclient.key&#39;
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [CN]:
State or Province Name (full name) [BJ]:
Locality Name (eg, city) [Beijing]:
Organization Name (eg, company) [user]:
Organizational Unit Name (eg, section) [beyond]:
Common Name (eg, your name or your server&#39;s hostname) [vpnclient]:
Name [beyond]:
Email Address [123@qq.com]:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:123456               #此处密码与服务端一致即可
An optional company name []:oldboy
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
countryName           :PRINTABLE:&#39;CN&#39;
stateOrProvinceName   :PRINTABLE:&#39;BJ&#39;
localityName          :PRINTABLE:&#39;Beijing&#39;
organizationName      :PRINTABLE:&#39;user&#39;
organizationalUnitName:PRINTABLE:&#39;beyond&#39;
commonName            :PRINTABLE:&#39;vpnclient&#39;
name                  :PRINTABLE:&#39;beyond&#39;
emailAddress          :IA5STRING:&#39;123@qq.com&#39;
Certificate is to be certified until Sep  8 11:44:26 2027 GMT (3650 days)
Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
#查看生成的文件
[root@centos7 easy-rsa]# ll keys/
总用量 84
-rw-r--r-- 1 root root 5337 9月  10 18:46 01.pem
-rw-r--r-- 1 root root 5219 9月  10 19:44 02.pem
-rw-r--r-- 1 root root 1635 9月  10 18:31 ca.crt
-rw------- 1 root root 1704 9月  10 18:31 ca.key
-rw-r--r-- 1 root root  424 9月  10 18:54 dh2048.pem
-rw-r--r-- 1 root root  232 9月  10 19:44 index.txt
-rw-r--r-- 1 root root   21 9月  10 19:44 index.txt.attr
-rw-r--r-- 1 root root   21 9月  10 18:46 index.txt.attr.old
-rw-r--r-- 1 root root  116 9月  10 18:46 index.txt.old
-rw-r--r-- 1 root root    3 9月  10 19:44 serial
-rw-r--r-- 1 root root    3 9月  10 18:46 serial.old
-rw-r--r-- 1 root root 5219 9月  10 19:44 vpnclient.crt
-rw-r--r-- 1 root root 1119 9月  10 19:44 vpnclient.csr
-rw------- 1 root root 1704 9月  10 19:44 vpnclient.key
-rw-r--r-- 1 root root 5337 9月  10 18:46 vpnserver.crt
-rw-r--r-- 1 root root 1119 9月  10 18:46 vpnserver.csr
-rw------- 1 root root 1704 9月  10 18:46 vpnserver.key

#生成拨号时需要密码的客户端文件和证书，和上面两者选择一种就可以

[root@centos7 easy-rsa]# ./build-key-pass vpnbeyond
Generating a 2048 bit RSA private key
....................................................................+++
............+++
writing new private key to &#39;vpnbeyond.key&#39;
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [CN]:
State or Province Name (full name) [BJ]:
Locality Name (eg, city) [Beijing]:
Organization Name (eg, company) [user]:
Organizational Unit Name (eg, section) [beyond]:
Common Name (eg, your name or your server&#39;s hostname) [vpnbeyond]:
Name [beyond]:
Email Address [123@qq.com]:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:123456
An optional company name []:oldboy
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
countryName           :PRINTABLE:&#39;CN&#39;
stateOrProvinceName   :PRINTABLE:&#39;BJ&#39;
localityName          :PRINTABLE:&#39;Beijing&#39;
organizationName      :PRINTABLE:&#39;user&#39;
organizationalUnitName:PRINTABLE:&#39;beyond&#39;
commonName            :PRINTABLE:&#39;vpnbeyond&#39;
name                  :PRINTABLE:&#39;beyond&#39;
emailAddress          :IA5STRING:&#39;123@qq.com&#39;
Certificate is to be certified until Sep  8 11:48:10 2027 GMT (3650 days)
Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
#查看生成的文件
[root@centos7 easy-rsa]# ll keys/
总用量 108
-rw-r--r-- 1 root root 5337 9月  10 18:46 01.pem
-rw-r--r-- 1 root root 5219 9月  10 19:44 02.pem
-rw-r--r-- 1 root root 5219 9月  10 19:48 03.pem
-rw-r--r-- 1 root root 1635 9月  10 18:31 ca.crt
-rw------- 1 root root 1704 9月  10 18:31 ca.key
-rw-r--r-- 1 root root  424 9月  10 18:54 dh2048.pem
-rw-r--r-- 1 root root  348 9月  10 19:48 index.txt
-rw-r--r-- 1 root root   21 9月  10 19:48 index.txt.attr
-rw-r--r-- 1 root root   21 9月  10 19:44 index.txt.attr.old
-rw-r--r-- 1 root root  232 9月  10 19:44 index.txt.old
-rw-r--r-- 1 root root    3 9月  10 19:48 serial
-rw-r--r-- 1 root root    3 9月  10 19:44 serial.old
-rw-r--r-- 1 root root 5219 9月  10 19:48 vpnbeyond.crt
-rw-r--r-- 1 root root 1119 9月  10 19:48 vpnbeyond.csr
-rw------- 1 root root 1834 9月  10 19:48 vpnbeyond.key
-rw-r--r-- 1 root root 5219 9月  10 19:44 vpnclient.crt
-rw-r--r-- 1 root root 1119 9月  10 19:44 vpnclient.csr
-rw------- 1 root root 1704 9月  10 19:44 vpnclient.key
-rw-r--r-- 1 root root 5337 9月  10 18:46 vpnserver.crt
-rw-r--r-- 1 root root 1119 9月  10 18:46 vpnserver.csr
-rw------- 1 root root 1704 9月  10 18:46 vpnserver.key
</code></pre>

<p>已经生成了vpnclient.csr、vpnclient.crt和vpnclient.key这个三个文件, vpnclient.crt和vpnclient.key两个文件是我们要使用的。至此，Client端E证书就制作完毕。</p></li>
</ol></li>
<li><p>配置server端</p>

<pre><code>[root@centos7 easy-rsa]# cp /usr/share/doc/openvpn-2.4.3/sample/sample-config-files/server.conf /etc/openvpn/server.conf.bak
[root@centos7 easy-rsa]# cd /etc/openvpn/
[root@centos7 openvpn]# grep -Ev &quot;^;|^#|^$&quot; server.conf.bak &gt;server.conf
[root@centos7 openvpn]# vim server.conf
port 1194
proto tcp
dev tun
ca ca.crt
cert vpnserver.crt
key vpnserver.key  # This file should be kept secret
dh dh2048.pem
server 10.8.0.0 255.255.255.0
push &quot;route 172.16.1.0 255.255.255.0&quot;
ifconfig-pool-persist ipp.txt
keepalive 10 120
comp-lzo
persist-key
persist-tun
status openvpn-status.log
verb 3
client-to-client
duplicate-cn
log /var/log/openvpn.log
~                                                                                  
~                                                                                  
&quot;server.conf&quot; 19L, 360C 已写入  
#启动服务
[root@centos7 openvpn]# systemctl start openvpn@server   
[root@centos7 openvpn]# ss -lntup |grep openvpn
tcp    LISTEN     0      1         *:1194                  *:*                   users:((&quot;openvpn&quot;,pid=19333,fd=6))
</code></pre></li>
<li><p>client端配置</p>

<ol>
<li><p>在server端操作 </p>

<p>创建客户端文件夹并拷贝客户端文件到该文件夹配置完成后打包压缩下载到本地Windows端</p>

<pre><code>[root@centos7 openvpn]# mkdir vpnclient
[root@centos7 openvpn]# cp /usr/share/doc/openvpn-2.4.3/sample/sample-config-files/client.conf ./vpnclient/vpnclient.ovpn
[root@centos7 openvpn]# pwd
/etc/openvpn
[root@centos7 openvpn]# cp easy-rsa/keys/vpnclient.crt easy-rsa/keys/vpnclient.key easy-rsa/keys/ca.crt easy-rsa/keys/ca.key ./vpnclient/
[root@centos7 openvpn]# ls -l vpnclient/
总用量 24
-rw-r--r-- 1 root root 1635 9月  10 21:22 ca.crt
-rw------- 1 root root 1704 9月  10 21:22 ca.key
-rw-r--r-- 1 root root 5219 9月  10 21:22 vpnclient.crt
-rw------- 1 root root 1704 9月  10 21:22 vpnclient.key
-rw-r--r-- 1 root root 3584 9月  10 21:17 vpnclient.ovpn
[root@centos7 openvpn]# cp vpnclient/vpnclient.ovpn{,.bak}
[root@centos7 openvpn]# vim vpnclient/vpnclient.ovpn
ns-cert-type server
client
dev tun
proto tcp
remote 10.0.0.201 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert vpnclient.crt
key vpnclient.key
ns-cert-type server
comp-lzo
verb 3
~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
&quot;vpnclient/vpnclient.ovpn&quot; 14L, 184C 已写入

[root@centos7 openvpn]# zip -r vpnclient.zip ./vpnclient/
  adding: vpnclient/ (stored 0%)
  adding: vpnclient/vpnclient.crt (deflated 47%)
  adding: vpnclient/vpnclient.key (deflated 23%)
  adding: vpnclient/ca.crt (deflated 35%)
  adding: vpnclient/ca.key (deflated 23%)
  adding: vpnclient/vpnclient.ovpn.bak (deflated 54%)
  adding: vpnclient/vpnclient.ovpn (deflated 30%)
[root@centos7 openvpn]# ls
ca.crt      easy-rsa            server           vpnclient      vpnserver.key
client      ipp.txt             server.conf      vpnclient.zip
dh2048.pem  openvpn-status.log  server.conf.bak  vpnserver.crt
[root@centos7 openvpn]# sz vpnclient.zip -y
rz
 zmodem trl+C ȡ
  100%       9 KB    9 KB/s 00:00:01       0 Errors
  ```
</code></pre></li>
<li><p>Windows客户端上操作</p>

<p>在windows的Client端，安装完毕Openvpn后，程序安装路径是：D:\ProgramFiles\OpenVPN\，如下图解压sz下载的压缩包到config目录下：<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/13093217.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/8858594.jpg" alt=""/></p>

<p>双击桌面openvpn图标如上图点击连接后会成功拨号如下所示：分配的ip地址是10.8.0.6</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/50805201.jpg" alt=""/></p>

<p>在vpnserver端查看IP地址如下图分配的IP地址是10.8.0.1，然后在Windows端ping10.8.0.6即可ping通，当然用crt或者xshell也可连接上</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/82462584.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/52340472.jpg" alt=""/></p></li>
</ol></li>
<li><p>实现访问内网网段</p>

<pre><code>#开启ipv4转发
[root@centos7 openvpn]# echo &#39;net.ipv4.ip_forward =1&#39; &gt;&gt; /etc/sysctl.conf                  [root@centos7 openvpn]# sysctl -p
net.ipv4.ip_forward = 1
[root@centos7 openvpn]# grep net.ip /etc/sysctl.conf                      
net.ipv4.ip_forward =1
#抓包
[root@centos7 openvpn]# tcpdump -i eth1
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes
22:41:22.362365 ARP, Request who-has 172.16.1.62 tell 172.16.1.201, length 28
22:41:22.362767 ARP, Reply 172.16.1.62 is-at 00:0c:29:e7:44:c0 (oui Unknown), length 46
22:41:22.362778 IP 10.8.0.6 &gt; 172.16.1.62: ICMP echo request, id 1, seq 329, length 40
22:41:27.032841 IP 10.8.0.6 &gt; 172.16.1.62: ICMP echo request, id 1, seq 330, length 40
22:41:32.032299 IP 10.8.0.6 &gt; 172.16.1.62: ICMP echo request, id 1, seq 331, length 40
22:41:37.032198 IP 10.8.0.6 &gt; 172.16.1.62: ICMP echo request, id 1, seq 332, length 40
#通过抓包可以发现数据包到达vpn的内部机器上没有返回

#解决方法1：在vpn的内部机器上添加返回路由或干脆把vpn server作为vpn内部机器的网关

#在vpn内部机器172.16.1.62上配置
[root@localhost ~]# ip a
3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 00:0c:29:e7:44:c0 brd ff:ff:ff:ff:ff:ff
    inet 172.16.1.62/24 brd 172.16.1.255 scope global eth1
    inet6 fe80::20c:29ff:fee7:44c0/64 scope link 
       valid_lft forever preferred_lft forever
[root@localhost ~]# route add -net 10.8.0.0/24 gw 172.16.1.201
[root@localhost ~]# tcpdump -i eth1
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes
22:52:47.063020 IP 10.8.0.6 &gt; 172.16.1.62: ICMP echo request, id 1, seq 366, length 40
22:52:47.063044 IP 172.16.1.62 &gt; 10.8.0.6: ICMP echo reply, id 1, seq 366, length 40
22:52:48.063590 ARP, Request who-has 172.16.1.62 tell 172.16.1.201, length 46
22:52:48.063605 ARP, Reply 172.16.1.62 is-at 00:0c:29:e7:44:c0 (oui Unknown), length 28
22:52:48.065214 IP 10.8.0.6 &gt; 172.16.1.62: ICMP echo request, id 1, seq 367, length 40
22:52:48.065231 IP 172.16.1.62 &gt; 10.8.0.6: ICMP echo reply, id 1, seq 367, length 40
[root@localhost ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.0.0.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0
10.8.0.0        172.16.1.201    255.255.255.0   UG    0      0        0 eth1
172.16.1.0      0.0.0.0         255.255.255.0   U     0      0        0 eth1
169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     1003   0        0 eth1
0.0.0.0         10.0.0.254      0.0.0.0         UG    0      0        0 eth0
#或者：
route add default gw 172.16.1.201

#此方法虽然实现了访问vpn内部机器的功能，但是当vpn内部机器有很多台的时候此方法就不好了，所以有第二种方法：在vpn服务器上配置防火墙转发

iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j SNAT --to-source 172.16.1.201
iptables -F
iptables -t nat -L -n
iptables -t filter -L -n
/etc/init.d/iptables save
/etc/init.d/iptables restart

[root@localhost ~]# tcpdump -i eth1
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes
23:51:59.411144 IP 172.16.1.201 &gt; 172.16.1.62: ICMP echo request, id 1, seq 393, length 40
23:51:59.411190 IP 172.16.1.62 &gt; 172.16.1.201: ICMP echo reply, id 1, seq 393, length 40
23:52:00.412799 IP 172.16.1.201 &gt; 172.16.1.62: ICMP echo request, id 1, seq 394, length 40
23:52:00.412819 IP 172.16.1.62 &gt; 172.16.1.201: ICMP echo reply, id 1, seq 394, length 40
</code></pre></li>
<li><p>openvpn客户端证书的撤销</p>

<ol>
<li><p>撤销单个证书</p>

<pre><code>[root@centos7 sample-config-files]# cd /etc/openvpn/easy-rsa/
[root@centos7 easy-rsa]# ls
build-ca        build-key-pkcs12  inherit-inter      openssl-1.0.0.cnf  vars.bak
build-dh        build-key-server  keys               pkitool            whichopensslcnf
build-inter     build-req         list-crl           revoke-full
build-key       build-req-pass    openssl-0.9.6.cnf  sign-req
build-key-pass  clean-all         openssl-0.9.8.cnf  vars
[root@centos7 easy-rsa]# source vars
NOTE: If you run ./clean-all, I will be doing a rm -rf on /etc/openvpn/easy-rsa/keys
[root@centos7 easy-rsa]# ./revoke-full vpnclient
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
Revoking Certificate 02.
Data Base Updated
Using configuration from /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
vpnclient.crt: C = CN, ST = BJ, L = Beijing, O = user, OU = beyond, CN = vpnclient, name = beyond, emailAddress = 123@qq.com
error 23 at 0 depth lookup:certificate revoked
[root@centos7 easy-rsa]# ll keys/crl.pem 
-rw-r--r-- 1 root root 715 9月  11 00:42 keys/crl.pem
[root@centos7 easy-rsa]# cat keys/crl.pem 
-----BEGIN X509 CRL-----
MIIB5jCBzzANBgkqhkiG9w0BAQsFADCBiTELMAkGA1UEBhMCQ04xCzAJBgNVBAgT
AkJKMRAwDgYDVQQHEwdCZWlqaW5nMQ0wCwYDVQQKEwR1c2VyMQ8wDQYDVQQLEwZi
ZXlvbmQxDzANBgNVBAMTBm9sZGJveTEPMA0GA1UEKRMGYmV5b25kMRkwFwYJKoZI
hvcNAQkBFgoxMjNAcXEuY29tFw0xNzA5MTAxNjQyMDBaFw0xNzEwMTAxNjQyMDBa
MBQwEgIBAhcNMTcwOTEwMTY0MjAwWjANBgkqhkiG9w0BAQsFAAOCAQEAFPEKfUoF
wayBHlI1FE3prhAN53C0wJm0IUpwBuRDC8XbPLPMTX3dzps1Jmatw0BVX++IlvGJ
z7lrxZpFXPbCr44m9rDpOMHdbwgrqchMCpyBX4N3qRAd1rDXbeahb/n0GhRbPudD
EeRodU07aT9AQ5kpp0occPZsiSFuypwemegdan3l2KNus4vdABrE6bRpCfE1Xizb
NqKDNIf44ewvelP8m9XGR8o84hD5jgJtL2Cqx5Hfc7vxm8PIIn4Ne1KfdgT6U0pB
ssyXsAAMfTTrDiiazcu8PFaomMBhtDJghZLs1td5bkYSLbkpgT4hKQumcZgZqj9V
F4aCaqe6+wQjXA==
-----END X509 CRL-----
[root@centos7 easy-rsa]# cat keys/index.txt
V       270908104628Z           01      unknown /C=CN/ST=BJ/L=Beijing/O=user/OU=beyond/CN=vpnserver/name=beyond/emailAddress=123@qq.com
R       270908114426Z   170910164200Z   02      unknown /C=CN/ST=BJ/L=Beijing/O=user/OU=beyond/CN=vpnclient/name=beyond/emailAddress=123@qq.com
V       270908114810Z           03      unknown /C=CN/ST=BJ/L=Beijing/O=user/OU=beyond/CN=vpnbeyond/name=beyond/emailAddress=123@qq.com

#编辑vpn服务端配置文件增加如下配置
crl-verify /etc/openvpn/easy-rsa/keys/crl.pem
#重启服务
[root@centos7 easy-rsa]# systemctl restart openvpn@server.service 
[root@centos7 easy-rsa]# systemctl stop openvpn@server.service        
[root@centos7 easy-rsa]# ss -lntup|grep openvpn
[root@centos7 easy-rsa]# systemctl start openvpn@server.service   
[root@centos7 easy-rsa]# ss -lntup|grep openvpn                 
tcp    LISTEN     0      1         *:1194                  *:*                   users:((&quot;openvpn&quot;,pid=22972,fd=6))
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/83356688.jpg" alt=""/></p>

<p>此时会发现证书已吊销无法登陆。</p></li>
<li><p>取消撤销<br/>
如果发现撤销错误需要回退的时候只需要将配置文件中加的内容注释掉然后再重启服务即可。</p></li>
</ol></li>
<li><p>配置linux下vpn客户端<br/>
安装过程和linux下vpn server端一样</p></li>
</ol>

<hr/>

<h5 id="toc_0">启动：</h5>

<p>openvpn /etc/openvpn/vpnclient.ovpn</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-13T16:42:52+08:00" itemprop="datePublished">2017/9/13</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15052921723963.html" itemprop="url">
		卅二、NTP时间服务</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>为什么需要NTP时间服务器</p>

<p>NTP 是提供一个时间标准, 系统软件对时间的精度要求非常严格, 相差个几秒或者几分钟, 会导致服务无法启动, 各种各样的报错</p>

<p>系统优化方面: 参加工作以后，把自己管理的服务器全部要排查时间同步<br/>
企业服务器:<br/>
同步公网的时间服务器的延迟：10ms-xxx秒<br/>
局域网时间服务器的延迟：&lt;1ms</p></li>
<li><p>服务端搭建ntpd</p>

<p>正确安装软件的理论：<br/>
①安装 ②配置 ③启动 ④使用软件<br/>
能够yum安装就yum安装；不能yum安装的，先编译安装然后自己打一个rpm包，然后yum安装</p>

<pre><code>[root@m01 ~]# yum -y install ntp
[root@m01 ~]# rpm -qa ntp
ntp-4.2.6p5-10.el6.centos.2.x86_64
</code></pre>

<p>ntp旧版本有漏洞，企业环境将他升级到最新版本，更简单方法，不给ntp时间服务器公网地址</p>

<ol>
<li><p>防火墙设置</p>

<pre><code>iptables -I INPUT -p udp -m udp --sport 123 -j ACCEPT  #对外开放123端口
</code></pre>

<p><mark>最好的办法</mark>是将所有linux系统的防火墙都关闭：</p>

<pre><code>chkconfig --level 2345 ip6tables off
chkconfig --level 2345 iptables off
service ip6tables stop
service iptables stop
</code></pre></li>
<li><p>配置/etc/ntp.conf</p>

<p>参考资料: <a href="http://jingyan.baidu.com/article/3c48dd347b3b75e10be35892.html">http://jingyan.baidu.com/article/3c48dd347b3b75e10be35892.html</a> </p>

<pre><code>cp /etc/ntp.conf{,.ori} 
cat&gt;/etc/ntp.conf&lt;&lt;EOF
driftfile /var/lib/ntp/drift
restrict default nomodify
restrict 127.0.0.1
restrict -6 ::1
server ntp1.aliyun.com
fudge ntp1.aliyun.com stratum 8
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys
EOF
</code></pre>

<ol>
<li><p>第一种配置：允许任何IP的客户机都可以进行时间同步</p>

<pre><code>restrict default nomodify notrap
</code></pre></li>
<li><p>第二种配置：只允许172.16.1.***网段的客户机进行时间同步</p>

<pre><code>restrict 172.16.1.0 mask 255.255.255.0 nomodify notrap
</code></pre></li>
</ol></li>
<li><p>启动</p>

<p>NTP时间服务器也有时间同步功能，发现自己系统时间不对，也会自己把自己的系统时间更新</p>

<pre><code>/etc/init.d/ntpd start
chkconfig --level 35 ntpd on
</code></pre>

<p>ntpd服务重启后,查看时间同步过程(如果服务是刚重启,需要等待几秒钟就能看到动态结果)</p>

<pre><code>[root@m01 ~]# watch ntpq -p
Every 2.0s: ntpq -p                                    Mon Aug 28 09:22:59 2017
remote             refid           st t when poll reach   delay   offset  jitter
==============================================================================
*time5.aliyun.co 10.137.38.86     2 u   55   64  377   10.240  1983.55 1043.58
</code></pre></li>
</ol></li>
<li><p>客户端同步时间</p>

<pre><code>[root@m01 ~]# ntpdate 10.0.0.61
25 Aug 09:41:00 ntpdate[37476]: the NTP socket is in use, exiting
</code></pre>

<p>在m01使用ntpdate命令会和ntp服务进程冲突，不能同时使用<br/>
客户端能正常同步的情况:</p>

<pre><code>[root@web02 ~]# ntpdate 172.16.1.61
25 Aug 09:44:03 ntpdate[29612]: adjust time server 10.0.0.61 offset -0.010470 sec
</code></pre>

<p>所有客户端加入定时任务</p>

<pre><code>[root@lb02 ~]# crontab -l
*/5 * * * * /usr/sbin/ntpdate 10.0.0.61 &gt;/dev/null 2&gt;&amp;1
</code></pre></li>
<li><p>无法同步的情况</p>

<pre><code>[root@lb02 ~]# ntpdate 172.16.1.61
15 Aug 16:35:02 ntpdate[29611]: no server suitable for synchronization found
</code></pre>

<p>使用-d debug调试</p>

<pre><code>[root@web02 ~]# ntpdate -d 172.16.1.61
30 Aug 00:41:45 ntpdate[73624]: ntpdate 4.2.6p5@1.2349-o Mon Feb  6 07:22:46 UTC 2017 (1)
Looking for host 172.16.1.61 and service ntp
host found : m01
transmit(172.16.1.61)
receive(172.16.1.61)
transmit(172.16.1.61)
receive(172.16.1.61)
transmit(172.16.1.61)
receive(172.16.1.61)
transmit(172.16.1.61)
receive(172.16.1.61)
172.16.1.61: Server dropped: strata too high
server 172.16.1.61, port 123
stratum 16, precision -23, leap 11, trust 000
refid [172.16.1.61], delay 0.02571, dispersion 0.00000
transmitted 4, in filter 4
reference time:    00000000.00000000  Mon, Jan  1 1900  8:05:43.000
originate timestamp: dd5017d3.378721d8  Wed, Aug 30 2017  0:41:55.216
transmit timestamp:  dd5017c9.6a0d13f1  Wed, Aug 30 2017  0:41:45.414
filter delay:  0.02588  0.02576  0.02577  0.02571
         0.00000  0.00000  0.00000  0.00000
filter offset: 9.802604 9.802566 9.802544 9.802574
         0.000000 0.000000 0.000000 0.000000
delay 0.02571, dispersion 0.00000
offset 9.802574

30 Aug 00:41:45 ntpdate[73624]: no server suitable for synchronization found
[root@web02 ~]#
</code></pre>

<p>以下内容引自: <a href="http://www.blogjava.net/spray/archive/2008/07/10/213964.html">http://www.blogjava.net/spray/archive/2008/07/10/213964.html</a></p>

<ol>
<li><p>错误1.Server dropped: Strata too high</p>

<p>在ntp客户端用ntpdate –d serverIP查看，发现有“Server dropped: strata too high”的错误，并且显示“stratum 16”。而正常情况下stratum这个值得范围是“0~15”。这是因为NTP server还没有和其自身或者它的上级server同步上。</p>

<p>以下的定义是让NTP Server和其自身保持同步，如果在/ntp.conf中定义的server都不可用时，将使用local时间作为ntp服务提供给ntp客户端。</p>

<pre><code>server 127.127.1.0
fudge 127.127.1.0 stratum 8 
</code></pre>

<p>在ntp server上重新启动ntp服务后，ntp server自身或者与其server的同步的需要一个时间段，这个过程可能是5分钟，在这个时间之内在客户端运行ntpdate命令时会产生no server suitable for synchronization found的错误。</p>

<p>那么如何知道何时ntp server完成了和自身同步的过程呢？<br/>
在ntp server上使用命令：</p>

<pre><code>watch ntpq -p
</code></pre>

<p>出现画面：</p>

<pre><code>Every 2.0s: ntpq -p                                     Thu Jul 10 02:28:32 2008
     remote           refid      st t when poll reach   delay   offset jitter
==============================================================================
 192.168.30.22   LOCAL(0)         8 u   22   64    1    2.113 179133.   0.001
  LOCAL(0)        LOCAL(0)        10 l   21   64    1    0.000   0.000  0.001
  ```

注意LOCAL的这个就是与自身同步的ntp server。
注意reach这个值，在启动ntp server服务后，这个值就从0开始不断增加，当增加到17的时候，从0到17是5次的变更，每一次是poll的值的秒数，是64秒*5=320秒的时间。
如果之后从ntp客户端同步ntp server还失败的话，用ntpdate –d来查询详细错误信息，再做判断。
</code></pre></li>
<li><p>错误2.Server dropped: no data<br/>
从客户端执行netdate –d时有错误信息如下：</p>

<pre><code>transmit(192.168.30.22)
transmit(192.168.30.22)
transmit(192.168.30.22)
transmit(192.168.30.22)
transmit(192.168.30.22)
192.168.30.22: Server dropped: no data
server 192.168.30.22, port 123
.....
28 Jul 17:42:24 ntpdate[14148]: no server suitable for synchronization found
</code></pre>

<p>出现这个问题的原因可能有2：</p>

<ol>
<li><p>检查ntp的版本，如果你使用的是ntp4.2（包括4.2）之后的版本，在restrict的定义中使用了notrust的话，会导致以上错误。解决：把notrust去掉。</p>

<pre><code>rpm -qa ntp #检查版本命令, 也可使用 ntpq -c version
</code></pre></li>
<li><p>检查ntp server的防火墙。可能是server的防火墙屏蔽了upd 123端口。</p>

<pre><code>service iptables stop
</code></pre></li>
</ol></li>
</ol></li>
<li><p>ntpd与ntpdate的区别</p></li>
</ol>

<blockquote>
<p>以下内容源自: <a href="http://www.cnblogs.com/liuyou/archive/2012/07/29/2614330.html">http://www.cnblogs.com/liuyou/archive/2012/07/29/2614330.html</a><br/>
之前配置ntpd的时候搜到一句话，印象很深刻，也觉得很有标题党的效果，就借鉴为标题了：<br/>
“我认为有几种人是必须不招聘/裁掉的： 1 用ntpdate代替ntpd的人”<br/>
但具体原因不太懂，总觉得还是用ntpdate比较方便。<br/>
今天问了红帽技术支持，对方的解释是：<br/>
ntpd在实际同步时间时是一点点的校准过来时间的，最终把时间慢慢的校正对。而ntpdate不会考虑其他程序是否会阵痛，直接调整时间。<br/>
一个是校准时间，一个是调整时间。<br/>
以下是一个形象的假设：<br/>
linuxtone限制用户注册1小时才能发帖。<br/>
数据库服务器在 10：00分接受了我的注册邀请；<br/>
10：03分，ntpdate将数据库时间强行改成9：35分；<br/>
然后10：05分（9：37分）我尝试发帖，系统判断我注册时间是否满一小时会使用：9：37 - 10：00<br/>
最后电脑就逻辑混乱了。。。<br/>
类似的帖子网上也有很详细的说明，贴出来给大家看看：<br/>
时钟的跃变，有时候会导致很严重的问题。许多应用程序依赖连续的时钟??毕竟，这是一项常见的假定，即，取得的时间是线性的，一些操作，例如数据库事务，通常会地依赖这样的事实：时间不会往回跳跃。<br/>
不幸的是，ntpdate调整时间的方式就是我们所说的”跃变“：在获得一个时间之后，ntpdate使用settimeofday(2)设置系统时间，这有几个非常明显的问题：<br/>
第一，这样做不安全。ntpdate的设置依赖于ntp服务器的安全性，攻击者可以利用一些软件设计上的缺陷，拿下ntp服务器并令与其同步的服务器执行某些消耗性的任务。由于ntpdate采用的方式是跳变，跟随它的服务器无法知道是否发生了异常（时间不一样的时候，唯一的办法是以服务器为准）。<br/>
第二，这样做不精确。一旦ntp服务器宕机，跟随它的服务器也就会无法同步时间。与此不同，ntpd不仅能够校准计算机的时间，而且能够校准计算机的时钟。<br/>
第三，这样做不够优雅。由于是跳变，而不是使时间变快或变慢，依赖时序的程序会出错（例如，如果ntpdate发现你的时间快了，则可能会经历两个相同的时刻，对某些应用而言，这是致命的）。<br/>
因而，唯一一个可以令时间发生跳变的点，是计算机刚刚启动，但还没有启动很多服务的那个时候。其余的时候，理想的做法是使用ntpd来校准时钟，而不是调整计算机时钟上的时间。<br/>
NTPD 在和时间服务器的同步过程中，会把 BIOS 计时器的振荡频率偏差??或者说 Local Clock 的自然漂移(drift)??记录下来。这样即使网络有问题，本机仍然能维持一个相当精确的走时。<br/>
最后提醒一下使用vmware的各位，因为虚拟机的时钟不太正常，比正常速度慢好多秒，所以在虚拟机上测试ntpd很难得到理想的结果，我当年就是为这个问题耽搁了好几天。。</p>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-13T08:34:43+08:00" itemprop="datePublished">2017/9/13</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15052628837678.html" itemprop="url">
		redis简单入门及实现wordpress数据库缓存</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>redis简介<br/>
Remote Dictionary Server（Redis）是一个基于 key-value 键值对的持久化数据库存储系统。支持多种数据结构，包括 string (字符串)、list (链表)、set (集合)、zset (sorted set --有序集合)和 hash（哈希类型）。<br/>
redis和memcached的区别<br/>
Redis和Memcache都是将数据存放在内存中，都是内存数据库。不过memcache还可用于缓存其他东西，例如图片、视频等等；<br/>
Redis不仅仅支持简单的k/v类型的数据，同时还提供list，set，hash等数据结构的存储；<br/>
虚拟内存--Redis当物理内存用完时，可以将一些很久没用到的value 交换到磁盘；<br/>
过期策略--memcache在set时就指定，例如set key1 0 0 8,即永不过期。Redis可以通过例如expire 设定，例如expire name 10；<br/>
分布式--设定memcache集群，利用magent做一主多从;redis可以做一主多从。<br/>
存储数据安全--memcache挂掉后，数据没了；redis可以定期保存到磁盘（持久化）；<br/>
灾难恢复--memcache挂掉后，数据不可恢复; redis数据丢失后可以恢复；<br/>
Redis支持数据的备份，即master-slave模式的数据备份；<br/>
应用场景不一样：Redis除了作为NoSQL数据库使用外，还能用做消息队列、数据堆栈和数据缓存等；Memcached适合于缓存SQL语句、数据集、用户临时性数据、延迟查询数据和session等<br/>
性能对比：由于Redis只使用单核，而Memcached可以使用多核，所以平均每一个核上Redis在存储小数据时比Memcached性能更高。而在100k以上的数据中，Memcached性能要高于Redis，虽然Redis最近也在存储大数据的性能上进行优化，但是比起 Memcached，还是稍有逊色。<br/>
内存使用效率对比：使用简单的key-value存储的话，Memcached的内存利用率更高，而如果Redis采用hash结构来做key-value存储，由于其组合式的压缩，其内存利用率会高于Memcached。<br/>
Redis支持服务器端的数据操作：Redis相比Memcached来说，拥有更多的数据结构和并支持更丰富的数据操作，通常在Memcached 里，你需要将数据拿到客户端来进行类似的修改再set回去。这大大增加了网络IO的次数和数据体积。在Redis中，这些复杂的操作通常和一般的 GET/SET一样高效。所以，如果需要缓存能够支持更复杂的结构和操作，那么Redis会是不错的选择。<br/>
redis服务端的安装<br/>
中文帮助文档<br/>
<a href="http://redisdoc.com/">http://redisdoc.com/</a><br/>
在lb01   10.0.0.5（172.16.1.5）上操作：<br/>
下载地址：<br/>
wget  <a href="http://download.redis.io/releases/redis-3.2.10.tar.gz">http://download.redis.io/releases/redis-3.2.10.tar.gz</a><br/>
安装：<br/>
tar zxf redis-3.2.10.tar.gz <br/>
cd redis-3.2.10<br/>
make<br/>
make install<br/>
拷贝启动文件：<br/>
cd utils/<br/>
cp redis_init_script /etc/init.d/redis<br/>
chmod +x /etc/init.d/redis<br/>
拷贝配置文件：<br/>
mkdir /etc/redis<br/>
cd ..<br/>
cp redis.conf /etc/redis/6379.conf<br/>
/etc/init.d/redis start<br/>
此时会看到redis是在前台运行需要修改配置文件让其在后台运行并且开启持久化：<br/>
持久化有两种方式：<br/>
1.rdb（快照默认开启）二进制文件<br/>
2.aof（类似于mysql的binlog功能）操作语句保存在文件中<br/>
sed -i &#39;s/daemonize no/daemonize yes/;s/appendonly no/appendonly yes/;163c logfile &quot;/var/log/redis.log&quot;&#39; /etc/redis/6379.conf<br/>
sed -i &#39;247c dir  /tmp&#39; /etc/redis/6379.conf<br/><br/>
sed -i &#39;s/bind 127.0.0.1/bind 127.0.0.1 172.16.1.5 /g&#39; /etc/redis/6379.conf<br/>
/etc/init.d/redis start<br/>
查看端口是否启动成功：<br/>
[root@lb01 ~]# netstat -lntup|grep redis<br/>
tcp        0      0 127.0.0.1:6379              0.0.0.0:*                   LISTEN      58534/redis-server<br/>
测试：<br/>
[root@lb01 ~]# redis-cli <br/>
127.0.0.1:6379&gt; set key1 hellword<br/>
OK<br/>
127.0.0.1:6379&gt; get key1<br/>
&quot;hellword&quot;<br/>
127.0.0.1:6379&gt; quit<br/>
查看帮助：<br/>
redis-cli --help<br/>
安装redis php客户端<br/>
下载地址：<br/>
wget <a href="http://pecl.php.net/get/redis-2.2.3.tgz">http://pecl.php.net/get/redis-2.2.3.tgz</a><br/>
添加模块<br/>
tar zxf redis-2.2.3.tgz<br/>
cd redis-2.2.3<br/>
/application/php/bin/phpize<br/>
./configure --with-php-config=/application/php/bin/php-config<br/>
make &amp;&amp; make install<br/>
修改配置文件并重启<br/>
echo &quot;extension = redis.so&quot; &gt;&gt;/application/php/lib/php.ini<br/>
killall php-fpm<br/>
/application/php/sbin/php-fpm<br/>
wordpress实现redis数据库缓存<br/>
需要一个客户端开发包以便PHP可以连接到redis服务端 ，这里推荐predis. 加入WordPress的根目录，执行下面<br/>
cd /application/nginx/html/blog wget <a href="http://uploads.staticjw.com/ji/jim/predis.php">http://uploads.staticjw.com/ji/jim/predis.php</a>  chown nginx.nginx predis.php<br/>
前端缓存的PHP脚本，加入WordPress的根目录，执行下面<br/>
wget <a href="https://gist.githubusercontent.com/JimWestergren/3053250/raw/d9e279e31cbee4a1520f59108a4418ae396b2dde/index-with-redis.php">https://gist.githubusercontent.com/JimWestergren/3053250/raw/d9e279e31cbee4a1520f59108a4418ae396b2dde/index-with-redis.php</a>  chown nginx.nginx index-with-redis.php<br/>
根据自己需求修改index-with-redis.php，修改如下：<br/>
\(cf = 0;                // set to 1 if you are using cloudflare  \)debug = 1;              // set to 1 if you wish to see execution time and cache actions  $display_powered_by_redis = 0; // set to 1 if you want to display a powered by redis message with execution time, see below<br/>
替换index.php<br/>
 mv index.php index.php.bak   mv index-with-redis.php index.php<br/>
修改predis文件信息<br/>
sed -i &#39;s/127.0.0.1/172.16.1.5/g&#39; predis.php<br/>
[root@web02 blog]# grep 172.16.1.5 predis.php <br/>
    const DEFAULT_HOST = &#39;172.16.1.5&#39;;<br/>
打开网页测试：<br/>
在redis服务器执行：<br/>
[root@lb01 ~]# redis-cli -h 172.16.1.5<br/>
172.16.1.5:6379&gt; keys *<br/>
1) &quot;count&quot;<br/>
2) &quot;key1&quot;<br/>
3) &quot;feaeb784f8a27e2af7166667a5f084fb&quot;<br/>
[root@lb01 tmp]# tail -5 /tmp/appendonly.aof<br/><br/>
<script type='text/javascript' src='http://blog.etiantian.org/wp-content/themes/twentysixteen/js/functions.js?ver=20160816'></script><br/>
<script type='text/javascript' src='http://blog.etiantian.org/wp-includes/js/wp-embed.min.js?ver=4.8.1'></script><br/>
</body><br/>
</html><br/>
redis实现session共享<br/>
修改php的配置文件php.ini<br/>
session.save_handler = redis<br/>
session.save_path = &quot;tcp://172.16.1.5:6379&quot;<br/>
重启php即可<br/>
redis的主从复制<br/>
Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下：</p>

<p>从服务器连接主服务器，发送SYNC命令；<br/>
 主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；<br/>
 主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；<br/>
 从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；<br/>
 主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令； <br/>
从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；</p>

<p>Redis增量复制是指Slave初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。  增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。</p>

<p>vim /etc/redis/6379.conf</p>

<p>logfile &quot;/var/log/redis_6379.log&quot;<br/>
dbfilename dump_6379.rdb<br/>
appendfilename &quot;appendonly_6379.aof&quot;</p>

<p>/etc/init.d/redis stop<br/>
/etc/init.d/redis start<br/>
[root@lb01 tmp]# ls /tmp<br/>
appendonly_6379.aof  appendonly.aof  dump.rdb<br/>
拷贝配置文件并修改<br/>
cd /etc/redis/<br/>
cp 6379.conf 6380.conf<br/>
sed -i &#39;s/6379/6380/g&#39; 6380.conf<br/>
diff 6379.conf 6380.conf </p>

<p>/usr/local/bin/redis-server 6380.conf </p>

<p>[root@lb01 redis]# ps aux |grep redis <br/>
root      59357  0.1  0.7 133544  7524 ?        Ssl  11:42   0:01 /usr/local/bin/redis-server 127.0.0.1:6379<br/><br/>
root      59379  0.0  0.7 133544  7520 ?        Ssl  11:59   0:00 /usr/local/bin/redis-server 127.0.0.1:6380</p>

<p>[root@lb01 redis]# ls /tmp<br/>
appendonly_6379.aof  appendonly_6380.aof  appendonly.aof  dump.rdb<br/>
redis-cli -p 6380<br/>
开启主从复制功能<br/>
127.0.0.1:6380&gt; SLAVEOF 172.16.1.5 6379<br/>
OK<br/>
127.0.0.1:6380&gt; info<br/>
......</p>

<h1 id="toc_0">Replication</h1>

<p>role:slave<br/>
master_host:172.16.1.5<br/>
master_port:6379<br/>
master_link_status:up<br/>
master_last_io_seconds_ago:3<br/>
......<br/>
查看主机状态<br/>
172.16.1.5:6379&gt; info<br/>
......</p>

<h1 id="toc_1">Replication</h1>

<p>role:master<br/>
connected_slaves:1<br/>
slave0:ip=127.0.0.1,port=6380,state=online,offset=169,lag=1<br/>
master_repl_offset:169<br/>
......<br/>
测试主从复制功能<br/>
主库写入<br/>
172.16.1.5:6379&gt; set key test<br/>
OK<br/>
从库查询<br/>
127.0.0.1:6380&gt; keys *<br/>
1) &quot;count&quot;<br/>
2) &quot;key&quot;<br/>
redis cluster集群<br/>
redis本身是单实例单进程的<br/>
参考文档<br/>
<a href="http://www.cnblogs.com/wuxl360/p/5920330.html">http://www.cnblogs.com/wuxl360/p/5920330.html</a> </p>

<p>redis管理工具<br/>
cd /application/nginx/html/blog<br/>
git clone <a href="https://github.com/ErikDubbelboer/phpRedisAdmin.git">https://github.com/ErikDubbelboer/phpRedisAdmin.git</a> <br/>
cd phpRedisAdmin <br/>
git clone <a href="https://github.com/nrk/predis.git">https://github.com/nrk/predis.git</a> vendor<br/>
更改配置文件添加多实例<br/>
/application/nginx/html/blog/phpRedisAdmin/includes<br/>
vim config.sample.inc.php<br/>
......<br/>
$config = array(<br/>
  &#39;servers&#39; =&gt; array(<br/>
    array(<br/>
      &#39;name&#39;   =&gt; &#39;6379&#39;, // Optional name.<br/>
      &#39;host&#39;   =&gt; &#39;172.16.1.5&#39;,<br/>
      &#39;port&#39;   =&gt; 6379,<br/>
      &#39;filter&#39; =&gt; &#39;*&#39;,<br/>
      &#39;scheme&#39; =&gt; &#39;tcp&#39;,<br/>
      &#39;path&#39;   =&gt; &#39;&#39;<br/>
    ),<br/>
    array(<br/>
      &#39;name&#39; =&gt; &#39;6380&#39;,<br/>
      &#39;host&#39; =&gt; &#39;172.16.1.5&#39;,<br/>
      &#39;port&#39; =&gt; 6380<br/>
    ),<br/>
......<br/>
浏览器输入<a href="http://blog.etiantian.org/phpRedisAdmin/%E5%8D%B3%E5%8F%AF%E8%AE%BF%E9%97%AE">http://blog.etiantian.org/phpRedisAdmin/即可访问</a></p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-12T14:36:16+08:00" itemprop="datePublished">2017/9/12</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051981760993.html" itemprop="url">
		Linux下获取公网IP地址的方法</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>curl 纯文本格式输出:<br/>
推荐使用</p>

<pre><code>curl ipinfo.io/ip
</code></pre>

<p>备选</p>

<pre><code>curl ipinfo.io
curl ifconfig.me
curl icanhazip.com
curl ifconfig.me
curl curlmyip.com
curl ip.appspot.com
curl ipecho.net/plain
curl www.trackip.net/i
curl http://members.3322.org/dyndns/getip 
</code></pre></li>
<li><p>curl JSON格式输出:</p>

<pre><code>curl ipinfo.io/json
curl ifconfig.me/all.json
curl www.trackip.net/ip?json  #(有点丑陋)
</code></pre></li>
<li><p>curl XML格式输出:</p>

<pre><code>curl ifconfig.me/all.xml
</code></pre></li>
<li><p>curl 得到所有IP细节 （挖掘机）</p>

<pre><code>curl ifconfig.me/all
</code></pre></li>
<li><p>使用 DYDNS （当你使用 DYDNS 服务时有用）</p>

<pre><code>curl -s &#39;http://checkip.dyndns.org&#39; | sed &#39;s/.*Current IP Address: \([0-9\.]*\).*/\1/g&#39;
curl -s http://checkip.dyndns.org/ | grep -o &quot;[[:digit:].]\+&quot;
</code></pre></li>
<li><p>使用 Wget 代替 Curl</p>

<pre><code>wget http://ipecho.net/plain -O - -q ; echo
wget http://observebox.com/ip -O - -q ; echo
</code></pre></li>
<li><p>使用 host 和 dig 命令</p>

<blockquote>
<p>如果有的话，你也可以直接使用 host 和 dig 命令。</p>
</blockquote>

<pre><code>host -t a dartsclink.com | sed &#39;s/.*has address //&#39;
dig +short myip.opendns.com @resolver1.opendns.com
</code></pre></li>
<li><p>bash 脚本示例:</p>

<pre><code>#!/bin/bash
PUBLIC_IP=`wget http://ipecho.net/plain -O - -q ; echo`
echo $PUBLIC_IP
</code></pre></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-12T00:36:36+08:00" itemprop="datePublished">2017/9/12</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051477961930.html" itemprop="url">
		卅一、Keepalived部署</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>VRRP协议原理 </p>

<ol>
<li>VRRP协议，全称Virtual Router Redundancy Protocol，中文名为虚拟路由冗余协议，VRRP的出现是为了解决静态路由的单点故障。</li>
<li>VRRP是用过IP多播的方式（默认多播地址（224.0.0.18））实现高可用对之间通信的。</li>
<li><p>工作时主节点发包，备节点接包，当备节点接收不到主节点发的数据包的时候，就启动接管程序接管主节点的资源。备节点可以有多个，通过优先级竞选，但一般Keepalived系统运维工作中都是一对。</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/77060938.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/93570182.jpg" alt=""/></p></li>
</ol></li>
<li><p>Keepalived高可用软件功能<br/>
参考博文: <a href="http://www.cnblogs.com/pricks/p/3822232.html">http://www.cnblogs.com/pricks/p/3822232.html</a> </p>

<ol>
<li><p>管理LVS负载均衡软件<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/63547204.jpg" alt=""/></p></li>
<li><p>实现对LVS集群节点健康检查功能--healthcheck</p>

<p>keepalived可能通过在自身的keepalived.conf文件里配置LVS节点IP和相关的参数实现对LVS的直接管理,除此之外,当LVS集群中的一个甚至几个节点服务器同时发生故障无法提供服务时,keepalived服务会自启动将失效的节点服务器从LVS的正常转发队列中清除出去，并将请求调度到正常节点的服务器上，从而保证最终用户的访问不受影响，当故障的节点服务器被修复后,keepalived服务会自动把它们加入到正常的转发队列中,对客户提供服务.</p></li>
<li><p>作为系统网络服务的高可用功能--failover</p>

<p>keepalived可以实现任意两台主机之间,例如Master和Backup主机之间的故障转移和自动切换,这个主机可以是普通的不能停机的业务服务器,也可以是LVS负载均衡,nginx反向代理这样的服务器.</p>

<p>keepalived高可用功能实现的简单原理为:两台主机同时安装好keepalived软件并启动服务,开始正常工作时,由角色Master的主机获得所有资源并对用户提供用户,角色为Backup的主机将自动接管Master主机的所有工作,包括接管VIP资源及相应资源服务,而当master的主机故障修复后,又会自动接管回它原来的处理的工作,角色为backup的主机则同时释放master主机失效时它按管的工作,此时,两台主机将恢复到最初启动时各自的原始角色及工作状态.</p></li>
</ol></li>
<li><p>简单实现web集群的高可用(单实例VIP漂移)</p>

<ol>
<li>安装依赖包, 部署nginx</li>
<li><p>安装并启动Keepalived<br/>
<code><br/>
yum install -y keepalived<br/>
rpm -qa keepalived<br/>
rpm -ql keepalived<br/>
/etc/init.d/keepalived start<br/>
ip a #查看主备情况<br/>
</code></p></li>
<li><p>Keepalived配置文件修改: /etc/keepalived/keepalived.conf</p>

<p>配置文件的组成部分<br/>
· GLOBAL CONFIGURATION     # 全局定义（默认配置文件的01-13行）<br/>
· VRRPD CONFIGURATION      # 虚拟ip的配置（默认配置文件15-30行）<br/>
· LVS CONFIGURATION        # 配置与管理lvs</p>

<ol>
<li><p>lb01 Keepalived配置</p>

<pre><code>global_defs {
   router_id LVS_01
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
     10.0.0.3/24  dev eth0 label eth0:1
    }
}
</code></pre></li>
<li><p>lb02 Keepalived配置</p>

<pre><code>global_defs {
   router_id LVS_02           # 虚拟路由标识, 局域网内要唯一
}

vrrp_instance VI_1 {          # vrrp实例名
    state BACKUP               # 主备角色
    interface eth0             # 虚拟ip所在的网卡位置
    virtual_router_id 51      # 虚拟路由组标识, 同一个负载集群的必须相同
    priority 100               # 默认是100, 数值越大优先级越高
    advert_int 1               # 主备通讯时间间隔(秒)
    authentication {
        auth_type PASS         # 主备通讯加密类型
        auth_pass 1111         # 主备通讯认证密码
    }
    virtual_ipaddress {
     10.0.0.3/24  dev eth0 label eth0:1   # 虚拟ip配置
    }
}
</code></pre></li>
</ol></li>
<li><p>统一lb01/lb02的nginx配置文件nginx.conf </p>

<pre><code>worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
    upstream server_pools {
        server 10.0.0.7 ;
        server 10.0.0.8 ;
        server 10.0.0.9 ;
    }
    server {
        listen 80;
        server_name bbs.etiantian.org ;
        location / {
        proxy_pass http://server_pools ;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        }
        access_log  logs/access_www.log   main;
   }
     server {
        listen 80;
        server_name www.etiantian.org ;
        location / {
        proxy_pass http://server_pools ;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        }
       access_log  logs/access_blog.log  main;
   }
}
</code></pre></li>
<li><p>重启两个服务</p>

<pre><code>nginx -t
nginx -s reload
/etc/init.d/keepalived reload
</code></pre></li>
<li><p>修改Windows hosts文件</p>

<pre><code>10.0.0.3  www.etiantian.org  blog.etiantian.org bbs.etiantian.org
</code></pre></li>
<li><p>浏览器测试+Wireshark抓包测试</p>

<h5 id="toc_0">测试实验操作</h5>

<ol>
<li>抓取vrrp协议包检查看看</li>
<li>关闭主，测试主备切换</li>
<li>重新开启主，测试主的抢占功能</li>
</ol>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/59051863.jpg" alt=""/></p>

<h5 id="toc_1">lb01Keepalived停掉:</h5>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/43066305.jpg" alt=""/></p></li>
</ol></li>
<li><p>配置文件详解<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/68684154.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/8764913.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/2188686.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/75353371.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/44072065.jpg" alt=""/></p></li>
<li><p>主从切换后执行的脚本</p>

<p>notify_master /path/to/to_master.sh：表示当切换到master状态时，要执行的脚本<br/>
notify_backup /path/to/to_backup.sh：表示当切换到backup状态时，要执行的脚本<br/>
注意点: VIP漂移后, 获得VIP的主机对to_master.sh的执行会<mark>优先于</mark>另一主机执行to_backup.sh</p></li>
<li><p>Keepalived重点故障: 脑裂</p>

<p>指的是MASTER和BACKUP都获得了vip, 这种情况发生在二者的通讯发生异常中断时, BACKUP没收到MASTER的组播信号, 主动取代了MASTER</p>

<p><mark>注意</mark>: 使用关网卡这种方法模拟宕机测试VIP漂移时, 也会出现脑裂, 建议使用/etc/init.d/keepalived stop模拟宕机</p>

<ol>
<li><p>原因排查</p>

<p>一般来说,裂脑的问题,有以下几种原因:<br/>
高可用服务器对之间的心跳线链接发生故障,导致无法正常通信<br/>
心跳线坏了(包括 断了,老化)<br/>
网卡及相关驱动坏了,IP 配置及冲突问题(网卡直接)<br/>
心跳线连接的设备故障(网卡及交换机)<br/>
仲裁的机器出问题(采用仲裁的方案)<br/>
高可用服务器上开启了iptables防火墙阻挡了心跳消息传输<br/>
高可用服务器上心跳网卡地址等信息配置不正确,导致发送心跳失败.<br/>
其他服务器配置不当等原因,如心跳方式不同,心跳广播冲突,软件Bug等.</p>

<p>排查位置: 1 防火墙 ; 2 网络线路异常<br/>
解决方案: 1两条心跳线 ; 2 脑裂监控报警脚本</p>

<pre><code>vim monitor_keepalived.sh
#!/bin/bash
if [ ip a|grep -c 10.0.0.3 ]
then
  echo &quot;master error&quot;
fi
</code></pre></li>
<li><p>解决方案<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/93722011.jpg" alt=""/></p></li>
</ol></li>
<li><p>实现lb只监听VIP虚拟地址</p>

<ol>
<li><p>统一修改lb01/lb02的nginx监听地址</p>

<pre><code>worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
    upstream server_pools {
        server 10.0.0.7;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
    upstream server_pools {
        server 10.0.0.7;
        server 10.0.0.8;
        server 10.0.0.9;
    }
    server {
        listen 10.0.0.3:80;
        server_name bbs.etiantian.org;
        location / {
        proxy_pass http://server_pools;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        }
        }
        access_log  logs/access_www.log  main;
    }
    server {
        listen 10.0.0.3:80;
        server_name www.etiantian.org;
        location / {
        proxy_pass http://server_pools;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        }
        access_log  logs/access_blog.log  main;
    }
}
</code></pre>

<p><mark>注意点:</mark><br/>
在修改反向代理服务器配置文件监听地址时，多个server都需要配置监听地址，否则仍旧使用默认监听所有</p>

<p>listen <mark>10.0.0.3:</mark>80; 修改后的配置,只监听10.0.0.3这一个VIP<br/>
listen 80; 默认配置, 监听所有网络请求, 监听范围更大, 使监听VIP的限制失效</p></li>
<li><p>配置检测nginx -t</p>

<h5 id="toc_2">lb01</h5>

<pre><code>[root@lb01 ~]# nginx -t
nginx: the configuration file /application/nginx-1.10.3//conf/nginx.conf syntax is ok
nginx: configuration file /application/nginx-1.10.3//conf/nginx.conf test is successful
</code></pre>

<h5 id="toc_3">lb02</h5>

<pre><code>[root@lb02 ~]# nginx -t
nginx: the configuration file /application/nginx-1.10.3//conf/nginx.conf syntax is ok
nginx: [emerg] bind() to 10.0.0.3:80 failed (99: Cannot assign requested address)
nginx: configuration file /application/nginx-1.10.3//conf/nginx.conf test failed
</code></pre>

<ol>
<li><p>实际问题:lb02配置监听10.0.0.3失败</p>

<p>原因: 因为lb01正常运行, 而lb02未获取VIP, 所以无法监听本地不存在的ip地址 <br/>
解决方法：</p>

<pre><code># 修改内核配置文件, 取消本地IP绑定
# 永久生效
echo &#39;net.ipv4.ip_nonlocal_bind = 1&#39; &gt;&gt;/etc/sysctl.conf
sysctl -p #加载sysctl.conf
# 内存临时生效
echo &quot;1&quot; &gt;/proc/sys/net/ipv4/ip_nonlocal_bind
</code></pre></li>
</ol></li>
</ol></li>
<li><p>实现keepalived监控nginx运行状态并及时作出响应</p>

<ol>
<li><p>第一个里程碑-keepalived监控nginx条件</p>

<blockquote>
</blockquote>

<ol>
<li><p>如何得知nginx挂了?</p>

<p>1）端口<br/>
2）进程<br/>
<code>ps -ef |grep nginx |grep -v grep |wc -l</code></p></li>
<li><p>模拟keepalived挂了</p>

<p><code>/etc/init.d/keepalived stop</code></p></li>
</ol></li>
<li><p>第二个里程碑-根据条件-书写脚本</p>

<p>复习知识: shell脚本中的数值判断</p>

<pre><code>#&gt;  -gt    greater than  
#&gt;= -ge    greater equal 
#&lt;  -lt    less than 
#&lt;= -le    less equal 
#== -eq    equal
</code></pre>

<p>统一脚本存放路径</p>

<pre><code>mkdir -p /server/scripts
cd /server/scripts
</code></pre>

<p>编写检查脚本</p>

<pre><code>#!/bin/bash
#name: check_web.sh
#desc: check nginx and kill keepalived 
grep_num=`ps -ef |grep -c [n]ginx`  #grep [n]ginx: 利用正则排除(grep nginx)进程
echo $grep_num
if [ $grep_num -eq 2 ];then
   echo &#39;nginx is running.&#39;
else
   echo &#39;nginx stopped.&#39;
   /etc/init.d/keepalived stop
fi
</code></pre>

<p>注意:如果命名为check_nginx.sh,执行ps -ef |grep -c [n]ginx时, 结果会+1, 因为进程中临时会多出来一个 /bin/bash check_nginx.sh</p></li>
<li><p>第三个里程碑-为脚本添加x权限(不需要修改属主)</p>

<pre><code>chmod +x /server/scripts/check_web.sh #不加X权限会导致脚本不能被成功执行
ls -l /server/scripts/check_web.sh
</code></pre></li>
<li><p>第四个里程碑-测试脚本</p>

<pre><code>nginx -s stop
sh /server/scripts/check_web.sh
</code></pre></li>
<li><p>第五个里程碑-将脚本引入到lb01的keepalived.conf </p>

<pre><code>global_defs {
   router_id LVS_01
}

vrrp_script check_web {                     # 使用一个脚本模块
script &quot;/server/scripts/check_web.sh&quot;      # 脚本路径
interval 2                                    # 脚本执行的时间间隔(秒)
weight 2                                      # 脚本每运行成功一次,priority-2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.0.0.3/24 dev eth0 label eth0:1
    }
   track_script {                              # 引用脚本
         check_web
   }
}
</code></pre></li>
<li><p>第六个里程碑-测试</p>

<pre><code>lb01
nginx
/etc/init.d/keepalived restart
nginx -s stop
ps -ef |grep [k]eep
</code></pre></li>
</ol></li>
<li><p>lb01/02双主配置</p>

<p>实现目标: 将用户请求压力按www与bbs分离, 实现:<br/>
访问www.etiantian.org时, lb01为主,lb02为备<br/>
访问bbs.etiantian.org时, lb02为主,lb01为备<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/78136168.jpg" alt=""/></p>

<ol>
<li><p>lb集群的Keepalived配置<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/461189.jpg" alt=""/></p></li>
<li><p>lb集群的nginx配置</p>

<pre><code>[root@lb01 ~]# cat /application/nginx/conf/nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
    upstream server_pools {
        server 10.0.0.7;
        server 10.0.0.8;
        server 10.0.0.9;
    }
    server {
        listen 10.0.0.4:80;
        server_name bbs.etiantian.org;
        location / {
            proxy_pass http://server_pools;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $remote_addr;
        }
       access_log  logs/access_bbs.log  main;

    }
    server {
        listen 10.0.0.3:80;
        server_name www.etiantian.org;
        location / {
            proxy_pass http://server_pools;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $remote_addr;
        }
       access_log  logs/access_www.log  main;

    }
}
</code></pre></li>
<li><p>web服务器nginx配置</p>

<pre><code>[root@web03 ~]# cat /application/nginx/conf/nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen 80;
        server_name  bbs.etiantian.org;
        location / {
            root   html/bbs;
            index  index.html index.htm;
        }
    }
    server {
        listen 80;
        server_name  www.etiantian.org;
        location / {
            root   html/www;
            index  index.html index.htm;
        }
    }
}
</code></pre></li>
<li><p>修改web服务器主页文件作为测试页面</p>

<pre><code>[root@web01 ~]# cat /application/nginx/html/bbs/index.html
bbs web01
[root@web01 ~]# cat /application/nginx/html/www/index.html
www web01
[root@web02 ~]# cat /application/nginx/html/bbs/index.html
bbs web02
[root@web02 ~]# cat /application/nginx/html/www/index.html
www web02
[root@web03 ~]# cat /application/nginx/html/bbs/index.html
bbs web03
[root@web03 ~]# cat /application/nginx/html/www/index.html
www web03
</code></pre></li>
<li><p>修改Windows hosts文件</p>

<pre><code>10.0.0.3            bbs.etiantian.org
10.0.0.4            www.etiantian.org
</code></pre></li>
<li><p>访问测试</p>

<pre><code>[root@lb01 ~]# curl -H Host:bbs.etiantian.org 10.0.0.3
bbs web02
[root@lb01 ~]# curl -H Host:bbs.etiantian.org 10.0.0.3
bbs web03
[root@lb01 ~]# curl -H Host:bbs.etiantian.org 10.0.0.3
bbs web01
[root@lb01 ~]# curl -H Host:bbs.etiantian.org 10.0.0.4
bbs web03
[root@lb01 ~]# curl -H Host:bbs.etiantian.org 10.0.0.4
bbs web01
[root@lb01 ~]# curl -H Host:bbs.etiantian.org 10.0.0.4
bbs web02
[root@lb02 ~]# curl -H Host:www.etiantian.org 10.0.0.3
www web01
[root@lb02 ~]# curl -H Host:www.etiantian.org 10.0.0.3
www web02
[root@lb02 ~]# curl -H Host:www.etiantian.org 10.0.0.3
www web03
[root@lb02 ~]# curl -H Host:www.etiantian.org 10.0.0.4
www web01
[root@lb02 ~]# curl -H Host:www.etiantian.org 10.0.0.4
www web02
[root@lb02 ~]# curl -H Host:www.etiantian.org 10.0.0.4
www web03
</code></pre></li>
</ol></li>
<li><p>组播地址冲突</p>

<p>如何解决多组Keepalived在同一个局域网中的组播地址相同导致的冲突?<br/>
vrrp_mcast_group4 224.0.0.X (默认值是18)<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/13814683.jpg" alt=""/></p></li>
<li><p>排错</p>

<ol>
<li>DNS是否正确解析---curl测试---检查hosts文件--ping测试</li>
<li>浏览器缓存---隐身无痕模式----Ctrl F5强制刷新,不载入缓存</li>
<li>修改服务配置后没有reload</li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-12T00:32:57+08:00" itemprop="datePublished">2017/9/12</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051475777273.html" itemprop="url">
		三十、Nginx应用--反向代理--负载均衡</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>集群的</p>

<ol>
<li>相同功能的服务器的集合</li>
<li>高可用性能更好--对用户请求的处理能力更强</li>
<li>安全稳定--避免单点故障</li>
</ol>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/6167401.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/92263812.jpg" alt=""/></p></li>
<li><p>集群的实现---反向代理</p>

<ol>
<li><p>反向代理</p>

<p>====指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/91531825.jpg" alt=""/></p></li>
<li><p>负载均衡<br/>
====对访问请求进行调度, 使各个web服务器一起分担压力</p>

<ol>
<li>硬件实现----F5/A10</li>
<li><p>软件实现</p>

<p>Nginx (4/7层) 反向代理+负载均衡<br/>
LVS (4层) 数据转发+负载均衡<br/>
haproxy (4/7层) 反向代理</p></li>
</ol></li>
</ol></li>
<li><p>nginx负载均衡部署<br/>
<a href="http://nginx.org/en/docs/http/load_balancing.html">http://nginx.org/en/docs/http/load_balancing.html</a><br/>
<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass</a><br/>
<a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html">http://nginx.org/en/docs/http/ngx_http_upstream_module.html</a></p>

<ol>
<li><p>准备工作</p>

<p>lb01 lb02: 安装Nginx<br/>
准备3台web服务器: web01 web02 web03</p></li>
<li><p>lb01 lb02 安装部署Nginx</p></li>
<li><p>web01 web02 修改nginx.conf</p>

<pre><code>worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
    server {
        listen       80;
        server_name  bbs.etiantian.org;
        location / {
            root   html/bbs;
            index  index.html index.htm;
        }
          access_log  logs/access_bbs.log  main;
    }
    server {
        listen       80;
        server_name  www.etiantian.org;
        location / {
            root   html/www;
            index  index.html index.htm;
        }
        access_log  logs/access_www.log  main;
    }
}
</code></pre></li>
<li><p>lb01修改nginx.conf</p>

<pre><code>[root@lb01 ~]# vim /application/nginx/conf/nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # upstream模块
    upstream server_pools {
      server 10.0.0.7:80 weight=3;
      server 10.0.0.8:80 weight=2;
    # server 10.0.0.9:80 weight=2 down;
    # server 10.0.0.9:80 weight=2 backup;
    }
    server {
        listen       80;
        server_name  bbs.etiantian.org;
        location / {
    # proxypass模块
            proxy_pass http://server_pools;
        }
    }
    ```
</code></pre></li>
</ol>

<ol>
<li><p>重载所有Linux服务器中nginx服务</p>

<pre><code>nginx -t
nginx -s reload
</code></pre></li>
<li><p>修改/etc/hosts文件</p>

<pre><code>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
172.16.1.5      lb01
172.16.1.6      lb02
172.16.1.7      web02 www.etiantian.org blog.etiantian.org bbs.etiantian.org etiantian.org
172.16.1.8      web01 www.etiantian.org blog.etiantian.org bbs.etiantian.org etiantian.org
172.16.1.9      web03
172.16.1.51     db01 db01.etiantian.org
172.16.1.31     nfs01
172.16.1.41     backup
172.16.1.61     m01
</code></pre></li>
<li><p>修改Windows的hosts文件</p>

<pre><code>10.0.0.5      status.etiantian.org etiantian.org www.etiantian.org bbs.etiantian.org blog.etiantian.org
</code></pre></li>
<li><p>负载均衡测试</p>

<pre><code>[root@lb02 nginx-1.10.3]# curl 10.0.0.5/oldboy.html
bbs web01
[root@lb02 nginx-1.10.3]# curl 10.0.0.5/oldboy.html
bbs web02
[root@lb02 nginx-1.10.3]# curl 10.0.0.5/oldboy.html
bbs web01
[root@lb02 nginx-1.10.3]# curl 10.0.0.5/oldboy.html
bbs web02
[root@lb02 nginx-1.10.3]# curl 10.0.0.5/oldboy.html
bbs web02
[root@lb02 nginx-1.10.3]# curl 10.0.0.5/oldboy.html
bbs web01
</code></pre></li>
</ol></li>
<li><p>upstream负载均衡模块ngx_http_upstream_module</p>

<ol>
<li><p>模块参数<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/61658316.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/51578229.jpg" alt=""/></p></li>
<li><p>调度算法</p>

<ol>
<li><p>rr轮询调度算法(round robin)--默认算法</p>

<p>将用户访问请求周期性轮流地平均分配给池中的性能相近的web服务器</p></li>
<li><p>wrr权重调度算法</p>

<p>将用户访问请求按权重值分配给池中的不同性能的web服务器</p></li>
<li><p>least_conn 最小连接数优先算法</p>

<p>将用户访问请求按各个服务器的实时负载压力(连接数)来分配, 优先分配给连接数最小的.</p></li>
<li><p>IP_hash算法</p>

<p>将用户访问请求按照不同的源IP计算出不同的hash值并分别对应到各个web服务器上,再将hash值相同的请求分配给同一台web服务器</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/70294491.jpg" alt=""/></p>

<p>可能导致的问题: 一个公网IP多个子网用户的情况下,访问请求会集中在一台web服务器上,导致负载不均</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/12213651.jpg" alt=""/></p>

<p>解决方案: memcached/redis 缓存服务器 (缓存用户浏览数据和会话信息)</p></li>
<li><p>补充:fair 动态调度算法</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/33408704.jpg" alt=""/></p></li>
</ol></li>
</ol></li>
<li><p>proxy反向代理模块ngx_http_proxy_module</p>

<ol>
<li><p>保留用户请求的主机名</p>

<p>核心代码: <mark>proxy_set_header Host $host;</mark><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/92469971.jpg" alt=""/></p>

<p>客户端访问（host:<a href="http://www.etiantian.org">www.etiantian.org</a> ）---&gt;代理端（不关心客户端的host信息，直接用IP访问节点）---&gt;节点收到IP地址的请求（将第一个server主机信息进行回复）</p>

<p>proxy_set_header（host:<a href="http://www.etiantian.org">www.etiantian.org</a> ）---&gt;代理端（关心客户端的host信息，利用客户端请求host访问节点）---&gt;节点收到host的请求（将相应主机信息进行响应）</p>

<p>proxy反向代理模块中的proxy_set_header能保留用户的请求报文头部信息(即保留用户请求的URL, 使负载池中IP指向设置失效)所以www.etiantian.org/oldboy.html会被保留,web服务器就能正确响应返回www.etiantian.org而不是默认第一个bbs.etiantian.org</p>

<p>说明:curl -H Host: 将自定义的请求头信息传递给服务器</p>

<pre><code>[root@lb01 conf]# curl www.etiantian.org/oldboy.html
www web02
[root@lb01 conf]# curl 10.0.0.8/oldboy.html
bbs web01
[root@lb01 conf]# curl -H Host:www.etiantian.org 10.0.0.8/oldboy.html 
www web01
</code></pre></li>
<li><p>保留用户的真实IP</p>

<p>核心代码: <mark>proxy_set_header X-Forwarded-For $remote_addr;</mark></p>

<p>负载均衡配置</p>

<pre><code>[root@lb01 ~]# cat /application/nginx/conf/nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    upstream server_pools {
    #ip_hash;
    server 10.0.0.7:80 ;
    server 10.0.0.8:80 ;
    } 
    server {
        listen       80;
        server_name  bbs.etiantian.org;
        location / {
          proxy_pass http://server_pools;
          proxy_set_header Host $host; 
          proxy_set_header X-Forwarded-For $remote_addr; 
        }
    }
    server {
        listen       80;
        server_name  www.etiantian.org ;
        location / {
          proxy_pass http://server_pools ;
          proxy_set_header Host $host;         
          proxy_set_header X-Forwarded-For $remote_addr; 
        }
    }
}
</code></pre>

<p>web服务器配置</p>

<pre><code>[root@web02 ~]# cat /application/nginx/conf/nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
    server {
        listen       80;
        server_name  bbs.etiantian.org 

;
        location / {
            root   html/bbs;
            index  index.html index.htm;
        }
  access_log  logs/access_bbs.log  main;
    }
    server {
        listen       80;
        server_name  www.etiantian.org 

;
        location / {
            root   html/www;
            index  index.html index.htm;
        }
   access_log  logs/access_www.log   main;
    }
}
</code></pre>

<p>查看web服务器上的日志</p>

<pre><code>10.0.0.5 - - [13/Aug/2017:22:25:07 +0800] &quot;GET /oldboy.html HTTP/1.0&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36&quot; &quot;10.0.0.1&quot;
</code></pre></li>
</ol></li>
<li><p>区别cookie和session</p>

<p>都可以存放用户的访问信息, 但是存放位置和功能不同</p>

<ol>
<li><p>cookie 客户端--浏览器</p>

<p>1）变量名字和变量的内容<br/>
2）由开发人员制定<br/>
3）每个网站（域名）对应着 cookie是相同 </p></li>
<li><p>session会话服务端<br/>
存放用户登录信息 ----打包/加密----不用重新登录</p></li>
</ol></li>
<li><p>负载均衡部署实战</p>

<ol>
<li><p>反向代理的三种应用场景</p>

<p>01：根据URL中的目录地址实现代理转发<br/>
02：根据客户端的设备（user_agent）转发实践<br/>
03：根据文件扩展名实现代理转发</p></li>
<li><p>动静分离--根据用户请求的uri类型(动态/静态)分配给不同集群<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/30387209.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-13/58402715.jpg" alt=""/></p>

<ol>
<li><p>环境模拟</p>

<blockquote>
<p>web01</p>
</blockquote>

<pre><code>mkdir /application/nginx/html/www/upload/
cd /application/nginx/html/www/upload/
echo &quot;upload_info web01&quot; &gt;oldgirl.html
</code></pre>

<blockquote>
<p>web02</p>
</blockquote>

<pre><code>mkdir /application/nginx/html/www/static/
cd /application/nginx/html/www/static/
echo &quot;static_info web02&quot; &gt;oldgirl.html
</code></pre>

<blockquote>
<p>web03</p>
</blockquote>

<pre><code>cd /application/nginx/html/www/
echo &quot;default_info web03&quot; &gt;oldgirl.html
</code></pre></li>
<li><p>主配置修改</p>

<blockquote>
<p>lb01 nginx.conf</p>
</blockquote>

<pre><code>worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
upstream upload_pools {
  server 10.0.0.8:80;
}

upstream static_pools {
  server 10.0.0.7:80;
}

upstream default_pools {
  server 10.0.0.9:80;
}
  server {
    listen 80;
server_name www.etiantian.org;

    location /static/ { 
    proxy_pass http://static_pools;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

    location /upload/ { 
    proxy_pass http://upload_pools;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
}

    location / { 
    proxy_pass http://default_pools;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    }
    access_log  logs/access_www.log  main;
  }
}
</code></pre>

<blockquote>
<p>web123 nginx.conf</p>
</blockquote>

<pre><code>```
</code></pre>

<p>worker_processes  1;<br/>
events {<br/>
    worker_connections  1024;<br/>
}<br/>
http {<br/>
    include       mime.types;<br/>
    default_type  application/octet-stream;<br/>
    sendfile        on;<br/>
    keepalive_timeout  65;<br/>
    server {<br/>
        listen       80;<br/>
        server_name  bbs.etiantian.org;<br/>
        location / {<br/>
            root   html/bbs;<br/>
            index  index.html index.htm;<br/>
        }<br/>
    }<br/>
    server {<br/>
        listen       80;<br/>
        server_name  <a href="http://www.etiantian.org">www.etiantian.org</a>;<br/>
        location / {<br/>
            root   html/www;<br/>
            index  index.html index.htm;<br/>
        }<br/>
    }<br/>
}<br/>
```</p></li>
</ol>

<ol>
<li><p>所有主机: 重启nginx服务</p>

<pre><code>nginx -t
nginx -s stop
nginx
</code></pre></li>
<li><p>浏览器测试</p>

<p>浏览器分别访问<br/>
<a href="http://www.etiantian.org/oldgirl.html">http://www.etiantian.org/oldgirl.html</a><br/>
<a href="http://www.etiantian.org/static/oldgirl.html">http://www.etiantian.org/static/oldgirl.html</a><br/>
<a href="http://www.etiantian.org/upload/oldgirl.html">http://www.etiantian.org/upload/oldgirl.html</a></p></li>
</ol></li>
<li><p>基于用户使用的客户端类型($http_user_agent)分配访问请求</p>

<ol>
<li><p>环境模拟</p>

<blockquote>
<p>web01接受chrome浏览器访问请求</p>
</blockquote>

<pre><code>echo &quot;Chrome web01&quot; &gt; /application/nginx/html/www/liulanqi.html
</code></pre>

<blockquote>
<p>web02 接受IE浏览器访问请求</p>
</blockquote>

<pre><code>echo &quot;MSIE web02&quot; &gt; /application/nginx/html/www/liulanqi.html
</code></pre>

<blockquote>
<p>web03 接受其他浏览器访问请求</p>
</blockquote>

<pre><code>echo &quot;Default web03&quot; &gt; /application/nginx/html/www/liulanqi.html
</code></pre></li>
</ol></li>
<li><p>lb01主配置文件修改</p>

<pre><code>[root@lb01 conf]# cat nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
upstream upload_pools {
  server 10.0.0.8:80;
}

upstream static_pools {
  server 10.0.0.7:80;
}

upstream default_pools {
  server 10.0.0.9:80;
}

    server {
        listen 80;
        server_name www.etiantian.org;
        location / {
         if ($http_user_agent ~* &quot;MSIE&quot;)
          {
            proxy_pass http://static_pools;
          }
         if ($http_user_agent ~* &quot;Chrome&quot;)
          {
            proxy_pass http://upload_pools;
          }
            proxy_pass http://default_pools;
               }
         proxy_set_header HOST $host;
         proxy_set_header X-Forwarded-For $remote_addr;
         access_log  logs/access_www.log  main;
   }
}
</code></pre></li>
<li><p>使用不同浏览器测试</p>

<p>chrome浏览器模拟手机访问测试页面: <a href="http://www.etiantian.org/liulanqi.html">http://www.etiantian.org/liulanqi.html</a></p></li>
</ol></li>
<li><p>反向代理访问异常排错思路</p>

<ol>
<li>确认访问代理服务器网络是否正确       客户端---代理服务器是否正常   ping telnet</li>
<li>代理服务器访问节点网络链路是否正常   代理服务器---web节点         ping telnet</li>
<li>客户端直接访问web节点，确认是否节点访问有异常</li>
<li>负载均衡反向代理服务器配置有问题</li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-12T00:18:15+08:00" itemprop="datePublished">2017/9/12</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051466954965.html" itemprop="url">
		廿九、数据库迁移--NFS迁移</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p><strong>迁移目的</strong></p>

<blockquote>
<p>将部署在web01中的数据库完整迁移到db01, 使数据库服务器和web服务器各司其职<br/>
将web01上www用户上传的文件统一存放到nfs01上</p>
</blockquote>

<p>========MySQL数据库迁移========</p>

<ol>
<li><p>db01的准备工作</p>

<ol>
<li><p>添加系统虚拟用户mysql</p>

<pre><code>useradd -s /sbin/nologin  -M mysql
</code></pre></li>
<li><p>安装MySQL</p>

<pre><code>cd /server/tools/
tar xf mysql-5.6.34-linux-glibc2.5-x86_64.tar.gz
mv /server/tools/mysql-5.6.34-linux-glibc2.5-x86_64 /application/mysql-5.6.34
ln -s /application/mysql-5.6.34/ /application/mysql
chown -R mysql.mysql /application/mysql/data/
/application/mysql/scripts/mysql_install_db --basedir=/application/mysql --datadir=/application/mysql/data --user=mysql
cp /application/mysql/support-files/mysql.server  /etc/init.d/mysqld
chmod +x /etc/init.d/mysqld
chkconfig --add mysqld
chkconfig mysqld on
sed -i &#39;s#/usr/local/mysql#/application/mysql#g&#39; /application/mysql/bin/mysqld_safe /etc/init.d/mysqld
\cp /application/mysql/support-files/my-default.cnf /etc/my.cnf
/etc/init.d/mysqld start
echo &#39;export PATH=/application/mysql/bin:$PATH&#39; &gt;&gt;/etc/profile
source /etc/profile
which mysql
/application/mysql/bin/mysqladmin -u root password &#39;oldboy123&#39;
mysql -uroot -poldboy123
quit
</code></pre></li>
</ol></li>
<li><p>web01上进行数据库备份并推送到db01</p>

<ol>
<li><p>mysqldump命令</p>

<pre><code>Dumping structure and contents of MySQL databases and tables.
Usage: mysqldump [OPTIONS] database [tables]
OR     mysqldump [OPTIONS] --databases [OPTIONS] DB1 [DB2 DB3...]
OR     mysqldump [OPTIONS] --all-databases [OPTIONS]
-A --all-databases 备份所有数据库
</code></pre>

<pre><code>mysqldump -uroot -p -A|gzip &gt;/tmp/alldb-bak.gz #不使用明文密码的安全操作
ll /tmp/alldb-bak.gz
</code></pre></li>
<li><p>scp推送到db01</p>

<pre><code>scp /tmp/alldb-bak.gz db01:/tmp        #需要hosts文件中有对应的ip解析
</code></pre></li>
</ol></li>
<li><p>db01上解压并使用root账号导入备份</p>

<pre><code>gzip -d /tmp/alldb-bak.gz
mysql -uroot -p &lt;/tmp/alldb-bak         #不使用明文密码的安全操作
mysql -uroot -poldboy123                 #使用管理账号登录
flush privileges;                 #刷新账号信息使之生效
quit
mysql -uwordpress -p                     # WordPress测试账号登录是否成功(迁移成功)
</code></pre></li>
<li><p>修改web01配合文件</p>

<pre><code>grep &#39;localhost&#39; /application/nginx/html/blog/wp-config.php
define(&#39;DB_HOST&#39;, &#39;localhost&#39;);
sed -i &#39;s#localhost#172.16.1.51#g&#39; /application/nginx/html/blog/wp-config.php /application/nginx/html/blog/test_mysql.php
grep &#39;172&#39; /application/nginx/html/blog/wp-config.php
define(&#39;DB_HOST&#39;, &#39;172.16.1.51&#39;);
</code></pre></li>
<li><p>停掉web01数据库并设置开机不启动</p>

<pre><code>/etc/init.d/mysqld stop
chkconfig  mysqld off
</code></pre></li>
<li><p>修改web01的php与db01的mysql连通性测试文件</p>

<pre><code>vim /application/nginx/html/blog/test_mysql.php
</code></pre>

<pre><code>&lt;?php
     //$link_id=mysql_connect(&#39;主机名&#39;,&#39;用户&#39;,&#39;密码&#39;);
     //mysql -u用户 -p密码 -h 主机
     $link_id=mysql_connect(&#39;172.16.1.51&#39;,&#39;wordpress&#39;,&#39;123456&#39;) or mysql_error();
     if($link_id){
         echo &quot;mysql successful by oldboy !\n&quot;;
      }else{
         echo mysql_error();
       }
?&gt;
</code></pre></li>
<li><p>排错</p>

<ol>
<li><p>test_mysql.php测试时账号认证错误</p>

<blockquote>
<p>db01中缺少了少了同网段的认证信息</p>
</blockquote>

<pre><code>mysql -uroot -poldboy123
grant all on wordpress.* to &#39;wordpress&#39;@&#39;localhost&#39; identified by &#39;123456&#39;;
grant all on wordpress.* to &#39;wordpress&#39;@&#39;172.16.1.0/255.255.255.0&#39; identified by &#39;123456&#39;;
flush privileges;
</code></pre></li>
</ol>

<p>========NFS迁移========</p>

<blockquote>
<p>如何找到用户上传的文件路径?</p>

<ol>
<li><p>复制blog中的图片地址</p>

<p><a href="http://blog.etiantian.org/wp-content/uploads/2017/08/nginx-320x320-300x300.jpg">http://blog.etiantian.org/wp-content/uploads/2017/08/nginx-320x320-300x300.jpg</a></p></li>
<li><p>找到blog目录下最新的文件</p>

<pre><code>find /application/nginx/html/blog/ -mmin -10
</code></pre></li>
</ol>
</blockquote></li>
<li><p>在nfs01上确认nfs服务是否启动</p>

<pre><code>/etc/init.d/nfs status
/etc/init.d/rpcbind stop
/etc/init.d/nfs stop
</code></pre>

<blockquote>
<p>启动顺序</p>
</blockquote>

<pre><code>/etc/init.d/rpcbind start
/etc/init.d/nfs start
/etc/init.d/nfs status
</code></pre></li>
<li><p>nfs01准备共享目录</p>

<pre><code>mkdir /blog-data
chown nfsnobody. nfsnobody /blog-data/
echo &#39;#blog-data 20170811&#39; &gt;&gt;/etc/exports
echo &#39;/blog-data/ 172.16.1.0/24(rw,sync,all_squash)&#39; &gt;&gt;/etc/exports
/etc/init.d/nfs reload             # == exportsfs -rv
showmount -e nfs01
</code></pre></li>
<li><p>web01挂载前的准备(需要关闭网站,不让用户创建新博客)</p>

<pre><code>yum install -y rpcbind nfs-utils
showmount -e nfs01
mkdir /tmp/blog-tmp/
mv /application/nginx/html/blog/wp-content/uploads/* /tmp/blog-tmp/
</code></pre></li>
<li><p>web01挂载共享目录并在nfs01上测试结果</p>

<pre><code>mount -t nfs 172.16.1.31:/blog-data /application/nginx/html/blog/wp-content/uploads/
echo &#39;mount -t nfs 172.16.1.31:/blog-data /application/nginx/html/blog/wp-content/uploads/&#39; &gt;&gt;/etc/profile #设置开机挂载
touch /application/nginx/html/blog/wp-content/uploads/test.txt
</code></pre></li>
<li><p>将用户上传的••文件转移回来</p>

<pre><code>mv /tmp/blog-tmp/* /application/nginx/html/blog/wp-content/uploads/
</code></pre>

<blockquote>
<p>注意: 这一步操作会出现告警信息, 因为挂载后www用户会被压缩, 文件属主会有变化<br/>
注意: web01和nfs01时间上要保持一致同步, 否则按时间查找用户上传的文件时会有坑</p>
</blockquote></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-12T00:05:21+08:00" itemprop="datePublished">2017/9/12</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051459212797.html" itemprop="url">
		廿八、MySQL基本操作</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>shell内操作</p>

<p><a href="http://www.cnblogs.com/kerrycode/p/4606400.html">http://www.cnblogs.com/kerrycode/p/4606400.html</a></p>

<pre><code>[root@db01 ~]# mysql -uroot -p123456 
</code></pre>

<blockquote>
<p>-h远程登录: -h10.0.0.51</p>
</blockquote>

<pre><code>mysql&gt; quit
</code></pre>

<ol>
<li><p>备份db01--&gt;db02</p>

<pre><code>[root@db01 ~]# mysqldump -uroot -p -A|gzip &gt;/tmp/alldb-bak.gz
[root@db01 ~]# scp /tmp/alldb-bak.gz db02:/tmp
</code></pre>

<pre><code>[root@db02 ~]# gzip -d /tmp/alldb-bak.gz
[root@db02 ~]# mysql -uroot -p &lt;/tmp/alldb-bak
</code></pre></li>
<li><p>查看数据库操作历史</p>

<pre><code>[root@db01 ~]# cat ~/.mysql_history
</code></pre></li>
</ol></li>
<li><p>库操作</p>

<blockquote>
<p>#查看数据库列表</p>

<pre><code>mysql&gt; show databases;
</code></pre>
</blockquote>

<blockquote>
<p>#创建数据库</p>

<pre><code>mysql&gt; create database wordpress;
</code></pre>
</blockquote>

<blockquote>
<p>#删除数据库</p>

<pre><code>mysql&gt; drop database wordpress;
</code></pre>
</blockquote>

<blockquote>
<p>#查看当前所在数据库，类似于pwd命令的功能</p>

<pre><code>mysql&gt; select database();
</code></pre>
</blockquote>

<blockquote>
<p>#使用一个数据库，相当于cd进入一个数据库</p>

<pre><code>mysql&gt; use mysql;
</code></pre>
</blockquote></li>
<li><p>用户操作</p>

<blockquote>
<p># 为MySQL用户指定新密码</p>

<pre><code>mysqladmin -u wordpress -p password 123456
</code></pre>
</blockquote>

<blockquote>
<p>#查看所有数据库的用户信息</p>

<pre><code>mysql&gt; select user,host from mysql.user;
</code></pre>

<p>注意: 每个库的用户名和密码都存放在user表中</p>
</blockquote>

<blockquote>
<p>#授权 所有权限 在WordPress库的所有表 给WordPress用户 密码设置为oldboy123 用户信息</p>

<pre><code>mysql&gt; grant all on wordpress.* to &#39;wordpress&#39;@&#39;localhost&#39; identified by &#39;123456&#39;;
mysql&gt; grant all on wordpress.* to &#39;wordpress&#39;@&#39;172.16.1.0/255.255.255.0&#39; identified by &#39;123456&#39;;
mysql&gt; flush privileges;
</code></pre>

<p>注意: 实现本地登录数据库, 必须授权给localhost, 否则无法登录; 远程登录必须控制在内网范围内.<br/>
注意: 新版本中不再支持&#39;172.16.1.0/24&#39;和&#39;172.16.1.%&#39;两种写法.<br/>
注意: 修改用户授权信息后, 要更新权限.</p>
</blockquote>

<blockquote>
<p>#删除用户信息</p>

<pre><code>mysql&gt; drop user wordpress@&#39;172.16.1.8&#39;;
</code></pre>
</blockquote>

<blockquote>
<p>#查看当前登录数据库的用户</p>

<pre><code>mysql&gt; select user();
</code></pre>
</blockquote>

<blockquote>
<p># 查看可以登录mysql数据库的目录，以及都可以从哪里进行管理mysql数据库</p>

<pre><code>mysql&gt; select user,host from mysql.user;
</code></pre>
</blockquote></li>
<li><p>表操作</p>

<blockquote>
<p>#查看数据表列表</p>

<pre><code>mysql&gt; show tables;
</code></pre>
</blockquote></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-11T23:52:13+08:00" itemprop="datePublished">2017/9/11</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051451335516.html" itemprop="url">
		附录: 502和504错误</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h3 id="toc_0">一、错误提示说明：</h3>

<p>Nginx 502 Bad Gateway的含义是请求的PHP-CGI已经执行，但是由于某种原因（一般是读取资源的问题）没有执行完毕而导致PHP-CGI进程终止。</p>

<p>Nginx 504 Gateway Time-out的含义是所请求的网关没有请求到，简单来说就是没有请求到可以执行的PHP-CGI。</p>

<h3 id="toc_1">二、错误提示原因分析：</h3>

<p>解决这两个问题其实是需要综合思考的，一般来说Nginx 502 Bad Gateway和php-fpm.conf的设置有关，<br/>
而Nginx 504 Gateway Time-out则是与nginx.conf的设置有关。</p>

<p>php-fpm.conf有两个至关重要的参数，一个是”max_children”,另一个是”request_terminate_timeout” ，但是这个值不是通用的，而是需要自己计算的。</p>

<p>计算的方式如下：<br/>
如果你的服务器性能足够好，且宽带资源足够充足，PHP脚本没有系循环或BUG的话你可以直接将”request_terminate_timeout”设置成0s。0s的含义是让PHP-CGI一直执行下去而没有时间限制。而如果你做不到这一点，也就是说你的PHP-CGI可能出现某个BUG，或者你的宽带不够充足或者其他的原因导致你的PHP-CGI能够假死那么就建议你给”request_terminate_timeout”赋一个值，这个值可以根据你服务器的性能进行设定。一般来说性能越好你可以设置越高，20分钟-30分钟都可以。由于我的服务器PHP脚本需要长时间运行，有的可能会超过10分钟因此我设置了900秒，这样不会导致PHP-CGI死掉而出现502 Bad gateway这个错误。</p>

<p>而”max_children”这个值又是怎么计算出来的呢？这个值原则上是越大越好，php-cgi的进程多了就会处理的很快，排队的请求就会很少。设置”max_children”也需要根据服务器的性能进行设定，一般来说一台服务器正常情况下每一个php-cgi所耗费的内存在20M左右，因此我的”max_children”我设置成40个，20M*40=800M也就是说在峰值的时候所有PHP-CGI所耗内存在800M以内，低于我的有效内存1Gb。而如果我的”max_children”设置的较小，比如5-10个，那么php-cgi就会“很累”，处理速度也很慢，等待的时间也较长。如果长时间没有得到处理的请求就会出现504 Gateway Time-out这个错误，而正在处理的很累的那几个php-cgi如果遇到了问题就会出现502 Bad gateway这个错误。</p>

<h3 id="toc_2">三、临时解决办法：</h3>

<p>综上所述，Nginx提示502和504错误的临时解决办法是：</p>

<h4 id="toc_3">1、调整php-fpm.conf的相关设置：</h4>

<pre><code>32
30s
</code></pre>

<h4 id="toc_4">2、调整nginx.conf的相关设置：</h4>

<pre><code>fastcgi_connect_timeout 600;
fastcgi_send_timeout 600;
fastcgi_read_timeout 600;
fastcgi_buffer_size 256k;
fastcgi_buffers 16 256k;
fastcgi_busy_buffers_size 512k;
fastcgi_temp_file_write_size 512k;
</code></pre>

<h3 id="toc_5">四、终级解决方案：</h3>

<p>标题3中所示的解决方案只能临时解决问题，而如果网站的访问量确实非常非常大，而Nginx+FastCGI只能对处理瞬间或短时间内的高并发有很好的效果，所以目前唯一的终极解决方案是：定时平滑重启php-cgi。</p>

<p>具体配置如下：</p>

<h4 id="toc_6">1、写一个非常简单的脚本：</h4>

<pre><code>vi /home/www/scripts/php-fpm.sh 
</code></pre>

<p>内容如下：</p>

<pre><code>#!/bin/bash
# This script run at */1
/usr/local/php/sbin/php-fpm reload
</code></pre>

<h4 id="toc_7">2、将脚本添加至计划任务：</h4>

<pre><code>crontab -e
</code></pre>

<p>内容如下：</p>

<pre><code>*/1 * * * * /home/www/scripts/php-fpm.sh 
</code></pre>

<blockquote>
<p>注：为了省事起见，也可以不写脚本，直接在crontab里写入php-fpm的平滑重启命令。</p>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-11T22:56:54+08:00" itemprop="datePublished">2017/9/11</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051418147758.html" itemprop="url">
		廿七、单台服务器LNMP搭建</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>LNMP架构与部署流程图<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/54209317.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/79629399.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/50069384.jpg" alt=""/></p></li>
<li><p>Linux部署</p>

<ol>
<li><p>网络配置</p>

<blockquote>
<p>Linux网卡配置: ---------- vm网络编辑器的配置<br/>
eth0:10.0.0.X ----------- NAT<br/>
eth1:172.16.1.X  -------- 虚拟LAN区段: 172.16.1.0/24<br/>
网关设置:NAT 10.0.0.254<br/>
DNS配置:NAT 223.5.5.5 223.6.6.6</p>
</blockquote></li>
<li><p>确认系统环境</p>

<pre><code>[root@web01 ~]# cat /etc/centos-release
CentOS release 6.9 (Final)
[root@web01 ~]# uname -a
Linux web01 2.6.32-696.el6.x86_64 #1 SMP Tue Mar 21 19:29:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></li>
<li><p>虚拟机优化</p>

<blockquote>
<p>iptables防火墙关闭<br/>
selinux关闭<br/>
/tmp目录权限 1777<br/>
epel源下载</p>

<pre><code>wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
</code></pre>
</blockquote></li>
</ol></li>
<li><p>Nginx部署</p>

<ol>
<li><p>统一安装包路径, 下载解压nginx软件包</p>

<pre><code>mkdir -p /server/tools/
cd /server/tools/
wget http://nginx.org/download/nginx-1.10.3.tar.gz
</code></pre></li>
<li><p>创建nginx虚拟用户用户---www</p>

<pre><code>useradd -s /sbin/nologin -M www
</code></pre></li>
<li><p>依赖包安装：pcre-devel openssl-devel</p>

<pre><code>yum install pcre-devel openssl-devel gcc -y
rpm -qa pcre* openssl* gcc
</code></pre></li>
<li><p>编译安装nginx软件服务</p>

<pre><code>tar xf nginx-1.10.3.tar.gz
cd nginx-1.10.3/
./configure --prefix=/application/nginx-1.10.3 --user=www --group=www --with-http_stub_status_module --with-http_ssl_module
make &amp;&amp; make install
</code></pre></li>
<li><p>创建服务程序的软链接</p>

<pre><code>ln -s /application/nginx-1.10.3 /application/nginx
ln -s /application/nginx/sbin/nginx /usr/local/sbin/
</code></pre></li>
<li><p>配置文件进行编辑修改</p>

<blockquote>
<pre><code>cd /application/nginx/conf/
mkdir /application/nginx/conf/extra
egrep -v &#39;#|^$&#39; nginx.conf.default
egrep -v &#39;#|^$&#39; nginx.conf.default &gt;nginx.conf
for i in www bbs blog status;do touch extra/${i}.conf;done
tree extra/
</code></pre>

<p>extra/<a href="http://www.conf">www.conf</a></p>

<pre><code>cat &gt;&gt; extra/www.conf&lt;&lt;EOF
server {
    listen       80;
    server_name  www.etiantian.org;
    location / {
        root   html/www;
        index  index.html index.htm;
    }
}
EOF
</code></pre>

<p>extra/bbs.conf</p>

<pre><code>cat &gt;&gt; extra/bbs.conf&lt;&lt;EOF
server {
    listen       80;
    server_name  bbs.etiantian.org;
    location / {
        root   html/blog;
        index  index.html index.htm;
    }
}
EOF
</code></pre>

<p>extra/blog.conf</p>

<pre><code>cat &gt;&gt; extra/blog.conf&lt;&lt;EOF
server {
    listen       80;
    server_name  blog.etiantian.org;
    location / {
        root   html/bbs;
        index  index.html index.htm;
    }
}
EOF
</code></pre>

<p>extra/status.conf</p>

<pre><code>cat &gt;&gt; extra/status.conf&lt;&lt;EOF
server{
    listen  80;
    server_name  status.etiantian.org;
    location / {
      stub_status on;
      access_log   off;
    }
  }
EOF
</code></pre>

<p>extra/nginx.conf</p>

<pre><code>cat&gt;nginx.conf&lt;&lt;EOF
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
    access_log  logs/access.log  main;
    include extra/www.conf;
    include extra/bbs.conf;
    include extra/blog.conf;
    include extra/status.conf;
}
EOF
</code></pre>

<pre><code>cd /application/nginx/html/
mkdir /application/nginx/html/{www,bbs,blog}
echo &#39;www web01&#39; &gt;www/index.html
echo &#39;bbs web01&#39; &gt;bbs/index.html
echo &#39;blog web01&#39; &gt;blog/index.html
</code></pre>
</blockquote></li>
<li><p>测试配置文件语法，启动nginx服务并检查</p>

<pre><code>nginx -t
nginx
lsof -i:80
</code></pre></li>
<li><p>修改Windows的hosts并在浏览器中测试</p>

<blockquote>
<p>C:\Windows\System32\drivers\etc\hosts<br/>
使用管理员权限编辑, 加入一行新内容:</p>
</blockquote>

<pre><code>10.0.0.8 www.etiantian.org bbs.etiantian.org blog.etiantian.org status.etiantian.org etiantian.org
</code></pre></li>
</ol></li>
<li><p>MySQL部署</p>

<ol>
<li><p>添加系统虚拟用户mysql</p>

<pre><code>groupadd -g 555 mysql
useradd -s /sbin/nologin -u 555 -g 555 -M mysql
</code></pre></li>
<li><p>下载解压mysql二进制软件包</p>

<pre><code>cd /server/tools/
tar xf mysql-5.6.34-linux-glibc2.5-x86_64.tar.gz
</code></pre></li>
<li><p>将mysql解压后的目录转移(重命名)并创建软连接</p>

<pre><code>\cp -r /server/tools/mysql-5.6.34-linux-glibc2.5-x86_64 /application/mysql-5.6.34
ln -s /application/mysql-5.6.34/ /application/mysql
</code></pre></li>
<li><p>让mysql用户管理 /application/mysql/</p>

<pre><code>chown -R mysql.mysql /application/mysql/data/
</code></pre></li>
<li><p>初始化数据库</p>

<pre><code>/application/mysql-5.6.34/scripts/mysql_install_db --basedir=/application/mysql-5.6.34/ --datadir=/application/mysql-5.6.34/data --user=mysql
# 说明信息: 初始化成功，会看到输出信息中有两个OK
# mysql启动脚本 默认放在support-files/mysql.server
</code></pre></li>
<li><p>复制默认的配置文件</p>

<pre><code>\cp /application/mysql/support-files/my-default.cnf /etc/my.cnf
</code></pre></li>
<li><p>修改mysqld 和 mysqld_safe两个脚本中的相关路径<mark>(注意先复制再修改,顺序不要错)</mark></p>

<pre><code>sed -i &#39;s#/usr/local/mysql#/application/mysql#g&#39; /application/mysql/bin/mysqld_safe /etc/init.d/mysqld
</code></pre></li>
<li><p>复制启动脚本到/etc/init.d/, 授与x权限, 并设置开机自启动</p>

<pre><code>cp /application/mysql/support-files/mysql.server  /etc/init.d/mysqld
chmod +x /etc/init.d/mysqld
chkconfig --add mysqld
chkconfig mysqld on
</code></pre></li>
<li><p>启动MySQL</p>

<pre><code>/etc/init.d/mysqld start   #启动后提示 Starting MySQL....... SUCCESS!
lsof -i:3306                #MySQL使用的端口3306
</code></pre></li>
<li><p>扩展知识：将数据库命令集目录追加到PATH中</p>

<pre><code>ln -s /application/mysql/bin/* /usr/local/bin/
which mysql
</code></pre></li>
<li><p>给MySQL添加管理员并设置密码</p>

<pre><code>/application/mysql/bin/mysqladmin -u root password &#39;oldboy123&#39;
</code></pre></li>
<li><p>测试数据库能否使用, 进入和退出</p>

<pre><code>mysql -uroot -poldboy123     #使用用户名和密码安全进入数据库
quit #退出数据库
</code></pre></li>
</ol></li>
<li><p>PHP部署</p>

<ol>
<li><p>解压PHP软件</p>

<pre><code>cd /server/tools/
tar xf php-5.5.32.tar.gz
</code></pre></li>
<li><p>准备两个文件和依赖包</p>

<pre><code>## ln -s /application/mysql/lib/libmysqlclient.so.18  /usr/lib64/  #如果未安装MySQL,可省略. 此处有隐患, 如果以后删除mysql会导致软链接失效, 建议使用以下命令
cp /application/mysql/lib/libmysqlclient.so.18.1.0 /usr/lib64/libmysqlclient.so.18 
</code></pre>

<pre><code>touch /server/tools/php-5.5.32/ext/phar/phar.phar
yum install zlib-devel libxml2-devel libjpeg-devel libjpeg-turbo-devel freetype-devel libpng-devel gd-devel libcurl-devel libxslt-devel libmcrypt-devel mhash mcrypt -y
</code></pre></li>
<li><p>安装依赖包libiconv-devel</p>

<pre><code>tar xf libiconv-1.14.tar.gz
cd libiconv-1.14
./configure --prefix=/application/libiconv

make &amp;&amp; make install
</code></pre></li>
<li><p>PHP编译安装</p>

<blockquote>
<p>#如果未安装MySQL,要修改为--with-mysql==mysqlnd --with-pdo-mysql=mysqlnd, 建议这两个编译参数直接指定mysqlnd, php就会使用</p>
</blockquote>

<pre><code>cd /server/tools/php-5.5.32
./configure \
--prefix=/application/php-5.5.32 \
--with-mysql=/application/mysql/ \    
--with-pdo-mysql=/application/mysql/ \ 
--with-freetype-dir \
--with-jpeg-dir \
--with-png-dir \
--with-zlib \
--with-libxml-dir=/usr \
--enable-xml \
--disable-rpath \
--enable-bcmath \
--enable-shmop \
--enable-sysvsem \
--enable-inline-optimization \
--with-curl \
--enable-mbregex \
--enable-fpm \
--enable-mbstring \
--with-mcrypt \
--with-gd \
--enable-gd-native-ttf \
--with-openssl \
--with-mhash \
--enable-pcntl \
--enable-sockets \
--with-xmlrpc \
--enable-soap \
--enable-short-tags \
--enable-static \
--with-xsl \
--with-fpm-user=www \
--with-fpm-group=www \
--enable-ftp \
--enable-opcache=no

make &amp;&amp; make install
</code></pre></li>
<li><p>创建PHP软件目录的软链接</p>

<pre><code>ln -s /application/php-5.5.32/ /application/php
</code></pre></li>
<li><p>配置php解析文件  配置php-fpm配置文件</p>

<pre><code>cp /server/tools/php-5.5.32/php.ini-production /application/php/lib/php.ini
cp /application/php/etc/php-fpm.conf.default /application/php/etc/php-fpm.conf
</code></pre>

<blockquote>
<p>#扩展: php.ini-production 与 php.ini-development 两个文件的区别和关系<br/>
#扩展：文件比较命令 diff zdiff vimdiff windows上的文件比较</p>
</blockquote></li>
<li><p>启动php-fpm程序</p>

<pre><code>/application/php/sbin/php-fpm
</code></pre></li>
<li><p>确认php 9000端口是否正确启动</p>

<pre><code>lsof -i:9000
ps -ef|grep php-fpm
</code></pre></li>
<li><p>创建PHP测试页面</p>

<pre><code>cd /application/nginx/html/blog/
mv index.html index.html.bak
echo &#39;&lt;?php phpinfo(); ?&gt;&#39; &gt;/application/nginx/html/blog/test_info.php
</code></pre></li>
</ol></li>
<li><p>实现nginx与PHP配合</p>

<ol>
<li><p>修改blog配置文件</p>

<pre><code>vim /application/nginx/conf/extra/blog.conf
    server {
        listen       80;
        server_name  blog.etiantian.org;
        root   html/blog;
        location / {
#index.php不加或者不放在第一个, 都会导致主页定向到index.html
            index index.php index.html index.htm;
        }

        location ~* .*\.(php|php5)?$ {
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index index.php;
            include /application/nginx/conf/fastcgi.conf;
        }

}
</code></pre>

<blockquote>
<p>说明：利用nginx的location区块实现动态请求与静态请求的分别处理</p>
</blockquote></li>
<li><p>站点测试</p>

<pre><code>curl  http://blog.etiantian.org/index.html       # 静态请求站点文件信息测试
curl  http://blog.etiantian.org/test_info.php    # 动态请求站点文件信息测试
</code></pre>

<blockquote>
<p>说明：当php服务停止时，9000端口信息消失，即停止PHP错误报502错误<br/>
linux系统测试完毕后，建议利用浏览器进行最终测试，测试效果更明显些</p>
</blockquote>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/63563084.jpg" alt=""/></p></li>
</ol></li>
<li><p>实现php与MySQL连通</p>

<ol>
<li><p>创建WordPress数据库</p>

<pre><code>mysql -uroot -poldboy123
show databases;              #查看当前数据库信息
create database wordpress;
</code></pre></li>
<li><p>添加WordPress用户并授权管理</p>

<pre><code>WordPress库
grant all on wordpress.* to &#39;wordpress&#39;@&#39;localhost&#39; identified by &#39;123456&#39;;
grant all on wordpress.* to &#39;wordpress&#39;@&#39;172.16.1.0/255.255.255.0&#39; identified by &#39;123456&#39;;
flush privileges;
</code></pre>

<blockquote>
<p>注意: 每次修改用户授权, 都要刷新权限配置</p>
</blockquote></li>
<li><p>数据库WordPress登录测试</p>

<pre><code>mysql -uwordpress -p123456
</code></pre></li>
<li><p>编辑php与mysql连通性测试文件</p>

<pre><code>vim /application/nginx/html/blog/test_mysql.php
</code></pre>

<pre><code>&lt;?php
     //$link_id=mysql_connect(&#39;主机名&#39;,&#39;用户&#39;,&#39;密码&#39;);
     $link_id=mysql_connect(&#39;localhost&#39;,&#39;wordpress&#39;,&#39;123456&#39;) or mysql_error();
     if($link_id){
         echo &quot;Connect mysql success !\n&quot;;
      }else{
         echo mysql_error();
       }
?&gt;
</code></pre></li>
</ol></li>
<li><p>WordPress部署</p>

<ol>
<li><p>下载部署wordpress博客程序</p>

<pre><code>cd /server/tools/
wget https://cn.wordpress.org/wordpress-4.7.3-zh_CN.tar.gz
tar xf wordpress-4.7.3-zh_CN.tar.gz
\mv wordpress/* /application/nginx/html/blog/    # 强制覆盖index.html重名文件
</code></pre></li>
<li><p>文件目录权限设置<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/1583708.jpg" alt=""/></p>

<pre><code>chown -R www.www /application/nginx/html/blog/
chown -R www.www /application/nginx/html/blog/wp-content/uploads/ #用户上传数据目录属主修改为www
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/81176698.jpg" alt=""/></p>

<blockquote>
<p>说明: 编辑wp-config.php文件可以修改wordpress上的数据库连接参数信息</p>
</blockquote></li>
<li><p>用浏览器进行wordpress部署<br/>
<a href="http://blog.etiantian.org/wp-admin/setup-config.php">http://blog.etiantian.org/wp-admin/setup-config.php</a><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/81433116.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/55472707.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/64668274.jpg" alt=""/></p></li>
</ol></li>
<li><p>补充知识</p>

<ol>
<li><p>502和504错误</p>

<p><a href="15051451335516.html">附录: 502和504错误</a></p></li>
<li><p>排错--数据库连接问题</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-12/55569117.jpg" alt=""/></p>

<blockquote>
<p>检查网络连接<br/>
检查数据库服务<br/>
检查数据库授权</p>
</blockquote></li>
<li><p>排错mysql---启动脚本没有修改成功(可能是因为复制和修改这两个操作顺序错了)</p>

<pre><code>[root@oldboy38 ~]# /etc/init.d/mysqld start
/etc/init.d/mysqld: line 256: my_print_defaults: command not found
/etc/init.d/mysqld: line 276: cd: /application/mysql: No such file or directory
Starting MySQL ERROR! Couldn&#39;t find MySQL server (/application/mysql/bin/mysqld_safe)
</code></pre></li>
<li><p>排错: 博客发布后的链接会错误定位到blog/index.php<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-12/19982.jpg" alt=""/></p>

<blockquote>
<p>blog目录下先有了一个测试的index.php<br/>
转移解压后的wordpress内容的时候, 因为两个index.php重名了, 没有被替换掉<br/>
解决:</p>

<pre><code>\mv /server/tools/wordpress/index.php /application/nginx/html/blog/
</code></pre>
</blockquote></li>
<li><p>在数据库中查看博客中的内容</p>

<pre><code># mysql -uwordpress -p123456
mysql&gt; use wordpress;
mysql&gt; show tables;
select * from wp_posts\G           # \G 竖列显示,不接&#39;;&#39;
</code></pre></li>
<li><p>限制用户上传的文件大小</p>

<blockquote>
<p>注意: lb集群和web集群的nginx.conf都要加入以下代码才能有效</p>

<pre><code>http {
client_max_body_size 10m;
...
}
</code></pre>
</blockquote></li>
<li><p>/application/php-5.5.32/lib/php.ini</p>

<blockquote>
<p>file_uploads = On ;打开文件上传选项<br/>
upload_max_filesize = 500M ;上传文件上限<br/>
如果要上传比较大的文件，仅仅以上两条还不够，必须把服务器缓存上限调大，把脚本最大执行时间变长<br/>
post_max_size = 500M ;post上限<br/>
max_execution_time = 1800 ; Maximum execution time of each script, in seconds脚本最大执行时间<br/>
max_input_time = 1800 ; Maximum amount of time each script may spend parsing request data<br/>
memory_limit = 128M ; Maximum amount of memory a script may consume (128MB)内存上限</p>
</blockquote></li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-11T22:06:29+08:00" itemprop="datePublished">2017/9/11</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15051387894730.html" itemprop="url">
		廿六、Nginx应用--Web服务</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>nginx多虚拟主机--server{}标签</p>

<blockquote>
<p>在Web服务里独立的网站站点, 对应的是独立的域名或IP或端口</p>
</blockquote>

<ol>
<li><p>测试页面请求响应</p>

<ol>
<li><p>推荐用Linux的curl命令测试</p>

<blockquote>
<p>重启服务后立即生效, 比较准确,不受浏览器缓存的干扰</p>
</blockquote></li>
<li><p>用chrome浏览器查看修改</p>

<blockquote>
<p>需要注意浏览器缓存的干扰导致测试不准确,最好用&quot;隐身窗口&quot;,不进行页面缓存<br/>
<mark>说明：nginx配置文件修改之后，需要重启nginx服务；nginx站点目录内容变更，无需重启nginx服务</mark></p>
</blockquote></li>
</ol></li>
<li><p>基于域名的多虚拟主机配置--多个server{}标签</p>

<ol>
<li><p>环境准备</p>

<blockquote>
<p>模拟环境: <a href="http://www.etiantian.org">www.etiantian.org</a> bbs.etiantian.org blog.etiantian.org</p>
</blockquote>

<pre><code>[root@web01 ~]# mkdir /application/nginx/html/{www,bbs,blog}
[root@web01 ~]# ls /application/nginx/html/
50x.html  bbs  blog  index.html  index.html.bak  pic1.jpg  www
[root@web01 ~]# cd /application/nginx/html/
[root@web01 html]# for name in www bbs blog ; do echo $name `hostname` &gt;/application/nginx/html/$name/index.html;done
[root@web01 html]# for name in www bbs blog ; do cat /application/nginx/html/$name/index.html;done
www web01
bbs web01
blog web01
</code></pre></li>
<li><p>修改配置文件</p>

<pre><code>[root@web01 html]# cd /application/nginx/conf/
[root@web01 conf]# cp nginx.conf{,.ori.www.only}
[root@web01 conf]# vim nginx.conf
:set nu
:10,17co17
:10,17co25
</code></pre>

<blockquote>
<p>修改虚拟主机名, 修改虚拟主机各自的站点目录</p>
</blockquote>

<pre><code>server {
    listen       80;
    server_name  www.etiantian.org;
    location / {
        root   html/www;
        index  index.html index.htm;
    }
}
server {
    listen       80;
    server_name  bbs.etiantian.org;
    location / {
        root   html/blog;
        index  index.html index.htm;
    }
}
server {
    listen       80;
    server_name  blog.etiantian.org;
    location / {
        root   html/bbs;
        index  index.html index.htm;
    }
}
</code></pre></li>
<li><p>配置文件语法检查与重载</p>

<pre><code>[root@web01 conf]# nginx -t
nginx: the configuration file /application/nginx-1.10.3/conf/nginx.conf syntax is ok
nginx: configuration file /application/nginx-1.10.3/conf/nginx.conf test is successful
[root@web01 conf]# nginx -s reload
</code></pre></li>
<li><p>修改Windows hosts文件</p></li>
</ol>

<pre><code>C:\Windows\System32\drivers\etc\hosts
10.0.0.8   www.etiantian.org bbs.etiantian.org blog.etiantian.org
</code></pre></li>
<li><p>基于端口的多虚拟主机配置</p>

<blockquote>
<p>一般用于只想给内部用户访问, 不对外公开(即:不使用默认80端口)</p>
</blockquote>

<ol>
<li><p>修改配置文件</p>

<pre><code>[root@web01 conf]# cp nginx.conf{,.multi-hosts}
[root@web01 conf]# vim nginx.conf
</code></pre>

<blockquote>
<p>修改www端口</p>
</blockquote>

<pre><code>    server {
        listen       8080;
        server_name  www.etiantian.org;
        location / {
            root   html/www;
            index  index.html index.htm;
        }
}
</code></pre></li>
<li><p>语法检查并重载配置</p>

<pre><code>[root@web01 conf]# nginx -t
nginx: the configuration file /application/nginx-1.10.3/conf/nginx.conf syntax is ok
nginx: configuration file /application/nginx-1.10.3/conf/nginx.conf test is successful
[root@web01 conf]# nginx -s reload
[root@web01 conf]# ss -lntup|grep nginx
tcp    LISTEN     0      511                    *:8080                  *:*      users:((&quot;nginx&quot;,1440,10),(&quot;nginx&quot;,6059,10))
tcp    LISTEN     0      511                    *:80                    *:*      users:((&quot;nginx&quot;,1440,6),(&quot;nginx&quot;,6059,6))
</code></pre></li>
</ol></li>
<li><p>基于IP的多虚拟主机配置</p>

<pre><code>    server {
        listen       10.0.0.8:80;
        server_name  www.etiantian.org;
        location / {
            root   html/www;
            index  index.html index.htm;
        }
}
</code></pre>

<blockquote>
<p><mark>注意:基于IP修改配置,用平滑重启不能起效, 需要先stop再启动</mark></p>
</blockquote></li>
<li><p>规范化的nginx配置</p>

<ol>
<li><p>将不同页面的配置分别存放在对应的配置文件中</p>

<pre><code>[root@web01 conf]# cp nginx.conf{,.bak.port}
[root@web01 conf]# cat -n nginx.conf
[root@web01 conf]# mkdir extra
[root@web01 conf]# sed -n &#39;10,17p&#39; nginx.conf &gt;extra/www.conf
[root@web01 conf]# sed -n &#39;18,25p&#39; nginx.conf &gt;extra/bbs.conf
[root@web01 conf]# sed -n &#39;26,33p&#39; nginx.conf &gt;extra/blog.conf
[root@web01 conf]# cat extra/*
</code></pre></li>
<li><p>在主配置文件中引入这些配置</p>

<pre><code>[root@web01 conf]# vim nginx.conf
:10,33delete
[root@web01 conf]# cat nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    include extra/www.conf;
    include extra/*;
}
[root@web01 conf]# nginx -t
nginx: the configuration file /application/nginx-1.10.3/conf/nginx.conf syntax is ok
nginx: configuration file /application/nginx-1.10.3/conf/nginx.conf test is successful
[root@web01 conf]# nginx -s reload
</code></pre>

<blockquote>
<p><mark>注意: 不可以全都用&quot;extra/*;&quot;代替, *会按字母顺序先匹配到bbs.conf, 但可以先指定www.conf,其他用*代替</mark></p>
</blockquote></li>
</ol></li>
</ol></li>
<li><p>nginx虚拟主机的别名</p>

<ol>
<li><p>修改主页配置</p>

<pre><code>[root@web01 conf]# vim extra/www.conf
    server {
        listen       80;
        server_name  www.etiantian.org etiantian.org;
        location / {
            root   html/www;
            index  index.html index.htm;
        }
    }
</code></pre>

<ol>
<li><p>修改Windows hosts解析</p>

<pre><code>10.0.0.8   www.etiantian.org bbs.etiantian.org blog.etiantian.org etiantian.org
</code></pre></li>
</ol></li>
</ol></li>
<li><p>nginx处理请求的过程</p>

<blockquote>
<p>不指定端口, 只通过域名访问站点时, nginx会通过DNS解析出的IP, 寻找主机80端口在nginx.conf中相对应的第一个网址响应给浏览器(即使不能对应用户想要的域名), 即:配置文件中基于端口的设置优先于基于域名的设置.</p>
</blockquote></li>
<li><p>nginx状态信息功能模块</p>

<blockquote>
<p>nginx -V  ---查看nginx<mark>配置参数和版本</mark></p>
</blockquote>

<ol>
<li><p>编辑状态信息页面配置</p>

<pre><code>[root@web01 conf]# vim extra/status.conf
server {
    listen       80;
    server_name status.etiantian.org;
    location / {
        stub_status on;
        access_log off;
    }
}
</code></pre></li>
<li><p>修改主配置文件</p>

<pre><code>[root@web01 conf]# sed -i.bak.status &#39;/include.*blog/ a include extra/status.conf;&#39; nginx.conf
[root@web01 conf]# cat nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    include extra/www.conf;
    include extra/bbs.conf;
    include extra/blog.conf;
include extra/status.conf;
}
</code></pre></li>
<li><p>配置文件语法检查与重载</p>

<pre><code>[root@web01 conf]# nginx -t
nginx: the configuration file /application/nginx-1.10.3/conf/nginx.conf syntax is ok
nginx: configuration file /application/nginx-1.10.3/conf/nginx.conf test is successful
[root@web01 conf]# nginx -s reload
</code></pre></li>
<li><p>修改Windows hosts解析</p>

<pre><code>10.0.0.8   status.etiantian.org etiantian.org www.etiantian.org bbs.etiantian.org blog.etiantian.org
</code></pre></li>
</ol></li>
<li><p>nginx如何查看并发数?</p>

<ol>
<li><p>使用状态模块</p>

<blockquote>
<p>官方手册:<a href="http://nginx.org/en/docs/http/ngx_http_stub_status_module.html">http://nginx.org/en/docs/http/ngx_http_stub_status_module.html</a><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/57823511.jpg" alt=""/></p>

<pre><code>Active connections
The current number of active client connections including Waiting connections.
accepts
The total number of accepted client connections.
handled
The total number of handled connections. Generally, the parameter value is the same as accepts unless some resource limits have been reached (for example, the worker_connections limit).
requests
The total number of client requests.
Reading
The current number of connections where nginx is reading the request header.
Writing
The current number of connections where nginx is writing the response back to the client.
Waiting
The current number of idle client connections waiting for a request.
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/10186457.jpg" alt=""/></p>
</blockquote></li>
<li><p>ss -ant|grep -ic estab</p>

<pre><code>[root@web01 conf]# ss -ant|grep -i estab
ESTAB      0      64                 10.0.0.8:22                10.0.0.1:50152
ESTAB      0      0                  10.0.0.8:22                10.0.0.1:50923
[root@web01 conf]# ss -ant|grep -ic estab
2
</code></pre></li>
</ol></li>
<li><p>nginx访问日志</p>

<ol>
<li><p>定义日志的格式与使用方法</p>

<pre><code>[root@web01 conf]# grep -A4 &#39;log_format&#39; nginx.conf.default
    #log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
    #                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
    #                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;

    #access_log  logs/access.log  main;
[root@web01 conf]#
</code></pre>

<ol>
<li><p>编辑主配置文件</p>

<pre><code>[root@web01 conf]# vim nginx.conf
[root@web01 conf]# cat nginx.conf
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;

    access_log  logs/access.log  main; 
    include extra/www.conf;
    include extra/bbs.conf;
    include extra/blog.conf;
    include extra/status.conf;
}
</code></pre>

<blockquote>
<p><mark>说明: 在配置文件中正确定义了日志文件并成功启动nginx之后, 即使日志文件以前不存在也会被创建出来</mark></p>
</blockquote></li>
<li><p>语法检查与重载</p>

<pre><code>[root@web01 conf]# nginx -t
nginx: the configuration file /application/nginx-1.10.3/conf/nginx.conf syntax is ok
nginx: configuration file /application/nginx-1.10.3/conf/nginx.conf test is successful
[root@web01 conf]# nginx -s reload
</code></pre></li>
<li><p>刷新页面并检查日志</p></li>
</ol>

<pre><code>[root@web01 conf]# tail ../logs/access.log
</code></pre></li>
<li><p>日志格式分析</p>

<blockquote>
<p>$remote_addr 远端用户ip地址<br/>
$remote_user 远端用户,默认为空,需要指定<br/>
[$time_local] 服务器本地时间<br/>
$request 请求的起始行---(http请求方法  URI  http协议版本)<br/>
注意:nginx中的URI指的是一个完整网址的顶级域名后面的部分<br/>
$status 状态码<br/>
$body_bytes_sent 响应主体大小--byte<br/>
$http_referer 访问方式(连接跳转 或 域名访问)<br/>
$http_x_forwarded_for 反向代理相关<br/>
$http_user_agent 浏览器软件版本<br/>
说明=====浏览器UA 字串的标准格式为:<br/>
浏览器标识 (操作系统标识; 加密等级标识; 浏览器语言) 渲染引擎标识 版本信息<br/>
在chrome浏览器中, 使用F12打开调试模式, 可以模拟智能终端访问</p>
</blockquote>

<pre><code>10.0.0.1 - - [09/Aug/2017:12:02:52 +0800] &quot;GET / HTTP/1.1&quot; 200 10 &quot;-&quot; &quot;Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Mobile Safari/537.36&quot; &quot;-&quot;
10.0.0.1 - - [09/Aug/2017:01:51:16 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36&quot; &quot;-&quot;
10.0.0.1 - - [09/Aug/2017:09:27:15 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 571 &quot;http://www.etiantian.org/&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36&quot; &quot;-&quot;
</code></pre></li>
</ol></li>
<li><p>日志操作</p>

<ol>
<li><p>压缩日志</p>

<pre><code>access_log  logs/access.log  main gzip buffer=32k flush=5s;
</code></pre>

<blockquote>
<p>查看日志内容命令 zcat zgrep zless</p>
</blockquote></li>
<li><p>手动切割</p>

<blockquote>
<p>注意切割周期</p>
</blockquote>

<pre><code>[root@web01 logs]# mv access.log access_`date -d &quot;-1day&quot; +%F`.log
[root@web01 logs]# ls
access_2017-07-29.log  error.log  nginx.pid
[root@web01 logs]# /application/nginx/sbin/nginx -s reload
[root@web01 logs]# ls
access_2017-07-29.log access.log  error.log  nginx.pid
</code></pre></li>
<li><p>定时任务脚本切割</p>

<blockquote>
<p>通过脚本的方式来实现切割。通过计划任务</p>

<pre><code>vim /server/scripts/cut_nginx_log.sh
#!bin/sh
#nginx目录
Basedir=&quot;/application/nginx&quot;
#日志目录
Nginxlogdir=&quot;$Basedir/logs&quot;
#当天日志文件名前缀
Logname=&quot;access&quot;
#切割后的文件名中的时间格式
Dateformat=`date -d &quot;yesterday&quot; +%Y-%m-%d`
#判断nginx目录是否存在
[ -d $Nginxlogdir ]&amp;&amp; cd $Nginxlogdir||exit 1
#判断nginx是否启动
[ -f ${Nginxlogdir}/nginx.pid ]||exit 1
#判断日志文件是否存在
[ -f ${Logname}.log ]||exit 1
#重命名日志文件==切割
/bin/mv ${Logname}.log ${Dateformat}_${Logname}.log
#向 Nginx 的进程发送 USR1 信号以重新打开日志文件
kill -USR1 $(cat ${Nginxlogdir}/nginx.pid)
</code></pre>

<p>必须向 Nginx 的进程发送 USR1 信号以重新打开日志文件，如果不写的话，Nginx 会继续将日志信息写入 access_[yyyy-MM-dd].log 的那个文件中，这显然是不正确的。</p>
</blockquote>

<pre><code>#nginx日志切割
0 0 * * * /bin/bash /server/scripts/cut_nginx_log.sh &amp;&gt;/dev/null
</code></pre></li>
<li><p>loglocate日志轮询切割</p>

<pre><code>[root@web01 nginx]# vim /etc/logrotate.d/nginx
/application/nginx/logs/access.log /application/nginx/logs/error.log{
notifempty
daily
sharedscripts;
postrotate
/bin/kill -USR1 `/bin/cat /application/nginx/logs/nginx.pid`
endscript
}
</code></pre></li>
</ol></li>
<li><p>location请求定位</p>

<blockquote>
<p>作用是<br/>
官方文档: <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location">http://nginx.org/en/docs/http/ngx_http_core_module.html#location</a><br/>
语法location [ = | ~ | ~* | <sup>~</sup> ] uri { ... }<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/83152961.jpg" alt=""/></p>
</blockquote>

<ol>
<li><p>匹配字符串</p>

<blockquote>
<p>&quot;=&quot; 完全匹配(精确)<br/>
&quot;<sup>~&quot;</sup> 常规匹配, 不检查正则表达式<br/>
&quot;~<em>&quot; 不区分大小写, 可以用正则和!取反<br/>
&quot;~&quot; 区分大小写, 可以用正则!取反<br/>
&quot; &quot; 不指定表示匹配不到有效位置时最后的匹配<br/>
优先级: &quot;=&quot; &gt; &quot;<sup>~&quot;</sup> &gt; &quot;~</em>&quot; &gt; &quot;~&quot; &gt; &quot; &quot;(默认)</p>
</blockquote></li>
<li><p>匹配变量</p>

<blockquote>
<p>官网: <a href="http://nginx.org/en/docs/varindex.html">http://nginx.org/en/docs/varindex.html</a><br/>
常见变量: $request_uri</p>
</blockquote></li>
<li><p>allow和deny</p>

<pre><code>        location ~* /AV/ {
            root   html/www/AV/;
            index  index.html index.htm;
            allow  172.16.1.31/32;
            deny   all;
        }
</code></pre></li>
</ol></li>
<li><p>rewrite重写URI(用于伪静态)</p>

<ol>
<li><p>用途</p>

<blockquote>
<p><a href="http://oldboy.blog.51cto.com/2561410/1774260">http://oldboy.blog.51cto.com/2561410/1774260</a><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/49779301.jpg" alt=""/></p>
</blockquote></li>
<li><p>用法</p>

<blockquote>
<p>语法格式: rewrite RegEx replacement [flag];<br/>
相当于: sed &#39;s#RegEx#replacement#g&#39;<br/>
应用位置: server区块 location区块 if区块</p>
</blockquote></li>
<li><p>Perl正则: (.*)--$n<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/2480791.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/98781645.jpg" alt=""/></p></li>
<li><p>if区块用法</p>

<blockquote>
<p><a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if">http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if</a><br/>
Example:<br/>
if ($slow) {<br/>
    limit_rate 10k;<br/>
    break;<br/>
}<br/>
Syntax: if (condition) { ... }<br/>
Default:    —<br/>
Context:    server, location</p>
</blockquote></li>
<li><p><a href="http://www.conf%E7%AC%AC%E4%B8%80%E7%A7%8D%E5%86%99%E6%B3%95">www.conf第一种写法</a></p>

<pre><code>   server {
        listen         80;
        server_name  www.etiantian.org  etiantian.org ;
        if ($host ~* &quot;^etiantian.org$&quot;) {
        rewrite ^/(.*) http://www.etiantian.org/$1 permanent;
        }
        location / {
            root   html/www;
            index  index.html index.htm;
        }
}
</code></pre></li>
<li><p><a href="http://www.conf%E7%AC%AC%E4%BA%8C%E7%A7%8D%E5%86%99%E6%B3%95">www.conf第二种写法</a></p>

<pre><code>   server {
        listen   80;
        server_name etiantian.org ;
        rewrite ^/(.*) http://www.etiantian.org/$1 permanent;
         }
   server {
        listen   80;
        server_name  www.etiantian.org;
        location / {
            root   html/www;
            index  index.html index.htm;
        }
}
</code></pre></li>
</ol></li>
<li><p>Nginx基本认证功能</p>

<pre><code>yum install -y httpd-tools
htpasswd -bc /application/nginx/conf/htpasswd oldboy 123456
chmod 400 /application/nginx/conf/htpasswd
chown www.www /application/nginx/conf/htpasswd
</code></pre>

<blockquote>
<p>有效的配置代码:<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/42809116.jpg" alt=""/></p>
</blockquote>

<blockquote>
<p>修改status.conf作为测试</p>
</blockquote>

<pre><code>server{
    listen  80;
    server_name  status.etiantian.org;
    location / {

    ## status module
    stub_status on;
    access_log   off;

    ## auth module
    auth_basic &quot;root only&quot;;
    auth_basic_user_file /application/nginx/conf/htpasswd;
    }
}
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/38166362.jpg" alt=""/></p></li>
<li><p>补充:</p>

<ol>
<li><p>403错误的两种可能情况</p>

<blockquote>
<p>首页文件名不正确<br/>
配置文件阻止策略</p>
</blockquote></li>
<li><p>autoindex自动索引</p>

<blockquote>
<p>首页文件不存在时,如果设置 autoindex on;浏览器就会将站点目录结构解析出来</p>
</blockquote></li>
<li><p>304的含义</p>

<pre><code>10.0.0.1 - - [10/Aug/2017:11:19:38 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.86 Safari/537.36&quot; &quot;-&quot;
</code></pre>

<blockquote>
<p>意味着浏览器使用了缓存来访问站点<br/>
使用Ctrl+F5强制刷新,不使用缓存记录</p>
</blockquote></li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-11T09:15:30+08:00" itemprop="datePublished">2017/9/11</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E5%BF%83%E6%83%85%E9%9A%8F%E7%AC%94.html'>心情随笔</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15050925305457.html" itemprop="url">
		鸡汤</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li>智商、情商、胆商可以改变局面；知识、见识、胆识可以改变命运。</li>
<li>见人说人话需要学术，见人说神话需要艺术；见人说鬼话叫做“城府”，见鬼说人话叫做“迂腐”。</li>
<li>以克人之心克己，以容己之心容人。4.大胜必经大忍，大败常因心切。</li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-10T13:02:04+08:00" itemprop="datePublished">2017/9/10</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15050197248657.html" itemprop="url">
		卌二、KVM</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>为什么需要KVM</p>

<blockquote>
<p>云计算，OpenStack， 亚马逊<br/>
底层采用KVM，其他xen、docker，esxi<br/>
openstack类似cobbler，</p>

<blockquote>
<p>cobbler给kickstart提供web界面<br/>
    OpenStack给KVM提供web界面管理</p>
</blockquote>

<p>企业使用虚拟化要么就是kvm要么就是docker</p>
</blockquote>

<blockquote>
<p>最开始：没钱，全都用软件<br/>
公司有钱：买硬件<br/>
特别有钱：大部分使用软件</p>
</blockquote></li>
<li><p>技术演变</p>

<ol>
<li><p>软件模拟</p>

<blockquote>
<p>软件模拟，理论上可以模拟任何硬件，甚至是不存在的硬件。但是因为这种方式全部是软件模拟硬件，所以非常低效，一般只用于研究测试的场景。采用这种技术的典型产品有Bochs、 QEMU等。</p>
</blockquote></li>
<li><p>虚拟化层翻译</p>

<blockquote>
<p>1.2.1  软件全虚拟化：软件捕获翻译    ========》你和美国人说话需要一个翻译官<br/>
    VMware，有一个专门虚拟化引擎。通过虚拟化引擎，捕获虚拟机的指令，并进行处理，这也是为什么在虚拟机上虽然使用的是物理机一样的指令，但是虚拟机不能对硬件进行操作的原因，比如重启虚拟机不会引起宿主机的重启。这种解决方案也叫软件全虚拟化方案。</p>
</blockquote>

<blockquote>
<p>1.2.2  半虚拟化：改造虚拟机系统内核加虚拟化层翻译  ====》你学了英语和美国人说话<br/>
    xen，对虚拟机的操作系统内核进行改造，使虚拟机自己对特殊的指令进   行更改，然后和虚拟化层一起配合工作，这也是Xen早期一直要使用一个特殊内核的原因，并且不支持Windows系统虚拟化。改造的虚拟机虽然使用上有限制，配置比较麻烦，但是这种方式效率非常高，这种方式也被称为半虚拟化方案。</p>
</blockquote>

<blockquote>
<p>1.2.3  硬件支持的全虚拟化： 硬件支持的虚拟化层翻译 ==》你重生到美国然后和美国人说话<br/>
    2005年， Intel推出了硬件的方案，对CPU指令进行改造，即VT-x。 这种方案因为是基于硬件的，所以效率非常高，这种方案也称为硬件支持的全虚拟化方案。</p>
</blockquote></li>
<li><p>容器虚拟化</p>

<blockquote>
<p>kvm是在操作系统上安装了另外一个操作系统<br/>
docker是在操作系统上启动一个程序</p>
</blockquote>

<blockquote>
<p>容器虚拟化的原理是基于CGroups、 Namespace等技术将进程隔离，每个进程就像一台单独的虚拟机一样，有自己被隔离出来的资源，也有自己的根目录、独立的进程编号、被隔离的内存空间。基于容器的虚拟化可以实现在单一内核上运行多个实例，因此是一个更高效率的虚拟化方式。目前最热的容器虚拟化技术就是Docker。</p>
</blockquote>

<blockquote>
<p>比喻：一个新建的大楼的某层，如果将他改建成住宅，那就需要每个房间都要有厨房，浴室等正常人家必备设施，一层楼估计能做出3户人家；但是改建成宿舍，什么厨房，浴室就建一个就可以，然后每个宿舍的墙可以打个隔断，很节省资源，基本可以隔出20个。</p>
</blockquote></li>
<li><p>使用场景：</p>

<blockquote>
<p>虚拟化使用场景：对资源要求不高的服务，负载均衡，web服务</p>

<p>数据库，NFS存储对IO资源强烈需求的不建议使用虚拟化</p>
</blockquote></li>
</ol></li>
<li><p>KVM简介</p>

<ol>
<li><p>KVM简介<br/>
<strong><mark>KVM(Kernel-based Virtual Machine)</mark></strong></p>

<blockquote>
<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/4181648.jpg" alt=""/></p>
</blockquote>

<p>虚拟化嵌套</p>

<blockquote>
<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/92932098.jpg" alt=""/><br/>
KVM虚拟机=KVM内核模块+QEMU模拟器</p>

<p>KVM只是个内核模块，只提供CPU和内存。所以还使用qemu模拟器模拟IO设备如磁盘、网卡。</p>
</blockquote>

<blockquote>
<p>Libvirt是一套开源的虚拟化的管理工具，主要由3部分组成：<br/>
    一套API的lib库，支持主流的编程语言，包括C、Python、Ruby 等<br/>
    Libvirtd服务<br/>
    命令行工具virsh<br/>
Libvirt可以实现对虚拟机的管理，比如虚拟机的创建、启动、关闭、暂停、恢复、迁移、销毁，以及虚拟机网卡、硬盘、 CPU、内存等多种设备的热添加。</p>
</blockquote></li>
</ol></li>
<li><p>KVM安装</p>

<ol>
<li><p>环境检查</p>

<blockquote>
<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/56943339.jpg" alt=""/></p>

<pre><code>[root@oldboyedu ~]# cat /etc/redhat-release
CentOS Linux release 7.2.1511 (Core) 
[root@oldboyedu ~]# uname -r
3.10.0-327.el7.x86_64
[root@oldboyedu ~]# systemctl status firewalld.service 
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
[root@oldboyedu ~]# getenforce 
Disabled
[root@oldboyedu ~]# hostname -I
10.0.0.201 172.16.1.201 192.168.122.1 
[root@oldboyedu ~]# lsmod |grep kvm
kvm_intel             162153  0 
kvm                   525259  1 kvm_intel
[root@oldboyedu ~]# grep -Eo &#39;(vmx|svm)&#39; /proc/cpuinfo
vmx
</code></pre>
</blockquote></li>
<li><p>安装管理工具</p>

<blockquote>
<pre><code>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum -y install qemu-kvm qemu-kvm-tools virt-manager libvirt virt-install 
</code></pre>

<p>安装软件包详细说明</p>

<pre><code>[root@KVM ~]# rpm -qa|grep -E &#39;qemu|libvirt|virt&#39;
python-virtinst-0.600.0-29.el6.noarch   # 一套Python的虚拟机安装工具
gpxe-roms-qemu-0.9.7-6.14.el6.noarch    # 虚拟机iPXE的启动固件，支持虚拟机从网络启动
virt-manager-0.9.0-29.el6.x86_64        # 基于Libvirt的图像化虚拟机管理软件，需要图形界面操作系统
qemu-img-0.12.1.2-2.479.el6.x86_64      # 用于操作虚拟机硬盘镜像的创建、查看和格式转化
libvirt-python-0.10.2-54.el6.x86_64     # libvirt为Python提供的API
qemu-kvm-0.12.1.2-2.479.el6.x86_64      # KVM在用户空间运行的程序
qemu-kvm-tools-0.12.1.2-2.479.el6.x86_64
libvirt-0.10.2-54.el6.x86_64            # 用于管理虚拟机，它提供了一套虚拟机操作API
libvirt-client-0.10.2-54.el6.x86_64     # Libvirt的客户端，最重要的功能之一就是就在宿主机关机时可以通知虚拟机也关机，使虚拟机系统正常关机，而不是被强制关机，造成数据丢失
virt-top-1.0.4-3.15.el6.x86_64          # 类似于top命令，查看虚拟机的资源使用情况
virt-what-1.11-1.2.el6.x86_64           # 在虚拟机内部执行，查看虚拟机运行的虚拟化平台
virt-viewer-0.5.6-8.el6.x86_64          # 显示虚拟机的控制台console
</code></pre>
</blockquote></li>
</ol></li>
<li><p>安装KVM虚拟机</p>

<ol>
<li><p>创建磁盘文件</p>

<pre><code>mkdir -p /application/kvm_data
cd /application/kvm_data
qemu-img create -f qcow2 /application/kvm_data/moban.qcow2 20G
</code></pre>

<p>查看虚拟机磁盘的信息</p>

<pre><code>[root@oldboyedu kvm_data]# qemu-img info /application/kvm_data/moban.qcow2
image: /application/kvm_data/moban.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 196K
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
</code></pre></li>
<li><p>执行安装命令（包括上传系统镜像）</p>

<pre><code>virt-install --virt-type=kvm --name=c72-moban --vcpus=1 -r 1024 -c /application/tools/CentOS7_2.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=rhel7 --disk path=/application/kvm_data/moban.qcow2,size=20,format=qcow2
</code></pre>

<p>安装其他虚拟机需要变动的两处：</p>

<pre><code>virt-install --virt-type=kvm --name=xxxxxx --vcpus=1 -r 1024 -c /application/tools/CentOS7_2.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=rhel7 --disk path=/application/kvm_data/xxxx.qcow2,size=20,format=qcow2
</code></pre>

<p><em>小知识：</em><br/>
<em>KVM网络默认是NAT模式</em></p>

<p><em>dnsmasq既提供dns解析服务还提供DHCP服务</em></p></li>
<li><p>管理KVM的操作命令</p>

<p>5.3.1 查看KVM虚拟机</p>

<pre><code>[root@oldboyedu kvm_data]# virsh list
 Id    名称                         状态
----------------------------------------------------

[root@oldboyedu kvm_data]# virsh list --all
 Id    名称                         状态
----------------------------------------------------
 -     c72-moban                      关闭
</code></pre>

<p>5.3.2 启动、关闭</p>

<pre><code>[root@oldboyedu kvm_data]# virsh start c72-moban 
域 c72-moban 已开始

正常关闭：virsh shutdown c72-moban 
暴力关机：virsh destroy c72-moban

当然还可以在kvm虚拟机里面执行poweroff
</code></pre>

<p>5.3.3 连接端口</p>

<pre><code>vnc的默认端口5900
如果再安装或者启动一台新的虚拟机，端口就是5901  ==10.0.0.201:5901
如果再安装或者启动一台新的虚拟机，端口就是5902  ==10.0.0.201:5902
…………

[root@oldboyedu kvm_data]# netstat -tunlp|grep 5900
tcp        0      0 0.0.0.0:5900            0.0.0.0:*               LISTEN      3838/qemu-kvm       
[root@oldboyedu kvm_data]# ps -ef|grep 3838
qemu       3838      1 16 11:39 ?        00:01:02 /usr/libexec/qemu-kvm -name c72-moban -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off -cpu Haswell,-hle,-rtm -m 1024 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid 4453daa6-14d3-4a4c-93e1-ccfced1340f4 -no-user-config …………nc 0.0.0.0:0 -vga cirrus -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x7 -msg timestamp=on
</code></pre>

<p>5.3.4 查看虚拟机的信息</p>

<pre><code>lscpu查看虚拟机的cpu信息

L1d  一级数据缓存
L1i  一级指令缓存
</code></pre>

<p>5.3.5 查看宿主机网卡桥接信息</p>

<pre><code>[root@oldboyedu kvm_data]# brctl show
bridge name bridge id       STP enabled interfaces
virbr0      8000.fe5400b37bac   yes     vnet0
</code></pre>

<p>5.3.6 常用命令汇总    </p>

<blockquote>
<p>生成kvm虚拟机：virt-install<br/>
查看在运行的虚拟机：virsh list<br/>
查看所有虚拟机：virsh list --all<br/>
查看kvm虚拟机配置文件：virsh dumpxml name<br/>
启动kvm虚拟机：virsh start name<br/>
正常关机：virsh shutdown name <br/>
非正常关机（相当于物理机直接拔掉电源）：virsh destroy name<br/>
删除：virsh undefine name（彻底删除，找不回来了，如果想找回来，需要备份/etc/libvirt/qemu的xml文件）<br/>
根据配置文件定义虚拟机：virsh define file-name.xml<br/>
挂起，终止：virsh suspend name<br/>
恢复挂起状态:virsh resume name</p>
</blockquote></li>
</ol></li>
<li><p>磁盘文件格式介绍</p>

<p><a href="http://www.cnblogs.com/feisky/archive/2012/07/03/2575167.html">http://www.cnblogs.com/feisky/archive/2012/07/03/2575167.html</a></p>

<p>主流使用qcow2</p></li>
<li><p>克隆</p>

<ol>
<li><p>复制磁盘文件</p>

<pre><code>[root@oldboyedu kvm_data]# pwd
/application/kvm_data
[root@oldboyedu kvm_data]# ls
moban.qcow2
[root@oldboyedu kvm_data]# cp moban.qcow2 clone.qcow2
</code></pre></li>
<li><p>导出模板机的配置文件并修改</p>

<p>导出模板机的配置</p>

<pre><code>virsh dumpxml c72-moban &gt; clone.xml
cp clone.xml{,.ori}
</code></pre>

<p>第2,3,37,82修改</p>

<pre><code>[root@oldboyedu ~]# diff clone.xml{,.ori}
2,3c2,3
&lt;   &lt;name&gt;c72-clone&lt;/name&gt;
&lt;   &lt;uuid&gt;4453daf6-14d3-4a4c-93e1-ccfced1340f4&lt;/uuid&gt;
---
&gt;   &lt;name&gt;c72-moban&lt;/name&gt;
&gt;   &lt;uuid&gt;4453daa6-14d3-4a4c-93e1-ccfced1340f4&lt;/uuid&gt;
37c37
&lt;       &lt;source file=&#39;/application/kvm_data/clone.qcow2&#39;/&gt;
---
&gt;       &lt;source file=&#39;/application/kvm_data/moban.qcow2&#39;/&gt;
82c82
&lt;       &lt;mac address=&#39;52:54:00:b3:72:ac&#39;/&gt;
---
&gt;       &lt;mac address=&#39;52:54:00:b3:7b:ac&#39;/&gt;
</code></pre></li>
<li><p>导入新的克隆机器</p>

<p>默认kvm的配置文件</p>

<pre><code>[root@oldboyedu ~]# ls /etc/libvirt/qemu
c72-moban.xml  networks
</code></pre>

<p>导入</p>

<pre><code>[root@oldboyedu ~]# virsh define clone.xml
Domain c72-clone defined from clone.xml
</code></pre>

<p>再次查看</p>

<pre><code>[root@oldboyedu ~]# ls /etc/libvirt/qemu
c72-clone.xml  c72-moban.xml  networks
[root@oldboyedu ~]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 2     c72-moban                      running
 -     c72-clone                      shut off
</code></pre></li>
</ol></li>
<li><p>快照</p>

<ol>
<li>创建快照注意事项</li>
</ol>

<blockquote>
<p>磁盘格式要为qcow2<br/>
关机做快照最好，开机也能做快照</p>
</blockquote>

<ol>
<li><p>快照命令</p>

<p>创建快照</p>

<pre><code>virsh snapshot-create-as c72-clone    kuaizhao1
命令   创建快照指令         虚拟机名称     快照名称
</code></pre>

<p>查看快照列表</p>

<pre><code>virsh snapshot-list      c72-clone
命令   查看快照列表指令      虚拟机名称
</code></pre>

<p>查看快照信息</p>

<pre><code>virsh snapshot-info       c72-clone    kuaizhao1
命令   查看指定快照信息指令   虚拟机名称      快照名称
</code></pre>

<p>还原</p>

<pre><code>virsh snapshot-revert     c72-clone    kuaizhao1
命令   还原指定快照指令       虚拟机名称     快照名称
</code></pre>

<p>删除快照</p>

<pre><code>virsh snapshot-delete     c72-clone    kuaizhao1
命令   删除指定快照指令       虚拟机名称     快照名称
</code></pre></li>
</ol></li>
<li><p>图形化管理KVM</p></li>
</ol>

<blockquote>
<h1 id="toc_0">今日总结：</h1>

<ol>
<li>KVM安装</li>
<li>克隆</li>
<li>快照</li>
</ol>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-10T13:00:52+08:00" itemprop="datePublished">2017/9/10</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15050196529102.html" itemprop="url">
		卌一、CentOS 7</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li>回顾kickstart和cobbler</li>
</ol>

<p>在管理机m01安装kickstart服务端，然后用服务端自动安装了一个新的CentOS系统，然后给这个Vmware虚拟机起了个名字叫cobbler。到此，kickstart课程结束。</p>

<p>第二天，需要安装cobbler服务器，顺便用了昨天我们安装的机器，安装完cobbler服务端，我们又安装一台新系统。</p>

<p>cobbler二大功能：自动安装系统、创建yum仓库</p>

<p>CentOS7 TFTP启动<br/>
systemctl start tftp.socket<br/>
systemctl start tftp.server</p>

<ol>
<li><p>开机启动流程</p>

<blockquote>
<p>init系统：Shell脚本执行的特色：串行执行，从上往下执行<br/>
upstart系统：有依赖的关系的依然串行启动，但是没有依赖关系的就并行启动  initctl start onealert<br/>
systemd：基本上所有服务并行启动</p>
</blockquote></li>
<li><p>三种启动技术对比<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/52142850.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/99741039.jpg" alt=""/></p>

<blockquote>
<p>并发启动原理之一：解决 socket 依赖/端口依赖<br/>
并发启动原理之二：解决 D-Bus 依赖：采用了D-Bus作为程序之间的通信工具，类似消息队列，可以缓存信息。<br/>
并发启动原理之三：解决文件系统依赖：类似autofs机制<br/>
不用的时候就不挂载，用的时候帮你执行mount挂载<br/>
centos7没有按照autofs软件，但是底层实现相同功能<br/>
启动过程：磁盘自检--文件系统自检--挂载<br/>
除了/分区是必须用的，centos7只对开机必须的文件系统进行检查然后挂载。其他非必须分区，用的时候在检查挂载</p>
</blockquote></li>
<li><p>文件系统</p>

<blockquote>
<p>ext2/ext3/ext4  1PB=1024T 1T=1024G<br/>
xfs:专门为大数据设计的系统  格式化成xfs特别快<br/>
LVM的优点：动态增加或减少分区大小，但是会消耗一定的性能</p>
</blockquote></li>
<li><p>CentOS7新增功能</p>

<ol>
<li><p>yum源无需优化了，因此采用mirrorlist功能，自动找到最优的yum仓库</p>

<p>安装vim：</p>

<pre><code>yum -y install vim
</code></pre>

<p>tab补全：</p>

<pre><code>yum install -y bash-completion
</code></pre></li>
<li><p>网卡名称修改</p>

<p>修改内核选项，net.ifnames=0 biosdevname=0</p>

<p>已经安装完系统修改<br/>
<a href="http://oldboy.blog.51cto.com/2561410/1722101">http://oldboy.blog.51cto.com/2561410/1722101</a></p></li>
<li><p>网络管理命令</p>

<p>传统派：ifconfig netstat route   yum -y install net-tools  rpm -ql net-tools<br/>
新星派：ip ss                    yum -y install iproute</p>

<p>新一代的网络管理图形工具：nmtui   (network manager text user interface)</p></li>
<li><p>主机名等配置文件</p>

<p>4.1 主机名配置文件</p>

<blockquote>
<p>CentOS6--&gt; /etc/sysconfig/network<br/>
CentOS7--&gt; /etc/hostname</p>
</blockquote>

<p>CentOS6--&gt; 临时改hostname 主机名  + 永久改 改配置文件<br/>
CentOS7--&gt; hostnamectl</p>

<pre><code>[root@CentOS7 ~]# hostnamectl status
   Static hostname: CentOS7
         Icon name: computer-vm
           Chassis: vm
        Machine ID: 506a64e53f764d36bc96a5321abbf965
           Boot ID: 2944378099d34f43a01c8052ee537bbd
    Virtualization: vmware
  Operating System: CentOS Linux 7 (Core)
       CPE OS Name: cpe:/o:centos:centos:7
            Kernel: Linux 3.10.0-327.el7.x86_64
      Architecture: x86-64

[root@CentOS7 ~]# hostnamectl set-hostname oldboyedu
[root@oldboyedu ~]# cat /etc/hostname 
oldboyedu
</code></pre>

<p>4.2 字符集的配置文件</p>

<blockquote>
<p>CentOS6--&gt; /etc/sysconfig/i18n<br/>
CentOS7--&gt; /etc/locale.conf</p>
</blockquote>

<pre><code>[root@oldboyedu ~]# cat /etc/locale.conf 
LANG=zh_CN.UTF-8
[root@oldboyedu ~]# localectl status
   System Locale: LANG=zh_CN.UTF-8
       VC Keymap: us
      X11 Layout: us
[root@oldboyedu ~]# localectl list-locales 
aa_DJ
aa_DJ.iso88591
aa_DJ.utf8
…………

[root@oldboyedu ~]# localectl set-locale LANG=en_US.UTF-8
[root@oldboyedu ~]# localectl status
   System Locale: LANG=en_US.UTF-8
       VC Keymap: us
      X11 Layout: us
[root@oldboyedu ~]# cat /etc/locale.conf 
LANG=en_US.UTF-8
</code></pre>

<p>4.3  系统时间事情</p>

<pre><code>[root@oldboyedu ~]# timedatectl --help
timedatectl [OPTIONS...] COMMAND ...

Query or change system time and date settings.

[root@oldboyedu ~]# ll -h /etc/localtime
lrwxrwxrwx. 1 root root 35 4月  21 20:02 /etc/localtime -&gt; ../usr/share/zoneinfo/Asia/Shanghai
</code></pre>

<p>4.4 rc.local</p>

<blockquote>
<p>使用CentOS 6 shell脚本开机启动的方法</p>

<pre><code>chmod +x /etc/rc.d/rc.local
</code></pre>
</blockquote>

<p>4.5 运行级别</p>

<pre><code>[root@oldboyedu ~]# systemctl get-default
graphical.target
[root@oldboyedu ~]# systemctl set-default multi-user.target
Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/multi-user.target.
[root@oldboyedu ~]# systemctl get-default
multi-user.target
[root@oldboyedu ~]# systemctl set-default graphical.target
Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/graphical.target.
</code></pre>

<p>4.6 systemd一统天下</p>

<blockquote>
<p>看看从前的runlevel都变成什么样了？</p>

<pre><code>ls -lh /usr/lib/systemd/system/runlevel*.target
</code></pre>
</blockquote>

<blockquote>
<p>所有可用的单元文件存放在/usr/lib/systemd/system/和/etc/systemd/system/目录（后者优先级更高）。</p>

<pre><code>ll -h /etc/systemd/system/default.target
</code></pre>
</blockquote>

<blockquote>
<p>区别6：管理服务<br/>
chkconfig：管理开机自启动<br/>
service  ：服务的开启<br/>
/etc/init.d/：服务的开启</p>
</blockquote>

<blockquote>
<p>systemctl:融合service和chkconfig的功能于一体,兼容SysV和LSB的启动脚本，而且够在进程启动过程中更有效地引导加载服务。。</p>

<p>启动时间优化</p>

<pre><code>systemd-analyze time
systemd-analyze blame
systemd-analyze plot &gt; bootime.svg
</code></pre>
</blockquote></li>
</ol>

<p>学习文档（中文）：<br/>
<a href="http://www.jinbuguo.com/systemd/systemd.service.html">http://www.jinbuguo.com/systemd/systemd.service.html</a><br/>
<a href="https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/index.html">https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/index.html</a></p></li>
<li><p>服务<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/13610704.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/38773206.jpg" alt=""/></p></li>
</ol>

<blockquote>
<h1 id="toc_0">今日总结</h1>

<ol>
<li>安装系统</li>
<li>复习centos7新功能</li>
<li>熟练掌握centos7命令</li>
</ol>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-10T12:08:22+08:00" itemprop="datePublished">2017/9/10</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15050165021812.html" itemprop="url">
		四十、自动化安装 (二) -- cobbler</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>自动化的前提是标准化</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/57384517.jpg" alt=""/></p>

<ol>
<li><p>KS自动应答文件</p>

<p>作用：</p>

<blockquote>
<p>将我们手动安装的所有步骤以一个固定的格式写入到这个文件中。从此以后系统的安装程序只需要读取这个文件就可以自动安装系统。</p>
</blockquote>

<blockquote>
<p>anaconda-ks.cfg    anaconda就是安装程序的名字 ks kickstart</p>
</blockquote>

<p>ks文件主要分为三大段：</p>

<blockquote>
<p>命令段（里面的参数排序不分先后）<br/>
包组段（以%packages）一个包组包含若干个rpm包<br/>
脚本段（%post）</p>
</blockquote></li>
<li><p>kickstart自动安装操作系统<br/>
<a href="15050152527420.html">kickstart 自动批量的安装操作系统</a></p></li>
<li><p>cobbler自动安装操作系统</p></li>
</ol></li>
<li><p>使用学校的yum仓库</p>

<pre><code>echo &quot;192.168.14.200 mirrors.aliyun.com&quot; &gt;&gt;/etc/hosts
</code></pre></li>
<li><p>安装cobbler</p>

<pre><code>yum -y install cobbler cobbler-web dhcp tftp-server pykickstart httpd
</code></pre></li>
<li><p>cobbler自检</p>

<pre><code>cobbler check
</code></pre></li>
<li><p>修改配置文件</p>

<pre><code>cp /etc/cobbler/settings{,.ori} 
</code></pre></li>
<li><p>manage_dhcp  cobbler管理DHCP</p></li>
<li><p>pxe_just_once  只能装一次系统，防止重装</p>

<pre><code>sed -i &#39;s/server: 127.0.0.1/server: 172.16.1.121/&#39; /etc/cobbler/settings
sed -i &#39;s/next_server: 127.0.0.1/next_server: 172.16.1.121/&#39; /etc/cobbler/settings
sed -i &#39;s/manage_dhcp: 0/manage_dhcp: 1/&#39; /etc/cobbler/settings
sed -i &#39;s/pxe_just_once: 0/pxe_just_once: 1/&#39; /etc/cobbler/settings
sed -ri &quot;/default_password_crypted/s#(.*: ).*#\1\&quot;`openssl passwd -1 -salt &#39;oldboy&#39; &#39;123456&#39;`\&quot;#&quot; /etc/cobbler/settings
sed -i &#39;s#yes#no#&#39; /etc/xinetd.d/rsync
sed -i &#39;s#yes#no#&#39; /etc/xinetd.d/tftp
</code></pre></li>
<li><p>cobbler get-loaders  下面是免下载方法</p>

<pre><code>tar xfP cobbler_load.tar.gz
</code></pre></li>
<li><p>配置DHCP的配置文件的模板</p>

<pre><code>sed -i &#39;s#192.168.1#172.16.1#g;22d;23d&#39; /etc/cobbler/dhcp.template
</code></pre></li>
<li><p>启动服务</p>

<pre><code>/etc/init.d/xinetd restart
/etc/init.d/cobblerd restart
/etc/init.d/httpd restart
</code></pre></li>
<li><p>只要动了配置文件，就需要执行同步命令</p>

<pre><code>cobbler sync
</code></pre></li>
<li><p>访问网页</p>

<p><a href="http://10.0.0.121/cobbler_web">http://10.0.0.121/cobbler_web</a></p>

<blockquote>
<p>用户名：cobbler<br/>
密码：cobbler</p>
</blockquote></li>
<li><p>导入镜像<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/30801238.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/24513241.jpg" alt=""/></p></li>
<li><p>添加KS文件<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/66316311.jpg" alt=""/><br/>
文件名： CentOS-6.9-x86_64.cfg<br/>
内容：</p>

<pre><code># Cobbler for Kickstart Configurator for CentOS 6.9 by yao zhang
install
url --url=$tree
text
lang en_US.UTF-8
keyboard us
zerombr
bootloader --location=mbr --driveorder=sda --append=&quot;crashkernel=auto rhgb quiet&quot;
$SNIPPET(&#39;network_config&#39;)
timezone --utc Asia/Shanghai
authconfig --enableshadow --passalgo=sha512
rootpw  --iscrypted $default_password_crypted
clearpart --all --initlabel
part /boot --fstype=ext4 --asprimary --size=200
part swap --size=1024
part / --fstype=ext4 --grow --asprimary --size=200
firstboot --disable
selinux --disabled
firewall --disabled
logging --level=info
reboot

%pre
$SNIPPET(&#39;log_ks_pre&#39;)
$SNIPPET(&#39;kickstart_start&#39;)
$SNIPPET(&#39;pre_install_network_config&#39;)
# Enable installation monitoring
$SNIPPET(&#39;pre_anamon&#39;)
%end

%packages
@base
@compat-libraries
@debugging
@development
tree
nmap
sysstat
lrzsz
dos2unix
telnet
%end

%post --nochroot
$SNIPPET(&#39;log_ks_post_nochroot&#39;)
%end

%post
$SNIPPET(&#39;log_ks_post&#39;)
# Start yum configuration
$yum_config_stanza
# End yum configuration
$SNIPPET(&#39;post_install_kernel_options&#39;)
$SNIPPET(&#39;post_install_network_config&#39;)
$SNIPPET(&#39;func_register_if_enabled&#39;)
$SNIPPET(&#39;download_config_files&#39;)
$SNIPPET(&#39;koan_environment&#39;)
$SNIPPET(&#39;redhat_register&#39;)
$SNIPPET(&#39;cobbler_register&#39;)
# Enable post-install boot notification
$SNIPPET(&#39;post_anamon&#39;)
# Start final steps
$SNIPPET(&#39;kickstart_done&#39;)
# End final steps
%end
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/85271879.jpg" alt=""/></p></li>
<li><p>如何用cobbler配置YUM仓库</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/16638440.jpg" alt=""/><br/>
<a href="https://mirrors.aliyun.com/centos/6/os/x86_64/">Indexof/centos/6/os/x86_64/</a><br/>
<a href="https://mirrors.aliyun.com/centos/6/os/x86_64/">https://mirrors.aliyun.com/centos/6/os/x86_64/</a><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/15071045.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/51017309.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/59439046.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/27300956.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/66057658.jpg" alt=""/></p></li>
<li><p>自定义安装操作系统</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/3412012.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/29801964.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/99430010.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/3223783.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/40298229.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/15577609.jpg" alt=""/></p></li>
</ol>

<blockquote>
<h1 id="toc_0">今日总结：</h1>

<ol>
<li>kickstart自动安装 ---配置文件保证无误</li>
<li>cobbler安装成功</li>
<li><p>cobbler web界面非常简单，看一下视频补一下步骤</p>

<p>--导入镜像<br/>
--添加ks，并关联镜像<br/>
--同步公网yum仓库功能（把公网rpm下载到cobbler的自己的仓库中），并让镜像关联cobbler的yum仓库（让cobbler的yum仓库提供yum服务）<br/>
--自定义安装操作系统 使用system功能</p></li>
</ol>
</blockquote>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/29141985.jpg" alt=""/></p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-10T11:47:32+08:00" itemprop="datePublished">2017/9/10</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15050152527420.html" itemprop="url">
		卅九、自动批量的安装操作系统 -- kickstart</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>以前是怎么安装系统的</p>

<blockquote>
<ul>
<li>光盘（ISO文件，光盘的镜像文件）===》每一台物理机都得给一个光驱，如果用外置光驱的话，是不是每台机器都需要插一下</li>
<li>U盘：ISO镜像刻录到U盘==》需要每台机器都需要插一下</li>
<li>并行安装==》网络安装</li>
<li>自动化安装</li>
</ul>
</blockquote>

<blockquote>
<p>备注：（WDS，需要安装在Windows Server 2008）</p>
</blockquote></li>
<li><p>Linux系统批量安装</p>

<blockquote>
<p>kickstart是RedHat公司开源的软件，所以对CentOS兼容性最好。</p>
</blockquote>

<blockquote>
<p>原理：我们将手动安装的所有的详细步骤记录到一个文件中，然后kickstart通过读取这个文件就可以实现自动化安装系统。</p>
</blockquote>

<blockquote>
<p>kickstart是一个项目的名称。没有这个软件。使用者水平是高中以上</p>
</blockquote>

<blockquote>
<p>cobbler是对kickstart的所有组件的封装。使用者水平是初中以上。本质上就是网页版本的kickstart。</p>
</blockquote></li>
<li><p>kickstart的原理及组件<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/52469894.jpg" alt=""/></p></li>
<li><p>安装DHCP服务<br/>
环境准备</p>

<pre><code>[root@m01 ~]# cat /etc/redhat-release 
CentOS release 6.9 (Final)
[root@m01 ~]# uname -r
2.6.32-696.el6.x86_64
[root@m01 ~]# getenforce 
Disabled
[root@m01 ~]# /etc/init.d/iptables status
iptables: Firewall is not running.
[root@m01 ~]# hostname -I
10.0.0.61 172.16.1.61 
[root@m01 ~]# netstat -tunlp|grep 80  #==&gt; 没有80端口占用
[root@m01 ~]# echo &quot;192.168.14.200 mirrors.aliyun.com&quot; &gt;&gt;/etc/hosts
</code></pre>

<p>安装DHCP</p>

<pre><code>[root@m01 ~]#  yum -y install dhcp
</code></pre>

<p>配置DHCP</p>

<pre><code>cat &gt;&gt;/etc/dhcp/dhcpd.conf&lt;&lt;EOF
subnet 172.16.1.0 netmask 255.255.255.0 {
        range 172.16.1.120 172.16.1.200;
        option subnet-mask 255.255.255.0;
        default-lease-time 21600;
        max-lease-time 43200;
        next-server 172.16.1.61;
        filename &quot;/pxelinux.0&quot;;
}
EOF
</code></pre>

<p>启动dhcp查看日志</p>

<pre><code>[root@m01 ~]# /etc/init.d/dhcpd start
Starting dhcpd:                                            [  OK  ]
[root@m01 ~]# netstat -tunlp|grep dhcp
udp        0      0 0.0.0.0:67                  0.0.0.0:*                               88874/dhcpd         
[root@m01 ~]#

[root@m01 ~]# tailf /var/log/messages
</code></pre>

<p>DHCP服务对kickstart系统的影响程度</p>

<p>新建空白虚拟机，建完后做快照。<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/33358046.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/88796927.jpg" alt=""/></p>

<p>TFTP没有最终报错<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/36984203.jpg" alt=""/></p></li>
<li><p>安装TFTP服务</p>

<p>安装</p>

<pre><code>[root@m01 ~]# yum -y install tftp-server
</code></pre>

<p>配置</p>

<pre><code>sed -i &#39;14s#yes#no#&#39; /etc/xinetd.d/tftp
</code></pre>

<p>启动</p>

<pre><code>/etc/init.d/xinetd restart
[root@m01 ~]# netstat -tunlp|grep 69
udp        0      0 0.0.0.0:69                  0.0.0.0:*                               90419/xinetd  
</code></pre>

<p>TFTP服务对kickstart系统的影响程度<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/55045879.jpg" alt=""/></p>

<p>上面报错是在TFTP服务的根目录找不到启动文件pxelinux.0</p>

<pre><code>[root@m01 ~]# cd /var/lib/tftpboot/ # TFTP服务的根目录
[root@m01 tftpboot]# ls
[root@m01 tftpboot]#
[root@m01 ~]# yum -y install syslinux  # 为了找到pxelinux.0所以下载这个包
[root@m01 ~]# cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/13240529.jpg" alt=""/></p>

<blockquote>
<p>上面的错误是因为pxelinux.0这个小系统的配置文件（default）不存在，或者文件名不对</p>
</blockquote>

<p>如何找到这个配置文件</p>

<blockquote>
<p>第一步：挂载镜像</p>
</blockquote>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/63390276.jpg" alt=""/></p>

<blockquote>
<p>第二步</p>
</blockquote>

<pre><code>[root@m01 ~]# mkdir -p /var/www/html/CentOS6.9
[root@m01 ~]# mount /dev/cdrom /var/www/html/CentOS6.9
mount: block device /dev/sr0 is write-protected, mounting read-only
</code></pre>

<blockquote>
<p>第三步：从镜像中找到相关的配置文件</p>
</blockquote>

<pre><code>cp -a /var/www/html/CentOS6.9/isolinux/* /var/lib/tftpboot/
mkdir -p /var/lib/tftpboot/pxelinux.cfg
cp /var/www/html/CentOS6.9/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default
</code></pre></li>
<li><p>手动网络安装系统</p>

<p>自动化安装操作系统，如果弹出下面图片，属于一种错误<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/46803619.jpg" alt=""/><br/>
你得某个配置文件有没有指明选择哪块</p>

<p>在配置DHCP获取IP地址时<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/63278413.jpg" alt=""/></p>

<p>碰到错误2<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/87541235.jpg" alt=""/><br/>
核心：找不到DHCP服务端<br/>
情况1：选择网卡错了，选成eth0<br/>
情况2：<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/58027147.jpg" alt=""/>颠倒</p></li>
<li><p>安装HTTP服务<br/>
作用1：提供自动应答文件下载<br/>
作用2：提供安装系统所需的所有rpm包下载</p>

<pre><code>[root@m01 ~]# yum -y install httpd
[root@m01 ~]# /etc/init.d/httpd restart
</code></pre>

<p>检查步骤</p>

<pre><code>http://10.0.0.61/CentOS6.9/
curl http://172.16.1.61/CentOS6.9/
</code></pre>

<p>web服务不正常或者URL地址不正确会出现下面的问题<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/24466191.jpg" alt=""/></p>

<p>如果自动化安装出现上面的报错</p></li>
<li><p>补充知识点：default配置文件</p>

<pre><code>[root@m01 tftpboot]# pwd
/var/lib/tftpboot
[root@m01 tftpboot]# cd pxelinux.cfg/
[root@m01 pxelinux.cfg]# vim default
</code></pre></li>
<li><p>不该出现的错误<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-10/41992775.jpg" alt=""/><br/>
报错原因：selinux没关<br/>
<a href="http://blog.oldboyedu.com/autoinstall-kickstart/">http://blog.oldboyedu.com/autoinstall-kickstart/</a></p></li>
</ol>

<blockquote>
<p>今日总结：<br/>
1. kickstart的三大组件的作用，能描述图片内容<br/>
2. 安装3大组件，配置<br/>
3. 重点是掌握排错技能<br/>
4. 具体的配置文件的说明见<a href="http://blog.oldboyedu.com/autoinstall-kickstart/">http://blog.oldboyedu.com/autoinstall-kickstart/</a></p>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-09T22:30:00+08:00" itemprop="datePublished">2017/9/9</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15049674009290.html" itemprop="url">
		卅八、memcache及session共享</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><p>前言--数据库</p>

<blockquote>
<p>MySQL：数据最终是存放在磁盘上的<br/>
内存 和 磁盘 对比：<br/>
内存快，磁盘慢；<br/>
内存是断电数据丢失，磁盘只要是正常断电数据不丢数据</p>
</blockquote>

<blockquote>
<p>当我们生产环境是一个高并发大流量的网站<br/>
使用mysql时，会出现mysql进程占用cpu高，系统负载是CPU核数几十倍或百倍，此时MYSQL不顶用；<br/>
此时缓存（内存）数据库隆重登场，</p>
</blockquote>

<blockquote>
<p>常见的内存数据库：memcache、Redis、MongoDB</p>
</blockquote>

<p><strong>企业生产场景：MySQL（数据仓库）+内存数据库（提供业务服务）  搭配使用</strong></p>

<blockquote>
<p>内存数据库的缺点：<br/>
某些产品数据不做持久化（数据存在磁盘上）<br/>
内存数据库目的是为更快效率更高，但是这种能力是牺牲数据安全<br/>
数据出问题了还可以到MySQL去校验</p>
</blockquote></li>
<li><p>介绍memcache</p>

<blockquote>
<p>Memcached是一款开源的、高性能的纯内存缓存服务软件。Mem是内存的意思，cache是缓存的意思，d是daemon的意思。</p>
</blockquote>

<blockquote>
<p>Memcache是项目的名字，诞生于2003年。Memcache服务分为客户端和服务端两部分，C/S架构。</p>
</blockquote>

<blockquote>
<p>客户端软件memcache-2.25.tar.gz<br/>
服务端软件memcached-1.4.13.tar.gz</p>
</blockquote>

<blockquote>
<p>C/S  client/server <br/>
B/S  browser/server</p>
</blockquote>

<blockquote>
<p>在启动Memcached时，根据指定的内存大小参数，会被分配一个内存空间。当我们读取数据库的各类业务数据后，数据会同时放入Memcached缓存中，当下一次用户请求同样的数据，程序直接去Memcached取数据返回给用户。</p>
</blockquote>

<blockquote>
<p>优点：</p>

<blockquote>
<p>①对于用户来讲，用户访问网站更快了，体验更好了。</p>
</blockquote>

<blockquote>
<p>②对网站来说，数据库压力降低了。只有当内存没有数据时才会去请求数据库。第一次写入的数据也会请求数据库。一般公司没有预热，只有当用户读取过数据库才会放到Memcached中。</p>
</blockquote>

<blockquote>
<p>③提升了网站的并发访问，减少服务器数量。</p>
</blockquote>
</blockquote></li>
<li><p>Memcached在企业中使用场景</p>

<p>3.1 作为数据库的前端缓存<br/>
3.2 作为session会话保持</p>

<blockquote>
<p>cookies：网站程序存放在浏览器的一段字符串，作用是如同你的身份证，或者阿泰的vip会员卡</p>
</blockquote>

<blockquote>
<p>你的卡    包子店的电脑<br/>
会员ID==》去电脑中的数据库查找对应ID的所有信息。比如余额<br/>
cookies   session（存放相应的cookies的对应所有信息，比如你的姓名，性别...电话等）</p>
</blockquote>

<blockquote>
<p>session：存放在服务器的磁盘上；服务器通过磁盘上有无session来判断你是否登录</p>

<p>最开始，开发者将所有信息存放在cookies，不安全。<br/>
为了安全，cookies只存放id。然后用户通过cookies去服务器上找到对应的session</p>
</blockquote>

<blockquote>
<p>session共享方案：</p>

<blockquote>
<p>1.session是以文件的形式存放：通过文件共享方式，nfs、rsync、intotify、sersync、scp</p>
</blockquote>

<blockquote>
<p>2.session是以字符串的形式存放在数据库之中：mysql、memcache</p>
</blockquote>
</blockquote></li>
<li><p>Memcached分布式缓存集群</p>

<blockquote>
<p>memcache数据是存放内存中，常规最大内存128G<br/>
MYSQL 1T ==&gt;10台memcache<br/>
数据分开，程序不知道你的数据放哪了<br/>
memcache天生不支持集群</p>
</blockquote>

<blockquote>
<p>解决方案：memcache本身不支持，那么我自己写程序就是了<br/>
如果以一定规律存放数据，<br/>
那么可以根据这个规律找到数据</p>
</blockquote>

<blockquote>
<p>重点：一致性哈希<br/>
<a href="http://blog.csdn.net/cywosp/article/details/23397179">http://blog.csdn.net/cywosp/article/details/23397179</a></p>
</blockquote></li>
<li><p>安装使用memcache<br/>
5.1 环境准备</p>

<pre><code>[root@web02 ~]# cat /etc/redhat-release 
CentOS release 6.9 (Final)
[root@web02 ~]# uname -r
2.6.32-696.el6.x86_64
[root@web02 ~]# getenforce 
Disabled
[root@web02 ~]# /etc/init.d/iptables status
iptables: Firewall is not running.
[root@web02 ~]# hostname -I
10.0.0.7 172.16.1.7 
</code></pre>

<p>5.2 安装memcached</p>

<pre><code>[root@web02 ~]# echo &quot;192.168.14.200 mirrors.aliyun.com&quot; &gt;&gt;/etc/hosts
[root@web02 ~]# yum -y install memcached
</code></pre>

<p>5.3 启动memcached</p>

<pre><code>[root@web02 ~]# /etc/init.d/memcached start
[root@web02 ~]# netstat -tunlp|grep mem
tcp        0      0 0.0.0.0:11211               0.0.0.0:*                   LISTEN      14883/memcached     
tcp        0      0 :::11211                    :::*                        LISTEN      14883/memcached     
udp        0      0 0.0.0.0:11211               0.0.0.0:*                               14883/memcached     
udp        0      0 :::11211                    :::*                                    14883/memcached    
</code></pre>

<blockquote>
<p>-p <num>      指定TCP监听端口号，默认11211<br/>
-l <addr>     绑定监听的网卡。默认所有网卡<br/>
-d            后台运行<br/>
-u <username> 指定用户运行memcache<br/>
-m <num>      指定分配给memcahe内存空间大小，默认64M。<br/>
-c <num>      并发访问连接数，默认1024<br/>
-P <file>     指定pid存放文件名</p>
</blockquote>

<p>5.4 使用memcache</p>

<blockquote>
<p>memcahe数据类型只有一种：键值对 key-value<br/>
\r换行 相当于回车 \n新行</p>
</blockquote>

<blockquote>
<p>stored 英[stɔ:d]<br/>
美[stɔ:d]<br/>
adj.    存储的; 存信息的;</p>
</blockquote>

<pre><code>[root@web02 ~]# printf &quot;set key008 0 0 10\r\noldboy0987\r\n&quot;|nc 127.0.0.1 11211
STORED

set key008 0 0 10\r\noldboy0987\r\n
</code></pre>

<blockquote>
<p>set：写入，插入  mysql--insert  memcache--set<br/>
zabbix自定义监控:key，value(shell command)<br/>
memcahed存储数据格式为：key--value  oldboy--123456  set oldboy 。。。。  get oldboy<br/>
key008  : 就是一个存放在memcahed的一个key<br/>
0  ：flags<br/>
0  ：超时时间，如果值为0，表示永不过期，其他值单位为秒，<br/>
10 ：准备给key定义的value的值长度<br/>
oldboy0987 ：value值</p>
</blockquote>

<pre><code>[root@web02 ~]# printf &quot;get key008\r\n&quot;|nc 127.0.0.1 11211
VALUE key008 0 10
oldboy0987
END
</code></pre>

<p>完整例子</p>

<pre><code>[root@web02 ~]# printf &quot;set key008 0 0 10\r\noldboy0987\r\n&quot;|nc 127.0.0.1 11211
STORED
[root@web02 ~]# printf &quot;set key009 0 0 10\r\noldboy09876\r\n&quot;|nc 127.0.0.1 11211
CLIENT_ERROR bad data chunk
ERROR
[root@web02 ~]# printf &quot;get key009\r\n&quot;|nc 127.0.0.1 11211
END
[root@web02 ~]# printf &quot;get key008\r\n&quot;|nc 127.0.0.1 11211
VALUE key008 0 10
oldboy0987
END
[root@web02 ~]# printf &quot;set key009 0 10 11\r\noldboy09876\r\n&quot;|nc 127.0.0.1 11211
STORED
[root@web02 ~]# printf &quot;get key009\r\n&quot;|nc 127.0.0.1 11211
VALUE key009 0 11
oldboy09876
END
[root@web02 ~]# printf &quot;get key009\r\n&quot;|nc 127.0.0.1 11211
END
[root@web02 ~]# printf &quot;delete key008\r\n&quot;|nc 127.0.0.1 11211
DELETED
[root@web02 ~]# printf &quot;get key008\r\n&quot;|nc 127.0.0.1 11211
END
</code></pre>

<p>5.5 监控memcached</p>

<pre><code>[root@web02 ~]# printf &quot;stats\r\n&quot;|nc 127.0.0.1 11211
</code></pre>

<blockquote>
<p>命中率：hits数量/总数<br/>
要求命中率越高越好</p>
</blockquote>

<blockquote>
<p>①监听port或进程<br/>
②可以模拟用户先set后get，比对get内容是不是set的。crond nagios zabbix<br/>
③监控命中百分比<br/>
④监控响应时间及需要的状态<br/>
可以用gnuplot、rrdtool等绘图工具出图。</p>
</blockquote></li>
<li><p>memcahe客户端（PHP版本）</p>

<blockquote>
<p>/application/php/bin/php -m 查看PHP支持的模块<br/>
上传memcache-2.2.5.tgz</p>
</blockquote>

<p>编译安装客户端</p>

<pre><code>tar zxvf memcache-2.2.5.tgz
cd memcache-2.2.5
/application/php/bin/phpize
./configure --enable-memcache --with-php-config=/application/php/bin/php-config --with-zlib-dir
make
make install
</code></pre>

<p>配置php支持memcahe</p>

<pre><code>sed -i &#39;$a extension=memcache.so&#39; /application/php/lib/php.ini
pkill php
/application/php/sbin/php-fpm -t
/application/php/sbin/php-fpm
/application/php/bin/php -m|grep memcache
</code></pre></li>
<li><p>写程序支持memcahed存储数据</p>

<pre><code>[root@web02 memcache-2.2.5]# cat /application/nginx/html/blog/mc.php
&lt;?php
    $memcache = new Memcache;
    $memcache-&gt;connect(&#39;127.0.0.1&#39;, 11211) or die (&quot;Could not connect&quot;);
    $memcache-&gt;set(&#39;key20170901&#39;, &#39;oldboy0326&#39;);
    $get_value = $memcache-&gt;get(&#39;key20170901&#39;);
    echo $get_value;
?&gt;
</code></pre>

<p>访问网页<a href="http://blog.etiantian.org/mc.php">http://blog.etiantian.org/mc.php</a></p>

<pre><code>[root@web02 memcache-2.2.5]# printf &quot;get key20170901\r\n&quot;|nc 127.0.0.1 11211
VALUE key20170901 0 10
oldboy0326
END
</code></pre></li>
<li><p>支持session共享，使用memcahed存储session</p>

<pre><code>[root@web02 memcache-2.2.5]# grep session.save_path /application/php/lib/php.ini 
;session.save_path = &quot;/tmp&quot;

sed -i &#39;s#session.save_handler = files#session.save_handler = memcache#;$a session.save_path = &quot;tcp://127.0.0.1:11211&quot;&#39; /application/php/lib/php.ini

pkill php
/application/php/sbin/php-fpm -t
/application/php/sbin/php-fpm
</code></pre>

<blockquote>
<p>访问：<a href="http://blog.etiantian.org/test_info.php">http://blog.etiantian.org/test_info.php</a></p>

<p>访问：<a href="http://blog.etiantian.org/sess.php">http://blog.etiantian.org/sess.php</a></p>
</blockquote>

<blockquote>
<p>session_time:1501382375<br/>
now_time:1501382375<br/>
session_id:4g8q1j5dg244otv5drrrntol72</p>
</blockquote>

<pre><code>[root@web02 memcache-2.2.5]# printf &quot;get 4g8q1j5dg244otv5drrrntol72\r\n&quot;|nc 127.0.0.1 11211
VALUE 4g8q1j5dg244otv5drrrntol72 0 26
session_time|i:1501382375;
END
</code></pre></li>
<li><p>通过网页管理memcahed</p>

<blockquote>
<p>上传memadmin-1.0.12.tar.gz</p>
</blockquote>

<pre><code>[root@web02 tools]# tar xf memadmin-1.0.12.tar.gz -C /application/nginx/html/blog/
[root@web02 tools]# cd /application/nginx/html/blog/
[root@web02 blog]# ls memadmin/

http://blog.etiantian.org/memadmin/

[root@web02 memadmin]# pwd
/application/nginx/html/blog/memadmin
[root@web02 memadmin]# vim config.php 
&lt;?php
if (!defined(&#39;IN_MADM&#39;)) exit();

$config[&#39;user&#39;] = &quot;admin&quot;; // your username
$config[&#39;passwd&#39;] = &quot;admin&quot;; // your password
</code></pre></li>
<li><p>wordpress将数据存入memcahed</p>

<p>前提：你有现成程序支持</p>

<blockquote>
<p>WordPress 会自动检查在 wp-content 目录下是否有 object-cache.php 文件，如果有，直接调用它作为 WordPress 对象缓存机制。</p>
</blockquote>

<pre><code>[root@web02 memadmin]# cd /application/nginx/html/blog/wp-content/
[root@web02 memadmin]# rz object-cache.php
[root@web02 wp-content]# ls
index.php  languages  object-cache.php  plugins  themes  uploads
</code></pre>

<p>memcache 2种使用场景</p>

<ol>
<li><p>作为mysql的盾牌：例子：wordpress object-cache.php</p>

<blockquote>
<p>需要配置：</p>
</blockquote>

<blockquote>
<p>①有memcahe.so模块 《==编译安装客户端memcache-2.2.5.tgz</p>
</blockquote>

<blockquote>
<p>②配置php.ini:<br/>
添加extension=memcache.so ==》能够让php找到memcache客户端，然后能够将数据发送给客户端</p>
</blockquote>

<pre><code>[root@web02 wp-content]# ls /application/php-5.5.32/lib/php/extensions/no-debug-non-zts-20121212/
memcache.so
</code></pre>

<blockquote>
<p>③怎么找到服务端？怎么往服务端插入数据？<br/>
            在你的php文件中配置相关参数<br/>
            $memcache-&gt;connect(&#39;127.0.0.1&#39;, 11211) or die (&quot;Could not connect&quot;);</p>
</blockquote></li>
<li><p>session 共享</p>

<blockquote>
<p>需要配置：</p>
</blockquote>

<blockquote>
<p>①有memcahe.so模块 《==编译安装客户端memcache-2.2.5.tgz</p>
</blockquote>

<blockquote>
<p>②配置php.ini:<br/>
    添加extension=memcache.so ==》能够让php找到memcache客户端，然后能够将数据发送给客户端</p>
</blockquote>

<blockquote>
<p>③还需要配置php.ini:<br/>
session.save_handler = memcache<br/>
session.save_path = &quot;tcp://127.0.0.1:11211&quot;</p>
</blockquote>

<blockquote>
<p>session是php软件的功能</p>
</blockquote></li>
</ol></li>
</ol>

<blockquote>
<h1 id="toc_0">今日总结：</h1>

<ol>
<li>一致性哈希</li>
<li>memcached安装，监控</li>
<li>memcache安装，和php的结合</li>
<li>数据缓存和session共享的实现步骤</li>
</ol>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-06T23:22:41+08:00" itemprop="datePublished">2017/9/6</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15047113618478.html" itemprop="url">
		廿五、Nginx入门</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><h2 id="toc_0">常用Web服务软件</h2>

<ol>
<li>静态请求</li>
</ol>

<blockquote>
<p>Nginx/Apache/Lighttpd/tengine</p>
</blockquote>

<ol>
<li>动态请求</li>
</ol>

<blockquote>
<p>PHP   处理解析PHP语言<br/>
Tomcat  处理解析Java语言<br/>
resin 大型动态Web服务, Java容器</p>
</blockquote></li>
<li><p>web软件比较</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-7/90337747.jpg" alt=""/></p>

<ol>
<li><p>Apache优缺点</p>

<blockquote>
<p>优点：<br/>
Apache的兼容性和稳定性都是非常强<br/>
Apache 的模块比 Nginx/Lighttpd丰富<br/>
Apache在处理动态请求比Nginx/Lighttpd更有优势<br/>
缺点：<br/>
属于重量级web服务器（重量级主要是在软件包的大小上比较大, 软件的耦合度大）<br/>
在速度、性能不及其他轻量级web服务器, 并且消费内存较高。<br/>
使用传统的select模型, 高并发能力有限</p>
</blockquote></li>
<li><p>Nginx优缺点</p>

<blockquote>
<p>优点：<br/>
轻量级而且抗高并发, 支持几万的并发连接, 在高并发下nginx 能保持低资源/低消耗/高性能<br/>
基于异步的网络I/O模型(epoll), nginx 处理请求是异步非阻塞的, 而apache 则是同步阻塞型的<br/>
优秀地支持Web服务,反向代理(Reverse Proxy),缓存(cache)三大功能<br/>
高度模块化的设计, 编写模块相对简单<br/>
处理静态文件, 索引文件以及自动索引, 打开文件描述符缓冲。<br/>
缺点：<br/>
nginx处理动态请求不如Apache优秀</p>
</blockquote></li>
<li><p>建议</p>

<blockquote>
</blockquote>

<ul>
<li>软件环境统一--批量管理--标准化--自动化运维</li>
<li>Apache 动态业务后台服务器（主要处理php及一些动态请求+Tomcat）；</li>
<li>Nginx/Tengine 静态业务前端服务器（高并发请求、静态资源、负载均衡、反向代理和前端Cache等）。</li>
</ul>

<p><a href="http://www.cnblogs.com/oubo/archive/2012/05/21/2511726.html">http://www.cnblogs.com/oubo/archive/2012/05/21/2511726.html</a><br/>
<a href="http://www.blogjava.net/daniel-tu/archive/2008/12/29/248883.html">http://www.blogjava.net/daniel-tu/archive/2008/12/29/248883.html</a></p></li>
</ol></li>
<li><p>Nginx用途</p>

<ol>
<li><p>提供页面请求处理功能==web服务<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-7/10009570.jpg" alt=""/></p></li>
<li><p>提供反向代理和负载均衡</p>

<blockquote>
<p>反向代理==指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</p>

<p>负载均衡==对访问请求进行调度, 使各个web服务器一起分担压力<br/>
Nginx 反向代理+负载均衡<br/>
LVS 数据转发+负载均衡</p>
</blockquote></li>
<li><p>提供前端数据缓存服务==Web高速缓存</p>

<blockquote>
<p>通过提高重复访问内容的命中率，可以有效地改善网站的访问速度和整体性能，以弥补带宽的不足。特定的WWW对象经常被多个网络用户再次请求时，缓存设备会监视Web请求，检索它们，当第一次传送对象时把它存储到缓存设备中, 在以后的请求中发送缓存设备中(而不是目标站点)的对象。</p>
</blockquote>

<p>====WEB高速缓存重定向技术的好处</p>

<ol>
<li>减少带宽消耗:
由于需要在网上通过的请求和响应减少，降低了托管客户对互联网带宽的占用，因此可节省大量的带宽资源。</li>
<li>减少服务器载入:
服务器处理的请求减少，可以减少服务器的载入。</li>
<li>减少用户通入时间:
因为对缓存请求的响应是立即可以获得的, 不仅极大地缩短了互联网静态页面访问的响应时间，而且也大大提高了托管客户的WEB服务器对于不可缓存的内容的处理能力，因此可以在现有网络和设备条件下提供更好的内容访问服务。</li>
<li>增加吞吐量
在客户投资最少的情况下增加服务器的内容访问服务能力。</li>
<li>增加可靠性
由于具有持续高性能的互联网服务质量，系统的冗余性和故障恢复能力，因此可有效地保证高峰值业务量的服务能力。</li>
</ol></li>
</ol></li>
<li><p>Nginx安装部署</p>

<ol>
<li><p>确认安装环境</p>

<pre><code>[root@web01 ~]# cat /etc/centos-release
CentOS release 6.9 (Final)
[root@web01 ~]# uname -a
Linux web01 2.6.32-696.el6.x86_64 #1 SMP Tue Mar 21 19:29:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></li>
<li><p>安装环境准备</p>

<blockquote>
<p><strong>nginx.org官网半年内的稳定版</strong></p>
</blockquote>

<pre><code>id www
useradd -s /sbin/nologin -M www
mkdir -p /server/tools/
cd /server/tools/
wget http://nginx.org/download/nginx-1.10.3.tar.gz
</code></pre></li>
<li><p>安装依赖软件包</p>

<blockquote>
<p>pcre-devel(Perl语言兼容的正则表达式, rewrite会用到)<br/>
OpenSSL-devel(安全相关软件, 部署HTTPS服务会用到)<br/>
gcc(GNU编译器套件GNU Compiler Collection)</p>
</blockquote>

<pre><code>yum install pcre-devel openssl-devel gcc -y
rpm -qa pcre* openssl* gcc
</code></pre></li>
<li><p>编译安装</p>

<pre><code>tar xf nginx-1.10.3.tar.gz
cd nginx-1.10.3/
./configure --prefix=/application/nginx-1.10.3/ --user=www --group=www --with-http_stub_status_module --with-http_ssl_module
make &amp;&amp; make install
</code></pre></li>
<li><p>启动检查</p>

<pre><code>ln -s /application/nginx-1.10.3/ /application/nginx
ln -s /application/nginx/sbin/nginx /usr/local/sbin/
nginx
lsof -i:80       #Nginx使用端口80
</code></pre></li>
</ol></li>
<li><p>Nginx目录结构<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-7/61781401.jpg" alt=""/></p>

<pre><code>[root@web01 nginx]# tree
.
├── conf
│   ├── fastcgi.conf            #Nginx与其他动态网站软件PHP配合
│   ├── fastcgi.conf.default
│   ├── fastcgi_params
│   ├── fastcgi_params.default
│   ├── koi-utf
│   ├── koi-win
│   ├── mime.types              #http协议中的媒体类型
│   ├── mime.types.default
│   ├── nginx.conf              #核心配置文件
│   ├── nginx.conf.default      #原始备份
│   ├── scgi_params
│   ├── scgi_params.default
│   ├── uwsgi_params
│   ├── uwsgi_params.default
│   └── win-utf
├── html                        #默认的站点根目录
│   ├── 50x.html
│   └── index.html              #首页
├── logs
│   ├── access.log              #访问日志
│   ├── error.log
│   └── nginx.pid
├── sbin
    └── nginx                   #管理命令

9 directories, 21 files
</code></pre></li>
<li><p>修改配置文件</p>

<blockquote>
<p>main主区块<br/>
events 事件区块<br/>
http区块<br/>
  server 虚拟主机区块<br/>
    location 位置区块</p>
</blockquote>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-7/2232182.jpg" alt=""/></p>

<pre><code>[root@web01 conf]# egrep -v &#39;#|^$&#39; nginx.conf.default
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {                                  # 虚拟主机
        listen       80;                      # 监听端口
        server_name  localhost;              # 主机域名
        location / {
            root   html;                      # 站点根目录
            index  index.html index.htm;    # 首页文件
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@web01 conf]# egrep -v &#39;#|^$&#39; nginx.conf.default &gt;nginx.conf
[root@web01 conf]# sed -i &#39;s#localhost#www.etiantian.org#g&#39; nginx.conf
</code></pre></li>
<li><p>Nginx命令(默认用来启动)</p>

<blockquote>
<p>-h 帮助<br/>
-t 配置文件语法检查<br/>
-s Nginx服务管理 reload reopen quit stop   #不用选项即为start<br/>
-V 查看配置参数和版本</p>
</blockquote>

<pre><code> [root@web01 conf]# ln -s /application/nginx/sbin/nginx /usr/sbin/nginx #创建命令软链接
[root@web01 conf]# nginx -t #配置文件语法检查
nginx: the configuration file /application/nginx-1.10.3/conf/nginx.conf syntax is ok
nginx: configuration file /application/nginx-1.10.3/conf/nginx.conf test is successful
[root@web01 conf]# nginx -s reload #重新载入配置文件
</code></pre>

<blockquote>
<p>启动结果检查:</p>
</blockquote>

<pre><code>ps -ef|grep nginx
lsof -i:80
ss -lntup|grep nginx
curl 10.0.0.8
</code></pre></li>
<li><p>修改Windows的hosts</p>

<blockquote>
<p>C:\Windows\System32\drivers\etc\hosts<br/>
使用管理员权限编辑, 加入一行新内容:</p>
</blockquote>

<pre><code>10.0.0.8 www.etiantian.org bbs.etiantian.org blog.etiantian.org
</code></pre></li>
<li><p>站点检查</p>

<blockquote>
<p>用curl命令访问10.0.0.8<br/>
用浏览器访问10.0.0.8, 检查是否正确返回</p>
</blockquote></li>
<li><p>注意点</p>

<ol>
<li>不要用Windows edge浏览器打开Nginx主页</li>
<li>及时清理浏览器缓存!!!</li>
<li>注意Windows hosts不要写错</li>
</ol></li>
<li><p>补充知识</p>

<ol>
<li>并行程序设计模式--Master-Worker模式</li>
</ol>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-9/23629867.jpg" alt=""/></p>

<blockquote>
<p>Master进程负责接收和分配任务，Worker进程负责处理子任务。当各个Worker进程将子任务处理完后，将结果返回给Master进程，由Master进行归纳和汇总，从而得到系统结果。</p>
</blockquote></li>
<li><p>FastCGI<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-9/13307944.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-9/49236229.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-9/27337252.jpg" alt=""/></p></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-06T14:40:15+08:00" itemprop="datePublished">2017/9/6</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15046800151297.html" itemprop="url">
		廿四、网站访问相关命令</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><h1 id="toc_0">curl 传输网页内容命令</h1>

<pre><code>[root@m01 ~]# curl www.etiantian.org
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor=&quot;white&quot;&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.2.9&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<hr/>

<ol>
<li><p>-I 只显示响应头信息(去掉响应报文中的&lt;号以及响应报文主体)</p>

<pre><code>[root@m01 ~]# curl -I www.etiantian.org
HTTP/1.1 301 Moved Permanently
Server: nginx/1.2.9
Date: Mon, 07 Aug 2017 07:33:58 GMT
Content-Type: text/html
Content-Length: 184
Connection: keep-alive
Location: http://www.oldboyedu.com/
</code></pre>

<hr/></li>
<li><p>-s Silent mode不显示进度和错误信息, 显示的内容尽可能少</p>

<pre><code>[root@m01 ~]# curl -s www.etiantian.org
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor=&quot;white&quot;&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.2.9&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<hr/></li>
<li><p>-v 显示详细访问过程(&#39;&gt;&#39;表示用户请求;&#39;&lt;&#39;表示服务器响应)</p>

<pre><code>[root@m01 ~]# curl -v www.etiantian.org
* About to connect() to www.etiantian.org port 80 (#0)
*   Trying 42.62.5.158... connected
* Connected to www.etiantian.org (42.62.5.158) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
&gt; Host: www.etiantian.org
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 301 Moved Permanently
&lt; Server: nginx/1.2.9
&lt; Date: Mon, 07 Aug 2017 07:34:35 GMT
&lt; Content-Type: text/html
&lt; Content-Length: 184
&lt; Connection: keep-alive
&lt; Location: http://www.oldboyedu.com/
&lt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor=&quot;white&quot;&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.2.9&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
* Connection #0 to host www.etiantian.org left intact
* Closing connection #0
</code></pre>

<hr/></li>
<li><p>-o 将下载的数据(响应报文主体)写入到文件，必须使用绝对路径</p>

<pre><code>[root@m01 ~]# curl -o /tmp/test.txt www.etiantian.org
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
184   184  184   184    0     0     36      0  0:00:05  0:00:05 --:--:--  8000
</code></pre>

<hr/></li>
<li><p>-w 指定输出格式</p>

<pre><code>[root@m01 ~]# curl -w &quot;%{http_code}\n&quot; www.etiantian.org
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor=&quot;white&quot;&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.2.9&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
301
</code></pre>

<hr/></li>
<li><p>--progress 显示进度条</p>

<pre><code>[root@m01 ~]# curl -o /tmp/test.txt --progress www.jd.com
######################################################################## 100.0%
</code></pre>

<hr/></li>
<li><p>-A</p>

<pre><code>curl -A &quot;iphone&quot; www.etiantian.org 
</code></pre>

<blockquote>
<p>说明：-A参数可以模拟谷歌浏览器的F12功能，指定访问的user_agent信息</p>
</blockquote></li>
<li><p>-L 定位到跳转后的新网址</p>

<hr/></li>
<li><p>-H Host: 将自定义的请求头信息传递给服务器</p>

<pre><code> [root@lb01 conf]# curl www.etiantian.org/oldboy.html
www web02
[root@lb01 conf]# curl 10.0.0.8/oldboy.html
bbs web01
[root@lb01 conf]# curl -H Host:www.etiantian.org 10.0.0.8/oldboy.html 
www web01
</code></pre>

<hr/></li>
<li><p>实际应用: curl获取状态码</p>

<ul>
<li>方法1</li>
</ul>

<pre><code>[root@m01 ~]# curl -w &quot;%{http_code}\n&quot; -o /dev/null www.etiantian.org
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
184   184  184   184    0     0     35      0  0:00:05  0:00:05 --:--:--  7360
301
[root@m01 ~]# curl -sw &quot;%{http_code}\n&quot; -o /dev/null www.etiantian.org
301
</code></pre>

<ul>
<li>方法2</li>
</ul>

<pre><code>[root@m01 ~]# curl -I www.etiantian.org|awk &#39;NR==1{print $2}&#39;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                    Dload  Upload   Total   Spent    Left  Speed
  0   184    0     0    0     0      0      0 --:--:--  0:00:05 --:--:--     0
301
[root@m01 ~]# curl -Is www.etiantian.org|awk &#39;NR==1{print $2}&#39;
301
[root@m01 ~]# curl -sI www.etiantian.org|awk &#39;NR==1{print $2}&#39;
301
</code></pre></li>
</ol>

<hr/></li>
<li><h1 id="toc_1">wget 下载工具</h1>

<ul>
<li>--debug 查看网址访问过程</li>
</ul>

<pre><code>[root@m01 ~]# wget --debug www.bing.com
DEBUG output created by Wget 1.12 on linux-gnu.

--2017-08-05 18:25:48--  http://www.bing.com/
Resolving www.bing.com... 202.89.233.104, 202.89.233.103
Caching www.bing.com =&gt; 202.89.233.104 202.89.233.103
Connecting to www.bing.com|202.89.233.104|:80... connected.
Created socket 3.
Releasing 0x0000000002779020 (new refcount 1).

---request begin---
GET / HTTP/1.0
User-Agent: Wget/1.12 (linux-gnu)
Accept: * / *
Host: www.bing.com
Connection: Keep-Alive

---request end---
HTTP request sent, awaiting response...

---response begin---
HTTP/1.1 301 Moved Permanently
Location: http://cn.bing.com/
Server: Microsoft-IIS/10.0
X-MSEdge-Ref: Ref A: B1BE0DB046744BCDA6EB5A47881DB4BC Ref B: BJ1EDGE0221 Ref C: 2017-08-05T10:25:53Z
Date: Sat, 05 Aug 2017 10:25:52 GMT
Connection: keep-alive
Content-Length: 0

---response end---
301 Moved Permanently
Registered socket 3 for persistent reuse.
Location: http://cn.bing.com/ [following]
Skipping 0 bytes of body: [] done.
--2017-08-05 18:25:53--  http://cn.bing.com/
conaddr is: 202.89.233.104
Resolving cn.bing.com... 202.89.233.104, 202.89.233.103
Caching cn.bing.com =&gt; 202.89.233.104 202.89.233.103
Releasing 0x0000000002779600 (new refcount 1).
Reusing existing connection to www.bing.com:80.
Reusing fd 3.
...
</code></pre>

<hr/></li>
<li><h1 id="toc_2">iptables 防火墙配置命令</h1>

<blockquote>
<p>! 是取反的意思。<br/>
-t&lt;表&gt;：指定要操纵的表<br/>
 -A：向规则链中添加条目<br/>
 -D：从规则链中删除条目<br/>
 -I：向规则链中插入条目<br/>
 -R：替换规则链中的条目<br/>
 -L：显示规则链中已有的条目<br/>
 -F：清空规则链中已有的条目<br/>
 -Z：清空规则链中的数据包计算器和字节计数器<br/>
 -N：创建新的用户自定义规则链<br/>
 -P：定义规则链中的默认目标<br/>
 -h：显示帮助信息<br/>
 -p：指定要匹配的数据包协议类型<br/>
 -s：指定要匹配的数据包源ip地址<br/>
 -j&lt;目标&gt;：指定要跳转的目标<br/>
 -i&lt;网络接口&gt;：指定数据包进入本机的网络接口<br/>
 -o&lt;网络接口&gt;：指定数据包要离开本机所使用的网络接口。<br/>
iptables命令选项输入顺序<br/>
 iptables -t 表名 &lt;-A/I/D/R&gt; 规则链名 [规则号] &lt;-i/o 网卡名&gt; -p 协议名 &lt;-s 源IP/源子网&gt; --sport 源端口 &lt;-d 目标IP/目标子网&gt; --dport 目标端口 -j 动作 </p>
</blockquote>

<hr/>

<ol>
<li><p>表名包括</p>

<blockquote>
<p>raw：高级功能，如：网址过滤。 <br/>
mangle：数据包修改（QOS），用于实现服务质量。 <br/>
nat：地址转换，用于网关路由器。 <br/>
filter：包过滤，用于防火墙规则。 </p>
</blockquote>

<hr/></li>
<li><p>规则链名包括</p>

<blockquote>
<p>INPUT链：处理输入数据包。 <br/>
OUTPUT链：处理输出数据包。 <br/>
PORWARD链：处理转发数据包。 <br/>
PREROUTING链：用于目标地址转换（DNAT）。 <br/>
POSTOUTING链：用于源地址转换（SNAT）。 </p>
</blockquote>

<hr/></li>
<li><p>-j后的动作包括： </p>

<blockquote>
<p>ACCEPT：接收数据包。 <br/>
DROP：丢弃数据包。 <br/>
REDIRECT：重定向、映射、透明代理。 <br/>
SNAT：源地址转换。 <br/>
DNAT：目标地址转换。 <br/>
MASQUERADE：IP伪装（NAT），用于ADSL。 <br/>
LOG：日志记录。 </p>
</blockquote>

<hr/></li>
<li><p>实例</p>

<ul>
<li>清除已有iptables规则 </li>
</ul>

<pre><code>iptables -F 
iptables -X 
iptables -Z
</code></pre>

<ul>
<li>开放指定的端口 </li>
</ul>

<pre><code>iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT #允许本地回环接口(即运行本机访问本机) 
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT #允许已建立的或相关连的通行 
iptables -A OUTPUT -j ACCEPT #允许所有本机向外的访问 
iptables -A INPUT -p tcp --dport 22 -j ACCEPT #允许访问22端口 
iptables -A INPUT -p tcp --dport 80 -j ACCEPT #允许访问80端口 
iptables -A INPUT -p tcp --dport 21 -j ACCEPT #允许ftp服务的21端口 
iptables -A INPUT -p tcp --dport 20 -j ACCEPT #允许FTP服务的20端口 
iptables -A INPUT -j reject #禁止其他未允许的规则访问 
iptables -A FORWARD -j REJECT #禁止其他未允许的规则访问 
</code></pre>

<ul>
<li>屏蔽IP </li>
</ul>

<pre><code>iptables -I INPUT -s 123.45.6.7 -j DROP #屏蔽单个IP的命令 
iptables -I INPUT -s 123.0.0.0/8 -j DROP #封整个段即从123.0.0.1到123.255.255.254的命令 
iptables -I INPUT -s 124.45.0.0/16 -j DROP #封IP段即从123.45.0.1到123.45.255.254的命令 
iptables -I INPUT -s 123.45.6.0/24 -j DROP #封IP段即从123.45.6.1到123.45.6.254的命令
</code></pre>

<ul>
<li>查看已添加的iptables规则 </li>
</ul>

<pre><code>iptables -L -n -v
</code></pre>

<ul>
<li>删除已添加的iptables规则 将所有iptables以序号标记显示</li>
</ul>

<pre><code>iptables -L -n --line-numbers
</code></pre>

<ul>
<li>比如要删除INPUT里序号为8的规则，执行： </li>
</ul>

<pre><code>iptables -D INPUT 8
</code></pre></li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-05T16:08:00+08:00" itemprop="datePublished">2017/9/5</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15045988807012.html" itemprop="url">
		廿三、http协议==超文本传输协议</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li><h1 id="toc_0">http协议==超文本传输协议</h1>

<p>1.0版本 短连接<br/>
1.1版本 长连接--持久连接<br/>
HTTPS 安全版本: HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。</p>

<hr/></li>
<li><h1 id="toc_1">http协议中的文件类型(mime-type媒体类型)</h1>

<hr/></li>
<li><h1 id="toc_2">通过域名访问网站的流程</h1>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/97544416.jpg" alt=""/></p>

<hr/></li>
<li><h1 id="toc_3">DNS解析原理过程</h1>

<blockquote>
<p>01：查询本地缓存信息/本地hosts文件信息，确认是否有域名到IP的对应关系<br/>
    如果有域名--IP对应关系，直接通过IP地址访问服务器<br/>
    如果没有，继续下一步<br/>
02：请求LDNS（local DNS, 本地网卡上指定配置的），获取IP地址信息<br/>
    如果有域名-IP对应关系，直接将IP地址信息返回给主机<br/>
    如果没有，继续一下步<br/>
---------------------------至此：主机的请求查询过程称为递归查询<br/>
03：LDNS会向根域名服务器请求域名对应IP地址信息<br/>
    根域名服务器会告知LDNS服务器，顶级域名服务器信息<br/>
04：LDNS会向顶级域名服务器请求域名对应IP地址信息<br/>
    顶级域名服务器会告知LDNS服务器，二级域名服务器信息（google.com）<br/>
05: LDNS会向二级域名服务器请求域名对应IP地址信息<br/>
    二级域名会告知相应的 www bbs blog主机记录信息对应IP地址（A记录）<br/>
    这时二级域名服务器也会成为授权DNS服务器<br/>
06：LDNS服务受到授权服务器告知的域名与IP地址对应记录，会进行本地缓存，然后将记录再发送给主机<br/>
07：主机接收到域名与IP的对应关系记录，会进行本地缓存，根据获得的IP地址，直接访问网站服务器</p>
</blockquote>

<hr/>

<ol>
<li><p>域名的级别</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/7234860.jpg" alt=""/></p>

<table>
<thead>
<tr>
<th>根域名</th>
<th>.(省略不写)</th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>顶级域名</td>
<td>com. org. gov. net. cn. edu. info.</td>
<td><div>cn com gov org…</div></td>
</tr>
<tr>
<td>二级域名</td>
<td>bing.com</td>
<td></td>
</tr>
<tr>
<td>三级域名</td>
<td><a href="http://www.bing.com">www.bing.com</a></td>
<td></td>
</tr>
</tbody>
</table>

<hr/></li>
<li><p>DNS查询操作的种类</p>

<p>递归查询: 用户终端到本地DNS缓存/本地hosts文件/本地域名服务器/ISP DNS缓存的查询<br/>
迭代查询: 本地DNS到根域名服务器/顶级域名服务器/网站授权DNS的查询</p>

<hr/></li>
<li><p>DNS记录的种类</p>

<pre><code>[c:\~]$ ipconfig/displaydns
Windows IP 配置
www.bing.com
----------------------------------------
记录名称. . . . . . . : www.bing.com
记录类型. . . . . . . : 1
生存时间. . . . . . . : 10800
数据长度. . . . . . . : 4
部分. . . . . . . . . : 答案
A (主机)记录  . . . . : 204.79.197.220

www.bing.com
----------------------------------------
没有 AAAA 类型的记录
220.197.79.204.in-addr.arpa
----------------------------------------
记录名称. . . . . . . : 220.197.79.204.in-addr.arpa.
记录类型. . . . . . . : 12
生存时间. . . . . . . : 10800
数据长度. . . . . . . : 4
部分. . . . . . . . . : 答案
PTR 记录  . . . . . . : www.bing.com

www2.bing.com
----------------------------------------
记录名称. . . . . . . : www2.bing.com
记录类型. . . . . . . : 5
生存时间. . . . . . . : 14
数据长度. . . . . . . : 4
部分. . . . . . . . . : 答案
CNAME 记录  . . . . . : dual.a-0001.a-msedge.net
</code></pre>

<ul>
<li>A记录: 域名--IP对应关系</li>
<li>CNAME: 域名的别名</li>
</ul>

<hr/></li>
<li><p>Windows中查看DNS解析</p>

<ul>
<li>ipconfig/displaydns</li>
</ul>

<pre><code>[c:\~]$ ipconfig/flushdns
Windows IP 配置
已成功刷新 DNS 解析缓存。
[c:\~]$ ipconfig/displaydns
Windows IP 配置
www.bing.com
----------------------------------------
没有 AAAA 类型的记录

www.bing.com
----------------------------------------
记录名称. . . . . . . : www.bing.com
记录类型. . . . . . . : 1
生存时间. . . . . . . : 10800
数据长度. . . . . . . : 4
部分. . . . . . . . . : 答案
A (主机)记录  . . . . : 204.79.197.220

220.197.79.204.in-addr.arpa
----------------------------------------
记录名称. . . . . . . : 220.197.79.204.in-addr.arpa.
记录类型. . . . . . . : 12
生存时间. . . . . . . : 10800
数据长度. . . . . . . : 4
部分. . . . . . . . . : 答案
PTR 记录  . . . . . . : www.bing.com
</code></pre>

<ul>
<li>nslookup</li>
</ul>

<pre><code>[c:\~]$ nslookup ww.bing.com
非权威应答:
服务器:  gjjdial.bta.net.cn
Address:  202.106.195.68
名称:    a-0001.a-msedge.net
Addresses:  204.79.197.200
  13.107.21.200
Aliases:  ww.bing.com
  star-bing-com.a-0001.a-msedge.net
  ```

---
</code></pre></li>
<li><p>Linux中查看DNS解析</p>

<ul>
<li>dig</li>
</ul>

<pre><code>[root@m01 ~]# dig www.bing.com
[root@m01 ~]# dig +trace www.bing.com
</code></pre>

<ul>
<li>nslookup</li>
</ul>

<pre><code>[root@m01 ~]# nslookup www.bing.com
Server:     223.5.5.5
Address:    223.5.5.5#53
Non-authoritative answer:
www.bing.com    canonical name = cn.a-0001.a-msedge.net.
Name:   cn.a-0001.a-msedge.net
Address: 202.89.233.103
Name:   cn.a-0001.a-msedge.net
Address: 202.89.233.104
</code></pre>

<ul>
<li>host</li>
</ul>

<pre><code>[root@m01 ~]# host www.bing.com
www.bing.com is an alias for cn.a-0001.a-msedge.net.
cn.a-0001.a-msedge.net has address 202.89.233.104
cn.a-0001.a-msedge.net has address 202.89.233.103
</code></pre></li>
</ol>

<hr/></li>
<li><h1 id="toc_4">请求/响应的过程</h1>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/8409480.jpg" alt=""/></p>

<ol>
<li><p>请求</p>

<p>请求起始行<br/>
请求头<br/>
空行<br/>
请求报文主体(用户提交的内容, post才有, get没有)</p>

<hr/></li>
<li><p>请求方法<br/>
GET 下载<br/>
POST 上传</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/7925496.jpg" alt=""/></p>

<hr/></li>
<li><p>响应<br/>
响应起始行 HTTP/1.1 200 OK<br/>
响应头部<br/>
空行<br/>
响应报文主体</p>

<hr/></li>
<li><p>响应代码<br/>
200 OK标准返回<br/>
301 永久跳转到新位置</p>

<pre><code>&gt; Host: www.360buy.com
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 301 Moved Permanently
&lt; Server: JDWS/2.0
&lt; Location: https://www.jd.com/
</code></pre>

<p>302 临时跳转到新位置</p>

<pre><code>&gt; Host: www.jd.com
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 302 Moved Temporarily
&lt; Location: https://www.jd.com/
</code></pre>

<p>403 禁止访问, 服务器拒绝用户请求<br/>
404 找不到指定页面<br/>
500 内部服务器错误<br/>
502 bad gateway--代理服务器没有响应--反向代理<br/>
503 服务不可用<br/>
504 响应超时</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/6973836.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/42947422.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/80271387.jpg" alt=""/></p></li>
</ol>

<hr/></li>
<li><h1 id="toc_5">http资源类型</h1>

<ol>
<li><p>静态页面(访问效率更高)</p>

<p>· 以html htm shtml结尾，网址里面一般没有？&amp; <br/>
· 网页的内容，由<mark>客户端浏览器解析</mark>。服务器只需要根据请求，发送数据，网页内容即可<br/>
· 网页内容固定不变，容易被搜索引擎收录<br/>
· 很难有交互，一问一答<br/>
· 高并发访问效率高</p>

<hr/></li>
<li><p>动态页面</p>

<p>· 以asp、.aspx、.php、.js、.do、.cgi结尾，网址里面一般会有?/&amp;<br/>
· <mark>服务器端解析</mark>用户请求<br/>
· <mark>需要读取数据库</mark>，性能和效率降低<br/>
· 后端拥有数据库支持，和用户的交互性提升，功能实现方式增多</p>

<hr/></li>
<li><p>伪静态页面</p>

<p>将动态页面伪装成静态页面的方式, 方便搜索引擎收录<br/>
<mark>rewrite</mark>使用正则表达式<br/>
<a href="http://www.oldboyedu.com/oldboy&amp;linux">www.oldboyedu.com/oldboy&amp;linux</a><br/>
<a href="http://www.oldboyedu.com/oldboy-linux">www.oldboyedu.com/oldboy-linux</a></p></li>
</ol>

<hr/></li>
<li><h1 id="toc_6">ULR与URI</h1>

<p><mark>注意:nginx中的URI指的是一个完整网址的顶级域名后面的部分</mark></p>

<p>例如: <a href="http://www.cnblogs.com">http://www.cnblogs.com</a> <mark>/freescience/p/7309315.html</mark></p>

<ol>
<li><p>URI 统一资源标识符</p>

<p>URI，是uniform resource identifier，统一资源标识符，用来唯一的标识一个资源。Web上可用的每种资源如HTML文档、图像、视频片段、程序等都是用一个URI来定位的<br/>
URI一般由三部组成：<br/>
①访问资源的命名机制<br/>
②存放资源的主机名<br/>
③资源自身的名称，由路径表示，着重强调于资源。</p>

<ul>
<li>URL 统一资源定位器</li>
</ul>

<p>URL是uniform resource locator，统一资源定位器，它是一种具体的URI，即URL可以用来标识一个资源，而且还指明了如何locate这个资源。URL是Internet上用来描述信息资源的字符串，主要用在各种WWW客户程序和服务器程序上，特别是著名的Mosaic。<br/>
采用URL可以用一种统一的格式来描述各种信息资源，包括文件、服务器的地址和目录等。URL一般由三部组成：<br/>
①协议(或称为服务方式)<br/>
②存有该资源的主机IP地址(有时也包括端口号)<br/>
③主机资源的具体地址。如目录和文件名等</p>

<ul>
<li>URN 统一资源命名</li>
</ul>

<p>URN，uniform resource name，统一资源命名，是通过名字来标识资源，比如mailto:<a href="mailto:java-net@java.sun.com">java-net@java.sun.com</a>。</p>

<hr/></li>
<li><p>区别</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/33526943.jpg" alt=""/></p>

<p><a href="http://kb.cnblogs.com/page/90838/">http://kb.cnblogs.com/page/90838/</a></p></li>
</ol>

<hr/></li>
<li><h1 id="toc_7">网站访问流量的度量</h1>

<ol>
<li><p>临时统计</p>

<p>使用awk分析访问日志access.log</p>

<hr/></li>
<li><p>第三方统计</p>

<p><a href="http://alexa.chinaz.com/">http://alexa.chinaz.com/</a> 查看IP PV统计信息网站<br/>
hm.baidu.com 百度统计工具<br/>
piwik.org 统计软件</p>

<hr/></li>
<li><p>ip独立IP访问</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/5574767.jpg" alt=""/></p>

<p>私网ip--NAT映射--同一个公网IP--访问目标网站<br/>
ADSL拨号--拨号次数--每次的独立IP--访问目标网站</p>

<hr/></li>
<li><p>PV 页面浏览量(点击量)</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/74321318.jpg" alt=""/></p>

<hr/></li>
<li><p>UV 独立用户访问量</p>

<p>cookie(比较精确)<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/80187326.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/4070861.jpg" alt=""/></p></li>
</ol>

<hr/></li>
<li><h1 id="toc_8">网站并发连接</h1>

<p><mark>指的是一个网站在单位时间内能够处理的最大用户连接数</mark><br/>
<a href="http://lidao.blog.51cto.com/3388056/1948925">http://lidao.blog.51cto.com/3388056/1948925</a><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/79116736.jpg" alt=""/></p>

<hr/></li>
<li><h1 id="toc_9">扩展教学：测试磁盘存储性能方法</h1>

<p>连续的向磁盘中进行读写大文件的测试方法<br/>
dd if=/dev/zero of=/tmp/test01.bin bs=1k count=10000<br/>
随机读取<br/>
fio软件安装使用(需要借助epel源)<br/>
<a href="http://blog.csdn.net/hshl1214/article/details/49762149">http://blog.csdn.net/hshl1214/article/details/49762149</a><br/>
<a href="http://www.cnblogs.com/lpfuture/p/6054882.html">http://www.cnblogs.com/lpfuture/p/6054882.html</a><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-5/37884096.jpg" alt=""/></p></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-09-01T17:43:38+08:00" itemprop="datePublished">2017/9/1</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E5%BF%83%E6%83%85%E9%9A%8F%E7%AC%94.html'>心情随笔</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15042590185797.html" itemprop="url">
		甜蜜回忆</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p><img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/11839566.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/12290473.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/12428238.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/12430001.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/12790706.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/13235532.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/13903728.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/14289809.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/14507108.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/15669086.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/1585375.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/15924160.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/1732901.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/17829092.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/1860673.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/18645999.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/19524487.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/19836862.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/21122578.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/22847740.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/2296774.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/23871154.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/23874532.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/25261197.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/28781252.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/28945847.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/29008736.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/29624556.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/29941520.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/31244131.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/31276615.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/33547772.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/33957006.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/34370211.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/34963485.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/35028388.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/37728865.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/37954310.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/38277882.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/38736754.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/38919338.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/39197284.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/39227197.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/39676617.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/40117496.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/40785475.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/4109933.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/41365584.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/42046374.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/42101382.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/42759376.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/43364930.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/44373750.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/4444098.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/44694252.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/44701884.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/44769510.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/45201436.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/46379209.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/46630196.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/47975907.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/48800143.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/51033357.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/51210597.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/51469929.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/51559313.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/52068114.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/5397541.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/5414909.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/54608216.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/54963256.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/55543016.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/56034664.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/56116733.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/56118755.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/57226324.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/57755333.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/58468124.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/58474604.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/58489520.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/59071912.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/59159313.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/59688686.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/59759487.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/59832034.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/60355337.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/60778845.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/63024802.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/63050386.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/63563890.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/64955776.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/66024433.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/66464809.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/67634001.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/68650121.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/69127117.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/69219658.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/70566588.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/70739026.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/71344959.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/71667250.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/72729455.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/73748927.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/74057824.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/74280733.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/74459271.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/75776753.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/75915664.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/7641683.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/76469253.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/76956295.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/77998464.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/78518681.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/788905.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/79460513.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/81671486.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/8352814.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/84775473.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/84887299.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/85709470.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/86062400.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/8620973.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/87277510.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/87834771.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/90588883.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/90884167.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/9101309.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/9168330.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/91701042.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/9186365.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/92278319.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/92322604.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/92621751.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/92774221.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/93204328.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/93273692.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/9427463.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/94335819.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/9455976.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/94946385.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/95195584.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/95280495.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/95573710.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/96402055.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/9649294.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/96773741.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/98105058.jpg" alt=""/><br/>
<img src="http://ovat9n2re.bkt.clouddn.com/17-8-26/99776549.jpg" alt=""/></p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-08T09:03:49+08:00" itemprop="datePublished">2017/8/8</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15021542293136.html" itemprop="url">
		HTTP状态码列表</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>消息（1字头）服务器收到请求，需要请求者继续执行操作</p>

<table>
<thead>
<tr>
<th>状态码</th>
<th>状态码英文名称</th>
<th>中文描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>100</td>
<td>Continue</td>
<td>继续。客户端应继续其请求</td>
</tr>
<tr>
<td>101</td>
<td>Switching Protocols</td>
<td>切换协议。服务器根据客户端的请求切换协议。只能切换到更高级的协议，例如，切换到HTTP的新版本协议</td>
</tr>
<tr>
<td>102</td>
<td>Processing</td>
<td>由WebDAV（RFC 2518）扩展的状态码，代表处理将被继续执行。</td>
</tr>
</tbody>
</table>

<hr/>

<p>成功（2字头）操作被成功接收并处理</p>

<table>
<thead>
<tr>
<th>状态码</th>
<th>状态码英文名称</th>
<th>中文描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>200</td>
<td>OK</td>
<td>请求成功。一般用于GET与POST请求</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
<td>已创建。成功请求并创建了新的资源</td>
</tr>
<tr>
<td>202</td>
<td>Accepted</td>
<td>已接受。已经接受请求，但未处理完成</td>
</tr>
<tr>
<td>203</td>
<td>Non-Authoritative Information</td>
<td>非授权信息。请求成功。但返回的meta信息不在原始的服务器，而是一个副本</td>
</tr>
<tr>
<td>204</td>
<td>No Content</td>
<td>无内容。服务器成功处理，但未返回内容。在未更新网页的情况下，可确保浏览器继续显示当前文档</td>
</tr>
<tr>
<td>205</td>
<td>Reset Content</td>
<td>重置内容。服务器处理成功，用户终端（例如：浏览器）应重置文档视图。可通过此返回码清除浏览器的表单域</td>
</tr>
<tr>
<td>206</td>
<td>Partial Content</td>
<td>部分内容。服务器成功处理了部分GET请求</td>
</tr>
<tr>
<td>207</td>
<td>Multi-Status</td>
<td>由WebDAV(RFC 2518)扩展的状态码，代表之后的消息体将是一个XML消息，并且可能依照之前子请求数量的不同，包含一系列独立的响应代码。</td>
</tr>
</tbody>
</table>

<hr/>

<p>重定向（3字头）需要进一步的操作以完成请求</p>

<table>
<thead>
<tr>
<th>状态码</th>
<th>状态码英文名称</th>
<th>中文描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>300</td>
<td>Multiple Choices</td>
<td>多种选择。请求的资源可包括多个位置，相应可返回一个资源特征与地址的列表用于用户终端（例如：浏览器）选择</td>
</tr>
<tr>
<td>301</td>
<td>Moved Permanently</td>
<td>永久移动。请求的资源已被永久的移动到新URI，返回信息会包括新的URI，浏览器会自动定向到新URI。今后任何新的请求都应使用新的URI代替</td>
</tr>
<tr>
<td>302</td>
<td>Move temporarily</td>
<td>临时移动。与301类似。但资源只是临时被移动。客户端应继续使用原有URI</td>
</tr>
<tr>
<td>303</td>
<td>See Other</td>
<td>查看其它地址。与301类似。使用GET和POST请求查看</td>
</tr>
<tr>
<td>304</td>
<td>Not Modified</td>
<td>未修改。所请求的资源未修改，服务器返回此状态码时，不会返回任何资源。客户端通常会缓存访问过的资源，通过提供一个头信息指出客户端希望只返回在指定日期之后修改的资源</td>
</tr>
<tr>
<td>305</td>
<td>Use Proxy</td>
<td>使用代理。所请求的资源必须通过代理访问</td>
</tr>
<tr>
<td>306</td>
<td>Unused</td>
<td>已经被废弃的HTTP状态码</td>
</tr>
<tr>
<td>307</td>
<td>Temporary Redirect</td>
<td>临时重定向。与302类似。使用GET请求重定向</td>
</tr>
</tbody>
</table>

<hr/>

<p>请求错误（4字头）客户端错误，请求包含语法错误或无法完成请求</p>

<table>
<thead>
<tr>
<th>状态码</th>
<th>状态码英文名称</th>
<th>中文描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>客户端请求的语法错误，服务器无法理解</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>请求要求用户的身份认证</td>
</tr>
<tr>
<td>402</td>
<td>Payment Required</td>
<td>保留，将来使用</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
<td>服务器理解请求客户端的请求，但是拒绝执行此请求</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td>服务器无法根据客户端的请求找到资源（网页）。通过此代码，网站设计人员可设置“您所请求的资源无法找到”的个性页面</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed</td>
<td>客户端请求中的方法被禁止</td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable</td>
<td>服务器无法根据客户端请求的内容特性完成请求</td>
</tr>
<tr>
<td>407</td>
<td>Proxy Authentication Required</td>
<td>请求要求代理的身份认证，与401类似，但请求者应当使用代理进行授权</td>
</tr>
<tr>
<td>408</td>
<td>Request Time-out</td>
<td>服务器等待客户端发送的请求时间过长，超时</td>
</tr>
<tr>
<td>409</td>
<td>Conflict</td>
<td>服务器完成客户端的PUT请求是可能返回此代码，服务器处理请求时发生了冲突</td>
</tr>
<tr>
<td>410</td>
<td>Gone</td>
<td>客户端请求的资源已经不存在。410不同于404，如果资源以前有现在被永久删除了可使用410代码，网站设计人员可通过301代码指定资源的新位置</td>
</tr>
<tr>
<td>411</td>
<td>Length Required</td>
<td>服务器无法处理客户端发送的不带Content-Length的请求信息</td>
</tr>
<tr>
<td>412</td>
<td>Precondition Failed</td>
<td>客户端请求信息的先决条件错误</td>
</tr>
<tr>
<td>413</td>
<td>Request Entity Too Large</td>
<td>由于请求的实体过大，服务器无法处理，因此拒绝请求。为防止客户端的连续请求，服务器可能会关闭连接。如果只是服务器暂时无法处理，则会包含一个Retry-After的响应信息</td>
</tr>
<tr>
<td>414</td>
<td>Request-URI Too Large</td>
<td>请求的URI过长（URI通常为网址），服务器无法处理</td>
</tr>
<tr>
<td>415</td>
<td>Unsupported Media Type</td>
<td>服务器无法处理请求附带的媒体格式</td>
</tr>
<tr>
<td>416</td>
<td>Requested range not satisfiable</td>
<td>客户端请求的范围无效</td>
</tr>
<tr>
<td>417</td>
<td>Expectation Failed</td>
<td>服务器无法满足Expect的请求头信息</td>
</tr>
</tbody>
</table>

<hr/>

<p>服务器错误（5字头）服务器在处理请求的过程中发生了错误</p>

<table>
<thead>
<tr>
<th>状态码</th>
<th>状态码英文名称</th>
<th>中文描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>500</td>
<td>Internal Server Error</td>
<td>服务器内部错误，无法完成请求</td>
</tr>
<tr>
<td>501</td>
<td>Not Implemented</td>
<td>服务器不支持请求的功能，无法完成请求</td>
</tr>
<tr>
<td>502</td>
<td>Bad Gateway</td>
<td>充当网关或代理的服务器，从远端服务器接收到了一个无效的请求</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable</td>
<td>由于超载或系统维护，服务器暂时的无法处理客户端的请求。延时的长度可包含在服务器的Retry-After头信息中</td>
</tr>
<tr>
<td>504</td>
<td>Gateway Time-out</td>
<td>充当网关或代理的服务器，未及时从远端服务器获取请求</td>
</tr>
<tr>
<td>505</td>
<td>HTTP Version not supported</td>
<td>服务器不支持请求的HTTP协议的版本，无法完成处理</td>
</tr>
</tbody>
</table>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-07T18:18:36+08:00" itemprop="datePublished">2017/8/7</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15021011169868.html" itemprop="url">
		Ansible常用模块汇总</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<blockquote>
<p>Ansible通过模块的方式来完成一些远程的管理工作。可以通过ansible-doc -l查看所有模块，可以使用ansible-doc -s module来查看某个模块的参数具体用法，也可以使用ansible-doc help module来查看该模块更详细的信息。</p>
</blockquote>

<h2 id="toc_0">setup</h2>

<p>可以用来收集远程主机的一些基本信息：</p>

<pre><code>ansible -i /etc/ansible/hosts test -m setup
</code></pre>

<h2 id="toc_1">ping</h2>

<p>可以用来测试远程主机的运行状态：</p>

<pre><code>ansible test -m ping
</code></pre>

<h2 id="toc_2">file</h2>

<p>设置文件的属性<br/>
file模块包含如下选项：</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>force</td>
<td>需要在两种情况下强制创建软链接，一种是源文件不存在但之后会建立的情况下；另一种是目标软链接已存在,需要先取消之前的软链，然后创建新的软链，有两个选项：yes</td>
</tr>
<tr>
<td>group</td>
<td>定义文件/目录的属组</td>
</tr>
<tr>
<td>mode</td>
<td>定义文件/目录的权限</td>
</tr>
<tr>
<td>owner</td>
<td>定义文件/目录的属主</td>
</tr>
<tr>
<td>path</td>
<td>必选项，定义文件/目录的路径</td>
</tr>
<tr>
<td>recurse</td>
<td>递归的设置文件的属性，只对目录有效</td>
</tr>
<tr>
<td>src</td>
<td>要被链接的源文件的路径，只应用于state=link的情况</td>
</tr>
<tr>
<td>dest</td>
<td>被链接到的路径，只应用于state=link的情况</td>
</tr>
</tbody>
</table>

<p>state:</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>directory</td>
<td>如果目录不存在，创建目录</td>
</tr>
<tr>
<td>file</td>
<td>即使文件不存在，也不会被创建</td>
</tr>
<tr>
<td>link</td>
<td>创建软链接</td>
</tr>
<tr>
<td>hard</td>
<td>创建硬链接</td>
</tr>
<tr>
<td>touch</td>
<td>如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间</td>
</tr>
<tr>
<td>absent</td>
<td>删除目录、文件或者取消链接文件</td>
</tr>
</tbody>
</table>

<p>示例：</p>

<pre><code> ansible test -m file -a &quot;src=/etc/fstab dest=/tmp/fstab state=link&quot;
 ansible test -m file -a &quot;path=/tmp/fstab state=absent&quot;
 ansible test -m file -a &quot;path=/tmp/test state=touch&quot;
 ansible test -m file -a &quot;path=/tmp/test state=directory&quot;
 ansible test -m file -a &quot;path=/tmp/testd state=directory owner=root group=root mode=777&quot;
</code></pre>

<h2 id="toc_3">copy</h2>

<p>复制文件到远程主机<br/>
copy模块包含如下选项：</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>backup</td>
<td>在覆盖之前将原文件备份，备份文件包含时间信息。有两个选项：yes|no</td>
</tr>
<tr>
<td>content</td>
<td>用于替代&quot;src&quot;,可以直接设定指定文件的值</td>
</tr>
<tr>
<td>dest</td>
<td>必选项。要将源文件复制到的远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录</td>
</tr>
<tr>
<td>directory_mode</td>
<td>递归的设定目录的权限，默认为系统默认权限</td>
</tr>
<tr>
<td>force</td>
<td>如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes</td>
</tr>
<tr>
<td>others</td>
<td>所有的file模块里的选项都可以在这里使用</td>
</tr>
<tr>
<td>src</td>
<td>要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用&quot;/&quot;来结尾，则只复制目录里的内容，如果没有使用&quot;/&quot;来结尾，则包含目录在内的整个内容全部复制，类似于rsync。</td>
</tr>
<tr>
<td>validate</td>
<td>The validation command to run before copying into place. The path to the file to validate is passed in via &#39;%s&#39; which must be present as in the visudo example below.</td>
</tr>
</tbody>
</table>

<p>示例：</p>

<pre><code> ansible test -m copy -a &quot;src=/srv/myfiles/foo.conf dest=/etc/foo.conf owner=foo group=foo mode=0644&quot;
 ansible test -m copy -a &quot;src=/mine/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=644 backup=yes&quot;
 ansible test -m copy -a &quot;src=/mine/sudoers dest=/etc/sudoers validate=&#39;visudo -cf %s&#39;&quot;
</code></pre>

<h2 id="toc_4">command</h2>

<p>在远程主机上执行命令<br/>
command模块包含如下选项：</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>creates</td>
<td>一个文件名，当该文件存在，则该命令不执行</td>
</tr>
<tr>
<td>free_form</td>
<td>要执行的linux指令</td>
</tr>
<tr>
<td>chdir</td>
<td>在执行指令之前，先切换到该指定的目录</td>
</tr>
<tr>
<td>removes</td>
<td>一个文件名，当该文件不存在，则该选项不执行</td>
</tr>
<tr>
<td>executable</td>
<td>切换shell来执行指令，该执行路径必须是一个绝对路径</td>
</tr>
</tbody>
</table>

<p>示例：</p>

<pre><code> ansible test -a &quot;ls /root&quot;
</code></pre>

<h2 id="toc_5">shell</h2>

<p>切换到某个shell执行指定的指令，参数与command相同。</p>

<p>示例：</p>

<pre><code> ansible test -m shell -a &quot;somescript.sh &gt;&gt; somelog.txt&quot;
</code></pre>

<h2 id="toc_6">service</h2>

<p>用于管理服务<br/>
该模块包含如下选项：</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>arguments</td>
<td>给命令行提供一些选项</td>
</tr>
<tr>
<td>enabled</td>
<td>是否开机启动 yes</td>
</tr>
<tr>
<td>name</td>
<td>必选项，服务名称</td>
</tr>
<tr>
<td>pattern</td>
<td>定义一个模式，如果通过status指令来查看服务的状态时，没有响应，就会通过ps指令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然在运行</td>
</tr>
<tr>
<td>runlevel</td>
<td>运行级别</td>
</tr>
<tr>
<td>sleep</td>
<td>如果执行了restarted，在则stop和start之间沉睡几秒钟</td>
</tr>
<tr>
<td>state</td>
<td>对当前服务执行启动，停止、重启、重新加载等操作（started,stopped,restarted,reloaded）</td>
</tr>
</tbody>
</table>

<p>示例：</p>

<pre><code> ansible test -m service -a &quot;name=httpd state=started enabled=yes&quot;
 ansible test -m service -a &quot;name=foo pattern=/usr/bin/foo state=started&quot;
 ansible test -m service -a &quot;name=network state=restarted args=eth0&quot;
</code></pre>

<h2 id="toc_7">cron</h2>

<p>用于管理计划任务<br/>
包含如下选项：</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>backup</td>
<td>对远程主机上的原任务计划内容修改之前做备份</td>
</tr>
<tr>
<td>cron_file</td>
<td>如果指定该选项，则用该文件替换远程主机上的cron.d目录下的用户的任务计划</td>
</tr>
<tr>
<td>day</td>
<td>日（1-31，[i]，[/i]/2,……）</td>
</tr>
<tr>
<td>hour</td>
<td>小时（0-23，[i]，[/i]/2，……）</td>
</tr>
<tr>
<td>minute</td>
<td>分钟（0-59，[i]，[/i]/2，……）</td>
</tr>
<tr>
<td>month</td>
<td>月（1-12，[i]，[/i]/2，……）</td>
</tr>
<tr>
<td>weekday</td>
<td>周（0-7，*，……）</td>
</tr>
<tr>
<td>job</td>
<td>要执行的任务，依赖于state=present</td>
</tr>
<tr>
<td>name</td>
<td>该任务的描述</td>
</tr>
<tr>
<td>special_time</td>
<td>指定什么时候执行，参数：reboot,yearly,annually,monthly,weekly,daily,hourly</td>
</tr>
<tr>
<td>state</td>
<td>确认该任务计划是创建还是删除</td>
</tr>
<tr>
<td>user</td>
<td>以哪个用户的身份执行</td>
</tr>
</tbody>
</table>

<p>示例：</p>

<pre><code> ansible test -m cron -a &#39;name=&quot;check dirs&quot; hour=&quot;5,2&quot; job=&quot;ls -alh &gt; /dev/null&quot;&#39;
 ansible test -m cron -a &#39;name=&quot;a job for reboot&quot; special_time=reboot job=&quot;/some/job.sh&quot;&#39;
 ansible test -m cron -a &#39;name=&quot;yum autoupdate&quot; weekday=&quot;2&quot; minute=0 hour=12 user=&quot;root&quot; job=&quot;YUMINTERACTIVE=0 /usr/sbin/yum-autoupdate&quot; cron_file=ansible_yum-autoupdate&#39;
 ansilbe test -m cron -a &#39;cron_file=ansible_yum-autoupdate state=absent&#39;
</code></pre>

<h2 id="toc_8">filesystem</h2>

<p>在块设备上创建文件系统<br/>
选项：</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>dev</td>
<td>目标块设备</td>
</tr>
<tr>
<td>force</td>
<td>在一个已有文件系统的设备上强制创建</td>
</tr>
<tr>
<td>fstype</td>
<td>文件系统的类型</td>
</tr>
<tr>
<td>opts</td>
<td>传递给mkfs命令的选项</td>
</tr>
</tbody>
</table>

<h2 id="toc_9">user</h2>

<p>管理用户</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>home</td>
<td></td>
</tr>
<tr>
<td>groups</td>
<td></td>
</tr>
<tr>
<td>uid</td>
<td></td>
</tr>
<tr>
<td>password</td>
<td></td>
</tr>
<tr>
<td>name</td>
<td></td>
</tr>
<tr>
<td>createhome</td>
<td></td>
</tr>
<tr>
<td>system</td>
<td></td>
</tr>
<tr>
<td>remove</td>
<td></td>
</tr>
<tr>
<td>state</td>
<td></td>
</tr>
<tr>
<td>shell</td>
<td></td>
</tr>
</tbody>
</table>

<blockquote>
<p>需要特别说明的是，password后面指定的密码不能是明文，后面这一串密码会被直接传送到被管理主机的/etc/shadow文件中，而登陆的时候输入的密码会被hash加密以后再去与/etc/shadow中存放的密码去做对比，会出现不一致的现象。所以需要先将密码字符串进行加密处理：openssl passwd -salt -1 &quot;123456&quot;，然后将得到的字符串放到password中即可。</p>
</blockquote>

<h2 id="toc_10">synchronize</h2>

<p>使用rsync同步文件</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>archive</td>
<td></td>
</tr>
<tr>
<td>checksum</td>
<td></td>
</tr>
<tr>
<td>delete</td>
<td></td>
</tr>
<tr>
<td>dest</td>
<td></td>
</tr>
<tr>
<td>src</td>
<td></td>
</tr>
<tr>
<td>dest_port</td>
<td></td>
</tr>
<tr>
<td>existing_only</td>
<td>skip createing new files on receiver</td>
</tr>
<tr>
<td>links</td>
<td></td>
</tr>
<tr>
<td>owner</td>
<td></td>
</tr>
<tr>
<td>mode</td>
<td>(push, pull)</td>
</tr>
<tr>
<td>recursive</td>
<td></td>
</tr>
<tr>
<td>rsync_path</td>
<td></td>
</tr>
<tr>
<td>times</td>
<td>Preserve modification times</td>
</tr>
</tbody>
</table>

<p>示例：</p>

<pre><code> src=some/relative/path dest=/some/absolute/path rsync_path=&quot;sudo rsync&quot;
 src=some/relative/path dest=/some/absolute/path archive=no links=yes
 src=some/relative/path dest=/some/absolute/path checksum=yes times=no
 src=/tmp/helloworld dest=/var/www/helloword rsync_opts=--no-motd,--exclude=.git mode=pull
</code></pre>

<h2 id="toc_11">mount</h2>

<p>配置挂载点<br/>
选项：</p>

<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>dump</td>
<td></td>
</tr>
<tr>
<td>fstype</td>
<td>必选项，挂载文件的类型</td>
</tr>
<tr>
<td>name</td>
<td>必选项，挂载点</td>
</tr>
<tr>
<td>opts</td>
<td>传递给mount命令的参数</td>
</tr>
<tr>
<td>passno</td>
<td></td>
</tr>
<tr>
<td>src</td>
<td>必选项，要挂载的文件</td>
</tr>
<tr>
<td>state</td>
<td>必选项</td>
</tr>
<tr>
<td>present</td>
<td>只处理fstab中的配置</td>
</tr>
<tr>
<td>absent</td>
<td>删除挂载点</td>
</tr>
<tr>
<td>mounted</td>
<td>自动创建挂载点并挂载之</td>
</tr>
<tr>
<td>umounted</td>
<td>卸载</td>
</tr>
</tbody>
</table>

<p>示例：</p>

<pre><code> name=/mnt/dvd src=/dev/sr0 fstype=iso9660 opts=ro state=present
 name=/srv/disk src=&#39;LABEL=SOME_LABEL&#39; state=present
 name=/home src=&#39;UUID=b3e48f45-f933-4c8e-a700-22a159ec9077&#39; opts=noatime state=present

 ansible test -a &#39;dd if=/dev/zero of=/disk.img bs=4k count=1024&#39;
 ansible test -a &#39;losetup /dev/loop0 /disk.img&#39;
 ansible test -m filesystem &#39;fstype=ext4 force=yes opts=-F dev=/dev/loop0&#39;
 ansible test -m mount &#39;name=/mnt src=/dev/loop0 fstype=ext4 state=mounted opts=rw&#39;
</code></pre>

<h2 id="toc_12">raw</h2>

<p>类似command，可以传递管道</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-07T00:34:21+08:00" itemprop="datePublished">2017/8/7</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15020372614069.html" itemprop="url">
		web服务基础</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li>http服务的重要基础

<ol>
<li>用户访问网站基本流程</li>
<li>DNS系统解析基本流程

<ol>
<li>DNS简介</li>
<li>DNS解析流程</li>
</ol></li>
</ol></li>
<li>http协议

<ol>
<li>http协议简介</li>
<li>http协议版本

<ol>
<li>http/1.0简介</li>
<li>http/1.1简介</li>
</ol></li>
<li>http请求方法</li>
<li>http状态码

<ol>
<li>http状态码介绍</li>
<li>http状态码的命令行查看</li>
</ol></li>
<li>http报文

<ol>
<li>http请求报文(request message)介绍</li>
<li>http响应报文(response message)介绍</li>
<li>一个简单的请求报文和应答报文示例</li>
</ol></li>
<li>http协议原理及重点分析</li>
</ol></li>
<li>http资源

<ol>
<li>媒体类型</li>
<li>URL介绍</li>
<li>URI介绍</li>
<li>静态网页资源

<ol>
<li>静态网页资源介绍</li>
<li>静态网页资源特点</li>
<li>静态网页语言</li>
<li>有关静态网页的架构思想</li>
</ol></li>
<li>动态网页资源

<ol>
<li>动态网页资源介绍</li>
<li>动态网页资源特点</li>
<li>有关动态网页的架构思想</li>
</ol></li>
<li>伪静态网页

<ol>
<li>伪静态网页资源介绍</li>
<li>伪静态网页资源特点</li>
<li>伪静态网页作用</li>
<li>伪静态网页的缺点</li>
<li>伪静态网页小结</li>
</ol></li>
<li>生产web架构优化实战方案

<ol>
<li>门户新闻业务</li>
<li>视频网站业务</li>
<li>blog/BBS/SNS/微博社区业务/电商(如淘宝、京东)</li>
</ol></li>
</ol></li>
<li>网站流量度量术语

<ol>
<li>IP</li>
<li>PV</li>
<li>UV</li>
<li>企业网站对IP、PV、UV的度量

<ol>
<li>对IP的度量</li>
<li>对PV的度量</li>
<li>对UV的度量</li>
</ol></li>
<li>IP、PV、UV的区别</li>
<li>并发连接

<ol>
<li>网站并发连接</li>
<li>其他服务并发连接</li>
</ol></li>
<li>常见企业网站排名及PV/IP访问量</li>
<li>有关网站度量Linux企业运维的常见面试题</li>
</ol></li>
<li>WWW服务软件介绍

<ol>
<li>WWW软件全球使用排名参考</li>
<li>当前互联网主流web服务说明

<ol>
<li>当前互联网主流web服务软件</li>
<li>常用来提供动态服务的软件</li>
</ol></li>
<li>WWW静态程序服务软件Apache</li>
<li>WWW静态服务软件Nginx</li>
<li>WWW动态服务软件resin</li>
<li>WWW动态服务软件Tomcat</li>
<li>WWW动态服务软件PHP</li>
</ol></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-05T01:53:43+08:00" itemprop="datePublished">2017/8/5</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018692235223.html" itemprop="url">
		廿二、ansible</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">ansible软件知识介绍</a>
</li>
<li>
<a href="#toc_1">ansible软件特点概述(与saltstack对比)</a>
</li>
<li>
<a href="#toc_2">部署ansible</a>
</li>
<li>
<a href="#toc_3">ansible软件包说明</a>
</li>
<li>
<a href="#toc_4">ansible 远程执行脚本模块shell</a>
<ul>
<li>
<a href="#toc_5">不将脚本进行推送，让受控端执行脚本功能</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">ansible软件部署安装需求</a>
</li>
<li>
<a href="#toc_7">ansible在没有秘钥的时候如何批量管理</a>
<ul>
<li>
<a href="#toc_8">ansible测试受控端连通性方法</a>
</li>
</ul>
</li>
<li>
<a href="#toc_9">shell模块说明</a>
<ul>
<li>
<a href="#toc_10">shell模块和command模块功能类似，但是shell模块可以识别一些特殊符号信息 &gt; &gt;&gt; | * ^</a>
</li>
<li>
<a href="#toc_11">通过yum模块安装nmap软件：</a>
</li>
<li>
<a href="#toc_12">通过service模块管理软件服务：</a>
</li>
<li>
<a href="#toc_13">通过file模块设置文件属性信息：</a>
</li>
<li>
<a href="#toc_14">expect软件介绍</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_15">附录01：pssh命令使用扩展</a>
<ul>
<li>
<a href="#toc_16"></a>
</li>
<li>
<a href="#toc_17">ansible -k 172.16.1.51 -m ping</a>
</li>
</ul>


<h2 id="toc_0">ansible软件知识介绍</h2>

<blockquote>
<p>python语言是运维人员必会的语言！<br/>
ansible是一个基于Python开发的自动化运维工具！<br/>
其功能实现基于SSH+key远程连接服务！<br/>
ansible可以实现批量系统配置、批量软件部署、批量文件拷贝、批量运行命令等功能</p>

<p>说明信息：<br/>
ansible软件相关参考链接信息<br/>
<a href="http://docs.ansible.com/ansible/intro_installation.html">http://docs.ansible.com/ansible/intro_installation.html</a><br/>
<a href="http://www.ansible.com.cn/">http://www.ansible.com.cn/</a><br/>
<a href="http://docs.ansible.com/modules_by_category.html">http://docs.ansible.com/modules_by_category.html</a><br/>
<a href="http://www.ansible.cn/docs/">http://www.ansible.cn/docs/</a></p>
</blockquote>

<h2 id="toc_1">ansible软件特点概述(与saltstack对比)</h2>

<blockquote>
<p>不需要单独安装客户端（no agents），基于系统自带的sshd服务，sshd就相当于ansible的客户端。<br/>
不需要服务端(no servers)。<br/>
需要依靠大量的模块实现批量管理。（不需要自行编写脚本了 command模型 批量管理执行命令）<br/>
配置文件/etc/ansible/ansible.cfg</p>
</blockquote>

<h2 id="toc_2">部署ansible</h2>

<pre><code>①. 将管理端服务器上的公钥确认分发给了所有受控端
②. 管理端部署过程
    yum install epel-release  -y  &lt;- 随意的一个epel源
    wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
    说明：更新下载epel，ansible软件需要借助epel源进行下载安装
    yum install -y ansible
③. 受控端部署过程
    yum install libselinux-python -y
    说明：libselinux-python---在selinux中配置了，放行ansible到受控端的网络管理服务
</code></pre>

<h2 id="toc_3">ansible软件包说明</h2>

<pre><code>ansible软件常用命令
/usr/bin/ansible
/usr/bin/ansible-doc
/usr/bin/ansible-playbook

ansible软件重要配置文件
/etc/ansible/ansible.cfg
/etc/ansible/hosts           ---定义主控端所能管理的受控端信息
/etc/ansible/roles
</code></pre>

<h2 id="toc_4">ansible 远程执行脚本模块shell</h2>

<pre><code>[root@m01 scripts]# ansible oldboy -m copy -a &quot;src=/server/scripts/yum.sh dest=/server/scripts/&quot;
172.16.1.7 | SUCCESS =&gt; {
    &quot;changed&quot;: true, 
    &quot;checksum&quot;: &quot;1f34ee1ed19732776dde2961687199d096a0da57&quot;, 
    &quot;dest&quot;: &quot;/server/scripts/yum.sh&quot;, 
    &quot;gid&quot;: 0, 
    &quot;group&quot;: &quot;root&quot;, 
    &quot;md5sum&quot;: &quot;503d158b84339962adb698dc1ad57104&quot;, 
    &quot;mode&quot;: &quot;0644&quot;, 
    &quot;owner&quot;: &quot;root&quot;, 
    &quot;size&quot;: 34, 
    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1501735166.76-143080750592154/source&quot;, 
    &quot;state&quot;: &quot;file&quot;, 
    &quot;uid&quot;: 0
}
172.16.1.31 | SUCCESS =&gt; {
    &quot;changed&quot;: true, 
    &quot;checksum&quot;: &quot;1f34ee1ed19732776dde2961687199d096a0da57&quot;, 
    &quot;dest&quot;: &quot;/server/scripts/yum.sh&quot;, 
    &quot;gid&quot;: 0, 
    &quot;group&quot;: &quot;root&quot;, 
    &quot;md5sum&quot;: &quot;503d158b84339962adb698dc1ad57104&quot;, 
    &quot;mode&quot;: &quot;0644&quot;, 
    &quot;owner&quot;: &quot;root&quot;, 
    &quot;size&quot;: 34, 
    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1501735166.72-229091717010814/source&quot;, 
    &quot;state&quot;: &quot;file&quot;, 
    &quot;uid&quot;: 0
}
172.16.1.41 | SUCCESS =&gt; {
    &quot;changed&quot;: true, 
    &quot;checksum&quot;: &quot;1f34ee1ed19732776dde2961687199d096a0da57&quot;, 
    &quot;dest&quot;: &quot;/server/scripts/yum.sh&quot;, 
    &quot;gid&quot;: 0, 
    &quot;group&quot;: &quot;root&quot;, 
    &quot;md5sum&quot;: &quot;503d158b84339962adb698dc1ad57104&quot;, 
    &quot;mode&quot;: &quot;0644&quot;, 
    &quot;owner&quot;: &quot;root&quot;, 
    &quot;size&quot;: 34, 
    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1501735166.72-179829629838013/source&quot;, 
    &quot;state&quot;: &quot;file&quot;, 
    &quot;uid&quot;: 0
}
[root@m01 scripts]# ansible oldboy  -a &quot;ls /server/scripts&quot;
172.16.1.41 | SUCCESS | rc=0 &gt;&gt;
yum.sh

172.16.1.31 | SUCCESS | rc=0 &gt;&gt;
inotify.sh
nohup.out
yum.sh

172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
finger.txt
test.txt
web01_backup.sh
yum.sh

[root@m01 scripts]# ansible oldboy -m shell -a &quot;/bin/sh /server/scripts/yum.sh&quot;
172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
Loaded plugins: fastestmirror, security
Setting up Install Process
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * epel: mirrors.aliyun.com
 * extras: mirrors.aliyun.com
 * updates: mirrors.aliyun.com
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package iftop.x86_64 0:1.0-0.14.pre4.el6 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

================================================================================
 Package        Arch            Version                     Repository     Size
 
================================================================================
Installing:
 iftop          x86_64          1.0-0.14.pre4.el6           epel           49 k

Transaction Summary

================================================================================
Install       1 Package(s)

Total download size: 49 k
Installed size: 89 k
Downloading Packages:
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : iftop-1.0-0.14.pre4.el6.x86_64                               1/1 
  Verifying  : iftop-1.0-0.14.pre4.el6.x86_64                               1/1 

Installed:
  iftop.x86_64 0:1.0-0.14.pre4.el6                                              

Complete!

172.16.1.41 | SUCCESS | rc=0 &gt;&gt;
Loaded plugins: fastestmirror, security
Setting up Install Process
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * epel: mirrors.aliyun.com
 * extras: mirrors.aliyun.com
 * updates: mirrors.aliyun.com
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package iftop.x86_64 0:1.0-0.14.pre4.el6 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

================================================================================
 Package        Arch            Version                     Repository     Size
 
================================================================================
Installing:
 iftop          x86_64          1.0-0.14.pre4.el6           epel           49 k

Transaction Summary

================================================================================
Install       1 Package(s)

Total download size: 49 k
Installed size: 89 k
Downloading Packages:
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : iftop-1.0-0.14.pre4.el6.x86_64                               1/1 
  Verifying  : iftop-1.0-0.14.pre4.el6.x86_64                               1/1 

Installed:
  iftop.x86_64 0:1.0-0.14.pre4.el6                                              

Complete!

172.16.1.31 | SUCCESS | rc=0 &gt;&gt;
Loaded plugins: fastestmirror, security
Setting up Install Process
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * epel: mirrors.aliyun.com
 * extras: mirrors.aliyun.com
 * updates: mirrors.aliyun.com
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package iftop.x86_64 0:1.0-0.14.pre4.el6 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

================================================================================
 Package        Arch            Version                     Repository     Size
 
================================================================================
Installing:
 iftop          x86_64          1.0-0.14.pre4.el6           epel           49 k

Transaction Summary

================================================================================
Install       1 Package(s)

Total download size: 49 k
Installed size: 89 k
Downloading Packages:
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : iftop-1.0-0.14.pre4.el6.x86_64                               1/1 
  Verifying  : iftop-1.0-0.14.pre4.el6.x86_64                               1/1 

Installed:
  iftop.x86_64 0:1.0-0.14.pre4.el6                                              

Complete!

[root@m01 scripts]# ansible oldboy  -a &quot;rpm -qa iftop&quot;
 [WARNING]: Consider using yum, dnf or zypper module rather than running rpm

172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
iftop-1.0-0.14.pre4.el6.x86_64

172.16.1.31 | SUCCESS | rc=0 &gt;&gt;
iftop-1.0-0.14.pre4.el6.x86_64

172.16.1.41 | SUCCESS | rc=0 &gt;&gt;
iftop-1.0-0.14.pre4.el6.x86_64
</code></pre>

<h3 id="toc_5">不将脚本进行推送，让受控端执行脚本功能</h3>

<pre><code>[root@m01 scripts]# ansible oldboy -m script -a &quot;/server/scripts/yum02.sh&quot;
172.16.1.41 | SUCCESS =&gt; {
    &quot;changed&quot;: true, 
    &quot;rc&quot;: 0, 
    &quot;stderr&quot;: &quot;Shared connection to 172.16.1.41 closed.\r\n&quot;, 
    &quot;stdout&quot;: &quot;Loaded plugins: fastestmirror, security\r\nLoading mirror speeds from cached hostfile\r\n * base: mirrors.aliyun.com\r\n * epel: mirrors.aliyun.com\r\n * extras: mirrors.aliyun.com\r\n * updates: mirrors.aliyun.com\r\nrepo id          repo name                                                status\r\nbase             CentOS-6 - Base - mirrors.aliyun.com                      6,706\r\nepel             Extra Packages for Enterprise Linux 6 - x86_64           12,372\r\nextras           CentOS-6 - Extras - mirrors.aliyun.com                       45\r\nupdates          CentOS-6 - Updates - mirrors.aliyun.com                     447\r\nrepolist: 19,570\r\n&quot;, 
    &quot;stdout_lines&quot;: [
        &quot;Loaded plugins: fastestmirror, security&quot;, 
        &quot;Loading mirror speeds from cached hostfile&quot;, 
        &quot; * base: mirrors.aliyun.com&quot;, 
        &quot; * epel: mirrors.aliyun.com&quot;, 
        &quot; * extras: mirrors.aliyun.com&quot;, 
        &quot; * updates: mirrors.aliyun.com&quot;, 
        &quot;repo id          repo name                                                status&quot;, 
        &quot;base             CentOS-6 - Base - mirrors.aliyun.com                      6,706&quot;, 
        &quot;epel             Extra Packages for Enterprise Linux 6 - x86_64           12,372&quot;, 
        &quot;extras           CentOS-6 - Extras - mirrors.aliyun.com                       45&quot;, 
        &quot;updates          CentOS-6 - Updates - mirrors.aliyun.com                     447&quot;, 
        &quot;repolist: 19,570&quot;
    ]
}
172.16.1.7 | SUCCESS =&gt; {
    &quot;changed&quot;: true, 
    &quot;rc&quot;: 0, 
    &quot;stderr&quot;: &quot;Shared connection to 172.16.1.7 closed.\r\n&quot;, 
    &quot;stdout&quot;: &quot;Loaded plugins: fastestmirror, security\r\nLoading mirror speeds from cached hostfile\r\n * base: mirrors.aliyun.com\r\n * epel: mirrors.aliyun.com\r\n * extras: mirrors.aliyun.com\r\n * updates: mirrors.aliyun.com\r\nrepo id          repo name                                                status\r\nbase             CentOS-6 - Base - mirrors.aliyun.com                      6,706\r\nepel             Extra Packages for Enterprise Linux 6 - x86_64           12,372\r\nextras           CentOS-6 - Extras - mirrors.aliyun.com                       45\r\nupdates          CentOS-6 - Updates - mirrors.aliyun.com                     447\r\nrepolist: 19,570\r\n&quot;, 
    &quot;stdout_lines&quot;: [
        &quot;Loaded plugins: fastestmirror, security&quot;, 
        &quot;Loading mirror speeds from cached hostfile&quot;, 
        &quot; * base: mirrors.aliyun.com&quot;, 
        &quot; * epel: mirrors.aliyun.com&quot;, 
        &quot; * extras: mirrors.aliyun.com&quot;, 
        &quot; * updates: mirrors.aliyun.com&quot;, 
        &quot;repo id          repo name                                                status&quot;, 
        &quot;base             CentOS-6 - Base - mirrors.aliyun.com                      6,706&quot;, 
        &quot;epel             Extra Packages for Enterprise Linux 6 - x86_64           12,372&quot;, 
        &quot;extras           CentOS-6 - Extras - mirrors.aliyun.com                       45&quot;, 
        &quot;updates          CentOS-6 - Updates - mirrors.aliyun.com                     447&quot;, 
        &quot;repolist: 19,570&quot;
    ]
}
172.16.1.31 | SUCCESS =&gt; {
    &quot;changed&quot;: true, 
    &quot;rc&quot;: 0, 
    &quot;stderr&quot;: &quot;Shared connection to 172.16.1.31 closed.\r\n&quot;, 
    &quot;stdout&quot;: &quot;Loaded plugins: fastestmirror, security\r\nLoading mirror speeds from cached hostfile\r\n * base: mirrors.aliyun.com\r\n * epel: mirrors.aliyun.com\r\n * extras: mirrors.aliyun.com\r\n * updates: mirrors.aliyun.com\r\nrepo id          repo name                                                status\r\nbase             CentOS-6 - Base - mirrors.aliyun.com                      6,706\r\nepel             Extra Packages for Enterprise Linux 6 - x86_64           12,372\r\nextras           CentOS-6 - Extras - mirrors.aliyun.com                       45\r\nupdates          CentOS-6 - Updates - mirrors.aliyun.com                     447\r\nrepolist: 19,570\r\n&quot;, 
    &quot;stdout_lines&quot;: [
        &quot;Loaded plugins: fastestmirror, security&quot;, 
        &quot;Loading mirror speeds from cached hostfile&quot;, 
        &quot; * base: mirrors.aliyun.com&quot;, 
        &quot; * epel: mirrors.aliyun.com&quot;, 
        &quot; * extras: mirrors.aliyun.com&quot;, 
        &quot; * updates: mirrors.aliyun.com&quot;, 
        &quot;repo id          repo name                                                status&quot;, 
        &quot;base             CentOS-6 - Base - mirrors.aliyun.com                      6,706&quot;, 
        &quot;epel             Extra Packages for Enterprise Linux 6 - x86_64           12,372&quot;, 
        &quot;extras           CentOS-6 - Extras - mirrors.aliyun.com                       45&quot;, 
        &quot;updates          CentOS-6 - Updates - mirrors.aliyun.com                     447&quot;, 
        &quot;repolist: 19,570&quot;
    ]
}
</code></pre>

<!--
01：课程内容回顾
    ①. SSH免密码(ssh key密钥认证)登录课程回顾小结
        · 免密码登录验证是单向的，方向从私钥(钥匙)==>公钥(锁)
        · SSH免密码登录基于用户的，最好不要跨不同的用户
        · SSH连接慢解决；即修改sshd_config配置文件参数信息
        · 批量分发1000台初始都需要输入一次密码，并且第一次连接要确认(expect/sshpass)
          expect批量管理服务器参考博文---老男孩教育女学生作品
          http://oldboy.blog.51cto.com/2561410/1206238

02: 企业级生产场景批量管理-自动化管理方案
    ①. 最简单/最常用/最强大的选择是ssh key+shell/pssh方案，一般中小型企业会用(50-100台以下规模企业)
        a. 利用ssh key执行命令，并将命令放在脚本里面
        b. 利用ssh key执行命令，将命令放在脚本里面，并加上相应循环语句或判断语句
    ②. sina cfengine/puppet 较早的批量管理工具；现在基本上没有企业用
    ③. 门户级别比较流行的，puppet批量管理工具(复杂/笨重)
    ④. saltstack 批量管理工具；特点：简单，功能强大(配置复杂)---赶集网/小米/一些CDN公司
    批量管理路线：ssh key==>cfengine==>puppet==>saltstack/ansible  
    PS: 使用ansible软件的前提是ssh key公钥分发完成

03：如何完成集群规模架构一键自动化实现(步骤说明)
    ①. 5台服务器先配置好（kickstart,cobbler无人值守安装）。高级实现云计算（按需分配，动态调整）(openstack,kvm)
    ②. linux基本优化，包括ssh服务（可以自动化实现）。
    ③. 创建密钥信息(自动化免交互创建)
        ssh-keygen -t dsa -P '' -f ~/.ssh/id_dsa >/dev/null 2>&1
    ④. 进行批量分发密钥（sshpass,expect自动化实现）
    ⑤. ansible软件安装（可以自动化实现）
    ⑥. 网络服务自动化安装（ansible实现）
        (搭建yum仓库，定制rpm包)
-->

<h2 id="toc_6">ansible软件部署安装需求</h2>

<blockquote>
<ol>
<li>需要有epel源</li>
<li>ssh+key免密码环境必须部署完成</li>
</ol>
</blockquote>

<h2 id="toc_7">ansible在没有秘钥的时候如何批量管理</h2>

<blockquote>
<ol>
<li>编写hosts文件
不基于ssh+key方式使用ansible</li>
</ol>
</blockquote>

<h3 id="toc_8">ansible测试受控端连通性方法</h3>

<pre><code>[root@m01 ansible]# ansible 172.16.1.7 -m ping
2.16.1.7 | UNREACHABLE! =&gt; {
&quot;changed&quot;: false, 
&quot;msg&quot;: &quot;Failed to connect to the host via ssh: Permission denied (publickey,password).\r\n&quot;, 
&quot;unreachable&quot;: true
}
    
# vim /etc/ansible/hosts
172.16.1.7 ansible_ssh_user=root ansible_ssh_pass=123456
[root@m01 ansible]# ansible 172.16.1.7 -m ping
172.16.1.7 | SUCCESS =&gt; {
&quot;changed&quot;: false, 
&quot;ping&quot;: &quot;pong&quot;
}
    
# 不在hosts文件写入密码实现ansible远程管理
[root@m01 ansible]# ansible -k 172.16.1.7 -m ping
SSH password: 
172.16.1.7 | SUCCESS =&gt; {
&quot;changed&quot;: false, 
&quot;ping&quot;: &quot;pong&quot;
}
</code></pre>

<h2 id="toc_9">shell模块说明</h2>

<pre><code>[root@m01 ssh]# ansible 172.16.1.31 -m command -a &quot;free -m &gt;/tmp/free.txt&quot;
172.16.1.31 | SUCCESS | rc=0 &gt;&gt;
             total       used       free     shared    buffers     cached
Mem:          1990        348       1642          0         30        180
-/+ buffers/cache:        138       1852
Swap:          767          0        767

[root@m01 ssh]# ansible 172.16.1.31 -m command -a &quot;cat /tmp/free.txt&quot;
172.16.1.31 | FAILED | rc=1 &gt;&gt;
cat: /tmp/free.txt: No such file or directory

[root@m01 ssh]# ansible 172.16.1.31 -m shell -a &quot;free -m &gt;/tmp/free.txt&quot;
172.16.1.31 | SUCCESS | rc=0 &gt;&gt;


[root@m01 ssh]# ansible 172.16.1.31 -m command -a &quot;cat /tmp/free.txt&quot;
172.16.1.31 | SUCCESS | rc=0 &gt;&gt;
             total       used       free     shared    buffers     cached
Mem:          1990        348       1642          0         30        180
-/+ buffers/cache:        138       1852
Swap:          767          0        767
</code></pre>

<h3 id="toc_10">shell模块和command模块功能类似，但是shell模块可以识别一些特殊符号信息 &gt; &gt;&gt; | * ^</h3>

<blockquote>
<p><strong>可完全替代Command模块</strong></p>
</blockquote>

<h3 id="toc_11">通过yum模块安装nmap软件：</h3>

<pre><code>ansible oldboy -m yum -a &quot;name=nmap state=installed&quot;
</code></pre>

<h3 id="toc_12">通过service模块管理软件服务：</h3>

<pre><code>ansible oldboy -m service -a &quot;name=crond state=stop enabled=no&quot;
</code></pre>

<h3 id="toc_13">通过file模块设置文件属性信息：</h3>

<pre><code>ansible oldboy -m file -a &quot;src=/etc/hosts dest=/tmp/hosts state=link own=oldboy mode=0600&quot;
说明：表示批量创建软件
</code></pre>

<h3 id="toc_14">expect软件介绍</h3>

<pre><code>ssh 连接时
在文件中定义好：
yes/no ：yes
password ： 123456
</code></pre>

<p>04: ansible基础知识部分补充<br/>
    1） ansible软件特点：<br/>
        · 可以实现批量管理<br/>
        · 可以实现批量部署<br/>
        · ad-hoc(批量执行命令)---针对临时性的操作<br/>
          ansible oldboy -m command -a &quot;hostname&quot;   &lt;- 批量执行命令举例<br/>
        · 编写剧本-脚本(playbook)---针对重复性的操作<br/>
    2） ansible核心功能：<br/>
        · pyYAML-----用于ansible编写剧本所使用的语言格式<br/>
        · paramiko---远程连接与数据传输<br/><br/>
        · Jinja2-----用于编写ansible的模板信息<br/>
    ======================================================================================<br/>
    扩展说明：jinja2模板作用：<br/>
   【for循环语句jinja模板】<br/>
    为远程主机生成服务器列表，加入该列表info从192.168.13.201 web01.test.com 到192.168.13.211 web11.test.com 结束，<br/>
    如果手动添加就很不科学了，这里需要使用jinja2语法的for循环通过模板批量生成对应的配置文件，如下：</p>

<pre><code>ansible目录结构：
#cd /etc/ansible/roles/test_hosts
.
├── meta
│   └── main.yml
├── tasks
│   ├── file1.yml
│   └── main.yml
├── templates
│   └── test1.j2
└── vars
    └── main.yml

各个目录下yml文件内容：
# cat tasks/main.yml 
- include: file1.yml

# cat tasks/file1.yml 
- name: ansible jinja2 template for hosts config
  template: src=test1.j2 dest=/etc/httpd/conf/httpd.conf.test

# cat templates/test1.j2 
  {% for id in range(201,211) %}
  192.168.13.{{ id }} web{{ &quot;%02d&quot; |format(id-200) }}.test.com
  {% endfor %}
  解释：
  {{ id }} 提取for循环中对应的变量id值
  &quot;%02d&quot;   调用的是python内置的字符串格式化输出（%d格式化整数）因为是01,02这种格式，所以是保留2位，故用02
  然后将结果通过管道符 “|” 传递给format 函数做二次处理。

  执行结果： 
  #cat httpd.conf.test
  192.168.13.201 web01.test.com
  192.168.13.202 web02.test.com
  192.168.13.203 web03.test.com
  192.168.13.204 web04.test.com
  192.168.13.205 web05.test.com
  192.168.13.206 web06.test.com
  192.168.13.207 web07.test.com
  192.168.13.208 web08.test.com
  192.168.13.209 web09.test.com
  192.168.13.210 web10.test.com
  192.168.13.211 web11.test.com

参考资料：http://linuxg.blog.51cto.com/4410110/1788574
======================================================================================  
  说明：很多ansible的报错都是和python有关，因为ansible的底层开发是利用python编写的
</code></pre>

<p>05: ansible扩展模块功能介绍<br/>
    ①. ansible实现检查被管理服务器端网络连接是否通畅(检查道路是否通畅)<br/>
        # ansible oldboy -m command -a &quot;hostname&quot;    &lt;-- 最开始检查道路是否通畅方法<br/>
        # ansible oldboy -m ping                     &lt;-- 专业检查道路是否通畅方法<br/>
        172.16.1.31 | SUCCESS =&gt; {<br/>
        &quot;changed&quot;: false, <br/>
        &quot;ping&quot;: &quot;pong&quot;<br/>
        }<br/>
        172.16.1.7 | SUCCESS =&gt; {<br/>
            &quot;changed&quot;: false, <br/>
            &quot;ping&quot;: &quot;pong&quot;<br/>
        }<br/>
        172.16.1.41 | SUCCESS =&gt; {<br/>
            &quot;changed&quot;: false, <br/>
            &quot;ping&quot;: &quot;pong&quot;<br/>
        }<br/>
        以上信息不清楚，可以通过利用ansible查看帮助信息方法获取新模块功能说明<br/>
        # ansible-doc -s ping<br/>
        - name: Try to connect to host, verify a usable python and return `pong&#39; on success.<br/>
        action: ping<br/>
        说明：尝试连接到主机，验证网络连接是否通畅，如果通畅返回pong信息表示成功<br/>
              激活验证功能，利用ping模块</p>

<pre><code>②. ansible实现定时任务功能执行相应的操作(定时任务) 
    回顾传统的定时任务为：
    # crontab -l
    #time sync by oldboy at 2010-2-1
    */5 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1
    说明：日期格式为 分钟:minute，小时:hour，日期:day，月:month，周：weekday  
          日期格式后面接需要执行的命令或脚本文件
    获取ansible定时任务模块说明信息：
    # ansible-doc -s cron
    - name: Manage cron.d and crontab entries.
            cron模块主要管理cron.d和crontab条目信息；即实现配置定时任务
      action: cron    激活定时任务功能，利用cron模块
          backup                 # If set, create a backup of the crontab before it is modified. The location of the backup is returned in the `backup_file&#39; variable by this module.
          cron_file              # If specified, uses this file instead of an individual user&#39;s crontab. If this is a relative path, it is interpreted with respect to /etc/cron.d. (If it is absolute, it will
                                   typically be /etc/crontab). To use the `cron_file&#39; parameter you must specify the `user&#39; as well.
          day                    # Day of the month the job should run ( 1-31, *, */2, etc )
                                   运行job任务的日期时间信息(编写方式1-31，*, */2, 等)
          disabled               # If the job should be disabled (commented out) in the crontab. Only has effect if state=present
                                   如果job应该关闭(被注释掉)。只能影响状态是开启状态的定时任务条目
          env                    # If set, manages a crontab&#39;s environment variable. New variables are added on top of crontab. &quot;name&quot; and &quot;value&quot; parameters are the name and the value of environment variable.
                                   如果设置，管理crontab的环境变量信息。新的环境变量信息会被增加到定时任务表顶部。描述或数值会被环境变得的名称或数值所定义
          hour                   # Hour when the job should run ( 0-23, *, */2, etc )
                                   运行job任务的小时时间信息(编写方式0-23，*, */2, 等)
          insertafter            # Used with `state=present&#39; and `env&#39;. If specified, the environment variable will be inserted after the declaration of specified environment variable.
          insertbefore           # Used with `state=present&#39; and `env&#39;. If specified, the environment variable will be inserted before the declaration of specified environment variable.
          job                    # The command to execute or, if env is set, the value of environment variable. Required if state=present.
                                   执行相应的命令，如果env被设置，将作为环境变量的值，但前提是state=present
          minute                 # Minute when the job should run ( 0-59, *, */2, etc )
                                   运行job任务的分钟时间信息(编写方式0-59，*，*/2,等等)
          month                  # Month of the year the job should run ( 1-12, *, */2, etc )
                                   运行job任务的月份时间信息(编写方式1-12，*, */2, 等)
          name                   # Description of a crontab entry or, if env is set, the name of environment variable. Required if state=absent. Note that if name is not set and state=present, then a new crontab
                                   entry will always be created, regardless of existing ones.
                                   定时任务条目的描述信息；如果env被设定了，描述信息将为环境变量信息。前提是定时任务状态为关闭状态
                                   注意：如果名称没有被指定并且定时任务状态为开启，那么新的定时任务将总被创建，不管这个定时任务是否存在
          reboot                 # If the job should be run at reboot. This option is deprecated. Users should use special_time.
          special_time           # Special time specification nickname.
                                   指定时间规格绰号
          state                  # Whether to ensure the job or environment variable is present or absent.
                                   确认job或环境变量是开启或是关闭
          user                   # The specific user whose crontab should be modified.
                                   指定修改与编写定时任务的用户信息
          weekday                # Day of the week that the job should run ( 0-6 for Sunday-Saturday, *, etc )
                                   job任务应该在一周的哪天进行运行(编写方式0-6表示周日到周六，以及用*符号等)

    # ansible 172.16.1.7 -a &quot;crontab -l&quot;                  &lt;- 查看当前被管理服务器定时任务文件信息
      172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
      #crond-id-001:time sync by hq
      */5 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1

    参考下面编写的定时任务条目，进行编写ansible定时任务命令
    # restart network
    00 00 * * * /etc/init.d/network restart &gt;/dev/null 2&gt;&amp;1
    # ansible 172.16.1.7 -m cron -a &quot;minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;&quot;
      172.16.1.7 | SUCCESS =&gt; {
          &quot;changed&quot;: true, 
          &quot;envs&quot;: [], 
          &quot;jobs&quot;: [
              &quot;None&quot;
          ]
      }
    # ansible 172.16.1.7 -a &quot;crontab -l&quot;
      172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
      #Ansible: None
      00 00 * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1

    如果没有定义定时任务描述信息，每次执行ansible创建定时任务，都会被反复创建
    # ansible 172.16.1.7 -m cron -a &quot;name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;&quot;
      172.16.1.7 | SUCCESS =&gt; {
          &quot;changed&quot;: true, 
          &quot;envs&quot;: [], 
          &quot;jobs&quot;: [
              &quot;None&quot;, 
              &quot;restart network&quot;
          ]
      }
    # ansible 172.16.1.7 -a &quot;crontab -l&quot;
      172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
      #Ansible: None
      00 00 * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1
      #Ansible: restart network
      00 00 * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1

    利用ansible的模拟检查参数-C，实现模拟检查ansible命令语法格式是否正确，但命令并不会执行产生效果       
    # ansible 172.16.1.7 -C -m cron -a &quot;name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;&quot;
      172.16.1.7 | SUCCESS =&gt; {
          &quot;changed&quot;: false, 
          &quot;envs&quot;: [], 
          &quot;jobs&quot;: [
              &quot;None&quot;, 
              &quot;restart network&quot;
          ]
      }

    删除无用的定时任务信息
    # ansible 172.16.1.7 -C -m cron -a &quot;name=&#39;None&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39; state=absent&quot;  &lt;- 先进行测试，测试成功后再进行删除
    # ansible 172.16.1.7  -m cron -a &quot;name=&#39;None&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39; state=absent&quot;
      172.16.1.7 | SUCCESS =&gt; {
          &quot;changed&quot;: true, 
          &quot;envs&quot;: [], 
          &quot;jobs&quot;: [
              &quot;restart network&quot;
          ]
      }
    # ansible 172.16.1.7  -m cron -a &quot;name=&#39;None&#39; state=absent&quot;   &lt;- 指定当前任务名称，即可进行删除操作

    临时关闭与开启指定定时任务效果，但不删除定时任务条目
    # ansible 172.16.1.7 -m cron -a &quot;name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39; disabled=yes&quot;
      172.16.1.7 | SUCCESS =&gt; {
          &quot;changed&quot;: true, 
          &quot;envs&quot;: [], 
          &quot;jobs&quot;: [
              &quot;restart network&quot;
          ]
      }
      [root@m01 ~]# ansible 172.16.1.7 -a &quot;crontab -l&quot;
      172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
      #Ansible: restart network
      #00 00 * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1

    # ansible 172.16.1.7 -m cron -a &quot;name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39; disabled=no&quot;
      172.16.1.7 | SUCCESS =&gt; {
          &quot;changed&quot;: true, 
          &quot;envs&quot;: [], 
          &quot;jobs&quot;: [
              &quot;restart network&quot;
          ]
      }
      [root@m01 ~]# ansible 172.16.1.7 -a &quot;crontab -l&quot;
      172.16.1.7 | SUCCESS | rc=0 &gt;&gt;
      #Ansible: restart network
      00 00 * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1


      cron模块总结：
      01：对定时任务的状态进行注释时，-a后面信息，一定要包含定时任务的name信息以及job信息
      02：如果没有定义定时任务描述信息，每次执行ansible创建定时任务，都会被反复创建
      03：利用ansible的模拟检查参数-C，实现模拟检查ansible命令语法格式是否正确，但命令并不会执行产生效果
      04：指定当前任务名称，即可进行删除操作
</code></pre>

<p>06: ansible重要模块功能总结<br/><br/>
    command （重要模块）  执行命令模块，ansible命令执行默认模块<br/>
    shell   （重要模块）  执行shell脚本模块<br/>
    script  （重要模块）  把脚本发到客户端，然后执行；执行脚本命令在远端服务器上<br/>
    copy    （重要模块）  把本地文件发送到远端</p>

<p>07: ansible剧本编写规则说明<br/>
    pyYAML语法规则：<br/>
    规则一：缩进<br/>
    yaml使用一个固定的缩进风格表示数据层结构关系，Saltstack需要每个缩进级别由两个空格组成。一定不能使用tab键<br/>
    规则二：冒号<br/>
    CMD=&quot;echo&quot;<br/>
    yaml:<br/>
    mykey:<br/>
    每个冒号后面一定要有一个空格（以冒号结尾不需要空格，表示文件路径的模版可以不需要空格）<br/>
    规则三：短横线<br/>
    想要表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为同一个列表的一部分<br/>
    核心规则：有效的利用空格进行剧本的编写，剧本编写是不支持tab的</p>

<pre><code>---
### 剧本的开头，可以不写
- hosts: all         &lt;- 处理所有服务器，找到所有服务器;  -(空格)hosts:(空格)all
  task:              &lt;- 剧本所要干的事情;                (空格)(空格)task:
    - command: echo hello oldboy linux.                  (空格)(空格)空格)(空格)-(空格)模块名称:(空格)模块中对应的功能

剧本编写内容扩展：剧本任务定义名称
- hosts: 172.16.1.7  &lt;- 处理指定服务器                   -(空格)hosts:(空格)all
  task:                &lt;- 剧本所要干的事情;                (空格)(空格)task:
    - name: 
      command: echo hello oldboy linux.                  (空格)(空格)空格)(空格)-(空格)模块名称:(空格)模块中对应的功能

剧本编写内容扩展：剧本任务编写定时任务
# ansible all -m cron -a &quot;name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;&quot;
- hosts: all
  tasks:
    - name: restart-network
      cron: name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;
# ansible-playbook -C /etc/ansible/network-restart.yml  -vvvx
说明：测试剧本命令后面可以跟多个-v进行调试检查

剧本编写内容扩展：剧本任务编写多个任务
- hosts: all
  tasks:
    - name: restart-network
      cron: name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;
    - name: sync time
      cron: name=&#39;sync time&#39; minute=*/5 job=&quot;/usr/sbin/ntpdate pool.ntp.com &gt;/dev/null 2&gt;&amp;1&quot;


剧本编写内容扩展：剧本任务编写多个主机
- hosts: 172.16.1.7
  tasks:
    - name: restart-network
      cron: name=&#39;restart network&#39; minute=00 hour=00 job=&#39;/usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&#39;
    - name: sync time
      cron: name=&#39;sync time&#39; minute=*/5 job=&quot;/usr/sbin/ntpdate pool.ntp.com &gt;/dev/null 2&gt;&amp;1&quot;
- hosts: 172.16.1.31
  tasks:
    - name: show ip addr to file
      shell: echo $(hostname -i) &gt;&gt; /tmp/ip.txt
**************************************************************************************
扩展知识说明：vim编辑器使用说明
01：复制当前行到最后一行的内容，然后粘贴到最后一行的后面
    :/172.16.1.31/,$copy$
    :.,$copy$
**************************************************************************************

剧本编写方式
01 多主机单任务编写方式
02 多主机多任务编写方式
03 单主机多任务编写方式
</code></pre>

<p>08: ansible剧本编写总结说明<br/>
    找什么服务器，让服务器干写什么<br/>
    多使用检查命令-C</p>

<p>09：课后作业：<br/>
    ①. 请总结一下mount模块是否存在，mount模块如何使用<br/>
    ②. 利用ansible安装rsync服务器<br/>
    ③. 利用ansible安装nfs服务器<br/>
    ④. 利用ansible配置sersync数据同步</p>

<h1 id="toc_15">附录01：pssh命令使用扩展</h1>

<p>原文：<a href="http://liang3391.blog.51cto.com/178205/732100">http://liang3391.blog.51cto.com/178205/732100</a><br/>
参考：<a href="http://www.ibm.com/developerworks/cn/aix/library/au-spunix_remoteserver/index.html">http://www.ibm.com/developerworks/cn/aix/library/au-spunix_remoteserver/index.html</a></p>

<p>01：pssh命令使用场景说明<br/>
    假如同时给上千台服务器执行一个命令,拷贝一个文件,杀一个进程等,有什么简化运维管理的工具呢?<br/>
    在小型企业中通常使用for循环,但是数量巨大时：<br/>
    · 一方面不确定操作是否成功一方面不确定操作是否成功<br/>
    · 一方面for循环语句性能不好估计且是不是同步并行执行。<br/>
    因此需要使用批量并行执行的命令，这类工具比如 pdsh，mussh，cssh，dsh等还有下面说明提到的pssh</p>

<p>02：pssh软件安装部署方式 <br/>
    ①. 通过yum安装pssh软件<br/>
        yum install -y pssh    &lt;- pssh软件下载需要依靠epel源<br/>
        说明：pssh是一个软件大礼包，里面有很多软件命令<br/>
        # rpm -ql pssh<br/>
        /usr/bin/pnuke<br/>
        /usr/bin/prsync<br/>
        /usr/bin/pscp.pssh<br/>
        /usr/bin/pslurp<br/>
        /usr/bin/pssh<br/>
        ....省略部分信息....<br/>
    ①. 通过编译方式安装pssh软件<br/>
        wget <a href="http://peak.telecommunity.com/dist/ez_setup.py">http://peak.telecommunity.com/dist/ez_setup.py</a><br/>
        python ez_setup.py<br/>
        wget <a href="http://parallel-ssh.googlecode.com/files/pssh-2.2.2.tar.gz">http://parallel-ssh.googlecode.com/files/pssh-2.2.2.tar.gz</a><br/>
        tar zxvf pssh-2.2.2.tar.gz<br/>
        cd pssh-2.2.2<br/>
        python setup.py install</p>

<p>03：pssh软件使用操作说明(ssh key认证密钥配置完毕)<br/>
    pssh工具包主要有5个程序:<br/>
    ①. pssh  多主机并行运行命令<br/>
        [root@server pssh-2.2.2]# vim hosts_info.txt<br/>
        172.16.1.31:22<br/>
        172.16.1.41:22<br/>
        172.16.1.7:22             //注意我的端口号不仅是默认的22        </p>

<pre><code>    [root@m01 tmp]# pssh -P -h /tmp/hosts_info.txt uptime
    172.16.1.31:  00:05:58 up 3 days, 18:34,  2 users,  load average: 0.00, 0.01, 0.05
    [1] 00:05:58 [SUCCESS] 172.16.1.31:22
    172.16.1.41:  00:05:58 up 9 days, 22:39,  2 users,  load average: 0.00, 0.01, 0.05
    [2] 00:05:58 [SUCCESS] 172.16.1.41:22
    172.16.1.7:  00:05:58 up 9 days, 22:39,  2 users,  load average: 0.00, 0.01, 0.05
    [3] 00:05:58 [SUCCESS] 172.16.1.41:22        
    说明：如果想将执行命令的批量输出信息重定向到一个文件 加-o 目录 选项
          -h HOST_FILE,  --hosts=HOST_FILE       hosts file (each line &quot;[user@]host[:port]&quot;)
          -o OUTDIR,     --outdir=OUTDIR         output directory for stdout files (OPTIONAL)
          -P,            --print                 print output as we get it

②. pscp  把文件并行地复制到多个主机上
    注意 是从服务器端给客户端传送文件:
    [root@server pssh-2.2.2]# pscp -h test.txt /etc/sysconfig/network /tmp/network   
    //标示将本地的/etc/sysconfig/network传到目标服务器的/tmp/network

③. prsync 使用rsync协议从本地计算机同步到远程主机
    [root@server ~]# pssh -h test.txt -P mkdir /tmp/etc
    [root@server ~]# prsync -h test.txt -l dongwm -a -r /etc/sysconfig /tmp/etc 
    //标示将本地的/etc/sysconfig目录递归同步到目标服务器的 /tmp/etc目录下,并保持原来的时间戳,使用用户 dongwm

④. pslurp 将文件从远程主机复制到本地,和pscp方向相反:
    [root@server ~]# pslurp -h test.txt   -L /tmp/test -l root /tmp/network test  
    //标示将目标服务器的/tmp/network文件复制到本地的/tmp/test目录下,并更名为test
    [1] 14:53:54 [SUCCESS] 192.168.9.102 9922
    [2] 14:53:54 [SUCCESS] 192.168.9.104 9922
    [root@server ~]# ll /tmp/test/192.168.9.10
    192.168.9.102/ 192.168.9.104/
    [root@server ~]# ll /tmp/test/192.168.9.102/
    总计 4.0K
    -rw-r--r-- 1 root root 60 2011-04-22 14:53 test
    [root@server ~]# ll /tmp/test/192.168.9.104/
    总计 4.0K
    -rw-r--r-- 1 root root 60 2011-04-22 14:53 test

⑤. pnuke 并行在远程主机杀进程:
    [root@server ~]# pnuke -h test.txt  syslog 
    //杀死目标服务器的syslog进程,只要ps进程中出现相关词语 都能杀死
    [1] 15:05:14 [SUCCESS] 192.168.9.102 9922
    [2] 15:05:14 [SUCCESS] 192.168.9.104 9922
</code></pre>

<h1 id="toc_16"></h1>

<p>常见问题一：<br/><br/>
[root@m01 ~]# ansible  -k 172.16.1.51 -m ping<br/><br/>
SSH password: <br/>
[WARNING]: No hosts matched, nothing to do<br/>
原因分析：<br/>
在ansible的hosts文件中，没有配置相应主机地址信息</p>

<p>常见问题二：        </p>

<h1 id="toc_17">ansible -k 172.16.1.51 -m ping</h1>

<p>SSH password: <br/>
172.16.1.51|FAILED! =&gt; {<br/>
&quot;failed&quot;: true, <br/>
&quot;msg&quot;: &quot;Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this.  Please add this host&#39;s fingerprint to your known_hosts file to manage this host.&quot;<br/>
}<br/>
原因分析：<br/>
因为没有受控端的指纹信息，在known_hosts文件中    </p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-05T01:44:31+08:00" itemprop="datePublished">2017/8/5</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018686711597.html" itemprop="url">
		廿一、远程连接</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">SSH服务介绍说明</a>
<ul>
<li>
<a href="#toc_1">01：如何部署telnet远程服务</a>
<ul>
<li>
<a href="#toc_2">①: 需要安装telnet服务端软件</a>
</li>
<li>
<a href="#toc_3">②: 配置telnet服务被xinetd所管理</a>
</li>
<li>
<a href="#toc_4">③: 启动telnet服务</a>
</li>
<li>
<a href="#toc_5">④: 检查telnet服务是否正常启动</a>
</li>
<li>
<a href="#toc_6">⑤: 进行telnet远程连接服务器主机</a>
</li>
<li>
<a href="#toc_7">⑥: 创建telnet远程登录的用户</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_8">远程登录出现异常的时候如何进行排错</a>
<ul>
<li>
<a href="#toc_9">检查链路是否通畅</a>
</li>
<li>
<a href="#toc_10">检查服务端口有没有正常开启</a>
</li>
<li>
<a href="#toc_11">SSH加密算法</a>
</li>
<li>
<a href="#toc_12">SSH服务认证类型</a>
</li>
<li>
<a href="#toc_13">SSH配置文件说明</a>
</li>
</ul>
</li>
<li>
<a href="#toc_14">sftp：</a>
</li>
<li>
<a href="#toc_15">第二部分：SSH服务知识介绍说明部分</a>
<ul>
<li>
<a href="#toc_16">01：SSH服务简介说明</a>
</li>
<li>
<a href="#toc_17">02：远程连接方法(常见两种)</a>
<ul>
<li>
<a href="#toc_18">①. 通过SSH服务进行远程连接</a>
</li>
<li>
<a href="#toc_19">②. 通过Telnet服务进行远程连接</a>
</li>
</ul>
</li>
<li>
<a href="#toc_20">03：SSH远程连接异常排查思路</a>
<ul>
<li>
<a href="#toc_21">①. 确认网络通讯链路是否正常（客户端执行）</a>
</li>
<li>
<a href="#toc_22">②. 检查SSH进程，确认服务是否运行良好（客户端执行）</a>
</li>
<li>
<a href="#toc_23">③. 安全机制进行了连接建立阻止</a>
</li>
</ul>
</li>
<li>
<a href="#toc_24">04：SSH服务软件知识介绍</a>
<ul>
<li>
<a href="#toc_25">①. 软件安装包介绍</a>
</li>
<li>
<a href="#toc_26">②. 软件大礼包重要信息说明</a>
</li>
</ul>
</li>
<li>
<a href="#toc_27">05：SSH服务远程连接登录过程</a>
</li>
<li>
<a href="#toc_28">06：SSH服务软件版本区别说明(了解)</a>
</li>
<li>
<a href="#toc_29">07：SSH服务认证类型：</a>
</li>
<li>
<a href="#toc_30">08：SSH服务企业案例说明：(重点必会)</a>
</li>
<li>
<a href="#toc_31">09：SSH服务配置文件修改：(重点必会)</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_32">ssh+key共享密钥部署流程说明</a>
<ul>
<li>
<a href="#toc_33">1. 熟悉部署流程 架构图</a>
</li>
<li>
<a href="#toc_34">2. 部署环境准备：（4台虚拟主机）</a>
</li>
<li>
<a href="#toc_35">3. 部署步骤概述</a>
</li>
<li>
<a href="#toc_36">4. 生成 钥匙 锁头（密钥对） m01</a>
</li>
<li>
<a href="#toc_37">5. 锁头如何放过去（传送到远端服务器）</a>
</li>
<li>
<a href="#toc_38">扩展知识说明：</a>
<ul>
<li>
<a href="#toc_39">01：ssh服务特殊端口情况进行分发公钥</a>
</li>
<li>
<a href="#toc_40">02：ssh-copy-id命令脚本简单说明</a>
</li>
<li>
<a href="#toc_41">03：ssh服务如何识别公钥文件</a>
</li>
</ul>
</li>
<li>
<a href="#toc_42">5. 操作后检查！！！！！</a>
</li>
<li>
<a href="#toc_43">6. ssh服务分发公钥实质执行过程</a>
</li>
<li>
<a href="#toc_44">编写批量分发公钥脚本三个阻碍因素</a>
<ul>
<li>
<a href="#toc_45">01: 有一个需要进行确认的位置（yes/no）</a>
</li>
<li>
<a href="#toc_46">02: 有需要输入密码的位置</a>
</li>
<li>
<a href="#toc_47">03: 实现秘钥对创建免交互</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_48">ssh+key公钥批量分发步骤</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_49">1.【手动】发送锁头到所有服务器（backup nfs01 web01)</a>
</li>
<li>
<a href="#toc_50">2.【脚本】发送锁头到所有服务器（backup nfs01 web01)</a>
</li>
<li>
<a href="#toc_51">3. 分发密钥阻碍因素处理办法</a>
<ul>
<li>
<a href="#toc_52">01: ssh+key密钥对生成免交互方式生成</a>
</li>
<li>
<a href="#toc_53">02：ssh连接密码信息阻碍问题解决方式</a>
</li>
</ul>
</li>
<li>
<a href="#toc_54">03：ssh连接确认信息阻碍问题解决方式</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_55">ssh+key公钥批量管理实现</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_56">1. 编写批量管理脚本信息</a>
</li>
</ul>


<h2 id="toc_0">SSH服务介绍说明</h2>

<h3 id="toc_1">01：如何部署telnet远程服务</h3>

<h4 id="toc_2">①: 需要安装telnet服务端软件</h4>

<pre><code>    yum install -y telnet-server telnet
</code></pre>

<h4 id="toc_3">②: 配置telnet服务被xinetd所管理</h4>

<pre><code>    grep disable /etc/xinetd.d/telnet 
    disable     = yes
    sed -i &#39;s#yes#no#g&#39; /etc/xinetd.d/telnet
    grep disable /etc/xinetd.d/telnet 
    disable     = no
</code></pre>

<h4 id="toc_4">③: 启动telnet服务</h4>

<pre><code>    /etc/init.d/xinetd start
    xinetd:                                           [  OK  ]
</code></pre>

<h4 id="toc_5">④: 检查telnet服务是否正常启动</h4>

<pre><code>    ss -lntup|grep 23
    LISTEN     0      64                    :::23                   :::*      users:((&quot;xinetd&quot;,24628,5))
    ps -ef|grep telnet
    24637   1733  0 09:13 pts/1    00:00:00 grep telnet
    ps -ef|grep xinetd
    24628      1  0 09:12 ?        00:00:00 xinetd -stayalive -pidfile /var/run/xinetd.pid
    24639   1733  0 09:13 pts/1    00:00:00 grep xinetd
</code></pre>

<h4 id="toc_6">⑤: 进行telnet远程连接服务器主机</h4>

<pre><code>    telnet 10.0.0.61
    Connecting to 10.0.0.61:23...
    Connection established.
    To escape to local shell, press Ctrl+Alt+].
    CentOS release 6.9 (Final)
    Kernel 2.6.32-696.el6.x86_64 on an x86_64
    m01 login: root
    Password: 
    Login incorrect
    说明：默认telnet远程登录不允许root用户远程
</code></pre>

<h4 id="toc_7">⑥: 创建telnet远程登录的用户</h4>

<pre><code>    useradd alex
    echo 123456|passwd --stdin alex
    Changing password for user alex.
    passwd: all authentication tokens updated successfully.
</code></pre>

<h2 id="toc_8">远程登录出现异常的时候如何进行排错</h2>

<h3 id="toc_9">检查链路是否通畅</h3>

<blockquote>
<p>01：ping<br/>
  02：tracert---windows traceroute---linux（-n 禁止反向解析）</p>
</blockquote>

<pre><code>-n     Do not try to map IP addresses to host names when displaying them.
[g:\~]$ tracert -d www.baidu.com   （-d 禁止反向解析）
</code></pre>

<blockquote>
<p>通过最多 30 个跃点跟踪<br/>
  到 <a href="http://www.baidu.com">www.baidu.com</a> [61.135.169.121] 的路由:</p>
</blockquote>

<pre><code>1    &lt;1 毫秒   &lt;1 毫秒   &lt;1 毫秒 192.168.14.254 
2   266 ms   159 ms     8 ms  61.149.236.1 
3     7 ms     3 ms     3 ms  61.148.162.57 
4     7 ms     7 ms     4 ms  202.106.34.57 
5     6 ms     4 ms     4 ms  61.148.152.18 
6     4 ms     4 ms     5 ms  123.125.248.122 
7     *        *        *     请求超时。
8     3 ms     3 ms     3 ms  61.135.169.121
</code></pre>

<h3 id="toc_10">检查服务端口有没有正常开启</h3>

<pre><code>[root@m01 ~]## ss -lntup|grep 22
tcp    LISTEN     0      128                   :::22                   :::*      users:((&quot;sshd&quot;,1171,4))
tcp    LISTEN     0      128                    *:22                    *:*      users:((&quot;sshd&quot;,1171,3))
[root@m01 ~]## netstat -lntup|grep 22
tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1171/sshd           
tcp        0      0 :::22                       :::*                        LISTEN      1171/sshd           
[root@m01 ~]## lsof -i:22
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd    1171 root    3u  IPv4  10390      0t0  TCP *:ssh (LISTEN)
sshd    1171 root    4u  IPv6  10392      0t0  TCP *:ssh (LISTEN)
sshd    1731 root    3r  IPv4  11180      0t0  TCP 10.0.0.61:ssh-&gt;10.0.0.1:vpad (ESTABLISHED)
[root@m01 ~]## nmap -p 22 10.0.0.61

Starting Nmap 5.51 ( http://nmap.org ) at 2017-08-02 10:21 CST
Nmap scan report for 10.0.0.61
Host is up (0.000076s latency).
PORT   STATE SERVICE
22/tcp open  ssh

Nmap done: 1 IP address (1 host up) scanned in 13.10 seconds
[root@m01 ~]## nc 10.0.0.61 22
SSH-2.0-OpenSSH_5.3

Protocol mismatch.
[root@m01 ~]## nc 10.0.0.61 23456
[root@m01 ~]## telnet 10.0.0.61 22
Trying 10.0.0.61...
Connected to 10.0.0.61.
Escape character is &#39;^]&#39;.
SSH-2.0-OpenSSH_5.3
^]  
telnet&gt; quit
Connection closed.

[root@m01 ~]## rpm -ql openssh-clients
/etc/ssh/ssh_config
/usr/bin/.ssh.hmac
/usr/bin/scp
/usr/bin/sftp
/usr/bin/slogin
/usr/bin/ssh
/usr/bin/ssh-add
/usr/bin/ssh-agent
/usr/bin/ssh-copy-id
/usr/bin/ssh-keyscan
</code></pre>

<h3 id="toc_11">SSH加密算法</h3>

<blockquote>
<p>01：加密算法采用了公钥（锁头）和私钥（钥匙）的使用<br/>
02：SSH分为两种版本，v1和v2，v2版本更安全</p>
</blockquote>

<h3 id="toc_12">SSH服务认证类型</h3>

<blockquote>
<p>01：基于密码的认证类型<br/>
02：基于秘钥的认证类型</p>
</blockquote>

<h3 id="toc_13">SSH配置文件说明</h3>

<blockquote>
<p>01：#号后面有空格表示表述信息 #号后面没有空格表示配置参数信息<br/>
02：类似SSH配置文件，默认井号后面跟的配置参数为默认值<br/>
03：涉及到修改SSH的配置文件，尽量多开一个xshell连接窗口</p>
</blockquote>

<pre><code>[root@backup ~]## ssh 10.0.0.61
ssh: connect to host 10.0.0.61 port 22: Connection refused
[root@backup ~]## ping 10.0.0.61
PING 10.0.0.61 (10.0.0.61) 56(84) bytes of data.
64 bytes from 10.0.0.61: icmp_seq=1 ttl=64 time=1.32 ms
64 bytes from 10.0.0.61: icmp_seq=2 ttl=64 time=1.79 ms
64 bytes from 10.0.0.61: icmp_seq=3 ttl=64 time=1.38 ms
64 bytes from 10.0.0.61: icmp_seq=4 ttl=64 time=1.74 ms
^C
--- 10.0.0.61 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3691ms
rtt min/avg/max/mdev = 1.325/1.564/1.797/0.211 ms
[root@backup ~]## traceroute 10.0.0.61
traceroute to 10.0.0.61 (10.0.0.61), 30 hops max, 60 byte packets
 1  10.0.0.61 (10.0.0.61)  0.539 ms  0.267 ms  0.770 ms
[root@backup ~]## telnet 10.0.0.61 22
Trying 10.0.0.61...
telnet: connect to address 10.0.0.61: Connection refused
[root@backup ~]## nmap -p 1-1024 10.0.0.61
</code></pre>

<pre><code>Starting Nmap 5.51 ( http://nmap.org ) at 2017-08-02 11:38 CST
Nmap scan report for 10.0.0.61
Host is up (0.00037s latency).
Not shown: 1023 closed ports
PORT   STATE SERVICE
23/tcp open  telnet
MAC Address: 00:0C:29:5F:A7:8F (VMware)
</code></pre>

<pre><code>Nmap done: 1 IP address (1 host up) scanned in 0.73 seconds
[root@backup ~]## nmap -p 1-65535 10.0.0.61
</code></pre>

<pre><code>Starting Nmap 5.51 ( http://nmap.org ) at 2017-08-02 11:38 CST
Nmap scan report for 10.0.0.61
Host is up (0.00048s latency).
Not shown: 65533 closed ports
PORT      STATE SERVICE
23/tcp    open  telnet
52113/tcp open  unknown
MAC Address: 00:0C:29:5F:A7:8F (VMware)
</code></pre>

<pre><code>Nmap done: 1 IP address (1 host up) scanned in 13.82 seconds
[root@backup ~]## ssh 10.0.0.61 -p 52113
The authenticity of host &#39;[10.0.0.61]:52113 ([10.0.0.61]:52113)&#39; can&#39;t be established.
RSA key fingerprint is 82:d7:80:62:c0:db:c9:9a:d5:d0:8f:66:94:53:8b:9f.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;[10.0.0.61]:52113&#39; (RSA) to the list of known hosts.
root@10.0.0.61&#39;s password: 
Last login: Wed Aug  2 11:35:17 2017 from 10.0.0.1        
</code></pre>

<h2 id="toc_14">sftp：</h2>

<blockquote>
<p>pwd ls cd 表示操作远程主机<br/>
所有命令前面l 表示操作本地主机<br/>
get 表示从远程主机下载数据<br/>
put 表示本地主机上传数据信息        </p>
</blockquote>

<!--
思考题：
1. 如何使用root用户，利用telnet方式远程登录主机
2. 如何让没有外网卡的服务，访问外网（期中架构扩展知识点）

01：本次SSH课程知识大纲
    ①. SSH服务简介说明(服务的两个重要功能)
    -->

<h2 id="toc_15">第二部分：SSH服务知识介绍说明部分</h2>

<h3 id="toc_16">01：SSH服务简介说明</h3>

<pre><code>SSH是Secure Shell Protocol的简写，   
SSH服务的两个重要功能
· 提供类似telnet远程联机服务器的服务，即上面提到的SSH服务；
· 提供类似FTP服务的sftp-server，借助SSH协议来传输数据的，提供更安全的SFTP服务(vsftp,proftp)。
</code></pre>

<h3 id="toc_17">02：远程连接方法(常见两种)</h3>

<h4 id="toc_18">①. 通过SSH服务进行远程连接</h4>

<h4 id="toc_19">②. 通过Telnet服务进行远程连接</h4>

<pre><code>    a. 服务端下载安装telnet软件
       yum install -y telnet telnet-server
    b. 设置telnet服务可以允许被xinetd服务进行管理启动
       vim /etc/xinetd.d/telnet 
       disable         = no
    c. 启动xinetd服务同时开启telnet服务
       /etc/init.d/xinetd start
       netstat -lntup|grep 23
       tcp        0      0 :::23       :::*     LISTEN      43374/xinetd 
    d. telnet客户端连接测试
       [c:\~]$ telnet 10.0.0.61
       Connecting to 10.0.0.61:23...
       Connection established.
       To escape to local shell, press Ctrl+Alt+].
       CentOS release 6.8 (Final)
       Kernel 2.6.32-642.el6.x86_64 on an x86_64
       login: 
</code></pre>

<h3 id="toc_20">03：SSH远程连接异常排查思路</h3>

<h4 id="toc_21">①. 确认网络通讯链路是否正常（客户端执行）</h4>

<pre><code>    ping 服务器ip地址
    tracert -d 服务器ip地址(windows下操作)
    traceroute -n 服务器ip地址(linux下操作)
</code></pre>

<h4 id="toc_22">②. 检查SSH进程，确认服务是否运行良好（客户端执行）</h4>

<pre><code>    telnet ip 22
    nmap ip -p 22 &lt;- 此命令属于linux命令，只能在linux上执行
</code></pre>

<h4 id="toc_23">③. 安全机制进行了连接建立阻止</h4>

<pre><code>    iptables:/etc/init.d/iptables stop
    selinux功能开启
</code></pre>

<h3 id="toc_24">04：SSH服务软件知识介绍</h3>

<h4 id="toc_25">①. 软件安装包介绍</h4>

<pre><code>    rpm -qf  `which ssh`
</code></pre>

<h4 id="toc_26">②. 软件大礼包重要信息说明</h4>

<pre><code>    客户端大礼包重要信息
    /etc/ssh/ssh_config
    /usr/bin/scp
    /usr/bin/sftp
    /usr/bin/ssh
    服务端大礼包重要信息
    /etc/rc.d/init.d/sshd
    /etc/ssh/sshd_config
</code></pre>

<h3 id="toc_27">05：SSH服务远程连接登录过程</h3>

<pre><code>ssh 10.0.0.31 ---yes---输入密码---登录成功  
</code></pre>

<h3 id="toc_28">06：SSH服务软件版本区别说明(了解)</h3>

<pre><code>sshv1：密钥对信息保持不变
sshv2：密钥对信息经常变化
</code></pre>

<h3 id="toc_29">07：SSH服务认证类型：</h3>

<pre><code>· 基于口令的安全验证：利用密码认证进行登录
· 基于密钥的安全验证：利用密钥认证进行登录 == 利用钥匙和锁头的方式进行认证    
基于密钥热证的方式：
利用钥匙和锁头的方式进行验证，
a. 将钥匙放在管理服务器端(远程登录服务器端)
b. 将锁头放在被管理服务器端(远程被登录服务器端)
钥匙和锁头的使用过程：
①. 连接服务的ssh客户端，创建出密钥和锁头
②. 连接服务的ssh客户端，将锁头发送给ssh服务端
③. 连接服务的ssh客户端，发出连接请求
④. ssh服务端收到连接请求后，会发出质询信息，你想连接我，你能打开我的锁头吗
⑤. ssh客户端利用钥匙解密了质询，至此钥匙和锁头就匹配了，将匹配后的结果告知服务器端
⑥. ssh服务端认可匹配结果，连接请求建立
</code></pre>

<h3 id="toc_30">08：SSH服务企业案例说明：(重点必会)</h3>

<blockquote>
<p>【企业面试题】：给你一个端口，如何命令行查出对应的服务是什么?<br/>
   【企业面试题】：如果给你一个进程名oldboy，如何查看对应的端口是什么？</p>
</blockquote>

<h3 id="toc_31">09：SSH服务配置文件修改：(重点必会)</h3>

<pre><code>相关参数理解概念与作用
</code></pre>

<h1 id="toc_32">ssh+key共享密钥部署流程说明</h1>

<h3 id="toc_33">1. 熟悉部署流程 架构图</h3>

<blockquote>
<p>a. 锁头和钥匙概念<br/>
   b. 钥匙放在哪里？   ---&gt; m01上<br/>
   c. 锁头放在哪里？   backup web01 nfs01</p>
</blockquote>

<h3 id="toc_34">2. 部署环境准备：（4台虚拟主机）</h3>

<blockquote>
<p>NFS backup web --- 受控端<br/>
   m01            --- 主控端</p>
</blockquote>

<h3 id="toc_35">3. 部署步骤概述</h3>

<blockquote>
<p>第一个里程碑：生成私钥和公钥（生成密钥对）<br/>
   第二个里程碑：将锁头（公钥）发送到相应服务器上（分发公钥）<br/>
   第三个里程碑：进行检查测试（验证是否实现基于密钥访问服务器，即实现非交互方式）</p>
</blockquote>

<h3 id="toc_36">4. 生成 钥匙 锁头（密钥对） m01</h3>

<pre><code>[root@m01 ~]## ssh-keygen -t dsa 
Generating public/private dsa key pair.                        ####生成一对dsa类型的秘钥对（公钥和私钥）
Enter file in which to save the key (/root/.ssh/id_dsa):       ###想要把你的密钥对放在哪里 默认即可
Enter passphrase (empty for no passphrase):                    ###给你的钥匙锁头 加上个密码把。 回车
Enter same passphrase again:                                   #确认   
Your identification has been saved in /root/.ssh/id_dsa.      #私钥放置的位置（钥匙）
Your public key has been saved in /root/.ssh/id_dsa.pub.       #公钥放置的位置（锁头）
The key fingerprint is:
e8:26:51:ba:ed:f0:00:37:a7:3a:ab:ab:34:83:0a:9e root@m01
The key’s randomart image is:
</code></pre>

<p><code>+--[ DSA 1024]----+<br/>
   |                 |<br/>
   |                  |<br/>
   |      .           |<br/>
   |     o .          |<br/>
   |  . = o S         |<br/>
   |.  o O            |<br/>
   |o+  * +           |<br/>
   |= =. B            |<br/>
   |*Eoo  o           |<br/>
   +-----------------+<br/>
</code></p>

<pre><code>[root@m01 ~]## ll ~/.ssh -d
drwx------ 2 root root 4096 2017-04-18 09:42 /root/.ssh
[root@m01 ~]## ls -l /root/.ssh/
total 12
-rw------- 1 root root  668 Jan  5 16:37 id_dsa                     ###私钥 钥匙 
-rw-r--r-- 1 root root  598 Jan  5 16:37 id_dsa.pub                 ####公钥 锁头 ; .pub  public  公共的 公钥
-rw-r--r-- 1 root root 1576 Jan  5 14:58 known_hosts
</code></pre>

<h3 id="toc_37">5. 锁头如何放过去（传送到远端服务器）</h3>

<pre><code>[root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub 172.16.1.41                 #ip地址前没有指定用户信息，表示用当前用户进行传送公钥
[root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.41            #表示将公钥id信息进行复制传送
The authenticity of host &#39;172.16.1.41 (172.16.1.41)&#39; can’t be established.
RSA key fingerprint is 6e:85:f3:ce:58:f2:dd:4f:3c:0d:60:4e:3c:ef:79:ce.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;172.16.1.41&#39; (RSA) to the list of known hosts.
root@172.16.1.41’s password: 
Now try logging into the machine, with &quot;ssh &#39;root@172.16.1.41&#39;&quot;, and check in:

.ssh/authorized_keys

to make sure we haven’t added extra keys that you weren’t expecting.

测试远程登录
## ssh 172.16.1.41
Last login: Wed Aug  2 12:56:30 2017 from 10.0.0.1
## ll ~/.ssh/
total 8
-rw------- 1 root root  598 Aug  3 09:33 authorized_keys
-rw-r--r-- 1 root root 1185 Aug  2 11:58 known_hosts

## ssh 172.16.1.41 &quot;ll ~/.ssh/&quot;
bash: ll: command not found
## ssh 172.16.1.41 &quot;ls -l ~/.ssh/&quot;
total 8
-rw------- 1 root root  598 Aug  3 09:33 authorized_keys
-rw-r--r-- 1 root root 1185 Aug  2 11:58 known_hosts
说明：ssh远程执行命令,不支持别名功能
</code></pre>

<hr/>

<h3 id="toc_38">扩展知识说明：</h3>

<h4 id="toc_39">01：ssh服务特殊端口情况进行分发公钥</h4>

<pre><code>[root@rsync-server ~]## netstat -lntup|grep sshd
tcp        0      0 0.0.0.0:52113               0.0.0.0:*                   LISTEN      67538/sshd          
tcp        0      0 :::52113                    :::*                        LISTEN      67538/sshd 
说明：修改远程主机ssh服务连接端口信息，从22端口改为52113端口

   [root@m01 ~]## ssh -p 52113 172.16.1.41 hostname
   rsync-server
   说明：已经发送过公钥服务器，修改端口后，指定端口连接即可

   [root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub 172.16.1.41
   ssh: connect to host 172.16.1.41 port 22: Connection refused
   说明：修改端口后，采用默认分发公钥方式会出现报错“连接拒绝”，主要和ssh-copy-id命令机制有关

   [root@m01 ~]## which ssh-copy-id
   /usr/bin/ssh-copy-id
   [root@m01 ~]## file /usr/bin/ssh-copy-id
   /usr/bin/ssh-copy-id: POSIX shell script text executable       ## ssh-copy-id命令实际上是一个脚本文件
   [root@rsync-server ~]## ll ~/.ssh/authorized_keys 
   -rw------- 1 root root 1196 2017-04-18 10:55 /root/.ssh/authorized_keys
   [root@rsync-server ~]## rm -f ~/.ssh/authorized_keys            ## 删除远端服务器的公钥文件
   [root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub &quot;-p52113 root@172.16.1.41&quot;
   说明：根据命令脚本，修改$1传参信息，从而实现根据ssh不同端口传送公钥文件    
   ============================================
   #!/bin/bash
   until [ $## -eq 0 ]
   do
        echo $*
        shift
   done
   ============================================
</code></pre>

<h4 id="toc_40">02：ssh-copy-id命令脚本简单说明</h4>

<pre><code>ssh-copy-id 指定端口号--脚本---ssh
【了解】ssh-copy-id 执行过程
ssh  $1 &quot;exec sh -c &#39;umask 077; test -d ~/.ssh || mkdir ~/.ssh ; 
cat &gt;&gt; ~/.ssh/authorized_keys &amp;&amp; (test -x /sbin/restorecon &amp;&amp; /sbin/restorecon ~/.ssh ~/.ssh/authorized_keys &gt;/dev/null 2&gt;&amp;1 || true)’&quot;
①. 临时设置了一下umask 077 
②. 看目标服务器是否存在 ~/.ssh 目录
③. 如果目录不存在，则创建 mkdir ~/.ssh 
④. 把id_dsa.pub内容 放到了受控端服务器 ~/.ssh/authorized_keys   
说明：根据以上脚本分析内容可以
创建生成.ssh目录，权限是700
创建生成authorized_keys文件，权限是600
authorized_keys文件内容实质上等于id_dsa.pub公钥文件内容
</code></pre>

<h4 id="toc_41">03：ssh服务如何识别公钥文件</h4>

<pre><code>[root@m01 ~]## vim /etc/ssh/sshd_config               
49 #AuthorizedKeysFile     .ssh/authorized_keys
说明：利用ssh服务配置文件，识别公钥文件信息   
</code></pre>

<hr/>

<h3 id="toc_42">5. 操作后检查！！！！！</h3>

<pre><code>[root@m01 ~]## ssh 172.16.1.41                ## 基于密钥方式登录远程主机
[root@m01 ~]## ssh 172.16.1.41 hostname       ## 不登录远程主机，在远程主机上执行命令
说明：远程连接backup服务，以及远程在backup服务器上执行命令，从而验证基于密钥登录远程主机是否得以实现
</code></pre>

<h3 id="toc_43">6. ssh服务分发公钥实质执行过程</h3>

<pre><code>①. 管理服务器创建私钥和公钥（密钥对）
②. 将公钥文件远程传送复制到被管理服务器相应用户~/.ssh下，并修改.ssh目录权限为700
③. 修改公钥文件文件名称为authorized_keys，授权权限为600
④. 利用ssh服务配置文件的配置参数，进行识别公钥文件authorized_keys
⑤. 进而实现基于密钥远程登录服务器（免密码登录/非交互方式登录）   



-f filename
        Specifies the filename of the key file.   ---指定秘钥信息
-P passphrase
        Provides the (old) passphrase.
-N new_passphrase
        Provides the new passphrase.
</code></pre>

<h3 id="toc_44">编写批量分发公钥脚本三个阻碍因素</h3>

<h4 id="toc_45">01: 有一个需要进行确认的位置（yes/no）</h4>

<h4 id="toc_46">02: 有需要输入密码的位置</h4>

<pre><code>sshpass -p123456 ssh-copy-id -i ~/.ssh/id_dsa.pub root@172.16.1.7
</code></pre>

<h4 id="toc_47">03: 实现秘钥对创建免交互</h4>

<pre><code>ssh-keygen -t dsa -f /root/.ssh/id_dsa -P &quot;&quot;
</code></pre>

<h1 id="toc_48">ssh+key公钥批量分发步骤</h1>

<h3 id="toc_49">1.【手动】发送锁头到所有服务器（backup nfs01 web01)</h3>

<pre><code>[root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.41
[root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.31
[root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.8

[root@m01 ~]## ssh 172.16.1.8 hostname
web01
[root@m01 ~]## ssh 172.16.1.31 hostname
nfs01
[root@m01 ~]## ssh 172.16.1.41 hostname
backup
说明：手工批量验证基于密钥登录远程主机是否成功
思考：如何提高效率，哪里较低了部署效率
密钥对生成过程阻碍因素：需要交互方式生成密钥对
分发公钥的过程阻碍因素：需要交互方式传送公钥
</code></pre>

<h3 id="toc_50">2.【脚本】发送锁头到所有服务器（backup nfs01 web01)</h3>

<pre><code>[root@m01 ~]## mkdir /server/scripts                 ## 创建管理脚本目录
[root@m01 ~]## vim /server/scripts/distribute.sh     ## 编辑公钥分发脚本
#!/bin/bash
## distribute pub_key to remote_hosts
ssh-copy -i /root/.ssh/id_dsa.pub root@172.16.1.41
ssh-copy -i /root/.ssh/id_dsa.pub root@172.16.1.31
ssh-copy -i /root/.ssh/id_dsa.pub root@172.16.1.8
说明：以上脚本信息会有阻碍因素，影响脚本执行
</code></pre>

<blockquote>
<p>01：创建密钥对过程需要交互完成<br/>
02：确认信息阻碍脚本运行（yes/no）<br/>
03：ssh连接密码信息阻碍（第一次分发公钥需要输入密码信息）</p>
</blockquote>

<h3 id="toc_51">3. 分发密钥阻碍因素处理办法</h3>

<h4 id="toc_52">01: ssh+key密钥对生成免交互方式生成</h4>

<pre><code>   利用ssh-keygen命令参数实现免交互方式生成
   rm -f /root/.ssh/id_dsa*
   ssh-keygen -t dsa -f /root/.ssh/id_dsa -P &quot;&quot; &gt;/dev/null 2&gt;&amp;1   ## 非交互式生成秘钥对
   ssh-keygen -t dsa -f /root/.ssh/id_dsa -N &#39;&#39; &gt;/dev/null 2&gt;&amp;1   ## 非交互式生成秘钥对
   ssh-keygen -t dsa -f ~/.ssh/id_dsa  -P &#39;&#39; -q
</code></pre>

<h4 id="toc_53">02：ssh连接密码信息阻碍问题解决方式</h4>

<pre><code>******************************************************************************************************************
  
扩展知识说明：
①. sshpass命令说明介绍
实现在命令行中输入密码；sshpass 专门用来给ssh提供密码
sshpass----expect 
[root@m01 ~]## ssh 172.16.1.7 hostname            ## 默认没有分发公钥文件时，连接远程主机执行命令总是提示输入密码
root@172.16.1.7’s password: 
web02
[root@m01 ~]## sshpass -p123456 ssh 172.16.1.41 hostname   ## 利用sshpass命令的-p参数，实现对后面执行的命令给予密码信息
rsync-server                                              ## 结果返回是 backup
  
实现在命令行中处理确认消息问题
&gt;/root/.ssh/known_hosts                          ## 清空known_hosts文件信息，还原确认信息效果
rm -f /root/.ssh/*                               ## 直接清空.ssh目录，还原确认信息和密码认证
## ssh 172.16.1.7 hostname
The authenticity of host &#39;172.16.1.7 (172.16.1.7)&#39; can’t be established.
RSA key fingerprint is 0e:47:58:8c:cc:31:ca:2e:ae:94:f0:45:eb:51:30:60.
Are you sure you want to continue connecting (yes/no)?    ## 确认ssh连接已经还原成默认状态
## sshpass -p123456 ssh -o StrictHostKeyChecking=no  172.16.1.7 hostname 
Warning: Permanently added &#39;172.16.1.7&#39; (RSA) to the list of known hosts.
web02                                            ## 解决确认信息交互问题
The StrictHostKeyChecking option can be used to control logins to machines whose host key is not known or has changed.
StrictHostKeyChecking参数能被用于控制登录机器，在主机key是没有known信息或被改变的时候
******************************************************************************************************************   
[root@m01 ~]## ssh-copy-id -i /root/.ssh/id_dsa.pub 172.16.1.7
root@172.16.1.7’s password: 
[root@m01 ~]## sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.7     ## 非交换（免密码方式）分发密钥
[root@m01 ~]## sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.31
[root@m01 ~]## sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.41
[root@m01 ~]## ssh 172.16.1.41 hostname          ## 验证密钥是否分发成功
rsync-server
[root@m01 ~]## ssh 172.16.1.31 hostname
nfs-server
[root@m01 ~]## ssh 172.16.1.7 hostname
web02
</code></pre>

<h3 id="toc_54">03：ssh连接确认信息阻碍问题解决方式</h3>

<pre><code>非交互式 非一台服务器发送锁头（公钥）
sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub &quot;-o StrictHostKeyChecking=no 172.16.1.41&quot;
sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub &quot;-o StrictHostKeyChecking=no 172.16.1.8&quot;
sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub &quot;-o StrictHostKeyChecking=no 172.16.1.31&quot;   
[root@m01 ~]## ssh 172.16.1.31 hostname          ## 验证密钥是否分发成功
nfs-server
[root@m01 ~]## ssh 172.16.1.41 hostname
rsync-server
[root@m01 ~]## ssh 172.16.1.7 hostname
web02
 
阻碍因素问题得以解决，继续编写脚本实现批量分发公钥
## vim /server/scripts/distribute.sh 
for ip in 7 31 41
do
sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub &quot;-o StrictHostKeyChecking=no 172.16.1.$ip&quot;
done
## sh /server/scripts/distribute.sh
## sh -x  /server/scripts/distribute.sh           ## 检测脚本执行过程时会有+号信息，表示脚本执行的信息，多个+号表示执行信息的层级关系
                                              ## 没有+的信息表示输出到屏幕上的信息
说明：此脚本已经实现了批量免交互方式进行分发公钥，但是如果有新增主机需要对脚本文件进行修改
BTW：编写脚本的时候注意变量名称的指定，例如PATH一些特殊名称，不要作为变量名称进行指定
  
编写脚本利用传参方式执行，使脚本执行方式更加灵活
for ip in $*
do
 sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub &quot;-o StrictHostKeyChecking=no $ip&quot;
done
## sh /server/scripts/distribute.sh 172.16.1.31 172.16.1.41 172.16.1.7        ## 利用快捷键ctrl+w（剪切）和ctrl+y(粘贴)，实现快速编写传参参数
说明：利用$*(包含所有传输参数信息；man bash可以获取得知)循环实现传参批量分发公钥
  
编写批量检查公钥分发是否正确
## vim /server/scripts/check_distribute.sh
for ip in $*
do
 ssh $ip hostname
done
## sh  /server/scripts/check_distribute.sh 172.16.1.31 172.16.1.41 172.16.1.7   ## 检查脚本执行确认无误，批量分发公钥脚本执行成功
nfs-server
rsync-server
web02
PS：如果对以上脚本的编写内容还是不熟悉，可以查看翻译系统服务的启动脚本(/etc/init.d/nfs /etc/init.d/functions)，提升脚本编写能力
</code></pre>

<h1 id="toc_55">ssh+key公钥批量管理实现</h1>

<h3 id="toc_56">1. 编写批量管理脚本信息</h3>

<pre><code>[root@m01 scripts]## cat check-v587.sh 
#!/bin/bash
#filename :check-v587.sh
for ip  in  8 31 41
do
    ssh 172.16.1.$ip $1
done
[root@m01 scripts]## sh check-v587.sh &quot;ifconfig eth0&quot;
eth0      Link encap:Ethernet  HWaddr 00:0C:29:45:5E:1D  
          inet addr:10.0.0.8  Bcast:10.0.0.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fe45:5e1d/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:584 errors:0 dropped:0 overruns:0 frame:0
          TX packets:467 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:59453 (58.0 KiB)  TX bytes:40039 (39.1 KiB)
eth0      Link encap:Ethernet  HWaddr 00:0C:29:FB:27:33  
          inet addr:10.0.0.31  Bcast:10.0.0.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fefb:2733/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:79116 errors:0 dropped:0 overruns:0 frame:0
          TX packets:39323 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:79932709 (76.2 MiB)  TX bytes:3487552 (3.3 MiB)
     
eth0      Link encap:Ethernet  HWaddr 00:0C:29:36:C1:3B  
          inet addr:10.0.0.41  Bcast:10.0.0.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fe36:c13b/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:17889 errors:0 dropped:0 overruns:0 frame:0
          TX packets:15415 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
                    RX bytes:4679291 (4.4 MiB)  TX bytes:2691255 (2.5 MiB)
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-05T01:28:19+08:00" itemprop="datePublished">2017/8/5</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018676996592.html" itemprop="url">
		廿十、实时同步服务知识介绍(inotify+rsync)</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">①. 实时同步方式环境准备(绘图说明)</a>
</li>
<li>
<a href="#toc_1">②. rsync+inotify服务组合的起源</a>
</li>
<li>
<a href="#toc_2">已经学习过的企业项目案例：</a>
</li>
</ul>


<h2 id="toc_0">①. 实时同步方式环境准备(绘图说明)</h2>

<blockquote>
<p>a. 准备rsync守护进程服务，实现通过网络推送数据信息到rsync服务端(自行回忆rsync守护进程模式配置过程)<br/>
b. 准备inotify服务部署</p>
</blockquote>

<h2 id="toc_1">②. rsync+inotify服务组合的起源</h2>

<blockquote>
<p>a. inotify软件服务介绍</p>

<blockquote>
<p>异步的文件系统事件监控机制;监控文件系统中添加、删除，修改、移动等各种事件</p>
</blockquote>

<p>b. inotify软件同步原理(绘图说明)<br/>
c. inotify软件部署步骤</p>

<blockquote>
<p>yum源信息变更调整，准备epel源<br/>
inotify软件yum下载安装</p>
</blockquote>
</blockquote>

<pre><code>yum install inotify-tools
inotify软件确认系统是否支持
ll /proc/sys/fs/inotify
</code></pre>

<blockquote>
<blockquote>
<p>检查是否存在inotify的软件包<br/>
常用参数说明</p>
</blockquote>
</blockquote>

<h2 id="toc_2">已经学习过的企业项目案例：</h2>

<ol>
<li>集权分治的权限管理及日志审计</li>
<li>全网数据备份解决方案</li>
<li>共享存储实时备份（共享存储的单点解决方案）</li>
</ol>

<blockquote>
<p>①. 第一个里程碑：</p>

<blockquote>
<p>1） 实现从NFS客户端到rsync服务端的rsync服务部署（给学生时间进行部署）</p>
</blockquote>

<p>②. 第二个里程碑：</p>

<blockquote>
<p>2） 实现从nfs客户端对nfs目录文件系统事件的实时监控</p>
</blockquote>

<p>③. 第三个里程碑：</p>

<blockquote>
<p>3） 当监控到nfs目录文件系统事件变化后，触发rsync推送变化的文件。利用脚本进行实现</p>
</blockquote>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-05T00:58:29+08:00" itemprop="datePublished">2017/8/5</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018659093989.html" itemprop="url">
		十五、awk命令精讲</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>[TOC]<br/>
1. # awk基础<br/>
    1. ## awk是什么<br/>
是一个名字怪异的编程语言--查找与处理计算<br/>
    2. ## BEGIN 和 END 模块<br/>
    通常，对于每个输入行，awk 都会执行每个脚本代码块一次。然而，在许多编程情况中， 可能需要在 awk 开始处理输入文件中的文本之前执行初始化代码。对于这种情况，awk 允许 您定义一个 BEGIN 块。我们在前一个示例中使用了 BEGIN 块。因为 awk 在开始处理输入文 件之前会执行 BEGIN 块，因此它是初始化 FS(字段分隔符)变量、打印页眉或初始化其它 在程序中以后会引用的全局变量的极佳位置。<br/>
    awk 还提供了另一个特殊块，叫作 END 块。awk 在处理了输入文件中的所有行之后执行 这个块。通常，END 块用于执行最终计算或打印应该出现在输出流结尾的摘要信息。<br/>
    ## 运算符<br/>
类型<br/>
运算符<br/>
描述<br/>
赋值运算符<br/>
= += -= *= /= %= <sup>=</sup> **=<br/>
赋值语句<br/>
逻辑运算符<br/>
||<br/>
逻辑或</p>

<p>&amp;&amp;<br/>
逻辑与<br/>
正则运算符<br/>
~ !~<br/>
匹配正则表达式和不匹配正则表达式<br/>
关系运算符<br/>
&lt; &lt;= &gt; &gt;= != ==<br/>
关系运算符<br/>
算术运算符<br/>
+-<br/>
加，减</p>

<p>* /&amp;<br/>
乘，除与求余</p>

<p>+-!<br/>
一元加，减和逻辑非</p>

<p>^ ***<br/>
求幂</p>

<p>++ --<br/>
增加或减少，作为前缀或后缀<br/>
其他运算符<br/>
$<br/>
字段引用</p>

<p>空格<br/>
字符串链接符</p>

<p>?:<br/>
三目运算符</p>

<p>In<br/>
数组中是否存在某键值<br/>
    ### awk 赋值运算符<br/>
    a+5;等价于:a=a+5;其他同类<br/>
[root@yum tmp]# awk &#39;BEGIN{a=5;a+=5;print a}&#39;<br/>
10<br/>
    ### awk 逻辑运算符<br/>
[root@yum tmp]# awk &#39;BEGIN{a=1;b=2;print (a&gt;2&amp;&amp;b&gt;1,a=1||b&gt;1)}&#39;<br/>
01<br/>
    ### awk 正则运算符<br/>
[root@yum tmp]# awk &#39;BEGIN{a=&quot;100testaaa&quot;;if(a~/100/){print &quot;ok&quot;}}&#39;<br/>
ok<br/>
[root@yum tmp]# echo|awk &#39;BEGIN{a=&quot;100testaaa&quot;}a~/100/{print &quot;ok&quot;}&#39;<br/>
ok<br/>
    ### 关系运算符<br/>
    如:&gt; &lt; 可以作为字符串比较，也可以用作数值比较，关键看操作数如果是字符串 就会转换为字符串比较。两个都为数字 才转为数值比较。字符串比较:按照ascii 码顺序比较。<br/>
[root@yum tmp]# awk &#39;BEGIN{a=&quot;11&quot;;if(a&gt;=9){print &quot;ok&quot;}}&#39;<br/>
[root@yum tmp]# awk &#39;BEGIN{a=11;if(a&gt;=9){print &quot;ok&quot;}}&#39;<br/>
ok<br/>
[root@yum tmp]# awk &#39;BEGIN{a;if(a&gt;=b){print &quot;ok&quot;}}&#39;<br/>
ok<br/>
    ### awk 算术运算符<br/>
说明，所有用作算术运算符 进行操作，操作数自动转为数值，所有非数值都变为 0。<br/>
[root@yum tmp]# awk &#39;BEGIN{a=&quot;b&quot;;print a++,++a}&#39;<br/>
02<br/>
[root@yum tmp]# awk &#39;BEGIN{a=&quot;20b4&quot;;print a++,++a}&#39;<br/>
20 22<br/>
    ### 其他运算符<br/>
?:三目运算符<br/>
[root@yum tmp]# awk &#39;BEGIN{a=&quot;b&quot;;print a<mark>&quot;b&quot;?&quot;ok&quot;:&quot;err&quot;}&#39;<br/>
ok<br/>
[root@yum tmp]# awk &#39;BEGIN{a=&quot;b&quot;;print a</mark>&quot;c&quot;?&quot;ok&quot;:&quot;err&quot;}&#39;<br/>
err<br/>
in 运算符见后面数组<br/>
    ## 常用 awk 内置变量<br/>
变量名<br/>
属性<br/>
\(0<br/>
当前记录<br/>
\)1~\(n<br/>
当前记录的第 n 个字段<br/>
FS<br/>
输入字段分隔符 默认是空格<br/>
RS<br/>
输入记录分割符 默认为换行符<br/>
NF<br/>
当前记录中的字段个数，就是有多少列<br/>
NR<br/>
已经读出的记录数，就是行号，从 1 开始<br/>
OFS<br/>
输出字段分隔符 默认也是空格<br/>
ORS<br/>
输出的记录分隔符 默认为换行符<br/>
    ## awk正则<br/>
元字符<br/>
功能<br/>
示例<br/>
解释<br/>
^<br/>
行首定位符<br/>
/^root/<br/>
匹配所有以 root 开头的行<br/>
\)<br/>
行尾定位符<br/>
/root\(/<br/>
匹配所有以 root 结尾的行<br/>
.<br/>
匹配任意单个字符<br/>
/r..t/<br/>
匹配字母 r,然后两个任意字符，再以 l 结尾的行，比如 root,r33l 等<br/>
\*<br/>
匹配 0 个或多个前 导字符(包括回车)<br/>
/a\*ool/<br/>
匹配 0 个或多个 a 之后紧跟着 ool 的 行，比如 ool，aaaaool 等<br/>
+<br/>
匹配 1 个或多个前 导字符<br/>
/a+b/<br/>
匹配 1 个或多个 a 加 b 的行，比如 ab,aab 等<br/>
?<br/>
匹配 0 个或 1 个前 导字符<br/>
/a?b/<br/>
匹配 b 或 ab 的行<br/>
\[]<br/>
匹配指定字符组内 的任意一个字符<br/>
/^\[abc]<br/>
匹配以字母 a 或 b 或 c 开头的行<br/>
\[^]<br/>
匹配不在指定字符 组内任意一个字符<br/>
/^\[^abc]/<br/>
匹配不以字母 a 或 b 或 c 开头的行<br/>
()<br/>
子表达式组合<br/>
/(rool)+/<br/>
表示一个或多个 rool 组合，当有一些 字符需要组合时，使用括号括起来<br/>
|<br/>
或者的意思<br/>
/(root)|B/<br/>
匹配 root 或者 B 的行<br/>
\<br/>
转义字符<br/>
/a\\/\\//<br/>
匹配 a//<br/>
\~,!\~<br/>
匹配，不匹配的条件语句<br/>
\)1~/root/<br/>
匹配第一个字段包含字符 root 的所有记录<br/>
x{m} x{m,} X{m,n}<br/>
x 重复 m 次 x 重复至少 m 次 x 重复至少 m 次， 但不超过 n 次 需要指定参数: -posix 或者 --re-interval 没有该参数不能使用该模式<br/>
/(root){3}/ /(root){3,}/ /(root){5,6}/ cat rex.txt smierth,harry smierth,reru robin,tom<br/>
需要注意一点的是，root 加括号和不加括号的区别，x 可以表示字符串也可以只是一个字符，所以/root\{5\}/表示匹配 roo 再加上 5 个 t，及 roottttt /\(root\)\{2,\}/ 则表示匹配 rootrootrootroot 等 awk -posix &#39;/er\{1,2\}/&#39; rex.text smierth,harry smierth,reru<br/>
1. # awk 的 if、循环和数组<br/>
    1. ## 条件语句<br/>
        1. ### awk 提供了非常好的类似于 C 语言的 if 语句。<br/>
{<br/>
    if ( \(1== &quot;foo&quot; ) \{<br/>
        if ( \)2== &quot;foo&quot; ) {<br/>
            print &quot;uno&quot;<br/>
        } else {<br/>
            print &quot;one&quot;<br/>
        }<br/>
    } elseif (\(1== &quot;bar&quot; ) \{<br/>
        print &quot;two&quot;<br/>
    } else \{<br/>
        print &quot;three&quot;<br/>
    }<br/>
}<br/>
    ### 使用 if 语句还可以将代码:<br/>
! /matchme/ \{ print \)1 \(3 \)4 }<br/>
    转换成:<br/>
{<br/>
    if ( \(0 !\~ /matchme/ ) {<br/>
        print \)1 \(3 \)4<br/>
    }<br/>
}<br/>
    ## 循环结构<br/>
    我们已经看到了 awk 的 while 循环结构，它等同于相应的 C 语言 while 循环。awk 还有 &quot;do...while&quot;循环，它在代码块结尾处对条件求值，而不像标准 while 循环那样在开始处<br/>
求值。它类似于其它语言中的&quot;repeat...until&quot;循环。以下是一个示例:<br/>
    do...while 示例<br/>
{  count=1<br/>
    do {<br/>
        print &quot;I get printed at least once no matter what&quot;<br/>
    } while ( count !=1 )<br/>
}<br/>
    与一般的 while 循环不同，由于在代码块之后对条件求值，&quot;do...while&quot;循环永远都至少执行一次。换句话说，当第一次遇到普通 while 循环时，如果条件为假，将永远不执行该循环。<br/>
    ### for 循环<br/>
    awk 允许创建 for 循环，它就象 while 循环，也等同于 C 语言的 for 循环:<br/>
for ( initial assignment; comparison; increment ) {<br/>
    code block<br/>
 }<br/>
    以下是一个简短示例:<br/>
for ( x=1;x&lt;=4;x++ ) {<br/>
    print&quot;iteration&quot;, x<br/>
}<br/>
    此段代码将打印:<br/>
iteration1<br/>
iteration2<br/>
iteration3<br/>
iteration4<br/>
    ### break 和 continue<br/>
    此外，如同 C 语言一样，awk 提供了 break 和 continue 语句。使用这些语句可以更好地 控制 awk 的循环结构。以下是迫切需要 break 语句的代码片断:<br/>
while 死循环<br/>
while (1) {<br/>
    print &quot;forever and ever...&quot;<br/>
}while 死循环 1 永远代表是真，这个 while 循环将永远运行下去。<br/>
以下是一个只执行十次的循环:<br/>
#break 语句示例<br/>
x=1while(1) {  print &quot;iteration&quot;, x<br/>
    if ( x<mark>10 ) {     break<br/>
    }   x++<br/>
}<br/>
    这里，break 语句用于“逃出”最深层的循环。&quot;break&quot;使循环立即终止，并继续执行循 环代码块后面的语句。    continue 语句补充了 break，其作用如下:x=1<br/>
while (1) {<br/>
    if ( x</mark>4 ) {<br/>
        x++<br/>
        continue<br/>
    }<br/>
    print &quot;iteration&quot;, x<br/>
    if ( x&gt;20 ) {<br/>
        break<br/>
    }<br/>
    x++<br/>
}<br/>
    这段代码打印&quot;iteration1&quot;到&quot;iteration21&quot;，&quot;iteration4&quot;除外。如果迭代等于 4，则增加 x 并调用 continue 语句，该语句立即使 awk 开始执行下一个循环迭代，而不执行代码块 的其余部分。如同 break 一样，continue 语句适合各种 awk 迭代循环。在 for 循环主体 中使用时，continue 将使循环控制变量自动增加。以下是一个等价循环:<br/>
for ( x=1;x&lt;=21;x++ ) {<br/>
    if ( x==4 ) {<br/>
        continue<br/>
    }<br/>
    print &quot;iteration&quot;, x<br/>
}<br/>
在 while 循环中时，在调用 continue 之前没有必要增加 x，因为 for 循环会自动增加 x。</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-05T00:58:11+08:00" itemprop="datePublished">2017/8/5</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018658919010.html" itemprop="url">
		十四、网络基础</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">互联网技术人员需要了解的技术</a>
</li>
<li>
<a href="#toc_1">系统运维(Linux系统)</a>
</li>
<li>
<a href="#toc_2">网络知识</a>
</li>
<li>
<a href="#toc_3">开发知识(Java C C++ Python GO)</a>
</li>
<li>
<a href="#toc_4">数据库(MySQL)</a>
</li>
<li>
<a href="#toc_5">大数据(Hadoop)</a>
</li>
<li>
<a href="#toc_6">架构知识(docker openstack)</a>
</li>
<li>
<a href="#toc_7">为什么要学习网络知识</a>
</li>
<li>
<a href="#toc_8">主机之间如何实现网络通讯(实现网络通讯需要具备哪些条件)</a>
</li>
<li>
<a href="#toc_9">两台主机之间需要拥有传输介质</a>
</li>
<li>
<a href="#toc_10">两台主机之间通讯需要将数据信息变为计算机可以识别的二进制信息</a>
</li>
<li>
<a href="#toc_11">两台主机之间实现通讯需要利用网卡硬件设备</a>
</li>
<li>
<a href="#toc_12">网络基础硬件设备(重点)</a>
</li>
<li>
<a href="#toc_13">交换机</a>
<ul>
<li>
<a href="#toc_14">交换机的作用</a>
</li>
<li>
<a href="#toc_15">交换机如何实现多台主机之间通讯</a>
<ul>
<li>
<a href="#toc_16">身份识别问题</a>
</li>
<li>
<a href="#toc_17">判断相应网络范围内有对应主机信息存在方法</a>
</li>
</ul>
</li>
<li>
<a href="#toc_18">交换机的缺点</a>
<ul>
<li>
<a href="#toc_19">无法解决广播风暴问题,广播只会影响在本地局域网中的主机,因此交换机无法隔离广播域</a>
</li>
</ul>
</li>
<li>
<a href="#toc_20">交换机的作用</a>
<ul>
<li>
<a href="#toc_21">在一个交换机的端口上所连接的所有终端设备,均在一个网段上(称为一个广播域)</a>
</li>
<li>
<a href="#toc_22">并且1个网段会有一个统一的网络标识,会产生广播消耗设备的CPU资源</a>
</li>
<li>
<a href="#toc_23">交换机可以隔离冲突域,每一个端口就是一个冲突域</a>
</li>
<li>
<a href="#toc_24">终端用户的设备接入</a>
</li>
<li>
<a href="#toc_25">基本的安全功能</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_26">路由器</a>
<ul>
<li>
<a href="#toc_27">隔离广播风暴的思路</a>
</li>
<li>
<a href="#toc_28">什么是路由器</a>
<ul>
<li>
<a href="#toc_29">实现不同局域网之间主句的通讯需求</a>
</li>
<li>
<a href="#toc_30">隔离广播风暴</a>
</li>
<li>
<a href="#toc_31">让多台路由器之间的路由表信息共享</a>
</li>
<li>
<a href="#toc_32">悄悄话实现路由信息共享==路由协议</a>
</li>
<li>
<a href="#toc_33">实现路由信息共享(实现全部路由表信息统一) ==路由表的收敛过程</a>
</li>
</ul>
</li>
<li>
<a href="#toc_34">路由器的作用</a>
<ul>
<li>
<a href="#toc_35">路由转发,实现不同网段之间主机的通讯</a>
</li>
<li>
<a href="#toc_36">路由器会作为网关</a>
</li>
<li>
<a href="#toc_37">广域网链路支持</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_38">网络层次架构(拓扑结构)</a>
</li>
<li>
<a href="#toc_39">按照层次划分</a>
</li>
<li>
<a href="#toc_40">按照区域划分</a>
</li>
<li>
<a href="#toc_41">OSI网络模型概念</a>
</li>
<li>
<a href="#toc_42">OSI网络模型样子</a>
</li>
<li>
<a href="#toc_43">OSI网络模型层次(重点)</a>
</li>
<li>
<a href="#toc_44">OSI层次模型特征</a>
</li>
<li>
<a href="#toc_45">OSI层次模型介绍</a>
</li>
<li>
<a href="#toc_46">利用数据包封装与解封装过程熟悉主机之间网际互联原理</a>
</li>
<li>
<a href="#toc_47">TCP/IP协议簇</a>
</li>
<li>
<a href="#toc_48">TCP/IP网络模型概念</a>
<ul>
<li>
<a href="#toc_49">TCP/IP网络模型层次</a>
</li>
</ul>
</li>
<li>
<a href="#toc_50">TCP/IP三次握手过程</a>
<ul>
<li>
<a href="#toc_51">理解seq和ACK</a>
</li>
</ul>
</li>
<li>
<a href="#toc_53">TCP/IP四次挥手过程</a>
</li>
<li>
<a href="#toc_54">TCP/IP十一种状态集的转换</a>
<ul>
<li>
<a href="#toc_55">十一种状态集的转换</a>
</li>
<li>
<a href="#toc_56">socket套接字文件:(五元组)</a>
<ul>
<li>
<a href="#toc_57">协议TCP UDP协议</a>
</li>
<li>
<a href="#toc_58">目标IP地址</a>
</li>
<li>
<a href="#toc_59">目标端口号</a>
</li>
<li>
<a href="#toc_60">源IP地址</a>
</li>
<li>
<a href="#toc_61">源端口号</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_62">ARP协议说明</a>
<ul>
<li>
<a href="#toc_63">ARP协议的功能</a>
<ul>
<li>
<a href="#toc_64">将IPv4地址解析为MAC地址</a>
</li>
<li>
<a href="#toc_65">维护映射的缓存</a>
</li>
</ul>
</li>
<li>
<a href="#toc_66">提示信息</a>
<ul>
<li>
<a href="#toc_67">网络层对应的是IP地址,是跨网段使用的</a>
</li>
<li>
<a href="#toc_68">链路层地址对应的是MAC地址,是物理地址,实在局域网内部使用的</a>
</li>
<li>
<a href="#toc_69">MAC地址就好比自己的小名一样,只有本地局域网有效</a>
</li>
</ul>
</li>
<li>
<a href="#toc_70">ARP协议原理</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_71">IP地址分类与子网划分基础</a>
<ul>
<li>
<a href="#toc_72">IP地址概念介绍</a>
</li>
<li>
<a href="#toc_73">十进制与二进制转换</a>
</li>
<li>
<a href="#toc_74">按照IP地址范围进行划分</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_75">127.0.0.1</a>
</li>
<li>
<a href="#toc_76">0.0.0.0</a>
</li>
<li>
<a href="#toc_77">255.255.255.255</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_78">按照IP地址用途进行划分</a>
</li>
<li>
<a href="#toc_79">按照IP地址数值范围划分</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_80">ABC三类分配给互联网用户所使用</a>
</li>
<li>
<a href="#toc_81">D类型作为组播使用</a>
</li>
<li>
<a href="#toc_82">E类型作为科学研究使用,进行保留</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_83">IP地址子网划分</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_84">利用掩码信息,获取得知一个IP地址的网络部分和主机部分</a>
</li>
<li>
<a href="#toc_85">利用主类地址进行切割的方式,划分出多个小的网络(子网)</a>
</li>
<li>
<a href="#toc_86">IP地址网络部分不可以使用,因此需要借助主机部分,进行划分子网</a>
</li>
<li>
<a href="#toc_87">主机被借用,变为网络部分,从而生成相应子网.</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_88">子网划分结论说明</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_89">判断IP地址类型,找掩码</a>
</li>
<li>
<a href="#toc_90">变更掩码,出子网</a>
</li>
<li>
<a href="#toc_91">已知子网,获得子网号</a>
</li>
<li>
<a href="#toc_92">已知子网号,算取主机段</a>
</li>
<li>
<a href="#toc_93">根据主机段,得出广播号</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_94">IP地址子网划分方法</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_95">2的N次方=可以划分的子网个数</a>
</li>
<li>
<a href="#toc_96">2的N次方-2=一个网段的额主机个数</a>
</li>
<li>
<a href="#toc_97">其中N表示借用的主机位个数</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_98">企业中间搭建一个局域网的过程</a>
<ul>
<li>
<a href="#toc_99">确认相应网络硬件设备是否具备</a>
</li>
<li>
<a href="#toc_100">规划好连接拓扑,确认物理连接正常</a>
</li>
<li>
<a href="#toc_101">交换机上进行VLAN的配置</a>
</li>
<li>
<a href="#toc_102">路由器上面进行的配置:DHCP地址池设置</a>
</li>
<li>
<a href="#toc_103">进行检验测试</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_104">DNS</a>
<ul>
<li>
<a href="#toc_105">DNS解析原理过程</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_106">用户主机输入域名地址后：先要查询本地hosts文件，是否存在域名与IP地址的解析对应关系</a>
</li>
<li>
<a href="#toc_107">本地主机若不存在解析记录，需要进行访问Local DNS服务器（本地dns服务器），让LDNS服务器进行告知域名与IP的解析信息</a>
</li>
<li>
<a href="#toc_108">若LDNS服务器上也没有对应的域名与IP解析记录，需要向根域名服务器进行请求（www.jd.com.---&gt;ip地址）</a>
</li>
<li>
<a href="#toc_109">根域名服务器会有点com（顶级域名）的记录信息，告知LDNS服务器去找.com服务器进行询问</a>
</li>
<li>
<a href="#toc_110">顶级域名服务器会有.jd.com(二级域名)的记录信息，告知LDNS服务器去找jd.com服务器进行询问</a>
</li>
<li>
<a href="#toc_111">二级域名服务器会存在www.jd.com对应IP地址信息，告知LDNS服务器域名对应的解析记录</a>
</li>
<li>
<a href="#toc_112">LDNS服务器收到解析记录后，将解析记录进行保存到本地（缓存），再讲解析记录告知主机</a>
</li>
<li>
<a href="#toc_113">主机收到解析记录，将解析记录进行缓存；会根据解析的IP地址，进行网络访问</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_114">DNS解析相关命令</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_115">windows上dns记录查询命令</a>
</li>
<li>
<a href="#toc_116">通过域名获取解析后的IP地址信息命令</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_117">Linux相关的网络配置与设置</a>
<ul>
<li>
<a href="#toc_118">系统网卡配置知识</a>
</li>
</ul>
</li>
<li>
<a href="#toc_119">推荐：ifdown,ifup进行指定网卡的重启操作</a>
</li>
<li>
<a href="#toc_120">针对所有网卡进行重启操作（工作场景慎用此命令）</a>
<ul>
<li>
<a href="#toc_121">修改主机名的规范</a>
</li>
<li>
<a href="#toc_122">配置默认网关方法(重点掌握)</a>
</li>
</ul>
</li>
<li>
<a href="#toc_123">生效文件---ifcfg-ethx</a>
</li>
<li>
<a href="#toc_124">生效文件---network</a>
</li>
<li>
<a href="#toc_125">命令行优先，且临时生效</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_126">route命令应用的三种方式（重点）</a>
<ul>
<li>
<a href="#toc_127">IP别名与辅助IP配置方法（重点掌握）</a>
<ul>
<li>
<a href="#toc_128">IP别名方式（centos6）</a>
</li>
<li>
<a href="#toc_129">删除IP别名配置：</a>
<ul>
<li>
<a href="#toc_130">重启网卡即可</a>
</li>
<li>
<a href="#toc_131">利用命令删除IP别名信息</a>
</li>
</ul>
</li>
<li>
<a href="#toc_132">配置辅助IP地址方法（centos7）</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_133">利用辅助IP方式，增加接口地址</a>
<ul>
<li>
<a href="#toc_134">检查老男孩教育的网站是否有问题：</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_135">利用ping命令先检测网络连通性：</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_136">ping www.etiantian.org</a>
<ul>
<li>
<a href="#toc_137">ping -c3 -i2 -s512 www.baidu.com</a>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<a href="#toc_138">利用tracroute命令检测网络连通性：(虚拟主机无法使用此命令)</a>
</li>
<li>
<a href="#toc_139">利用telnet命令检查相应网络服务有没有开启：</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_140">telnet www.etiatian.org 80</a>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<a href="#toc_141">利用namp命令检测服务端相应网络服务端口是否开启：</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_142">nmap 10.0.0.25 -p 80</a>
</li>
</ul>


<h2 id="toc_0">互联网技术人员需要了解的技术</h2>

<h2 id="toc_1">系统运维(Linux系统)</h2>

<h2 id="toc_2">网络知识</h2>

<h2 id="toc_3">开发知识(Java C C++ Python GO)</h2>

<h2 id="toc_4">数据库(MySQL)</h2>

<h2 id="toc_5">大数据(Hadoop)</h2>

<h2 id="toc_6">架构知识(docker openstack)</h2>

<h2 id="toc_7">为什么要学习网络知识</h2>

<pre><code>                        通过网络
</code></pre>

<p>基础系统知识                  ======&gt;     系统服务的概念<br/>
单机游戏                        ======&gt;     网络游戏(王者荣耀)<br/>
听歌                          ======&gt;     听歌可以下载<br/>
看文档                     ======&gt;     文档资源共享(有道云笔记 为知笔记)<br/>
大电影(男生电脑的F盘)        ======&gt;     大电影(下载资源更方便)</p>

<h2 id="toc_8">主机之间如何实现网络通讯(实现网络通讯需要具备哪些条件)</h2>

<h2 id="toc_9">两台主机之间需要拥有传输介质</h2>

<pre><code>介质: 连接不同主机之间的物质(铜轴电缆 双绞线 光纤 无线WiFi 蓝牙)
</code></pre>

<h2 id="toc_10">两台主机之间通讯需要将数据信息变为计算机可以识别的二进制信息</h2>

<pre><code>通过计算机将二进制信息转换为高低不等的电压,在传输介质中进行传输
</code></pre>

<h2 id="toc_11">两台主机之间实现通讯需要利用网卡硬件设备</h2>

<pre><code>网卡: 单位时间内可以调制或接收到的信号个数
利用网卡将计算机中的二进制数(bit流(1个二进制==1bit))转换响应高低电压,也可以将高低电压转换为响应的二进制数(bit流)
网卡速率:   100Mbps=MB-&gt;MBit
                ps-&gt;per second
补充说明:   网络中100Mbps==b==&gt;bit流
            磁盘中100KB==B==&gt;Byte字节
            1bit=1/8字节  1字节=8bit
</code></pre>

<h2 id="toc_12">网络基础硬件设备(重点)</h2>

<h2 id="toc_13">交换机</h2>

<h3 id="toc_14">交换机的作用</h3>

<pre><code>为了解决网络中多台主机之间的彼此通讯需求
</code></pre>

<h3 id="toc_15">交换机如何实现多台主机之间通讯</h3>

<h4 id="toc_16">身份识别问题</h4>

<pre><code>通过mac(物理地址)地址,mac地址只在一个局域网内识别身份信息有效
</code></pre>

<h4 id="toc_17">判断相应网络范围内有对应主机信息存在方法</h4>

<pre><code>利用交换机的广播功能,可以实现局域网中所有主机都可以接收广播信号信息
</code></pre>

<h3 id="toc_18">交换机的缺点</h3>

<h4 id="toc_19">无法解决广播风暴问题,广播只会影响在本地局域网中的主机,因此交换机无法隔离广播域</h4>

<pre><code>1个交换机不管有多少接口,只有一个广播域
1个交换机有多少个接口,就有多少个冲突域
</code></pre>

<h3 id="toc_20">交换机的作用</h3>

<h4 id="toc_21">在一个交换机的端口上所连接的所有终端设备,均在一个网段上(称为一个广播域)</h4>

<h4 id="toc_22">并且1个网段会有一个统一的网络标识,会产生广播消耗设备的CPU资源</h4>

<h4 id="toc_23">交换机可以隔离冲突域,每一个端口就是一个冲突域</h4>

<h4 id="toc_24">终端用户的设备接入</h4>

<h4 id="toc_25">基本的安全功能</h4>

<h2 id="toc_26">路由器</h2>

<p>交换机<br/>
路由器<br/>
实现局域网内部主机之间的通讯交流<br/>
实现不同局域网主机之间的通讯交流<br/>
局域网中标识主机身份信息利用MAC地址<br/>
mac属于物理地址;mac地址是采用16进制数显示输出的48位表示(2进制数)<br/>
mac是护照!全球唯一<br/>
不同局域网之间标识主机身份信息利用IP地址<br/>
IP属于逻辑地址:IP地址采用10进制数显示输出的32位表示2进制数;如何转换成10进制数(重点了解)<br/>
IP地址对应的是身份证:一个局域网内部IP地址不可以相互重复<br/>
局域网数据包的基本组成:源Mac地址 目标Mac地址 数据信息<br/>
不同局域网数据的基本组成:源IP地址 目标IP地址 数据信息<br/>
冲突域:多个数据信息通过一个接口进行传输;交换机解决了冲突域,每一个接口就称为一个冲突域<br/>
每一个接口就称为一个冲突域<br/>
广播域:交换机无法解决广播域;因此会出现__广播风暴__<br/>
交换机所有的接口在一个广播域中<br/>
路由器的每一个接口称为一个广播域</p>

<h3 id="toc_27">隔离广播风暴的思路</h3>

<pre><code>通过隔离不同局域网来实现
</code></pre>

<h3 id="toc_28">什么是路由器</h3>

<h4 id="toc_29">实现不同局域网之间主句的通讯需求</h4>

<pre><code>路由器只记录: 局域网编号信息,不记录局域网中的主机编号信息
                局域网编号==网段       主机编号:主机地址
                网段+主机地址==IP地址,IP地址是一个逻辑地址
</code></pre>

<h4 id="toc_30">隔离广播风暴</h4>

<pre><code>利用多台路由器可以实现可以实现不同局域网主机之间的共享
</code></pre>

<h4 id="toc_31">让多台路由器之间的路由表信息共享</h4>

<h4 id="toc_32">悄悄话实现路由信息共享==路由协议</h4>

<h4 id="toc_33">实现路由信息共享(实现全部路由表信息统一) ==路由表的收敛过程</h4>

<pre><code>静态路由协议:指明到达目标地址或网络的方式
动态路由协议:自我宣告,或者通知的方式,发起其他互联路由器我饿路由表信息
</code></pre>

<h3 id="toc_34">路由器的作用</h3>

<h4 id="toc_35">路由转发,实现不同网段之间主机的通讯</h4>

<h4 id="toc_36">路由器会作为网关</h4>

<h4 id="toc_37">广域网链路支持</h4>

<h2 id="toc_38">网络层次架构(拓扑结构)</h2>

<h2 id="toc_39">按照层次划分</h2>

<pre><code>核心层:连接外网(互联网);要有冗余能力
汇聚层:承上启下
接入层:接入终端主机(用户)设备
</code></pre>

<h2 id="toc_40">按照区域划分</h2>

<pre><code>局域网
城域网(多个局域网)
广域网(多个城域网)
</code></pre>

<h2 id="toc_41">OSI网络模型概念</h2>

<h2 id="toc_42">OSI网络模型样子</h2>

<p>按层次进行划分的,由下至上共划分为7层</p>

<h2 id="toc_43">OSI网络模型层次(重点)</h2>

<p>DOD模型<br/>
OSI模型<br/>
功能<br/>
说明<br/>
应用层<br/>
应用层<br/>
应用程序及接口<br/>
提供应用程序的接口;就相当于开发好的软件.<br/>
FTP Telnet http pop3等</p>

<p>表示层<br/>
对数据进行转换 加密和压缩<br/>
将上层的数据进行装换和编译压缩为标准的文件,如jpg GIF ASCII码等</p>

<p>会话层<br/>
建立 管理和终止会话</p>

<p>主机到主机层<br/>
传输层<br/>
提供可靠的端到端的报文传输和差错控制<br/>
TCP UDP 建立可靠和费可靠连接<br/>
将上层的数据进行分段处理<br/>
因特网层<br/>
网络层<br/>
将分组从源端传送到目的端;提供网络互联<br/>
实质上就是提供路由寻址(IP协议)<br/>
将上层分段的数据进行打包<br/>
网络接入层<br/>
数据链路层<br/>
将分组数据封装成帧;提供节点到节点方式的传输<br/>
帧就是本地局域网中传输数据的一个单元,负责在局域网内部的点对点的寻址</p>

<p>物理层<br/>
在媒体上传输比特;提供机械的和电气的规约<br/>
就是底层链路介质的规范</p>

<h2 id="toc_44">OSI层次模型特征</h2>

<p>上层管理下层;下层为上层服务;但是每层都互相独立<br/>
两个OSI模型之间,相同层次进行交流</p>

<h2 id="toc_45">OSI层次模型介绍</h2>

<pre><code>只是一个标准模型,用于定于各层次的协议
</code></pre>

<p>网络层:IP地址(网段+主机地址)</p>

<h2 id="toc_46">利用数据包封装与解封装过程熟悉主机之间网际互联原理</h2>

<h2 id="toc_47">TCP/IP协议簇</h2>

<h2 id="toc_48">TCP/IP网络模型概念</h2>

<h3 id="toc_49">TCP/IP网络模型层次</h3>

<p>网络接入层 网络层 传输层 应用层<br/>
应用层:账户哦都有那些重要的协议,掌握这些协议对应的端口号信息<br/>
传输层:<br/>
TCP协议:属于面向连接的网络协议==同步的概念 ==== QQ在线传输文件 效率不高 可靠性高<br/>
UDP协议:属于无连接的网络协议==异步的概念 ==== QQ离线传输文件 效率更高 可靠性不高</p>

<h2 id="toc_50">TCP/IP三次握手过程</h2>

<h3 id="toc_51">理解seq和ACK</h3>

<ol>
<li>主机之间通讯都是有数据data信息的,只要有数据信息,就会有seq ACK存在</li>
<li>作为发送数据的一方,只发送seq数据序列号信息+拆分的数据信息</li>
<li><p>作为接收数据的一方,只发送ACK确认号信息,并且ACK确认号信息=接收到的seq信息数值+1</p>

<h3 id="toc_52">TCP三次握手状态转换简单说明:</h3></li>
<li><p>首先,建立连接之前,服务器和客户端的状态都为CLOSED</p></li>
<li><p>服务器创建socket后开始监听,变为LISTEN状态<br/>
客户端请求建立连接,向服务器发送SYN报文，客户端的状态变为SYN_SENT。</p></li>
<li><p>服务器收到客户端的报文后，向客户端发送ACK和SYN报文，此时服务器的状态变为SYN_RCVD。</p></li>
<li><p>然后，客户端收到ACK、SYN，就向服务器发送ACK，客户端状态变为ESTABLISHED。</p></li>
<li><p>服务器收到客户端的ACK后也变为ESTABLISHED。<br/>
此时三次握手完成，连接建立。</p></li>
</ol>

<h2 id="toc_53">TCP/IP四次挥手过程</h2>

<blockquote>
<p>由于TCP连接是全双工的，断开连接会比建立连接麻烦一点点。</p>
</blockquote>

<ol>
<li>客户端现象服务器发送FIN报文，请求断开连接，其状态变为FIN_WAIT1。</li>
<li>服务器收到FIN后向客户端发送ACK，服务器状态变为CLOSE_WAIT。</li>
<li>客户端收到ACK后就进入FIN_WAIT2状态。此时连接已经断开了一半了，如果服务器还有数据要发给客户端，就会继续发送。</li>
<li>直到发送完成，就发送FIN报文，此时服务器进入LAST_ACK状态。</li>
<li>客户端收到服务器的FIN后，马上发送ACK给服务器，此时客户端进入TIME_WAIT状态，再过了2MSL长的时间后进入CLOSED状态，服务器收到客户端的ACK就进入CLOSED状态。</li>
</ol>

<blockquote>
<p>至此，还有一个状态没有提及：CLOSING状态<br/>
CLOSING状态表示：<br/>
客户端发生了FIN，但FIN_WAIT1状态时没有收到服务器的ACK确认字段，却收到了服务器的FIN字段，这种情况发生在服务器发送的ACK丢包的时候，因为网络传输有时会有意外。</p>
</blockquote>

<h2 id="toc_54">TCP/IP十一种状态集的转换</h2>

<h3 id="toc_55">十一种状态集的转换</h3>

<p>状态出现方式<br/>
状态出现环境<br/>
状态名称<br/>
状态描述<br/>
TCP建立过程<br/>
涉及5种状态<br/>
服务端/客户端<br/>
CLOSED<br/>
默认初始化状态</p>

<p>服务端<br/>
LISTEN<br/>
建立socket,进入监听状态</p>

<p>客户端<br/>
SYN_SENT<br/>
发送SYN报文,进入SYN发送状态</p>

<p>服务端<br/>
SYN_RCVD<br/>
接收SYN报文,并回复ACK及SYN报文</p>

<p>客服端/服务端<br/>
ESTABLISHED<br/>
接收SYN报文,回复ACK,建立连接(客户端)<br/>
接收ACK报文,建立连接(服务端)<br/>
TCP断开过程<br/>
涉及6种状态<br/>
服务端/客户端<br/>
ESTABLISHED<br/>
默认断开前初始状态</p>

<p>客户端<br/>
FIN_WAIT1<br/>
发送断开请求FIN报文</p>

<p>服务端<br/>
CLOSE_WAIT<br/>
收到FIN后想客户端发送ACK</p>

<p>客户端<br/>
FIN_WAIT2<br/>
收到服务端返回的ACK报文,等待数据传输</p>

<p>服务端<br/>
LAST_ACK<br/>
发送FIN断开请求报文</p>

<p>客户端<br/>
TIME_WAIT<br/>
回复FIN断开请求,发送ACK报文</p>

<p>服务端/客户端<br/>
CLOSED<br/>
收到ACK报文,立即转变为断开状态<br/>
等待2MSL后,进入断开状态</p>

<p>客户端<br/>
CLOSEING<br/>
没收收到回复FIN报文的ACK,直接收到FIN</p>

<h3 id="toc_56">socket套接字文件:(五元组)</h3>

<h4 id="toc_57">协议TCP UDP协议</h4>

<h4 id="toc_58">目标IP地址</h4>

<h4 id="toc_59">目标端口号</h4>

<h4 id="toc_60">源IP地址</h4>

<h4 id="toc_61">源端口号</h4>

<h2 id="toc_62">ARP协议说明</h2>

<h3 id="toc_63">ARP协议的功能</h3>

<h4 id="toc_64">将IPv4地址解析为MAC地址</h4>

<pre><code>用于让IP地址与MAC地址建立关系
</code></pre>

<h4 id="toc_65">维护映射的缓存</h4>

<pre><code>ARP表主要存储在主机和交换机挡住,主要用于减少广播风暴
</code></pre>

<h3 id="toc_66">提示信息</h3>

<h4 id="toc_67">网络层对应的是IP地址,是跨网段使用的</h4>

<h4 id="toc_68">链路层地址对应的是MAC地址,是物理地址,实在局域网内部使用的</h4>

<h4 id="toc_69">MAC地址就好比自己的小名一样,只有本地局域网有效</h4>

<h3 id="toc_70">ARP协议原理</h3>

<pre><code>ARP条目分为静态条目和动态条目
静态条目:主机量比较少的情况  主机不会频繁发生变更
动态条目:主机量比较多的情况  主机会频繁发生变更
</code></pre>

<h1 id="toc_71">IP地址分类与子网划分基础</h1>

<h2 id="toc_72">IP地址概念介绍</h2>

<pre><code>常见的IP地址版本分为IPv4和IPv6
32位:IPv4地址是由32位二进制数字序列组成的数字序列
点分十进制:采用点将32位数字进行分割为4段,每段8位的二进制数,但二进制数不便于记忆,因此转换为10进制数显示,即点分十进制.
</code></pre>

<h2 id="toc_73">十进制与二进制转换</h2>

<h2 id="toc_74">按照IP地址范围进行划分</h2>

<p>特殊IP地址说明:</p>

<h4 id="toc_75">127.0.0.1</h4>

<pre><code>表示回环地址,进行测试使用,验证本地的TCP协议簇安装的是否正确.
</code></pre>

<h4 id="toc_76">0.0.0.0</h4>

<pre><code>主机位全为0的,称为是网络地址
</code></pre>

<h4 id="toc_77">255.255.255.255</h4>

<pre><code>主机位全为1的,称为广播地址,即向所有人发出信息
</code></pre>

<h2 id="toc_78">按照IP地址用途进行划分</h2>

<pre><code>公网地址:全球唯一的IP地址,并且可以被互联网路由器进行识别
私网地址:就是避免公网IP地址的枯竭所出现的
        一个局域网范围内唯一,不同的局域网主机,可以有相同的IP地址
        私网IP地址不能出现在互联网路由器中
公网地址类似于:护照上面的编号
私网地址类似于:国内使用的身份证编号
</code></pre>

<h2 id="toc_79">按照IP地址数值范围划分</h2>

<p>共分为5类,常见的地址是A,B,C三类<br/>
A<br/>
1.0.0.0~126.0.0.0<br/>
0.0.0.0和127.0.0.0保留<br/>
B<br/>
128.1.0.0~191.254.0.0<br/>
128.0.0.0和191.255.0.0保留<br/>
C<br/>
192.0.1.0~223.255.254.0<br/>
192.0.0.0和223.255.255.0保留<br/>
D<br/>
224.0.0.0~239.255.255.255<br/>
用于多点广播<br/>
E<br/>
240.0.0.0~255.255.255.254<br/>
保留(255.255.255.255用于广播)</p>

<h4 id="toc_80">ABC三类分配给互联网用户所使用</h4>

<h4 id="toc_81">D类型作为组播使用</h4>

<h4 id="toc_82">E类型作为科学研究使用,进行保留</h4>

<h2 id="toc_83">IP地址子网划分</h2>

<h4 id="toc_84">利用掩码信息,获取得知一个IP地址的网络部分和主机部分</h4>

<h4 id="toc_85">利用主类地址进行切割的方式,划分出多个小的网络(子网)</h4>

<h4 id="toc_86">IP地址网络部分不可以使用,因此需要借助主机部分,进行划分子网</h4>

<h4 id="toc_87">主机被借用,变为网络部分,从而生成相应子网.</h4>

<h2 id="toc_88">子网划分结论说明</h2>

<h4 id="toc_89">判断IP地址类型,找掩码</h4>

<pre><code>根据上面所学的IP地址分类规划,可以得知默认的主类网络地址掩码信息
</code></pre>

<h4 id="toc_90">变更掩码,出子网</h4>

<pre><code>根据默认的掩码规划信息,将掩码信息进行调整变更,即进行子网划分
</code></pre>

<h4 id="toc_91">已知子网,获得子网号</h4>

<pre><code>根据借用的主机位,可以判断出可用的子网信息
</code></pre>

<h4 id="toc_92">已知子网号,算取主机段</h4>

<pre><code>根据剩余的主机位,可以判断出可用的主机地址
</code></pre>

<h4 id="toc_93">根据主机段,得出广播号</h4>

<pre><code>得出足迹范围,即也就得出了网络地址和广播地址
</code></pre>

<h2 id="toc_94">IP地址子网划分方法</h2>

<h4 id="toc_95">2的N次方=可以划分的子网个数</h4>

<h4 id="toc_96">2的N次方-2=一个网段的额主机个数</h4>

<h4 id="toc_97">其中N表示借用的主机位个数</h4>

<h1 id="toc_98">企业中间搭建一个局域网的过程</h1>

<h4 id="toc_99">确认相应网络硬件设备是否具备</h4>

<h4 id="toc_100">规划好连接拓扑,确认物理连接正常</h4>

<h4 id="toc_101">交换机上进行VLAN的配置</h4>

<h4 id="toc_102">路由器上面进行的配置:DHCP地址池设置</h4>

<pre><code>进行路由配置(进行拨号连接就行了)
在路由和交换机互联的接口上配置一个IP地址,作为网关地址
</code></pre>

<h4 id="toc_103">进行检验测试</h4>

<h1 id="toc_104">DNS</h1>

<h2 id="toc_105">DNS解析原理过程</h2>

<h4 id="toc_106">用户主机输入域名地址后：先要查询本地hosts文件，是否存在域名与IP地址的解析对应关系</h4>

<pre><code>                            其次查询本地的dns缓存记录 ipconfig /displaydns 在cmd命令行中
    如果本地存在相应域名与IP的解析信息，就可以直接利用解析后的IP地址，进行网络访问
    疑问：如果缓存和hosts文件都没有呢
</code></pre>

<h4 id="toc_107">本地主机若不存在解析记录，需要进行访问Local DNS服务器（本地dns服务器），让LDNS服务器进行告知域名与IP的解析信息</h4>

<pre><code>    访问LDNS服务器，是通过网卡上面配置的DNS服务器信息进行访问的
    以为：如果LDNS服务器上也不存在响应域名与IP的对应关系呢
</code></pre>

<h4 id="toc_108">若LDNS服务器上也没有对应的域名与IP解析记录，需要向根域名服务器进行请求（www.jd.com.---&gt;ip地址）</h4>

<h4 id="toc_109">根域名服务器会有点com（顶级域名）的记录信息，告知LDNS服务器去找.com服务器进行询问</h4>

<h4 id="toc_110">顶级域名服务器会有.jd.com(二级域名)的记录信息，告知LDNS服务器去找jd.com服务器进行询问</h4>

<h4 id="toc_111">二级域名服务器会存在www.jd.com对应IP地址信息，告知LDNS服务器域名对应的解析记录</h4>

<h4 id="toc_112">LDNS服务器收到解析记录后，将解析记录进行保存到本地（缓存），再讲解析记录告知主机</h4>

<h4 id="toc_113">主机收到解析记录，将解析记录进行缓存；会根据解析的IP地址，进行网络访问</h4>

<pre><code>递归查询：主机到LDNS服务器的查询过程
          直接返回查询结果的过程
迭代查询：LDNS服务器到根域名服务器 到顶级域名服务器 到二级域名服务器的查询过程
          需要不断补充，从而完成最终的查询结果
</code></pre>

<h2 id="toc_114">DNS解析相关命令</h2>

<h4 id="toc_115">windows上dns记录查询命令</h4>

<pre><code>    ipconfig /flushdns          &lt;- 清除缓存命令
    ipconfig /displaydns        &lt;- 显示缓存命令
</code></pre>

<h4 id="toc_116">通过域名获取解析后的IP地址信息命令</h4>

<pre><code>    dig www.baidu.com
    dig @223.5.5.5 www.baidu.com +trace   &lt;- 通过此命令获取得知整个DNS解析原理过程
    nslookup www.baidu.com
    host www.baidu.com
    ping www.baidu.com
</code></pre>

<h1 id="toc_117">Linux相关的网络配置与设置</h1>

<h2 id="toc_118">系统网卡配置知识</h2>

<h1 id="toc_119">推荐：ifdown,ifup进行指定网卡的重启操作</h1>

<pre><code>    ifdown eth0     &lt;- 停掉eth0网卡
    ifup eth0           &lt;- 启动eth0网卡
</code></pre>

<h1 id="toc_120">针对所有网卡进行重启操作（工作场景慎用此命令）</h1>

<pre><code>    /etc/init.d/network restart 
</code></pre>

<h2 id="toc_121">修改主机名的规范</h2>

<h2 id="toc_122">配置默认网关方法(重点掌握)</h2>

<h1 id="toc_123">生效文件---ifcfg-ethx</h1>

<pre><code>    grep -i gate /etc/sysconfig/network-scripts/ifcfg-eth0 
    GATEWAY=10.0.0.254
</code></pre>

<h1 id="toc_124">生效文件---network</h1>

<pre><code>    grep -i gate /etc/sysconfig/network
    GATEWAY=10.0.0.253
</code></pre>

<h1 id="toc_125">命令行优先，且临时生效</h1>

<pre><code>    route -n或netstat -rn进行查看确认
    route add default gw 10.0.0.254
    route del default gw 10.0.0.254
</code></pre>

<h3 id="toc_126">route命令应用的三种方式（重点）</h3>

<p>· 添加默认网关路由<br/>
  route add default gw 10.0.0.254<br/>
· 添加静态网段路由<br/>
  route add -net 172.16.1.0 netmask 255.255.255.0 gw 10.0.0.254<br/>
· 添加静态主机路由<br/><br/>
      route add -host 192.168.2.13 dev eth2</p>

<h2 id="toc_127">IP别名与辅助IP配置方法（重点掌握）</h2>

<h3 id="toc_128">IP别名方式（centos6）</h3>

<pre><code>ifconfig eth0:0 10.0.0.100/24 up
ifconfig eth0:0 10.0.0.10 netmask 255.255.255.0 up
</code></pre>

<h3 id="toc_129">删除IP别名配置：</h3>

<h4 id="toc_130">重启网卡即可</h4>

<h4 id="toc_131">利用命令删除IP别名信息</h4>

<pre><code>    ifconfig eth0:0 down
    ifconfig eth0:0 10.0.0.10 netmask 255.255.255.0 down
使别名IP网卡重启不失效：
写成配置文件（/etc/sysconfig/network-scripts/ifcfg-eth0:1）。
</code></pre>

<h3 id="toc_132">配置辅助IP地址方法（centos7）</h3>

<h1 id="toc_133">利用辅助IP方式，增加接口地址</h1>

<pre><code>ip addr add 10.0.0.13/24 
ip addr del 10.0.0.10/24 dev ethx    &lt;- 删除辅助IP方式

一大波网络常用命令
ping命令：-c 指定ping包个数  -i 指定ping包间隔  -q 不显示ping过程 -f 表示极限快速ping
 telnet命令：测试端口是否可以访问 telnet 10.0.0.200 22
 ifconfig命令：查看网路信息 
               指定关闭或开启网卡 ifconfig eth0 down / ifconfig eth0 up
 其余需要总结命令参见网络文件命令文件
</code></pre>

<h2 id="toc_134">检查老男孩教育的网站是否有问题：</h2>

<h4 id="toc_135">利用ping命令先检测网络连通性：</h4>

<h1 id="toc_136">ping <a href="http://www.etiantian.org">www.etiantian.org</a></h1>

<h1 id="toc_137">ping -c3 -i2 -s512 <a href="http://www.baidu.com">www.baidu.com</a></h1>

<h4 id="toc_138">利用tracroute命令检测网络连通性：(虚拟主机无法使用此命令)</h4>

<pre><code>     traceroute www.baidu.com -n     -n 阻止IP到域名的解析（IP到域名，反向解析）
     tracert -d www.baidu.com
</code></pre>

<h4 id="toc_139">利用telnet命令检查相应网络服务有没有开启：</h4>

<h1 id="toc_140">telnet <a href="http://www.etiatian.org">www.etiatian.org</a> 80</h1>

<h4 id="toc_141">利用namp命令检测服务端相应网络服务端口是否开启：</h4>

<h1 id="toc_142">nmap 10.0.0.25 -p 80</h1>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-05T00:28:13+08:00" itemprop="datePublished">2017/8/5</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018640937342.html" itemprop="url">
		十三、shell编程入门</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

<ol>
<li>为什么要学习shell编程

<ol>
<li>Linux系统批量管理</li>
<li>提升工作效率</li>
<li>减少重复工作</li>
</ol></li>
<li>本阶段shell学习要求

<ol>
<li>看懂简单脚本</li>
<li>尝试写脚本</li>
<li>结合后面的其中架构</li>
</ol></li>
<li>学好shell编程所需的基础知识

<ol>
<li>熟练使用vim编辑器</li>
<li>熟悉ssh终端</li>
<li>数量掌握80个以上Linux常用命令</li>
<li>数量账务Linux正则表达式及三剑客命令(grep,sed,awk)</li>
<li>熟练账务常用系统服务</li>
</ol></li>
<li>如何学好shell编程

<ol>
<li>核心
多练--&gt;多思考--&gt;再练--&gt;再思考,坚持如此循环即可</li>
<li>大忌
不可拿来主义,可以模仿,但是要自己嚼烂了再吃下去,否则会闹肚子</li>
</ol></li>
<li><p>基础知识</p>

<ol>
<li>什么是shell

<ol>
<li>命令解释器

<ol>
<li>交互:从键盘输入命令,通过/bin/bash的解析,可以立即得到shell的回应</li>
<li>非交互:脚本<br/>
\(____________
|                               外围应用程序                              |  
|               |                 命令解释器                |               |
|               |              |    系统核心    |            |               |
|               |              |   |    硬件  |   |            |               |
\)</li>
</ol></li>
</ol></li>
</ol>

<p>centos默认的shell是bash<br/>
echo $SHELL<br/>
1. 什么是shell脚本<br/>
    1. 一个程序文件,包含若干行Linux命令语句<br/>
    2. 由命令/变量和流程控制语句有机的结合</p></li>
<li><p>创建shell脚本</p>

<ol>
<li>统一脚本存放目录
/server/scripts</li>
<li>推荐使用vim编辑器编辑脚本</li>
<li>第一行指出由哪个解释器来执行脚本中的内容

<ol>
<li>#!/bin/bash

<ol>
<li>&quot;#!&quot;称为幻数,能被内核识别</li>
<li>必须写在第一行,如果不是第一行则为脚本注释行</li>
<li>也可以写为#!/bin/sh
1.sh和bash的区别
2.bash的版本</li>
</ol></li>
<li>脚本注释

<ol>
<li>除第一行外,跟在#后面的内容表示注释</li>
<li>注释部分不会被执行,仅给人看</li>
<li>注释可以自成一行,也可以跟在命令后面,与命令同行</li>
<li>脚本不要用中文注释,尽量用英文注释</li>
</ol></li>
<li>版权声明
配置文件为 ~/.vimrc</li>
<li>写一个简单脚本(切换目录显示文件属性)并运行

<ol>
<li>sh script-name(推荐使用)</li>
<li>path/script-name或./script-name(全路径或当前路径执行脚本)</li>
</ol></li>
</ol></li>
</ol></li>
<li><p>shell脚本深入---变量段</p>

<ol>
<li>什么是变量
    用一个固定的字符串,替代更多更复杂的内容
    1. x=1
    2. devPath=/server/
    3. filelist=`ls`或\((ls)
    4. echo &quot;你现在使用\)USER用户登录,字符集为$LANG,因此我可以使用中文和你交流.&quot;</li>
<li>变量的分类

<ol>
<li>全局变量
又称环境变量
在创建他们的shell及其派生出来的子shell中使用
分类:

<ol>
<li>查看全局变量
env只显示全局变量</li>
<li>bash内置的环境变量
1.shell通过环境变量来确定登录用户名\命令路径\终端类型\登录目录等
2.HOME PATH SHELL UID USER等</li>
</ol></li>
<li>自定义环境变量

<ol>
<li>建议所有环境变量名称均为的大写</li>
<li>必须用export命令定义
export OLDBOY=老男孩
取消变量
unset OLDBOY
永久生效
#全局环境变量配置文件
/etc/profile /etc/bashrc /etc/profile.d
#用户环境变量配置文件
~/.bash_profile ~/.bashrc
局部变量
又称普通变量
只能在创建他们的shell函数或shell脚本中使用
定义变量:
变量名=value
变量名要求
由字母\数字\下划线组成,且以字母开头
规范的变量名写法定义:见名知意
驼峰语法:单个单词字母小写,其余单词首字母大写
oldboyAgeSex=1
把一个命令作为变量
普通字符串变量定义测试
典故:金庸新著
\(\{WEEK}DAY
特殊变量
位置变量:
\)0
1.获取当前执行的shell脚本的文件名
2.如果执行脚本带路径,那么久包括脚本路径
3.模拟系统脚本使用\(0
\#n
1.获取当前执行的shell脚本的第n个参数值,n=1..9..
2.参数默认以空格隔开
3.当n为0时表示脚本的文件名
4.如果n大于9时,用\{}括起来,如{10}
\)#
获取当前执行的shell脚本后面接的参数的数量
进程状态变量--\(?
1.获取执行上一个指令的返回值
2.0为成功,非0为失败
3.生产环境使用场景---用于判断命令程序是否执行成功
变量的定义
直接赋值
name=oldboy
passWord=123456
命令行传参
name=\)1
passWord=\(2
echo \)name
echo $passWord
read读入
read得到的输入默认存储在变量REPLY中
存储在一个指定变量中</li>
<li>存储在多个指定变量中</li>
<li>read -p &quot;提示语句&quot;,则屏幕就会输出提示语句</li>
<li>-t等待时间</li>
<li>-s关闭回显,用于密码输入
read -p &quot;请输入你的用户名:&quot; user
read -s -p &quot;请输入你的密码:&quot; pass</li>
</ol></li>
</ol></li>
</ol></li>
<li><p>shell脚本深入---命令语句段</p>

<ol>
<li>条件表达式

<ol>
<li>明天是否下雨

<ol>
<li>下雨</li>
<li>不下雨</li>
</ol></li>
<li>格式:[&lt;测试表达式&gt;]
好习惯:先敲一对[],然后退格输入2个空格[  ],最后再退格开始输入[ -f /etc/hosts ]
判断文件
符号
英文
说明
-f
file
文件存在且为普通文件则为真,即测试表达式成立
-d
directory
文件存在且为目录文件则为真
-s
size
文件存在且文件大小不为0则为真
-e
exist
文件存在则为真,只要有文件就行
-r
read
文件存在且可读
-w
write
文件存在且可写
-x
executable
文件存在且可执行
-L
link
文件存在且为连接文件
f1 -nt f2
newer than
文件f1比文件f2新则为真,根据文件修改时间计算
f1 -ou f2
older than
文件f1比文件f2旧则为真,根据文件修改时间计算
判断字符串
常用字符串测试操作符
说明
-z &quot;字符串&quot;
若&quot;字符串&quot;长度为0则为真,zero
-n &quot;字符串&quot;
若&quot;字符串&quot;长度不为0则为真,no zero
&quot;字符串1&quot; = &quot;字符串2&quot;
若等于则为真,可用&quot;<mark>&quot;代替&quot;=&quot;
&quot;字符串1&quot; != &quot;字符串2&quot;
若不等于则为真,但不能用&quot;!</mark>&quot;代替&quot;!=&quot;
注意:空格字符是有长度的
注意:字符串必须要用双引号引起来
注意:变量 等号 字符串左右都有空格</li>
<li>判断整数

<ol>
<li>-eq     等于          equal</li>
<li>-ne     不等于     not equal</li>
<li>-gt     大于          greater than</li>
<li>-ge     大于等于        greater equal</li>
<li>-lt     小于          less than</li>
<li>-le     小于等于        less equal</li>
</ol></li>
<li>简单案例:判断命令行参数个数等于2</li>
</ol></li>
<li>if条件语句

<ol>
<li>单分支条件语句
语法
if [ 条件 ]
then
指令
fi</li>
</ol></li>
</ol></li>
</ol>

<p>或<br/>
if [ 条件 ]; then<br/>
  指令<br/>
fi<br/>
    双分支条件语句<br/>
语法<br/>
if [ 条件 ]<br/>
  then<br/>
    指令1<br/>
else<br/>
    指令2<br/>
fi<br/>
    多分支if语句<br/>
语法<br/>
if [ 条件1 ]<br/>
  then<br/>
    指令1<br/>
elif [ 条件2 ]<br/>
  then<br/>
    指令2<br/>
elif [ 条件3 ]<br/>
  then<br/>
    指令3<br/>
.......<br/>
else<br/>
    指令n<br/>
fi<br/>
    case条件语句<br/>
        语法<br/>
case &quot;字符串变量&quot; in<br/>
  值1)<br/>
        指令1<br/>
        ;;<br/>
  值2)<br/>
        指令2<br/>
        ;;<br/>
.........<br/>
  *)<br/>
        指令n<br/>
esac<br/>
    case语句就相当于多分支的if语句<br/>
        case语句的优势是更规范 易读<br/>
        1. case语句适合变量的值少,且为固定的数字或字符串集合<br/>
        2. 案例:菜单脚本<br/>
    2. for循环语句<br/>
        1. 语法<br/>
for 变量名 in 变量取值列表<br/>
    do<br/>
      指令<br/>
done<br/>
    开机启动项优化<br/>
        批量创建文件<br/>
        1. 课后练习题:批量改文件名<br/>
        2. 课后练习题:批量创建用户并设置随机密码<br/>
        3. 倒计时 <br/>
    2. while循环语句<br/>
        1. 语法<br/>
while 条件<br/>
    do<br/>
      指令<br/>
done<br/>
    一般用于守护进程<br/>
        又名死循环<br/>
            true<br/>
        2. 语句小结<br/>
            1. while循环的特长是执行守护进程以及我们希望循环不退出,持续执行,用于频率小于1分钟循环处理(crond),其他的while循环几乎都可以被for循环替代<br/>
            2. case语句可以被if语句替换,一般在系统启动脚本传入少量固定规则字符串用case语句,其他普通判断多用if<br/>
            3. 一句话,if,for语句最常用,其次while(守护进程),case(服务启动脚本)</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-04T23:41:47+08:00" itemprop="datePublished">2017/8/4</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018613071828.html" itemprop="url">
		十二、sed命令精讲</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">sed是什么</a>
</li>
<li>
<a href="#toc_1">sed功能与版本</a>
</li>
<li>
<a href="#toc_2">语法格式</a>
</li>
<li>
<a href="#toc_3">命令执行流程</a>
</li>
<li>
<a href="#toc_4">常用功能</a>
<ul>
<li>
<a href="#toc_5">查询</a>
</li>
<li>
<a href="#toc_6">增加</a>
</li>
<li>
<a href="#toc_7">删除</a>
</li>
<li>
<a href="#toc_8">替换</a>
</li>
<li>
<a href="#toc_9">拓展</a>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">sed是什么</h2>

<blockquote>
<p>字符流编辑器(Stream Editor)</p>
</blockquote>

<h2 id="toc_1">sed功能与版本</h2>

<blockquote>
<p>处理纯文本文件,日志,配置文件等==&gt;Linux<br/>
增加/删除/修改/查询<br/>
sed --version</p>
</blockquote>

<h2 id="toc_2">语法格式</h2>

<pre><code class="language-bash">sed [选项] [sed指令] [输入文件]
</code></pre>

<h2 id="toc_3">命令执行流程</h2>

<blockquote>
<p>模式空间:sed从文件读取一行文本后存入的缓冲区(这个缓冲区是在内存中)</p>
</blockquote>

<h2 id="toc_4">常用功能</h2>

<h3 id="toc_5">查询</h3>

<p><strong>按行查询</strong></p>

<p>单行</p>

<pre><code>p   打印模式空间的内容
-n  取消默认的sed软件的输出
sed -n &#39;1p&#39; pperson.txt
</code></pre>

<p>多行 ==&gt;地址范围精讲</p>

<pre><code>1.没有地址,默认匹配所有行
2.sed &#39;n1[,n2]p&#39; 文件
3.数字
sed -n &#39;1p&#39; pperson.txt
sed -n &#39;1,3p&#39; person.txt
4.正则
sed -n &#39;/oldboy/p&#39; person.txt
sed -n &#39;/oldboy/,/yy/p&#39; person.txt
</code></pre>

<p>过滤多个字符</p>

<pre><code>-r支持扩展正则表达式
|扩展正则,同时过滤多个字符
sed -rn &#39;/oldboy|yy/p&#39; person.txt
</code></pre>

<h3 id="toc_6">增加</h3>

<p>单行增加</p>

<pre><code>a追加append,在指定行后添加一行或多行文本
i插入insert,在指定行前添加一行或多行文本
</code></pre>

<p>多行添加</p>

<pre><code>换行符  \n
</code></pre>

<p>企业案例<br/>
优化SSH配置(一键完成增加若干参数)</p>

<pre><code>cp /etc/ssh/sshd_config
-i将修改内容写入到磁盘文件
</code></pre>

<h3 id="toc_7">删除</h3>

<p>单行删除</p>

<pre><code>d 删除 delete
</code></pre>

<p>多行删除<br/>
企业案例</p>

<pre><code>打印文件内容但不包含oldboy
sed -n &#39;/oldboy/d&#39; person.txt
</code></pre>

<h3 id="toc_8">替换</h3>

<p>文本替换</p>

<pre><code>s单独使用--&gt;将每一行中第一处匹配的字符串进行替换
g每一行进行全部替换--&gt;sed指令s的替换标志之一(全局替换)
-i将修改内容写入到文件,-i.ori将修改内容写入到备份文件
Ms对第M行处理,单独使用时,只处理第一处匹配,有g时则对第M行全部匹配替换
Ng对每一行从匹配上的第N处开始替换.
</code></pre>

<p>变量替换</p>

<blockquote>
<p>引号的区别</p>

<blockquote>
<p>单引号<br/>
双引号<br/>
不用引号<br/>
反引号<br/>
反向引用</p>
</blockquote>
</blockquote>

<p>()可以记住正则表达式的一部分<br/>
扩展正则,需使用-r</p>

<pre><code>\1引用第一个()中的匹配内容,\2引用第二个,以此类推,最多可9个
案例: echo &quot;i am oldboy teacher.&quot;如果想保留这一行的单词oldbo
sed -r &#39;s#.*(oldboy).*#\1#g&#39;
</code></pre>

<p>企业案例</p>

<pre><code>系统开机启动项优化
</code></pre>

<h3 id="toc_9">拓展</h3>

<p>特殊符号&quot;=&quot;获取行号</p>

<pre><code>sed &quot;=&quot; person.txt
sed -n &quot;$=&quot; person.txt  #只显示文件最后一行的行号 == wc -l
</code></pre>

<p>一条sed语句执行多条命</p>

<pre><code>每个-e选项后可接一个sed指令
</code></pre>

<p>&quot;;&quot;分号的使用</p>

<pre><code>sed &#39;3,$d;s#10#01#&#39; person.txt
</code></pre>

<p>企业案例:</p>

<pre><code>一个文件100行,把5,35,70行单独拿出来
sed -n &#39;5p;35p;70p&#39;
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-04T19:51:17+08:00" itemprop="datePublished">2017/8/4</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018474773088.html" itemprop="url">
		十一、磁盘管理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>[TOC]<br/>
<strong>一、磁盘知识体系</strong></p>

<hr/>

<p><strong>二、磁盘结构</strong></p>

<ol>
<li>磁盘外部结构

<ol>
<li>组成</li>
<li>接口类型

<ol>
<li>SAS 300G/600G 15K转/分钟</li>
<li>SATA 5400/7200转/分钟 企业级1W转/分钟</li>
<li>SCSI</li>
<li>PCI-E SSD</li>
</ol></li>
</ol></li>
<li>磁盘内部原理

<ol>
<li>磁盘 硬盘(Disk)</li>
<li>磁头(Head)

<ol>
<li>盘面数量==磁头数量</li>
<li>用来写入和读取数据的</li>
</ol></li>
<li>磁道(Track)</li>
<li>扇区(Sector)

<ol>
<li>磁道上面的最小的单位</li>
<li>默认大小512字节</li>
</ol></li>
<li>柱面(Cylinder)

<ol>
<li>不同盘面上面的相同的磁道组成的圆柱体</li>
<li>不同盘面上的相同的呼啦圈组成的圆柱体</li>
<li>磁盘默认是按照柱面进行读写</li>
</ol></li>
<li>单元块(Units)
表示一个柱面的大小</li>
<li>如何计算磁盘的大小

<ol>
<li>磁盘空间:一个柱面的大小*柱面的数量</li>
<li>如何查看柱面的数量,柱面的大小</li>
<li>Linux如何进行计算</li>
</ol></li>
</ol></li>
</ol>

<hr/>

<p><strong>三、raid</strong></p>

<ol>
<li>磁盘阵列
能获得更大的容量,获得更高的性能,获得更好的安全性</li>
<li>raid卡

<ol>
<li>集成raid 0 raid 1</li>
<li>独立 0 1 5 10</li>
</ol></li>
<li>常用raid级别

<ol>
<li>raid 0

<ol>
<li>具有最高的存储性能(磁盘容量不浪费,读写很快),容量为所有磁盘的总和</li>
<li>要制作raid 0至少要有1块物理磁盘,不做raid不能安装系统</li>
</ol></li>
<li>raid 1

<ol>
<li>镜像效果,损失50%的数据容量.例如2块1T的硬盘,做完raid 1后容量为1T</li>
<li>Mirror不能提高存储性能.理论上写性能和单盘相差不大</li>
</ol></li>
<li>raid 5
至少需要3块硬盘,最多损坏1块</li>
<li>raid 10
至少需要4块硬盘,最多损坏2块</li>
</ol></li>
</ol>

<hr/>

<p><strong>四、磁盘分区</strong></p>

<ol>
<li>磁盘分区表位置</li>
</ol>

<blockquote>
<p>1磁头0磁道01扇区<br/>
前446字节mbr主引导记录<br/>
14字节的分区表<br/>
15AA表示的是结束标记</p>
</blockquote>

<ol>
<li>磁盘-盘片-mbr</li>
<li>主分区</li>
<li>扩展分区</li>
<li>逻辑分区</li>
<li>硬盘分区的设备名</li>
</ol>

<hr/>

<p><strong>五、磁盘格式化</strong>  </p>

<blockquote>
<p>磁盘分区实战</p>
</blockquote>

<ol>
<li>fdisk

<ol>
<li>创建一个100M的分区,把他挂载到/mnt上面

<ol>
<li>添加一个分区,给给所有容量</li>
<li>通知系统/dev/sdb的分区表更改了</li>
<li>装修-格式化(创建文件系统)</li>
<li>调整-挂载次数-检查间隔</li>
<li>挂载并检查结果</li>
<li>开机自动挂载</li>
</ol></li>
<li>磁盘大小小于2TB mbr</li>
</ol></li>
<li>parted

<ol>
<li>主要用于给磁盘大于2TB的磁盘进行分区</li>
<li>基于GPT分区表,支持更大的硬盘,支持更多的主分区</li>
<li>??企业案例:Java环境内存不够用</li>
</ol></li>
</ol>

<hr/>

<p><strong>六、文件系统</strong>  </p>

<ol>
<li>含义:决定系统怎么存放数据<br/></li>
<li>分类及区别<br/></li>
<li>centos 5.x ext3<br/></li>
<li>centos 6.x ext4<br/></li>
<li>centos 7.x xfs<br/></li>
<li>文件系统详细知识-superblock<br/>
inode block使用量剩余量</li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-04T17:45:39+08:00" itemprop="datePublished">2017/8/4</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018399397622.html" itemprop="url">
		十、用户管理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">用户分类</a>
<ul>
<li>
<a href="#toc_1">用户相关的配置文件</a>
<ul>
<li>
<a href="#toc_2">/etc/passwd(用户信息)</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_3">/etc/shadow(用户密码信息)</a>
<ul>
<li>
<a href="#toc_4">/etc/group(用户组信息)</a>
</li>
<li>
<a href="#toc_5">/etc/gshadow(用户组密码信息)</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">与用户相关的目录和文件</a>
<ul>
<li>
<a href="#toc_7">/etc/skel</a>
</li>
<li>
<a href="#toc_8">.*极度危险</a>
</li>
</ul>
</li>
<li>
<a href="#toc_9">用户管理的命令</a>
<ul>
<li>
<a href="#toc_10">用户相关命令</a>
<ul>
<li>
<a href="#toc_11">useradd</a>
</li>
</ul>
</li>
<li>
<a href="#toc_12">userdel</a>
<ul>
<li>
<a href="#toc_13">usermod</a>
</li>
<li>
<a href="#toc_14">passwd</a>
</li>
<li>
<a href="#toc_15">企业场景:用户及密码管理</a>
</li>
</ul>
</li>
<li>
<a href="#toc_16">用户组相关</a>
<ul>
<li>
<a href="#toc_17">groupadd</a>
</li>
</ul>
</li>
<li>
<a href="#toc_18">用户查询命令</a>
<ul>
<li>
<a href="#toc_19">id</a>
</li>
<li>
<a href="#toc_20">w</a>
</li>
<li>
<a href="#toc_21">last</a>
</li>
<li>
<a href="#toc_22">lastlog</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_23">sudo临时让用户获得root权限</a>
<ul>
<li>
<a href="#toc_24">是什么?</a>
</li>
<li>
<a href="#toc_25">怎么用</a>
</li>
</ul>
</li>
<li>
<a href="#toc_26">记录用户的操作 作为/日志审计</a>
</li>
</ul>


<h1 id="toc_0">用户分类</h1>

<blockquote>
<p>root  UID:0   皇帝<br/>
虚拟用户  UID:1-499   傀儡</p>

<blockquote>
<p>每个程序、服务运行的时候都需要一个用户<br/>
傀儡用户不需要用来登录系统<br/>
普通用户  UID:500+</p>
</blockquote>
</blockquote>

<h2 id="toc_1">用户相关的配置文件</h2>

<h3 id="toc_2">/etc/passwd(用户信息)</h3>

<pre><code>[root@worksation-lianxi ~]# head -1 /etc/passwd
/etc/passwd
root:x:0:0:root:/root:/bin/bash
</code></pre>

<table>
<thead>
<tr>
<th style="text-align: center">root</th>
<th style="text-align: center">x</th>
<th style="text-align: center">0</th>
<th style="text-align: center">0</th>
<th style="text-align: center">root</th>
<th style="text-align: center">/root</th>
<th style="text-align: center">/bin/bash</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: center">用户</td>
<td style="text-align: center">密码</td>
<td style="text-align: center">UID</td>
<td style="text-align: center">GID</td>
<td style="text-align: center">说明</td>
<td style="text-align: center">家目录</td>
<td style="text-align: center">命令解释器</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th style="text-align: left">字段名称</th>
<th style="text-align: left">注释说明</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">账号名称</td>
<td style="text-align: left">和用户UID对应,这是用户登录时使用的账号名称,在系统中时唯一的,不能重名.</td>
</tr>
<tr>
<td style="text-align: left">账号密码</td>
<td style="text-align: left">早起的Linux系统中,盖子段是存放账号密码的,由于安全原因后来把这个密码字段内容移到/etc/shadow 中了,这里可以看到一个字母X,表示该用户的密码实在/etc/shadow文件中保护着</td>
</tr>
<tr>
<td style="text-align: left">账号UID</td>
<td style="text-align: left">账号UID一般是有一个数字表示的,范围是0-65535 有关UID的限制请看本表格下面的表格</td>
</tr>
<tr>
<td style="text-align: left">账号GID</td>
<td style="text-align: left">账号GID一般也是有一个数字表示的,范围也是0-65535,添加账户是,默认情况下会同时建立一个与用户组同名且UID和GID相同的组</td>
</tr>
<tr>
<td style="text-align: left">用户说明</td>
<td style="text-align: left">这个字段是对账号的描述说明</td>
</tr>
<tr>
<td style="text-align: left">用户家目录</td>
<td style="text-align: left">用户登录后首先进入的目录,一般为&quot;/home/用户名&quot;这样的目录</td>
</tr>
<tr>
<td style="text-align: left">shell</td>
<td style="text-align: left">当前用户登录后所使用的shell,在centos/rhel等Linux系统中,默认的shell为bash,就是在这里设置的,如果通过usermod或者手工修改passwd配置,将改字段改为/sbin/nologin 即可,如果你仔细看PASSWD文件,会发现大部分内置系统的虚拟找好这个字段都是/dbin/nologin,表示禁止登录,这是出于安全的考虑</td>
</tr>
</tbody>
</table>

<pre><code>[root@worksation-lianxi ~]# echo $SHELL
/bin/bash
[root@worksation-lianxi ~]# cat /etc/shells 
/bin/sh
/bin/bash
/sbin/nologin
/bin/dash
/bin/tcsh
/bin/csh
</code></pre>

<h1 id="toc_3">/etc/shadow(用户密码信息)</h1>

<pre><code>passwd 为用户设置密码会更改/et/shadow
</code></pre>

<h2 id="toc_4">/etc/group(用户组信息)</h2>

<h2 id="toc_5">/etc/gshadow(用户组密码信息)</h2>

<h1 id="toc_6">与用户相关的目录和文件</h1>

<h2 id="toc_7">/etc/skel</h2>

<pre><code>新用户的家目录的模板
-bash-4.1$
    出现如上登录环境故障的原理及解决办法
    这个用户的家目录下面的环境变量文件被删除了
        ~/.bashrc  ~/.bash_profile
    切换到有故障的用户
    原因:用户环境变量有关的文件被删除
    /etc/skel/里面存放着用户家目录的模板
    /etc/skel/.bash*复制到当前用户
    重新登录
</code></pre>

<h2 id="toc_8">.*极度危险</h2>

<pre><code>以点开头的文件或目录
    .(当前目录)
    ..(当前目录的上一级目录)
    表示以点开头的文件或目录(隐藏文件)
</code></pre>

<h1 id="toc_9">用户管理的命令</h1>

<h2 id="toc_10">用户相关命令</h2>

<h3 id="toc_11">useradd</h3>

<pre><code>-u 指定用户的UID(数字 身份证号码)
-s 指定用户使用的shell
            默认为/bin/bash
            傀儡用户为/sbin/nologin 需手动添加
-M 表示不创建家目录 一般创建傀儡用户使用
-g 指定用户属于的组(组的名字)
例:添加一个用户lidao,指定UID为888,并禁止用户登录系统,不创建家目录
useradd -u 888 -s /sbin/nologin -M lidao
</code></pre>

<h2 id="toc_12">userdel</h2>

<pre><code>删除用户       一般情况不用命令删除,直接在/etc/passwd中注释掉
userdel默认不删除用户的家目录和邮箱
-r 删除与用户有关的所有信息(家目录)
</code></pre>

<h3 id="toc_13">usermod</h3>

<pre><code>修改用户的信息,这个用户已经存在
-s 修改用户使用的shell
-g 属于的家庭
</code></pre>

<h3 id="toc_14">passwd</h3>

<pre><code>--stdin 从管道中获取用户的密码(非交互式设置密码)
</code></pre>

<h3 id="toc_15">企业场景:用户及密码管理</h3>

<pre><code>    密码要复杂12位以上字母数字特殊字符
    保存密码:
            keepass(软件,密码存放在本地,本地保险柜)
            lastpass(在线版本,银行的保险柜)
    大的企业用户和密码统一管理(相当于活动目录(AD),(openLDAP域)
    动态密码:动态口令,第三方提供自己开发也很简单
    更安全
        /var/log/secure日志的分析:failure
        锁头chattr +i +a lsattr 锁定命令或文件
        指纹(find+md4sum+定时任务)监视常用命令和文件
            md5sum -c /--check
</code></pre>

<h2 id="toc_16">用户组相关</h2>

<h3 id="toc_17">groupadd</h3>

<pre><code>创建用户组
-g 指定用户组的gid数字
</code></pre>

<h2 id="toc_18">用户查询命令</h2>

<h3 id="toc_19">id</h3>

<pre><code>查看用户的信息
    一个用户是否存在
    查询用户的UID GID
    属于哪个组
</code></pre>

<h3 id="toc_20">w</h3>

<pre><code>显示系统中已经远程登录的用户 干啥
</code></pre>

<h3 id="toc_21">last</h3>

<pre><code>那个用户 在什么时候 从哪里 远程登录你的系统 用户登录信息
</code></pre>

<h3 id="toc_22">lastlog</h3>

<pre><code>显示Linux中所有用户最近一次远程登录的信息
</code></pre>

<h1 id="toc_23">sudo临时让用户获得root权限</h1>

<h2 id="toc_24">是什么?</h2>

<blockquote>
<p>开发人员,其他人员,想临时使用,看系统日志,删除软件的日志,人事添加用户(useradd)<br/>
普通用户想临时成为root  尚方宝剑</p>
</blockquote>

<h2 id="toc_25">怎么用</h2>

<pre><code>sudo -l 查看当前用户的尚方宝剑
visudo 给用户授予尚方宝剑
crontab -e (root) ==== vi /var/spool/cron/root
    自带语法检查功能
visudo ==== vim /etc/sudoers
授权某一个命令 用全路径写出
授权多个命令      用,加空格隔开
授权某个目录下面的所有命令   用*表示
排除某个命令      在全路径命令前加!
授权所有命令      ALL
授权所有命令并且不用密码
    oldboy ALL=(ALL) NOPASSWD:ALL
oldboy是运维人员的用户 就是你在使用
自己用的时候  我不想输入密码(sudo)
</code></pre>

<h1 id="toc_26">记录用户的操作 作为/日志审计</h1>

<blockquote>
<p>齐治的堡垒机:商业产品<br/>
Python开发的开源产品<br/>
gateone web跳板机<br/>
开源跳板机(堡垒机)jumpserver<br/>
Alex写的crazyEYE<br/>
shell跳板机</p>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-04T08:45:12+08:00" itemprop="datePublished">2017/8/4</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15018075128546.html" itemprop="url">
		九、定时任务</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">闹钟与定时任务</a>
</li>
<li>
<a href="#toc_1">定时任务分类</a>
</li>
</ul>
</li>
<li>
<a href="#toc_5">crond分类</a>
<ul>
<li>
<a href="#toc_6">系统定时任务</a>
</li>
<li>
<a href="#toc_7">用户定时任务</a>
</li>
</ul>
</li>
<li>
<a href="#toc_8">定时任务使用</a>
<ul>
<li>
<a href="#toc_9">定时任务以来的软件(服务)-是否能用</a>
</li>
<li>
<a href="#toc_10">crontab怎么使用</a>
<ul>
<li>
<a href="#toc_11">crontab命令使用</a>
</li>
<li>
<a href="#toc_12">为何使用crontab命令</a>
</li>
</ul>
</li>
<li>
<a href="#toc_13">定时任务相关的文件</a>
<ul>
<li>
<a href="#toc_14">哪些用户禁止使用定时任务</a>
</li>
<li>
<a href="#toc_15">定时任务中常用符号</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_16">定时任务书写流程</a>
</li>
<li>
<a href="#toc_17">总结</a>
<ul>
<li>
<a href="#toc_18">定时任务规则之前加注释</a>
</li>
<li>
<a href="#toc_19">定时任务脚本中的程序命令及路径尽量用绝对路径</a>
</li>
<li>
<a href="#toc_20">使用脚本替代命令行定时任务</a>
</li>
<li>
<a href="#toc_21">运行脚本一定要用/bin/sh 或sh</a>
</li>
<li>
<a href="#toc_22">定时任务中-命令或脚本结果(正确及错误)定向到空(/dev/null)或追加到文件中</a>
</li>
<li>
<a href="#toc_23">避免不必要的程序及命令输出</a>
</li>
<li>
<a href="#toc_24">打包压缩使用相对路径(切到目标目录的上一级打包目标)</a>
</li>
<li>
<a href="#toc_25">定时任务中date命令的%添加转义</a>
</li>
<li>
<a href="#toc_26">系统与命令位置有关的环境变量问题</a>
</li>
</ul>
</li>
<li>
<a href="#toc_27">开机自启动</a>
<ul>
<li>
<a href="#toc_28">chkconfig</a>
</li>
</ul>
</li>
<li>
<a href="#toc_29">精简开机自启动服务-命令拼接</a>
<ul>
<li>
<a href="#toc_30">开机需要启动的项目</a>
</li>
<li>
<a href="#toc_31">我们要的结果</a>
</li>
<li>
<a href="#toc_32">第一里程碑</a>
</li>
</ul>
</li>
</ul>


<h1 id="toc_0">闹钟与定时任务</h1>

<blockquote>
<p>Crond是Linux系统中用拉力定期执行命令/脚本或指定程序任务的一种服务或软件.一般情况下,我们安装完了Centos5/6操作系统之后,默认便会启动Crond任务调度服务,在我们前面的系统安装及开机启动优化的设置中,我们也保留了Crond开机自启动.Crond服务会定期(默认每分钟检查一次)检查系统中是否有要执行的任务工作,如果有,便会根据其预先设定的定时任务规则自动执行该定时任务工作,这个Crond定时任务服务就相当于我们平时早起使用闹钟一样定时任务分类.</p>

<blockquote>
<p>特殊需求:Crond服务搞不定了,一般在工作鞋shell脚本守护进程执行<br/>
程序(文件)放在磁盘里的,程序代码组成,但是没有在计算机内执行,当前没有执行<br/>
进程所谓进程就是在计算机中正在执行的程序,运行起来的程序<br/>
守护进程(守护进程):守护进程就是一直运行的程序.<br/>
sshd服务</p>
</blockquote>
</blockquote>

<h1 id="toc_1">定时任务分类</h1>

<blockquote>
<h2 id="toc_2">atd(运行一次)</h2>

<blockquote>
<p>at:适合仅执行一次就就结束的调度任务命令,列如某天晚上需要处理一个任务,仅仅是这一天的晚上,输入突发性的工作任务,执行at命令,还需要启动一个名为atd的服务才行</p>
</blockquote>

<h2 id="toc_3">crond(crontab)</h2>

<blockquote>
<p>crontab(命令):正如前面所说的这个命令可以周期性的执行工作,例如:每五分钟做一次服务器时间同步.要执行crontab这个命令,也需要启动一个服务Crond才行,这个crontab工作中常用.</p>
</blockquote>

<h2 id="toc_4">anacron(非7*24小时运行的服务器)</h2>

<blockquote>
<p>anacron:这个命令主要用于非7*24小时开机的服务器准备的,anacron并不能指定具体时间执行任务工作,而是以天威周期或者在系统每次开机后执行的任务工作.<br/>
    他会检测服务器停机期间应该执行,但是并没有进行的任务工作,并将该任务执行一遍.</p>
</blockquote>
</blockquote>

<h1 id="toc_5">crond分类</h1>

<h2 id="toc_6">系统定时任务</h2>

<pre><code>/etc/cron.hourly
/etc/cron.daily
/etc/cron.weekly
/etc/cron.monthly
/etc/cron.day
/etc/crontab    系统定时任务的配置文件之一
系统定时任务+logrotate命令  完成对日志的日志切割/日志轮循
    /var/log/cron
    /var/log/messages
    /var/log/secure
</code></pre>

<h2 id="toc_7">用户定时任务</h2>

<pre><code>crontab –l (list) 列表查看用户的定制任务
crontab –e (edit) 编辑用户的定时任务
/var/spool/cron/root (root是用户名 root用户的定时任务)
</code></pre>

<h1 id="toc_8">定时任务使用</h1>

<h2 id="toc_9">定时任务以来的软件(服务)-是否能用</h2>

<pre><code>查看当前是否正在运行
/etc/init.d/crond status
ps –ef |grep crond
查看crond是否开机自启动
chkconfig |grep crond
</code></pre>

<h2 id="toc_10">crontab怎么使用</h2>

<h3 id="toc_11">crontab命令使用</h3>

<pre><code>–e edit 编辑当前用户的定时任务
vi /var/spool/cron/root
–l list显示当前用户的定时任务
cat /var/spool/cron/root
–r 删除用户的定时任务
–i 删除之前提醒
</code></pre>

<h3 id="toc_12">为何使用crontab命令</h3>

<pre><code>有语法检查功能
方便
</code></pre>

<h2 id="toc_13">定时任务相关的文件</h2>

<h3 id="toc_14">哪些用户禁止使用定时任务</h3>

<pre><code>/etc/cron.deny
    ### 定时任务的额配置文件所在的目录
/var/spool/cron/
    ### 定时任务的日志文件
/var/log/cron
    ## 定时任务基本格式(分时日月周)
### 核心:
什么时间做什么,然后再想下一次什么时候执行什么时间,做什么事情
</code></pre>

<h3 id="toc_15">定时任务中常用符号</h3>

<pre><code>*   每
/n  */10 * * * *    每隔/每隔十分钟
-   从哪里来到哪里去    07-08
,   分隔      00 17,19,20 * * *
</code></pre>

<h1 id="toc_16">定时任务书写流程</h1>

<pre><code>命令行测试-把你的名字显示到文件中
把命令放入到脚本中
测试下脚本是否可用
写定时任务
检查结果
</code></pre>

<h1 id="toc_17">总结</h1>

<h2 id="toc_18">定时任务规则之前加注释</h2>

<h2 id="toc_19">定时任务脚本中的程序命令及路径尽量用绝对路径</h2>

<pre><code>* * * * * echo oldboy &gt;&gt;oldboy.log
#存放在了用户的家目录下
</code></pre>

<h2 id="toc_20">使用脚本替代命令行定时任务</h2>

<h2 id="toc_21">运行脚本一定要用/bin/sh 或sh</h2>

<pre><code>f 644 rw-r--r-- oldboy.sh
/bin/sh /server/scripts/oldboy.sh
</code></pre>

<h2 id="toc_22">定时任务中-命令或脚本结果(正确及错误)定向到空(/dev/null)或追加到文件中</h2>

<pre><code># 企业案例
如果定时任务规则结尾不加&gt;/dev/null 2&gt;&amp;1或者追加到文件中&gt;&gt;/tmp/oldboy 2&gt;&amp;1,很容易导致硬盘inode空间被沾满,从而系统服务不正常.
定时任务中,命令或脚本的结果没有定向到空或文件中
邮件的软件没有开启------大量小文件堆积在/var/spool/postfix/maildrop/------inode满了
邮件软件开启了------定时任务会不断的给root用户发邮件
you have new mail in /var/spool/mail/root
</code></pre>

<h2 id="toc_23">避免不必要的程序及命令输出</h2>

<pre><code>如:tar zcf
</code></pre>

<h2 id="toc_24">打包压缩使用相对路径(切到目标目录的上一级打包目标)</h2>

<pre><code>cd到被打爆目录的上一级目录
</code></pre>

<h2 id="toc_25">定时任务中date命令的%添加\转义</h2>

<h2 id="toc_26">系统与命令位置有关的环境变量问题</h2>

<blockquote>
<p>Java环境变量问题</p>

<blockquote>
<p>遇到Java的内容,都是用绝对路径<br/>
在脚本开头重新定义环境变量<br/>
/sbin/ifconfig使用命令的绝对路径<br/>
定时任务的脚本中认识的命令的位置只有PATH=/usr/bin:/bin</p>
</blockquote>
</blockquote>

<h1 id="toc_27">开机自启动</h1>

<pre><code> /etc/rc.local
把你需要开机的时候启动的命令或脚本放入到这个文件中即可.
</code></pre>

<h2 id="toc_28">chkconfig</h2>

<pre><code>通过chkconfig命令管理你要启动的脚本/服务
# 你这个脚本必须放在/etc/init.d/目录下面
要给脚本x权限
chkconfig管理脚本 让他开机自启动
chkconfig:2345 20 80
description:说明
添加到chkconfig管理
chkconfig --add oldboyd
检查结果
chkconfig |grep oldboyd
</code></pre>

<h1 id="toc_29">精简开机自启动服务-命令拼接</h1>

<h2 id="toc_30">开机需要启动的项目</h2>

<pre><code>network sshd rsyslog Crond sysstat
</code></pre>

<h2 id="toc_31">我们要的结果</h2>

<pre><code>chkconfig 服务名称 off
[root@worksation-lianxi ~]# chkconfig |grep 3:on
chkconfig abrt-ccpp         off
chkconfig abrtd             off
chkconfig acpid             off
chkconfig atd               off
chkconfig auditd            off
chkconfig blk-availability  off
chkconfig cpuspeed          off
chkconfig crond             off
chkconfig haldaemon         off
chkconfig ip6tables         off
chkconfig iptables          off
chkconfig irqbalance        off
chkconfig kdump             off
chkconfig lvm2-monitor      off
chkconfig mdmonitor         off
chkconfig messagebus        off
chkconfig netfs             off
chkconfig network           off
chkconfig postfix           off
chkconfig rdma              off
chkconfig rsyslog           off
chkconfig sshd              off
chkconfig sysstat           off
chkconfig udev-post         off 
</code></pre>

<h2 id="toc_32">第一里程碑</h2>

<blockquote>
<p>把你想保留的排除掉`其他的都关闭<br/>
把你想要的服务,通过排除的方法保留下来,不处理.</p>
</blockquote>

<pre><code> [root@worksation-lianxi ~]# chkconfig |egrep &quot;sshd|network|rsyslog|crond|sysstat&quot;
crond           0:off   1:off   2:on    3:on    4:on    5:on    6:off
network         0:off   1:off   2:on    3:on    4:on    5:on    6:off
rsyslog         0:off   1:off   2:on    3:on    4:on    5:on    6:off
sshd            0:off   1:off   2:on    3:on    4:on    5:on    6:off
sysstat         0:off   1:on    2:on    3:on    4:on    5:on    6:off
</code></pre>

<blockquote>
<p>排除</p>
</blockquote>

<pre><code>[root@worksation-lianxi ~]# chkconfig |egrep -v &quot;network|sshd|rsyslog|crond|sysstst&quot;
abrt-ccpp       0:off   1:off   2:off   3:on    4:off   5:on    6:off
abrtd           0:off   1:off   2:off   3:on    4:off   5:on    6:off
acpid           0:off   1:off   2:on    3:on    4:on    5:on    6:off
atd             0:off   1:off   2:off   3:on    4:on    5:on    6:off
auditd          0:off   1:off   2:on    3:on    4:on    5:on    6:off
blk-availability    0:off   1:on    2:on    3:on    4:on    5:on    6:off
cpuspeed        0:off   1:on    2:on    3:on    4:on    5:on    6:off
haldaemon       0:off   1:off   2:off   3:on    4:on    5:on    6:off
ip6tables       0:off   1:off   2:on    3:on    4:on    5:on    6:off
iptables        0:off   1:off   2:off   3:on    4:off   5:off   6:off
irqbalance      0:off   1:off   2:off   3:on    4:on    5:on    6:off
kdump           0:off   1:off   2:off   3:on    4:on    5:on    6:off
lvm2-monitor    0:off   1:on    2:on    3:on    4:on    5:on    6:off
mdmonitor       0:off   1:off   2:on    3:on    4:on    5:on    6:off
messagebus      0:off   1:off   2:on    3:on    4:on    5:on    6:off
netconsole      0:off   1:off   2:off   3:off   4:off   5:off   6:off
netfs           0:off   1:off   2:off   3:on    4:on    5:on    6:off
nfs-rdma        0:off   1:off   2:off   3:off   4:off   5:off   6:off
ntpd            0:off   1:off   2:off   3:off   4:off   5:off   6:off
ntpdate         0:off   1:off   2:off   3:off   4:off   5:off   6:off
postfix         0:off   1:off   2:on    3:on    4:on    5:on    6:off
psacct          0:off   1:off   2:off   3:off   4:off   5:off   6:off
quota_nld       0:off   1:off   2:off   3:off   4:off   5:off   6:off
rdisc           0:off   1:off   2:off   3:off   4:off   5:off   6:off
rdma            0:off   1:on    2:on    3:on    4:on    5:on    6:off
restorecond     0:off   1:off   2:off   3:off   4:off   5:off   6:off
rngd            0:off   1:off   2:off   3:off   4:off   5:off   6:off
saslauthd       0:off   1:off   2:off   3:off   4:off   5:off   6:off
smartd          0:off   1:off   2:off   3:off   4:off   5:off   6:off
svnserve        0:off   1:off   2:off   3:off   4:off   5:off   6:off
sysstat         0:off   1:on    2:on    3:on    4:on    5:on    6:off
udev-post       0:off   1:on    2:on    3:on    4:on    5:on    6:off
</code></pre>

<blockquote>
<p>第二个里程碑把权健的名字取出来</p>
</blockquote>

<pre><code>[root@worksation-lianxi ~]# chkconfig |egrep -v &quot;crond|network|rsyslog|sshd|sysstat&quot;|awk &#39;{print $1}&#39;
abrt-ccpp
abrtd
acpid
atd
auditd
blk-availability
cpuspeed
haldaemon
ip6tables
iptables
irqbalance
kdump
lvm2-monitor
mdmonitor
messagebus
netconsole
netfs
nfs-rdma
ntpd
ntpdate
postfix
psacct
quota_nld
rdisc
rdma
restorecond
rngd
saslauthd
smartd
svnserve
udev-post
</code></pre>

<blockquote>
<p>第三;;里程碑 如何弄出 chkconfig iiptables off</p>
</blockquote>

<pre><code>[root@worksation-lianxi ~]# echo ipt |awk &#39;{print &quot;chkconfig &quot;$1&quot; off&quot;}&#39;
chkconfig ipt off
[root@worksation-lianxi ~]# #拼接处你想要的结果  拼接处你想要的目标
</code></pre>

<blockquote>
<p>第四个里程碑-给找出来的服务都加上  chkconfig xxxx  off</p>
</blockquote>

<pre><code>[root@worksation-lianxi ~]# chkconfig |egrep -v &quot;crond|network|rsyslog|sshd|sysstat&quot;|awk &#39;{print &quot;chkconfig &quot;$1&quot; off&quot;}&#39;
chkconfig abrt-ccpp off
chkconfig abrtd off
chkconfig acpid off
chkconfig atd off
chkconfig auditd off
chkconfig blk-availability off
chkconfig cpuspeed off
chkconfig haldaemon off
chkconfig ip6tables off
chkconfig iptables off
chkconfig irqbalance off
chkconfig kdump off
chkconfig lvm2-monitor off
chkconfig mdmonitor off
chkconfig messagebus off
chkconfig netconsole off
chkconfig netfs off
chkconfig nfs-rdma off
chkconfig ntpd off
chkconfig ntpdate off
chkconfig postfix off
chkconfig psacct off
chkconfig quota_nld off
chkconfig rdisc off
chkconfig rdma off
chkconfig restorecond off
chkconfig rngd off
chkconfig saslauthd off
chkconfig smartd off
chkconfig svnserve off
chkconfig udev-post off
</code></pre>

<blockquote>
<p>第五个里程碑 :预备知识</p>
</blockquote>

<pre><code>PATH
执行…..bash
Linux 命令解释器   bash
  命令   软件
</code></pre>

<blockquote>
<p>第六个里程碑 执行--交给bash 执行</p>
</blockquote>

<pre><code>[root@worksation-lianxi ~]# chkconfig |egrep -v &quot;crond|network|rsyslog|sshd|sysstat&quot;|awk &#39;{print &quot;chkconfig &quot;$1&quot; off&quot;}&#39;|bash     交给bash执行
[root@worksation-lianxi ~]# chkconfig |grep 3:on   查看一下
crond           0:off   1:off   2:on    3:on    4:on    5:on    6:off
network         0:off   1:off   2:on    3:on    4:on    5:on    6:off
rsyslog         0:off   1:off   2:on    3:on    4:on    5:on    6:off
sshd            0:off   1:off   2:on    3:on    4:on    5:on    6:off
sysstat         0:off   1:on    2:on    3:on    4:on    5:on    6:off
命令的拼接小结
命令拼接(awk/sed)=====&gt;批量====&gt;循环
常用服务,必须开机启动的服务  Crond sshd network rsyslog sysstat
创造形式(命令) 最后交给bash执行解释
Echo Chkconfig iptables  off
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-03T20:17:28+08:00" itemprop="datePublished">2017/8/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15017626488369.html" itemprop="url">
		七、文件属性</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">1. 零、如何加强学习效果</a>
<ul>
<li>
<a href="#toc_1">1. 加入各种QQ群，解答问题——效率不高</a>
</li>
<li>
<a href="#toc_2">2. 分享——讲解</a>
</li>
</ul>
</li>
<li>
<a href="#toc_3">2. 文件属性 ls -lhi 简介</a>
</li>
</ul>
</li>
<li>
<a href="#toc_4">3.    inode和block</a>
<ul>
<li>
<a href="#toc_5">显示oldboyfile文件的内容的过程</a>
</li>
<li>
<a href="#toc_6">查看文件atime,mtime,ctime</a>
</li>
<li>
<a href="#toc_7">查看系统inode使用量</a>
</li>
<li>
<a href="#toc_8">查看系统磁盘使用量</a>
</li>
<li>
<a href="#toc_9">查看block数量与大小</a>
</li>
<li>
<a href="#toc_10">企业案例</a>
</li>
</ul>
</li>
<li>
<a href="#toc_11">文件类型</a>
<ul>
<li>
<a href="#toc_12">普通文件</a>
<ul>
<li>
<a href="#toc_13">文本文件</a>
</li>
<li>
<a href="#toc_14">命令</a>
</li>
<li>
<a href="#toc_15">数据文件</a>
</li>
</ul>
</li>
<li>
<a href="#toc_16">目录</a>
</li>
</ul>
</li>
<li>
<a href="#toc_17">软硬连接</a>
<ul>
<li>
<a href="#toc_18">软连接和硬链接的区别</a>
<ul>
<li>
<a href="#toc_19">硬链接</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_20">文件删除原理</a>
<ul>
<li>
<a href="#toc_21">文件被彻底删除的条件:</a>
<ul>
<li>
<a href="#toc_22">硬链接为0</a>
</li>
<li>
<a href="#toc_23">进程调用数为0</a>
</li>
</ul>
</li>
<li>
<a href="#toc_24">磁盘空间不足</a>
<ul>
<li>
<a href="#toc_25">看看那个分区满了</a>
</li>
<li>
<a href="#toc_26">详细的检查到底谁占得空间大</a>
</li>
<li>
<a href="#toc_27">硬链接数量为0,进程调用数不为0</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_28">用户和用户组</a>
<ul>
<li>
<a href="#toc_29">Linux系统中用户的分类</a>
<ul>
<li>
<a href="#toc_30">root用户</a>
</li>
<li>
<a href="#toc_31">虚拟用户</a>
</li>
<li>
<a href="#toc_32">普通用户</a>
</li>
</ul>
</li>
<li>
<a href="#toc_33">UID和GID</a>
</li>
<li>
<a href="#toc_34">用户和用户组</a>
</li>
<li>
<a href="#toc_35">与用户有关的文件</a>
<ul>
<li>
<a href="#toc_36">/etc/passwd</a>
</li>
<li>
<a href="#toc_37">/etc/shadow</a>
</li>
<li>
<a href="#toc_38">其他</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_39">Linux中的三种时间</a>
<ul>
<li>
<a href="#toc_40">mtime</a>
</li>
<li>
<a href="#toc_41">ctime</a>
</li>
<li>
<a href="#toc_42">atime</a>
</li>
</ul>


<h2 id="toc_0">1. 零、如何加强学习效果</h2>

<h3 id="toc_1">1. 加入各种QQ群，解答问题——效率不高</h3>

<h3 id="toc_2">2. 分享——讲解</h3>

<blockquote>
<p>在QQ群里面分享知识（QQ群视频 YY）<br/>
坚持——讲解的视频录制下来（优酷、土豆、百度云）不需要你认识多少人，关键是多少人认识你<br/>
只是容易忘记，记不住——分享讲解，练习题考试题（每日一题）<br/>
核心：</p>

<blockquote>
<p>1、分享讲解<br/>
2、复习，讲题<br/>
3、没有基础——说出来<br/>
4、有基础——说明白</p>
</blockquote>
</blockquote>

<h2 id="toc_3">2. 文件属性 ls -lhi 简介</h2>

<pre><code class="language-bash">[root@oldboyedu38-nb ~]# ls -lhi /etc/hosts 
390174 -rw-r--r--. 2 root root 185 Jun 17 10:31 /etc/hosts
390174
-
rw-r--r--.
2
root
root
185
Jun 17 10:3
/etc/hosts
inode号码
类型
权限
硬链接数
属主,所有者
属组
文件大小
文件修改时间
名字,不是属性
</code></pre>

<h1 id="toc_4">3.    inode和block</h1>

<h2 id="toc_5">显示oldboyfile文件的内容的过程</h2>

<pre><code class="language-bash">文件名——inode号码
inode号码找到inode空间
inode空间里面存放着文件属性——block的位置
找到block的内容——文件内容
查看文件和目录inode号码
[root@oldboyedu38-nb ~]# ls -li 
total 68
   49 -rw-r--r--  1 root root     7 Jun 17 12:43 alex.txt
 9585 -rw-------. 1 root root  1073 Jun  9 16:56 anaconda-ks.cfg
 6862 drwxr-xr-x. 2 root root  4096 Jun 10 04:16 data
   13 -rw-r--r--. 1 root root 21736 Jun  9 16:56 install.log
   14 -rw-r--r--. 1 root root  5890 Jun  9 16:54 install.log.syslog
   55 -rw-r--r--  1 root root    25 May 20 00:52 nginx.conf
   53 -rw-r--r--  1 root root    21 Jun 17 10:51 num.txt
11120 -rw-r--r--  1 root root    29 Jun 17 08:43 oldboy.txt
   98 -rw-r--r--  1 root root     6 Jun 10 19:36 oldboy.txt-new
  124 -rw-r--r--. 1 root root     7 Jun 10 19:35 oldboy.txt-new.bak
</code></pre>

<h2 id="toc_6">查看文件atime,mtime,ctime</h2>

<pre><code class="language-bash">[root@oldboyedu38-nb ~]# stat alex.txt 
  File: &#39;alex.txt&#39;
  Size: 7                 Blocks: 8          IO Block: 4096   regular file
Device: 803h/2051d        Inode: 49          Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2017-06-17 12:43:29.945255238 +0800
Modify: 2017-06-17 12:43:29.945255238 +0800
Change: 2017-06-17 12:43:29.945255238 +0800
</code></pre>

<h2 id="toc_7">查看系统inode使用量</h2>

<pre><code class="language-bash">[root@oldboyedu38-nb ~]# df -i
Filesystem     Inodes IUsed  IFree IUse% Mounted on
/dev/sda3      593344 56969 536375   10% /
tmpfs          238282     1 238281    1% /dev/shm
/dev/sda1       51200    39  51161    1% /boot
Filesystem
Inodes
IUsed
IFree
IUse%
Mounted on
/dev/sda3
593344
56969
536375
10%
/
tmpfs
238282
1
238281
1%
/dev/shm
/dev/sda1
51200
39
51161
1%
/boot
</code></pre>

<h2 id="toc_8">查看系统磁盘使用量</h2>

<pre><code class="language-bash">[root@oldboyedu38-nb ~]# df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda3       8.8G  1.5G  6.9G  18% /
tmpfs           931M     0  931M   0% /dev/shm
/dev/sda1       190M   40M  141M  22% /boot
[root@oldboyedu38-nb ~]# ls -lh /etc/hosts 
-rw-r--r--. 2 root root 185 Jun 17 10:31 /etc/hosts
Filesystem
Size
Used
Free
Use%
Mounted on
/dev/sda3
8.8G
1.5G
6.9G
18%
/
tmpfs
931M
0
931M
0%
/dev/shm
/dev/sda1
190M
40M
141M
22%
/boot
</code></pre>

<h2 id="toc_9">查看block数量与大小</h2>

<pre><code class="language-bash">[root@oldboyedu38-nb ~]# dumpe2fs /dev/sda3 |grep -i &quot;block count&quot;
dumpe2fs 1.41.12 (17-May-2010)
Block count:              2373376
Reserved block count:     118668
[root@oldboyedu38-nb ~]# dumpe2fs /dev/sda3 |grep -i &quot;block size&quot;
dumpe2fs 1.41.12 (17-May-2010)
Block size:               4096
</code></pre>

<h2 id="toc_10">企业案例</h2>

<pre><code class="language-bash">【企业案例】磁盘空间满了，no space left on device（磁盘空间不足）
环境模式
mkdir -p /app/logs  
dd if=/dev/zero of=/dev/sdc bs=8K  count=10
ls -l /dev/sdc
mkfs.ext4 /dev/sdc  ##这条命令一定要单独的复制粘贴 不要和上面的一起 
</code></pre>

<h1 id="toc_11">文件类型</h1>

<h2 id="toc_12">普通文件</h2>

<h3 id="toc_13">文本文件</h3>

<pre><code>可以直接编辑、修改文件的内容
</code></pre>

<h3 id="toc_14">命令</h3>

<pre><code>二进制文件，可执行文件
</code></pre>

<h3 id="toc_15">数据文件</h3>

<pre><code>需要指定的命令才能查看
</code></pre>

<h2 id="toc_16">目录</h2>

<h1 id="toc_17">软硬连接</h1>

<h2 id="toc_18">软连接和硬链接的区别</h2>

<h3 id="toc_19">硬链接</h3>

<pre><code>含义:
在同一个分区（文件系统）,文件的inode号码相同，互为硬链接
创建方法：
ln 
特点:
一个文件被彻底删除的条件：这个文件的硬链接数为0，rm 
硬链接相当于是文件的另外一个入口（超市的前后门）
### 软连接
含义：
快捷方式，软连接里面存放的是源文件的位置
如何创建:
ln -s
特点：
省事.比如软件版本更新,更新后只需更换软连接,就可更换软件整体配置路径
</code></pre>

<h1 id="toc_20">文件删除原理</h1>

<h2 id="toc_21">文件被彻底删除的条件:</h2>

<h3 id="toc_22">硬链接为0</h3>

<pre><code>硬链接数如何为0===&gt; rm 命令
</code></pre>

<h3 id="toc_23">进程调用数为0</h3>

<pre><code>进程调用数（多少人用）===&gt;找到对应的软件（谁在用） 重启对应的服务
</code></pre>

<p>lsof</p>

<h2 id="toc_24">磁盘空间不足</h2>

<h3 id="toc_25">看看那个分区满了</h3>

<p>df -h</p>

<h3 id="toc_26">详细的检查到底谁占得空间大</h3>

<p>du -sh</p>

<h3 id="toc_27">硬链接数量为0,进程调用数不为0</h3>

<pre><code>查找硬链接数量为0,进程调用数不为0的文件
</code></pre>

<p>lsof |grep deleted<br/>
    重启对应的软件/服务<br/>
/etc/init.d/rsyslog restart</p>

<h1 id="toc_28">用户和用户组</h1>

<h2 id="toc_29">Linux系统中用户的分类</h2>

<h3 id="toc_30">root用户</h3>

<pre><code>老大,皇帝
UID 为0
</code></pre>

<h3 id="toc_31">虚拟用户</h3>

<pre><code>傀儡
UID 为1-499
Linux里面每个进程、软件巡行的时候需要有一个用户和用户组
</code></pre>

<h3 id="toc_32">普通用户</h3>

<pre><code>贫民老百姓
UID 为500以上
</code></pre>

<h2 id="toc_33">UID和GID</h2>

<h2 id="toc_34">用户和用户组</h2>

<h2 id="toc_35">与用户有关的文件</h2>

<h3 id="toc_36">/etc/passwd</h3>

<pre><code>存放的是用户的信息
</code></pre>

<h3 id="toc_37">/etc/shadow</h3>

<pre><code>存放用户密码信息
</code></pre>

<h3 id="toc_38">其他</h3>

<pre><code>/etc/group  
/etc/gshadow
</code></pre>

<h1 id="toc_39">Linux中的三种时间</h1>

<h2 id="toc_40">mtime</h2>

<pre><code>【修改时间】文件/目录的修改时间，文件内容修改。
modify time
</code></pre>

<h2 id="toc_41">ctime</h2>

<pre><code>【属性改变时间】文件/目录的属性的修改时间，大小，硬链接数，权限，所有者，所属于的组，类型。
change time
</code></pre>

<h2 id="toc_42">atime</h2>

<pre><code>【访问时间】文件/目录的访问时间，cat 查看。
access time
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-03T19:56:51+08:00" itemprop="datePublished">2017/8/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15017614116406.html" itemprop="url">
		五、Linux基础优化</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">1. 基础环境</a>
</li>
<li>
<a href="#toc_1">2. 添加普通用户账号</a>
</li>
<li>
<a href="#toc_2">3. 关闭SElinux功能</a>
<ul>
<li>
<a href="#toc_3">3.1. 修改配置文件，使关闭SElinux永久生效</a>
</li>
<li>
<a href="#toc_4">3.2. 关闭iptables防火墙</a>
<ul>
<li>
<a href="#toc_6">4. Linux中文显示设置（如何防止显示中文乱码）</a>
<ul>
<li>
<a href="#toc_7">4.1. 临时更改字符集</a>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">1. 基础环境</h2>

<pre><code>你的系统是什么版本的？
</code></pre>

<p>查询系统版本<br/>
查询系统内核版本</p>

<h2 id="toc_1">2. 添加普通用户账号</h2>

<pre><code>Linux/Unix是一个多用户、多任务的操作系统
超级管理员（root）：root默认在Unix/Linux操作系统中拥有最高的管理权限。比喻：皇帝
普通用户：管理员或者具备管理权限的用户创建的。权限：系统管理尽可以读、看，不能增、删、改。
权限越大，责任越大。

可使用如下命令添加一个普通用户账号，并为其设置口令：
</code></pre>

<pre><code class="language-bash">[root@oldboyedu38 \~]# passwd oldboy
Changing password for user oldboy.
New password: 
BAD PASSWORD: it is too simplistic/systematic
BAD PASSWORD: is too simple
Retype new password: 
passwd: all authentication tokens updated successfully.
\[root@oldboyedu38 \~]# su - oldboy
\[oldboy@oldboyedu38 \~]$ whoami 
oldboy
\[oldboy@oldboyedu38-01 \~]$ su -
Password:
\[root@oldboyedu38-01 oldboy]# whoami
root
</code></pre>

<pre><code>批量修改密码
--stdin 从管道获取密码 非交互式设置密码
</code></pre>

<pre><code class="language-bash">[root@oldboyedu38-01 \~]# echo &quot;123456&quot; | passwd --stdin oldboy
更改用户 oldboy 的密码 。
passwd： 所有的身份验证令牌已经成功更新。
</code></pre>

<h2 id="toc_2">3. 关闭SElinux功能</h2>

<pre><code>SElinux（Security-Enhanced Linux）是美国国家安全局（NSA）对于强制访问控制的实现，这个功能让系统管理员又爱又恨，这里我们还是把它给关闭了吧，至于安全问题，后面通过其他手段来解决，这也是大多数生产环境的做法，如果非要开启也是可以的。关闭方法如下。
</code></pre>

<h3 id="toc_3">3.1. 修改配置文件，使关闭SElinux永久生效</h3>

<pre><code class="language-bash">[root@oldboyedu38-01 ~]# cp /etc/selinux/config /etc/selinux/config.ori #&lt;==备份
[root@oldboyedu38-01 ~]# sed &#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39; /etc/selinux/config
#&lt;==修改配置文件可使配置永久生效，但必须要重启系统，此步使sed快速修改方法，也可以通过vi编辑修改此文件。
[root@oldboyedu38-01 ~]# grep &quot;SELINUX=disabled&quot; /etc/selinux/config
SELINUX=disabled #&lt;==监察替换结果为disabled就表示编辑成功了。
       
## 临时关闭SElinux，可在命令行执行如下命令：   #命令行修改，重启失效
\[root@oldboyedu38-01 \~]# setenforce
usage:  setenforce \[ Enforcing | Permissive | 1 | 0 ]
    数字0表示Permissive，即给出警告提示，但不会阻止操作，相当于disabled
    数字1表示Enforcing，即表示SElinux为开启状态
\[root@oldboyedu38-01 \~]# setenforce 0 ##&lt;==临时将SElinux调成Permissive状态。
\[root@oldboyedu38-01 \~]# getenforce   ##&lt;==查看SElinux当前状态
Permissive
</code></pre>

<h3 id="toc_4">3.2. 关闭iptables防火墙</h3>

<blockquote>
<p>关闭防火墙的目的是为了让初学者学习更方便，将来在学了iptables技术后可再统一开启。<br/>
再企业环境中，一般只有配置外网IP的Linux服务器才需要开启防火墙，但即使是有外网IP，对于高并发高流量的业务服务器仍是不能开的，因为会有较大性能损失导致网站访问很慢，这种情况下只能在前端加更好的硬件防火墙了。</p>
</blockquote>

<pre><code>临时关闭防火墙的具体操作过程如下：
[root@oldboyedu38-01 \~]# /etc/init.d/iptables stop                 #&lt;==重复执行下确认已关闭。
iptables：Setting chains to policy  ACCEPT：filter                    [确定]
iptables：Flushing firewall rules：                                   [确定]
iptables：Unloading modules：                                     [确定]
[root@oldboyedu38-01 \~]# /etc/init.d/iptables stop                 #&lt;==重复执行下确认已关闭。
[root@oldboyedu38-01 \~]# /etc/init.d/iptables status               #查看是否关闭
iptables: Firewall is not running.

永久关闭防火墙的具体操作如下：
[root@oldboyedu38-01 \~]# chkconfig iptables off                    #&lt;==关闭开机自启动命令
[root@oldboyedu38-01 \~]# chkconfig | grep ipt                      #检查是否关闭自启动
iptables        0:off   1:off   2:off   3:off   4:off   5:off   6:off
</code></pre>

<blockquote>
<h1 id="toc_5">企业案例：系统开机启动项优化</h1>
</blockquote>

<pre><code>除了下面5个服务以外都关闭

crond sshd network sysstat rsyslog





chkconfig --list|grep 3:on|sed -r &#39;s#(.*).*0.*#\1#&#39;|egrep -v &#39;crond|sshd|network|sysstat|rsyslog&#39;|sed -r &#39;s#(.*)#chkconfig \1 off#&#39;|bash
</code></pre>

<h2 id="toc_6">4. Linux中文显示设置（如何防止显示中文乱码）</h2>

<blockquote>
<p>此项优化为可选项，即调整Linux系统的字符集设置，那么，什么是字符集呢？<br/>
简单的说，字符集就是一套文字符号及编码。目前Linux下常用的字符集有：</p>

<blockquote>
<p>GBK：定长，双字节，不是国际标准，支持的系统不少，实际企业用的不多。</p>

<p>UTF-8：非定长，1~4字节，广泛支持，MYSQL也使用UTF-8，企业广泛使用。  </p>
</blockquote>

<p>可通过快捷的命令方式在/etc/sysconfig/i18n中添加如下内容，使其支持中文显示：</p>
</blockquote>

<h3 id="toc_7">4.1. 临时更改字符集</h3>

<pre><code class="language-bash">[root@oldboyedu38-01 ~]# echo $LANG                             #查看系统当前的字符集
en_US.UTF8
[root@oldboyedu38-01 ~]# cat /etc/sysconfig/i18n                    #系统字符集配置文件的位置
LANG=&quot;en_US.UTF-8&quot;
SYSFONT=&quot;latarcyrheb-sun16&quot; 
    [root@oldboyedu38-01 ~]# export LANG=zh\_CN.UTF-8                   #临时更改字符集
    ```
## 4.2. 写入到合同里面
```bash
[root@oldboyedu38-01 ~]# cp /etc/sysconfig/i18n /etc/sysconfig/i18n.ori #备份 
[root@oldboyedu38-01 ~]# echo &#39;LANG=&quot;zh_CN.UTF-8&quot;&#39; &gt;/etc/sysconfig/i18n #修改配置文件
    #→相当于用vi /etc/sysconfig/i18n 添加LANG=&quot;zh_CN.UTF-8&quot;内容
[root@oldboyedu38-01 ~]# source /etc/sysconfig/i18n             #让配置文件生效
[root@oldboyedu38-01 ~]# echo $LANG                             #查看系统当前的字符集
zh_CN.UTF-8
</code></pre>

<pre><code>## 乱码的核心解决方法：
    ### 系统字符集（utf-8）
    ### 保持SSH客户端的字符集与Linux服务端一致。
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-03T19:38:49+08:00" itemprop="datePublished">2017/8/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='3.%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93.html'>3.命令总结</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15017603290224.html" itemprop="url">
		inotifywait</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>等待文件或文件集上的特定事件。</p>

<p>用法：inotifywait [options] file1 [file2] [file3] [...]</p>

<p>选项：</p>

<p>-h|--help<br/>
        显示此帮助文本。<br/>
@<file><br/>
        排除指定的文件被监视。<br/>
--exclude <pattern><br/>
        排除与扩展正则表达式<pattern>匹配的文件上的所有事件。<br/>
--excludei <pattern><br/>
        连接--exclude但不区分大小写。<br/>
-m|-monitor<br/>
        继续聆听事件。 如果没有这个选项，inotifywait将在收到一个事件后退出。<br/>
-d|--daemon<br/>
        与--monitor相同，除了在后台运行将事件记录到由-outfile指定的文件。<br/>
        包含 - 日志。<br/>
-r|--recursive<br/>
        递归地观看目录。<br/>
--fromfile <file><br/>
        从<file>读取文件，或者使用` - &#39;查看stdin文件。<br/>
-o|--outfile <file><br/>
        将事件打印到<file>而不是stdout。<br/>
-s|--syslog<br/>
        将错误发送到syslog而不是stderr。<br/>
-q|--quiet<br/>
        打印少（仅打印事件）。<br/>
-qq<br/>
        不打印（甚至没有事件）。<br/>
--format <fmt><br/>
        使用指定的类似printf的格式字符串打印; 阅读手册页了解更多详情。<br/>
--timefmt <fmt><br/>
        与strftime兼容的格式字符串用于 ％T in --format字符串。<br/>
-c | --csv<br/>
        以CSV格式打印事件。<br/>
-t | --timeout <seconds><br/>
        当侦听到单个事件时，等待事件&lt;秒&gt;秒后超时。<br/>
        如果<seconds>为0，inotifywait永远不会超时。<br/>
-e | --event <event1> [-e | --event <event2> ...]<br/>
        侦听定事件。如果省略，则会收听所有事件。<br/>
退出状态：</p>

<p>0 - 收到您要求的事件。<br/>
1 - 您没有要求观看的活动已收到（通常为delete_self或unmount），或发生一些错误。<br/>
2 - 给定了--timeout选项，在指定的时间间隔内没有发生任何事件。<br/>
事件：</p>

<p>access              文件或目录内容被读取<br/>
modify              文件或目录内容已写入<br/>
attrib              文件或目录属性已更改<br/>
close_write         文件或目录在可写模式下打开后关闭<br/>
close_nowrite       文件或目录在只读模式下打开后关闭<br/>
close               文件或目录关闭，无论读/写模式如何<br/>
open                文件或目录打开<br/>
moved_to            文件或目录移动到监视目录<br/>
moved_from          文件或目录从监视目录中移动<br/>
move                文件或目录移动到或从监视目录移动<br/>
create              在监视目录中创建的文件或目录<br/>
delete              在监视目录中删除的文件或目录<br/>
delete_self         文件或目录已被删除<br/>
unmount             包含已卸载文件或目录的文件系统</p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-08-03T19:38:39+08:00" itemprop="datePublished">2017/8/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15017603199663.html" itemprop="url">
		八、Linux权限体系</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">rwx是什么</a>
</li>
<li>
<a href="#toc_1">rwx对应的数字及计算方法</a>
</li>
<li>
<a href="#toc_2">对于文件与目录来说rwx是什么含义</a>
<ul>
<li>
<a href="#toc_3">文件</a>
</li>
<li>
<a href="#toc_4">目录</a>
</li>
</ul>
</li>
<li>
<a href="#toc_5">文件删除原理</a>
<ul>
<li>
<a href="#toc_6">硬连接数为0</a>
</li>
<li>
<a href="#toc_7">进程调用数为0</a>
</li>
</ul>
</li>
<li>
<a href="#toc_8">chmod命令的使用</a>
</li>
<li>
<a href="#toc_9">网站权限</a>
<ul>
<li>
<a href="#toc_10">Linux系统默认权限</a>
</li>
</ul>
</li>
<li>
<a href="#toc_11">Linux系统默认权限控制命令--umask</a>
<ul>
<li>
<a href="#toc_12">是什么</a>
</li>
<li>
<a href="#toc_13">怎么计算</a>
</li>
<li>
<a href="#toc_14">如何修改</a>
</li>
</ul>
</li>
<li>
<a href="#toc_15">了解特殊权限</a>
<ul>
<li>
<a href="#toc_16">suid setuid passwd 命令</a>
</li>
<li>
<a href="#toc_17">sticky粘滞位 1777 /tmp 目录</a>
</li>
</ul>
</li>
<li>
<a href="#toc_18">文件系统的权限</a>
<ul>
<li>
<a href="#toc_19">chattr</a>
</li>
<li>
<a href="#toc_20">lsattr</a>
</li>
</ul>
</li>
</ul>


<h1 id="toc_0">rwx是什么</h1>

<pre><code> r ---- 读
 w ---- 写
 x ---- 执行
</code></pre>

<h1 id="toc_1">rwx对应的数字及计算方法</h1>

<pre><code>读(read) 写(write)    执行(xecute)  简写(r,w,x)       也可用数字(4,2,1)表示
 权限项            r   w   x       r   w   x       r  w  x
数字表示            4   2   1       4   2   1       4  2  1
权限分配            文件所有者       文件所属组       其他用户
例:权限为7则代表可读可写可执行(4+2+1),若为6(4+2)则代表可读,可写
</code></pre>

<h1 id="toc_2">对于文件与目录来说rwx是什么含义</h1>

<h2 id="toc_3">文件</h2>

<pre><code>r 可读 
w 可写  w需要r的可读
x 可执行 x 需要r的可读
</code></pre>

<h2 id="toc_4">目录</h2>

<pre><code>r 查看书包中的内容 sl
w 在书包里面可以放内容 (文件) 是否可以再 目录下创建文件
x 是否可以进去这个目录 cd 是否可以访问目录里面的属性信息
</code></pre>

<h1 id="toc_5">文件删除原理</h1>

<h2 id="toc_6">硬连接数为0</h2>

<pre><code> 删除文件需要看文件所在目录的w权限
 实际删除的是商及目录的block里面的内容
</code></pre>

<h2 id="toc_7">进程调用数为0</h2>

<pre><code>lsof |grep messages
排错: lsof |grep delete
</code></pre>

<h1 id="toc_8">chmod命令的使用</h1>

<pre><code> change mode(改变权限)
 字母形式表示权限
 用户的表示方法
 u -- user (文件的所有者)
 g -- group (用户属于的组)
 o -- others (其他人)
 属于权限
 + 添加权限
 - 去掉某一个权限
 = 先去掉原有的权限,然后再赋予新的权限
 例:
 chmod +x test.sh ==== chmod ugo+x test.sh ==== chmod a+x test.sh
 chmod u+x test.sh
 数字形式表示权限
 权限对应的数字
 r ---- 4
 w ---- 2
 x ---- 1
 - ---- 0
 使用数字授予权限
rwxr-xr-x 755
chmod 755 test.sh
</code></pre>

<h1 id="toc_9">网站权限</h1>

<h2 id="toc_10">Linux系统默认权限</h2>

<pre><code>对于文件来说默认什么权限比较好?
所有者 家庭 隔壁老王
rw-r--r--  644
对于目录来说默认什么权限比较好?
所有者 家庭 隔壁老王
rwxr-xr-x  755
网站比较安全的权限
</code></pre>

<h1 id="toc_11">Linux系统默认权限控制命令--umask</h1>

<h2 id="toc_12">是什么</h2>

<pre><code>控制Linux里面创建文件或目录的默认的权限
</code></pre>

<h2 id="toc_13">怎么计算</h2>

<h2 id="toc_14">如何修改</h2>

<pre><code>临时: umask 022
永久: /etc/profile
</code></pre>

<h1 id="toc_15">了解特殊权限</h1>

<h2 id="toc_16">suid setuid passwd 命令</h2>

<pre><code>作用:运行某一个命令的时候相当于这个命令的所有者(root)
S/s: -rwsr-xr-x
设置方法: chmod u+s /bin/rm 或chmod 4755 /bin/rm
</code></pre>

<h2 id="toc_17">sticky粘滞位 1777 /tmp 目录</h2>

<pre><code>任何人都可以在这个目录里面创建文件
每个人只能管理自己的文件,其他人的处理不了
sgid locate
</code></pre>

<h1 id="toc_18">文件系统的权限</h1>

<h2 id="toc_19">chattr</h2>

<pre><code>a(append只能追加)如果设置了这个权限 只能追加 不能删除 不能修改
i(immutable无敌)无法修改 无法删除
+a -a
</code></pre>

<h2 id="toc_20">lsattr</h2>

<pre><code>查看文件系统权限
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-29T17:17:12+08:00" itemprop="datePublished">2017/7/29</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='3.%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93.html'>3.命令总结</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15013198329902.html" itemprop="url">
		Linux命令总结 (持续更新中)</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p><a href="command.html">Linux常用命令简明列表</a></p>

<ul>
<li>
<a href="#toc_0">线上查询及帮助命令(3个)</a>
</li>
<li>
<a href="#toc_1">文件和目录操作命令(19个)</a>
</li>
<li>
<a href="#toc_2">查看文件及内容处理命令(19个)</a>
</li>
<li>
<a href="#toc_3">文件压缩及解压缩命令(4个)</a>
</li>
<li>
<a href="#toc_4">信息显示命令(12个)</a>
</li>
<li>
<a href="#toc_5">搜索文件命令(4个)</a>
</li>
<li>
<a href="#toc_6">用户管理命令(10个)</a>
</li>
<li>
<a href="#toc_7">基础网络操作命令(10个)</a>
</li>
<li>
<a href="#toc_8">深入网络操作命令(6个)</a>
</li>
<li>
<a href="#toc_9">有关磁盘与文件系统的命令(10几个)</a>
</li>
<li>
<a href="#toc_10">关机和查看系统信息的命令(3个)</a>
</li>
<li>
<a href="#toc_11">系统管理相关命令(8个)</a>
</li>
<li>
<a href="#toc_12">系统安全相关命令(10个)</a>
</li>
<li>
<a href="#toc_13">查看系统用户登陆信息的命令(7个)</a>
</li>
<li>
<a href="#toc_14">其它(19个)</a>
</li>
<li>
<a href="#toc_15">系统性能监视高级命令(12个)</a>
<ul>
<li>
<a href="#toc_16">内存:</a>
</li>
<li>
<a href="#toc_17">CPU:</a>
</li>
<li>
<a href="#toc_18">I/O:</a>
</li>
<li>
<a href="#toc_19">进程:</a>
</li>
</ul>
</li>
<li>
<a href="#toc_20">关机/重启/注销命令(7)</a>
<ul>
<li>
<a href="#toc_21">关机重启:</a>
</li>
<li>
<a href="#toc_22">注销退出:</a>
</li>
</ul>
</li>
<li>
<a href="#toc_23">进程管理:(16个)</a>
</li>
<li>
<a href="#toc_24">非常危险的系统命令(5个):</a>
</li>
<li>
<a href="#toc_25">linux系统三剑客(3个)</a>
</li>
</ul>


<h2 id="toc_0">线上查询及帮助命令(3个)</h2>

<ol>
<li><strong>man</strong></li>
<li><strong>help</strong></li>
<li><strong>info</strong></li>
</ol>

<h2 id="toc_1">文件和目录操作命令(19个)</h2>

<ol>
<li><p><strong>ls 显示目录列表</strong></p>

<p><em>-l 显示详细列表<br/>
-d  只显示目录<br/>
-a  显示所有</em></p></li>
<li><p><strong>cd 切换目录</strong></p>

<p><em>.  当前目录<br/>
. .     当前目录的上一级目录<br/>
~   家目录<br/>
-  上一次目录<br/>
/   根目录</em></p></li>
<li><p><strong>cp 复制</strong></p></li>
<li><p><strong>find   查找</strong></p></li>
<li><p><strong>mkdir  创建目录</strong></p></li>
<li><p><strong>mv 移动</strong></p></li>
<li><p><strong>pwd   显示当前路径</strong></p></li>
<li><p><strong>rename    重命名</strong></p></li>
<li><p><strong>rm    删除</strong></p></li>
<li><p><strong>rmdir 删除目录</strong></p></li>
<li><p><strong>touch 更改时间戳</strong></p></li>
<li><p><strong>tree  树状显示目录列表</strong></p></li>
<li><p><strong>basename</strong></p></li>
<li><p><strong>dirname</strong></p></li>
<li><p><strong>chattr    修改超级权限</strong></p></li>
<li><p><strong>lsattr    查看超级权限</strong></p></li>
<li><p><strong>file  查看文件类型</strong></p></li>
<li><p><strong>md5sum    查看指纹信息</strong></p></li>
</ol>

<h2 id="toc_2">查看文件及内容处理命令(19个)</h2>

<ol>
<li><strong>cat   查看文件内容</strong></li>
<li><strong>tac   反向查看文件内容</strong></li>
<li><strong>more  分页查看文件内容</strong></li>
<li><strong>less</strong></li>
<li><strong>head</strong></li>
<li><strong>tail  查看文件头,尾10行</strong></li>
<li><strong>cut   awk阉割版</strong></li>
<li><strong>paste</strong></li>
<li><strong>sort</strong></li>
<li><strong>uniq</strong></li>
<li><strong>wc        计算文件信息</strong></li>
<li><strong>iconv</strong></li>
<li><strong>dos2unix  转换文件格式</strong></li>
<li><strong>file  查看文件类型</strong></li>
<li><strong>diff</strong></li>
<li><strong>vimdiff</strong></li>
<li><strong>rev</strong></li>
<li><strong>grep(egrep)   筛查三剑客老三</strong></li>
<li><strong>split</strong></li>
<li><strong>join</strong></li>
<li><strong>tr</strong></li>
<li><strong>vi/vim</strong></li>
</ol>

<h2 id="toc_3">文件压缩及解压缩命令(4个)</h2>

<ol>
<li><strong>tar</strong></li>
<li><strong>unzip</strong></li>
<li><strong>gzip</strong></li>
<li><strong>zip</strong></li>
</ol>

<h2 id="toc_4">信息显示命令(12个)</h2>

<ol>
<li><strong>uname</strong></li>
<li><strong>hostname</strong></li>
<li><strong>dmesg</strong></li>
<li><strong>uptime</strong></li>
<li><strong>file</strong></li>
<li><strong>stat</strong></li>
<li><strong>du</strong></li>
<li><strong>df</strong></li>
<li><strong>top</strong></li>
<li><strong>free</strong></li>
<li><strong>date</strong></li>
<li><strong>cal</strong></li>
</ol>

<h2 id="toc_5">搜索文件命令(4个)</h2>

<ol>
<li><strong>which</strong></li>
<li><strong>find</strong></li>
<li><strong>whereis</strong></li>
<li><strong>locate</strong></li>
</ol>

<h2 id="toc_6">用户管理命令(10个)</h2>

<ol>
<li><strong>useradd</strong></li>
<li><strong>usermod</strong></li>
<li><strong>userdel</strong></li>
<li><strong>groupadd</strong></li>
<li><strong>passwd</strong></li>
<li><strong>chage</strong></li>
<li><strong>id</strong></li>
<li><strong>su</strong></li>
<li><strong>visudo</strong></li>
<li><strong>sudo</strong></li>
</ol>

<h2 id="toc_7">基础网络操作命令(10个)</h2>

<ol>
<li><strong>telnet</strong></li>
<li><strong>ssh</strong></li>
<li><strong>scp</strong></li>
<li><strong>wget</strong></li>
<li><strong>ping</strong></li>
<li><strong>route</strong></li>
<li><strong>ifconfig</strong></li>
<li><strong>ifup</strong></li>
<li><strong>ifdown</strong></li>
<li><strong>netstat</strong></li>
</ol>

<h2 id="toc_8">深入网络操作命令(6个)</h2>

<ol>
<li><strong>nmap</strong></li>
<li><strong>lsof</strong></li>
<li><strong>route</strong></li>
<li><strong>mail</strong></li>
<li><strong>mutt</strong></li>
<li><strong>nslookup</strong></li>
<li><strong>dig</strong></li>
<li><strong>host</strong></li>
<li><strong>traceroute</strong></li>
<li><strong>tcpdump</strong></li>
</ol>

<h2 id="toc_9">有关磁盘与文件系统的命令(10几个)</h2>

<ol>
<li><strong>mount</strong></li>
<li><strong>umount</strong></li>
<li><strong>df</strong></li>
<li><strong>du</strong></li>
<li><strong>fsck</strong></li>
<li><strong>dd</strong></li>
<li><strong>dumpe2fs</strong></li>
<li><strong>dump</strong></li>
<li><strong>fdisk</strong></li>
<li><strong>parted</strong></li>
<li><strong>mkfs</strong></li>
<li><strong>partprobe</strong></li>
<li><strong>e2fsck</strong></li>
<li><strong>mkswap</strong></li>
<li><strong>swapon</strong></li>
<li><strong>sync</strong></li>
<li><strong>resize2fs</strong></li>
</ol>

<h2 id="toc_10">关机和查看系统信息的命令(3个)</h2>

<ol>
<li><strong>shutdown</strong></li>
<li><strong>halt</strong></li>
<li><strong>init</strong></li>
</ol>

<h2 id="toc_11">系统管理相关命令(8个)</h2>

<ol>
<li><strong>uptime</strong></li>
<li><strong>top</strong></li>
<li><strong>free</strong></li>
<li><strong>vmstat</strong></li>
<li><strong>mpstat</strong></li>
<li><strong>iostat</strong></li>
<li><strong>sar(sysstats)</strong></li>
<li><strong>chkconfig</strong></li>
</ol>

<h2 id="toc_12">系统安全相关命令(10个)</h2>

<ol>
<li><strong>chmod</strong></li>
<li><strong>chown</strong></li>
<li><strong>chgrp</strong></li>
<li><strong>chage</strong></li>
<li><strong>passwd</strong></li>
<li><strong>su</strong></li>
<li><strong>sudo</strong></li>
<li><strong>umask</strong></li>
<li><strong>chattr</strong></li>
<li><strong>lsattr</strong></li>
</ol>

<h2 id="toc_13">查看系统用户登陆信息的命令(7个)</h2>

<ol>
<li><strong>whoami</strong></li>
<li><strong>who</strong></li>
<li><strong>w</strong></li>
<li><strong>last</strong></li>
<li><strong>lastlog</strong></li>
<li><strong>users</strong></li>
<li><strong>finger</strong></li>
</ol>

<h2 id="toc_14">其它(19个)</h2>

<ol>
<li><strong>echo</strong></li>
<li><strong>printf</strong></li>
<li><strong>rpm</strong></li>
<li><strong>yum</strong></li>
<li><strong>watch</strong></li>
<li><strong>alias</strong></li>
<li><strong>unalias</strong></li>
<li><strong>date</strong></li>
<li><strong>clear</strong></li>
<li><strong>history</strong></li>
<li><strong>eject</strong></li>
<li><strong>time</strong></li>
<li><strong>nohup</strong></li>
<li><strong>nc</strong></li>
<li><strong>xargs</strong></li>
<li><strong>exec</strong></li>
<li><strong>export</strong></li>
<li><strong>unset</strong></li>
<li><strong>type</strong></li>
<li><strong>bc</strong></li>
</ol>

<h2 id="toc_15">系统性能监视高级命令(12个)</h2>

<h3 id="toc_16">内存:</h3>

<ol>
<li><strong>top</strong></li>
<li><strong>free</strong></li>
<li><strong>vmstat</strong></li>
<li><strong>mpstat</strong></li>
<li><strong>iostat</strong></li>
<li><strong>sar</strong></li>
</ol>

<h3 id="toc_17">CPU:</h3>

<ol>
<li><strong>top</strong></li>
<li><strong>vmstat</strong></li>
<li><strong>mpstat</strong></li>
<li><strong>iostat</strong></li>
<li><strong>sar</strong></li>
</ol>

<h3 id="toc_18">I/O:</h3>

<ol>
<li><strong>vmstat</strong></li>
<li><strong>mpstat</strong></li>
<li><strong>iostat</strong></li>
<li><strong>sar</strong></li>
</ol>

<h3 id="toc_19">进程:</h3>

<ol>
<li><strong>ipcs</strong></li>
<li><strong>ipcrm</strong></li>
<li><strong>lsof</strong></li>
<li><strong>strace</strong></li>
<li><strong>lstrace</strong></li>
</ol>

<h2 id="toc_20">关机/重启/注销命令(7)</h2>

<h3 id="toc_21">关机重启:</h3>

<ol>
<li><strong>shutdown</strong></li>
<li><strong>init</strong></li>
<li><strong>halt</strong></li>
<li><strong>poweroff</strong></li>
<li><strong>reboot</strong></li>
</ol>

<h3 id="toc_22">注销退出:</h3>

<ol>
<li><strong>logout</strong></li>
<li><strong>exit</strong></li>
<li><strong>ctl+d        快捷键(生产常用)</strong></li>
</ol>

<h2 id="toc_23">进程管理:(16个)</h2>

<ol>
<li><strong>bg       后台运行</strong></li>
<li><strong>fg       挂起程序</strong></li>
<li><strong>jobs     显示后台程序</strong></li>
<li><strong>kill,killall,pkill   杀掉进程</strong></li>
<li><strong>crontab      设置定时</strong></li>
<li><strong>ps       查看进程</strong></li>
<li><strong>pstree   显示进程状态树</strong></li>
<li><strong>top      显示进程</strong></li>
<li><strong>nice     改变优先权</strong></li>
<li><strong>nohup        用户退出系统之后继续工作</strong></li>
<li><strong>pgrep        查找匹配条件的进程</strong></li>
<li><strong>strace       跟踪一个进程的系统调用</strong></li>
<li><strong>ltrace       跟踪进程调用库函数的情</strong></li>
<li><strong>vmstat   报告虚拟内存统计信息</strong></li>
<li><strong>runlevel</strong></li>
<li><strong>init</strong></li>
<li><strong>service</strong></li>
</ol>

<h2 id="toc_24">非常危险的系统命令(5个):</h2>

<ol>
<li><strong>mv</strong></li>
<li><strong>rm</strong></li>
<li><strong>fdisk</strong></li>
<li><strong>parted</strong></li>
<li><strong>dd</strong></li>
</ol>

<h2 id="toc_25">linux系统三剑客(3个)</h2>

<ol>
<li><strong>grep(egrep)</strong></li>
<li><strong>sed</strong></li>
<li><strong>awk</strong></li>
</ol>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-29T16:44:44+08:00" itemprop="datePublished">2017/7/29</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E8%80%83%E8%AF%95%E9%A2%98.html'>考试题</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15013178849284.html" itemprop="url">
		期中架构之前复习考试</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h1 id="toc_0">目录</h1>

<ul>
<li>
<a href="#toc_0">目录</a>
<ul>
<li>
<a href="#toc_1">01. 向oldboy.txt加入内容 &quot;I love studying Linux.&quot; (不少于3种方法)</a>
</li>
<li>
<a href="#toc_2">02. 说说这些特殊符号含义:  </a>
</li>
<li>
<a href="#toc_3">03. 要求在使用rm命令的时候提示command not found,如何实现？</a>
</li>
<li>
<a href="#toc_4">04. 查找出/data目录下所有以.txt结尾的文件，并且把文件中的trainning修改为oldboy.</a>
</li>
<li>
<a href="#toc_5">05. test.txt文件内容如下，要求输出时候不显示trainning。(最少3中方法)</a>
</li>
<li>
<a href="#toc_6">06. 查找/oldboy目录下所有7天以前的，以log结尾的，并且大于1M的文件，把这些文件移动到/tmp下.</a>
</li>
<li>
<a href="#toc_7">07. 写定时任务,每天晚上12点删除/var/spool/postfix/maildrop/ 目录下7天以前的文件。</a>
</li>
<li>
<a href="#toc_8">08. 如何查看是否开启22，及查看sshd进程是否存在？</a>
</li>
<li>
<a href="#toc_9">09. 列举出linux常用打包压缩工具及其压缩解压参数。</a>
</li>
<li>
<a href="#toc_10">10. 将/etc/目录打包压缩放在/backup目录，并且要求每天备份的文件名不同，请问如何做？</a>
</li>
<li>
<a href="#toc_11">11. 让linux开机自启动某个软件/服务有哪些方法？</a>
</li>
<li>
<a href="#toc_12">12. 如果向磁盘写入数据提示如下错误：No space left on device，通过df -h查看磁盘空间，发现没满，请问可能原因是什么？ </a>
</li>
<li>
<a href="#toc_13">13. 批量创建10个用户stu01-stu10，并且设置随机 8位密码，位密码，要求不能用shell循环（例如：for,while等），只能用命令及管道实现</a>
</li>
<li>
<a href="#toc_14">14. 添加一个用户mysql指定uid为888，禁止登陆并且不创建家目录</a>
</li>
<li>
<a href="#toc_15">15. 请说出linux系统从开机打开电源到进入登录界面整个过程。</a>
</li>
</ul>
</li>
<li>
<a href="#toc_16">16. Sed考试题</a>
<ul>
<li>
<a href="#toc_17"><strong>文件内容如下：</strong></a>
</li>
<li>
<a href="#toc_18">16.1. 删除文件中的空行及#号开头的行（sed命令）</a>
</li>
<li>
<a href="#toc_19">16.2. 替换shutdown为SHUTDOWN</a>
</li>
<li>
<a href="#toc_20">16.3. 删除头三行</a>
</li>
</ul>
</li>
<li>
<a href="#toc_21">17. Shell面试题：根据题意写出对应表达式。</a>
<ul>
<li>
<a href="#toc_22">17.1. 判断/data目录是否存在，存在则进入目录并查看文件属性。</a>
</li>
<li>
<a href="#toc_23">17.2. 判断/etc/hosts文件是否存在，存在则将文件复制到/tmp目录下。</a>
</li>
</ul>
</li>
</ul>


<h2 id="toc_1">01. 向oldboy.txt加入内容 &quot;I love studying Linux.&quot; (不少于3种方法)</h2>

<p>方法一</p>

<pre><code>[root@oldboy38niubility ~]# vim oldboy
I love studying Linux.
~                                                                                                                        
~                                                                                                                                                                                                                                           
~                                                                                                                        
&quot;oldboy&quot; [New] 1L, 23C written
</code></pre>

<p>方法二</p>

<pre><code>[root@oldboy38niubility ~]# echo &quot;I love studying Linux.&quot; &gt; oldboy.txt 
[root@oldboy38niubility ~]# cat oldboy.txt 
I love studying Linux.
</code></pre>

<p>方法三</p>

<pre><code>[root@oldboy38niubility ~]# cat &gt; oldboy.txt &lt;&lt;EOF
&gt; I love studying Linux.
&gt; EOF
[root@oldboy38niubility ~]# cat oldboy.txt 
I love studying Linux.
</code></pre>

<h2 id="toc_2">02. 说说这些特殊符号含义:  </h2>

<p><code>~  .  ..  |  &gt;  &gt;&gt;  &lt;  &lt;&lt;  #</code></p>

<pre><code>~   当前用户的家目录
.   表示当前目录（位置）
..  表示当前目录（位置）的上一级目录（位置）
|   管道符 把管道前面执行完的结果交给管道后面的命令处理
&gt;   输出重定向
&gt;&gt;  追加输出重定向
&lt;   输入重定向
&lt;&lt;  追加输入重定向
#   注释符号
</code></pre>

<h2 id="toc_3">03. 要求在使用rm命令的时候提示command not found,如何实现？</h2>

<p><code>临时生效:</code></p>

<pre><code>alias rm=&#39;echo rm command is not allowed to use&#39;
</code></pre>

<p><code>永久生效:</code></p>

<pre><code>echo &quot;alias rm=&#39;echo rm command is not allowed to use&#39;&quot; &gt;&gt; /etc/profile
source /etc/profile
</code></pre>

<h2 id="toc_4">04. 查找出/data目录下所有以.txt结尾的文件，并且把文件中的trainning修改为oldboy.</h2>

<pre><code>find /data -type f -name &quot;*.txt&quot;|xargs sed &quot;s#trainning#oldboy#g&quot;
</code></pre>

<h2 id="toc_5">05. test.txt文件内容如下，要求输出时候不显示trainning。(最少3中方法)</h2>

<p><code>trainning<br/>
fanbingbing<br/>
oldboy</code></p>

<pre><code>方法一
tail -2 test.txt
方法二
egrep -v trainning test.txt
方法三
sed -n &#39;2,3p&#39; test.txt
方法四
sed &#39;1d&#39; test.txt
方法五
sed &#39;/trainning/d&#39; test.txt
方法六
awk &#39;/trainning/d&#39; test.txt
</code></pre>

<h2 id="toc_6">06. 查找/oldboy目录下所有7天以前的，以log结尾的，并且大于1M的文件，把这些文件移动到/tmp下.</h2>

<pre><code>find /oldboy -type d -mtime +7 -name &quot;*log&quot; -size +1M |xargs mv -t /tmp
</code></pre>

<h2 id="toc_7">07. 写定时任务,每天晚上12点删除/var/spool/postfix/maildrop/ 目录下7天以前的文件。</h2>

<pre><code>cd /server/scripts/
vim del.sh
find /var/spool/postfix/maildrop -type f -mtime +7 |xargs \rm -rf
  :wq!
crontab -e 
00 00 * * * /bin/sh     /server/scripts/del.sh &amp;&gt;/dev/null
</code></pre>

<h2 id="toc_8">08. 如何查看是否开启22，及查看sshd进程是否存在？</h2>

<pre><code>netstat -lntup|grep 22
ss -lntup|grep 22
ps -ef|grep sshd
</code></pre>

<h2 id="toc_9">09. 列举出linux常用打包压缩工具及其压缩解压参数。</h2>

<pre><code>压缩 tar zcf    解压 tar xf
-z  gunzip 压缩
-c  create
-f  file
-x 解压
-c 指定压缩路径
-t list 查看
-P 取消自动去掉/的功能
--exclude 排除
</code></pre>

<h2 id="toc_10">10. 将/etc/目录打包压缩放在/backup目录，并且要求每天备份的文件名不同，请问如何做？</h2>

<pre><code>tar -zcf /backup/etc.$(date +%F).tar.gz  /etc
</code></pre>

<h2 id="toc_11">11. 让linux开机自启动某个软件/服务有哪些方法？</h2>

<pre><code>###第一个里程碑  进入服务管理文件夹 创建一个脚本并给予执行权限X
[root@oldboy38niubility ~]# cd /etc/init.d/
[root@oldboy38niubility init.d]# touch xzp
[root@oldboy38niubility init.d]# chmod +x xzp
###第二个里程碑  编辑脚本 添加 给予运行级别2345 和开启17 关闭顺序95
[root@oldboy38niubility init.d]# vim xzp
#!/bin/bash
# chkconfig: 2345 17 95
# description: xzp service
echo xzp
~                                                                                                                    
~                                                                                                                        
~                                                                                                                        
&quot;xzp&quot; 4L, 72C written~    
####第三个里程碑   把创建好的脚本通过chkconfig --add 添加到chkconfig 里
[root@oldboy38niubility init.d]# chkconfig --add xzp  
####第四个里程碑    测试重启xzp服务
[root@oldboy38niubility init.d]# /etc/init.d/xzp restart
xzp
[root@oldboy38niubility init.d]#chkconfig xzp on
####第五个里程碑  list查看xzp服务
[root@oldboy38niubility init.d]# chkconfig --list|grep xzp
xzp             0:off   1:off   2:on    3:on    4:on    5:on    6:off    
</code></pre>

<h2 id="toc_12">12. 如果向磁盘写入数据提示如下错误：No space left on device，通过df -h查看磁盘空间，发现没满，请问可能原因是什么？ </h2>

<pre><code>inode 满了
</code></pre>

<h2 id="toc_13">13. 批量创建10个用户stu01-stu10，并且设置随机 8位密码，位密码，要求不能用shell循环（例如：for,while等），只能用命令及管道实现</h2>

<pre><code>echo stu{01..10}|xargs -n1|sed &#39;s#.*#useradd &amp;;uuidgen|cut -c -8&gt;/passwd&amp;.txt;cat /passwd&amp;.txt|password --stdin &amp; &gt;/dev/null 2&gt;\&amp;1#g&#39;|bash
</code></pre>

<h2 id="toc_14">14. 添加一个用户mysql指定uid为888，禁止登陆并且不创建家目录</h2>

<pre><code>useradd -u 888 -s /sbin/nologin -M mysql
</code></pre>

<h2 id="toc_15">15. 请说出linux系统从开机打开电源到进入登录界面整个过程。</h2>

<pre><code>电源打开
BIOS自检
MBR引导
GRUB菜单
内核加载kernel
运行init进程
读取/etc/inittab配置文件
执行/etc/rc.d/rc.sysinit脚本
执行/etc/rc.d/rc3.d脚本根据运行级别定一般为3文本模式
启动mingetty进程进入系统登录界面
</code></pre>

<h1 id="toc_16">16. Sed考试题</h1>

<h2 id="toc_17"><strong>文件内容如下：</strong></h2>

<pre><code>[root@oldboyedu ~]# cat /tmp/passwd
root:x:0: 0:root:/root:/bin/bash

bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin

lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin

sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
uucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin
</code></pre>

<h2 id="toc_18">16.1. 删除文件中的空行及#号开头的行（sed命令）</h2>

<pre><code>sed -r &quot;^$|^#&quot; /tmp/passwd -i
</code></pre>

<h2 id="toc_19">16.2. 替换shutdown为SHUTDOWN</h2>

<pre><code>sed -i &#39;#shutdown#SHUTDOWN#&#39; /tmp/passwd
</code></pre>

<h2 id="toc_20">16.3. 删除头三行</h2>

<pre><code>sed &#39;1,3d&#39; /tmp/passwd -i
</code></pre>

<h1 id="toc_21">17. Shell面试题：根据题意写出对应表达式。</h1>

<h2 id="toc_22">17.1. 判断/data目录是否存在，存在则进入目录并查看文件属性。</h2>

<pre><code>[ -d /data ] &amp;&amp;cd /data&amp;&amp;ls -lh
</code></pre>

<h2 id="toc_23">17.2. 判断/etc/hosts文件是否存在，存在则将文件复制到/tmp目录下。</h2>

<pre><code>[ -f /etc/hosts ] &amp;&amp; cp /etc/hosts /tmp
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-29T16:12:51+08:00" itemprop="datePublished">2017/7/29</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15013159711138.html" itemprop="url">
		十九、期中架构NFS知识讲解</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">期中学习过程（重要）</a>
</li>
<li>
<a href="#toc_1">NFS存储服务</a>
</li>
<li>
<a href="#toc_2">NFS工作原理</a>
</li>
<li>
<a href="#toc_3">NFS部署过程（部署过程重点掌握）</a>
<ul>
<li>
<a href="#toc_4">NFS服务端部署</a>
<ul>
<li>
<a href="#toc_5">第一个里程碑：检查nfs服务相关软件是否安装部署</a>
</li>
<li>
<a href="#toc_6">第二个里程碑：进行NFS服务相关软件安装</a>
</li>
<li>
<a href="#toc_7">第三个里程碑：进行NFS服务配置文件编写</a>
</li>
<li>
<a href="#toc_8">第四个里程碑：创建NFS服务的共享目录</a>
</li>
<li>
<a href="#toc_9">第五个里程碑：创建管理NFS共享目录的用户</a>
</li>
<li>
<a href="#toc_10">第六个里程碑：NFS先关安全配置</a>
</li>
<li>
<a href="#toc_11">第七个里程碑：启动nfs服务</a>
</li>
</ul>
</li>
<li>
<a href="#toc_12">NFS客户端部署</a>
<ul>
<li>
<a href="#toc_13">第一个里程碑：检查nfs服务相关软件是否安装部署</a>
</li>
<li>
<a href="#toc_14">第二个里程碑：进行NFS服务相关软件安装</a>
</li>
<li>
<a href="#toc_15">第三个里程碑：进行服务测试</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_16">01：检查房源信息是否可靠</a>
</li>
<li>
<a href="#toc_17">02：检查共享目录信息是否存在</a>
</li>
<li>
<a href="#toc_18">03：测试远程共享目录挂载</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_19">NFS共享存储服务扩展说明：</a>
<ul>
<li>
<a href="#toc_20">01：NFS服务端配置文件</a>
</li>
<li>
<a href="#toc_21">02：NFS服务端权限参数信息：</a>
<ul>
<li>
<a href="#toc_22">01:实验all_squash</a>
</li>
<li>
<a href="#toc_23">客户端测试all_squash参数</a>
<ul>
<li>
<a href="#toc_24">以root用户进行数据创建</a>
</li>
<li>
<a href="#toc_25">以oldboy用户进行数据创建</a>
</li>
<li>
<a href="#toc_26">root_squash,no_all_squash参数实践</a>
</li>
<li>
<a href="#toc_27">root_squash,no_all_squash参数实践</a>
</li>
</ul>
</li>
<li>
<a href="#toc_28">客户端测试root_squash,no_all_squash参数作用</a>
<ul>
<li>
<a href="#toc_29">以root权限创建信息</a>
</li>
<li>
<a href="#toc_30">以oldboy权限创建信息</a>
</li>
<li>
<a href="#toc_31">nfs服务端默认权限参数设置文件</a>
<ul>
<li>
<a href="#toc_32">客户端需要安装rpcbind和nfs-utils软件，但可以不用启动</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_33">重要的配置文件或目录信息</a>
<ul>
<li>
<a href="#toc_34">NFS客户端开机自启动挂载</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h1 id="toc_0">期中学习过程（重要）</h1>

<pre><code>01. 进入到迷茫，怀疑人生阶段（LNMP）
02. 进入到兴奋，任督二脉打开状态
03. 进入到无敌状态，期中架构利用一键自动化完成
04. 进入觉得自己能力还有很多不足的状态（别放弃）
05. 进入到出关阶段，开森找工作（满意的薪资）
</code></pre>

<h1 id="toc_1">NFS存储服务</h1>

<pre><code>什么是NFS；
NFS是Network File System的缩写,中文意思是网络文件系统，它的主要功能是通过网络（一般是局域网）让不同的主机系统之间可以共享文件或目录  
如果大型网站，那么有可能还会用到更复杂的分布式文件系统，例如：Moosefs（mfs）、GlusterFS、FastDFS

数据存储共享方式：
① NFS: 实现linux系统在局域网之间的数据共享(重点理解NFS服务)
② FTP: 实现linux系统和windows系统在局域网之间的数据共享（配置较为复杂）
③ samba: 实现linux系统和windows系统在局域网之间的数据共享   

为什么要用NFS：（重点）
在没有NFS共享存储时，用户数据会被存储到一台web服务器上，其他web服务器需要同步数据，实现web服务上数据一致性
在存在NFS共享存储时，用户数据不会存储到一台web服务器上，会将数据统一存储到NFS共享存储服务器中，实现web服务数据一致性

实现共享存储的方式：（了解）
01：硬件实现共享存储：IBM 存储设备（v5000 v7000） Oracle（数据库） EMC（专业做存储的）
02：软件实现共享存储：NFS FTP 
</code></pre>

<h1 id="toc_2">NFS工作原理</h1>

<pre><code>什么是RPC服  
利用RPC服务与NFS服务结合，如果实现远程挂载
</code></pre>

<h1 id="toc_3">NFS部署过程（部署过程重点掌握）</h1>

<h2 id="toc_4">NFS服务端部署</h2>

<h3 id="toc_5">第一个里程碑：检查nfs服务相关软件是否安装部署</h3>

<pre><code>rpm -qa|grep -E &quot;rpcbind|nfs-utils&quot;
</code></pre>

<h3 id="toc_6">第二个里程碑：进行NFS服务相关软件安装</h3>

<pre><code>yum install -y rpcbind nfs-utils

centos6 RPC服务软件：rpcbind
centos5 RPC服务软件：portmap

rpm -qa
rpm -ql  rpcbind
rpm -qf  rpcinfo   &lt;-查看一个全路径的命令/文件信息，属于哪个软件大礼包

注意：进行yum下载安装软件时，一定要注意两点：
①. 主机可以访问外网，并且dns解析没有问题
②. yum源文件配置正确；yum源文件保存目录/etc/yum.repos.d/
</code></pre>

<h3 id="toc_7">第三个里程碑：进行NFS服务配置文件编写</h3>

<pre><code>vim /etc/exports
cat&gt;&gt;/etc/exports&lt;&lt;EOF
#share /data by oldboy for share at 20170220
/data 172.16.1.0/24(rw,sync)
EOF
</code></pre>

<h3 id="toc_8">第四个里程碑：创建NFS服务的共享目录</h3>

<pre><code>mkdir /data -p
</code></pre>

<h3 id="toc_9">第五个里程碑：创建管理NFS共享目录的用户</h3>

<pre><code>id nfsnobody
</code></pre>

<h3 id="toc_10">第六个里程碑：NFS先关安全配置</h3>

<pre><code>没有
注意：只能在企业网络内部使用，尽量不要跨越外网（互联网）进行使用
</code></pre>

<h3 id="toc_11">第七个里程碑：启动nfs服务</h3>

<pre><code>[root@nfs01 ~]# /etc/init.d/rpcbind start
Starting rpcbind:                                          [  OK  ]
[root@nfs01 ~]# netstat -lntup|grep rpcbind
tcp        0      0 0.0.0.0:111                 0.0.0.0:*                   LISTEN      1832/rpcbind        
tcp        0      0 :::111                      :::*                        LISTEN      1832/rpcbind        
udp        0      0 0.0.0.0:735                 0.0.0.0:*                               1832/rpcbind        
udp        0      0 0.0.0.0:111                 0.0.0.0:*                               1832/rpcbind        
udp        0      0 :::735                      :::*                                    1832/rpcbind        
udp        0      0 :::111                      :::*                                    1832/rpcbind        
[root@nfs01 ~]# rpcinfo -p 172.16.1.31
   program vers proto   port  service
    100000    4   tcp    111  portmapper
    100000    3   tcp    111  portmapper
    100000    2   tcp    111  portmapper
    100000    4   udp    111  portmapper
    100000    3   udp    111  portmapper
    100000    2   udp    111  portmapper
# 查看房源注册信息
# 进行房源的注册
[root@nfs01 ~]# /etc/init.d/nfs start
Starting NFS services:                                     [  OK  ]
Starting NFS quotas:                                       [  OK  ]
Starting NFS mountd:                                       [  OK  ]
Starting NFS daemon:                                       [  OK  ]
Starting RPC idmapd:                                       [  OK  ]
# 再次查看房源注册信息
[root@nfs01 ~]# rpcinfo -p 172.16.1.31
   program vers proto   port  service
    100000    4   tcp    111  portmapper
    100000    3   tcp    111  portmapper
    100000    2   tcp    111  portmapper
    100000    4   udp    111  portmapper
    100000    3   udp    111  portmapper
    100000    2   udp    111  portmapper
    100011    1   udp    875  rquotad
    100011    2   udp    875  rquotad
    100011    1   tcp    875  rquotad
    100011    2   tcp    875  rquotad
    100005    1   udp  61730  mountd
    100005    1   tcp  32469  mountd
    100005    2   udp  57148  mountd
    100005    2   tcp  47036  mountd
    100005    3   udp  13794  mountd
    100005    3   tcp  60173  mountd
    100003    2   tcp   2049  nfs
    100003    3   tcp   2049  nfs
    100003    4   tcp   2049  nfs
    100227    2   tcp   2049  nfs_acl
    100227    3   tcp   2049  nfs_acl
    100003    2   udp   2049  nfs
    100003    3   udp   2049  nfs
    100003    4   udp   2049  nfs
    100227    2   udp   2049  nfs_acl
    100227    3   udp   2049  nfs_acl
    100021    1   udp  55706  nlockmgr
    100021    3   udp  55706  nlockmgr
    100021    4   udp  55706  nlockmgr
    100021    1   tcp   7031  nlockmgr
    100021    3   tcp   7031  nlockmgr
    100021    4   tcp   7031  nlockmgr
</code></pre>

<p>至此服务端配置结束</p>

<h2 id="toc_12">NFS客户端部署</h2>

<h3 id="toc_13">第一个里程碑：检查nfs服务相关软件是否安装部署</h3>

<pre><code>rpm -qa|grep -E &quot;rpcbind|nfs-utils&quot;
</code></pre>

<h3 id="toc_14">第二个里程碑：进行NFS服务相关软件安装</h3>

<pre><code>yum install -y rpcbind nfs-utils
</code></pre>

<h3 id="toc_15">第三个里程碑：进行服务测试</h3>

<h5 id="toc_16">01：检查房源信息是否可靠</h5>

<pre><code>rpcinfo -p 172.16.1.31
</code></pre>

<h5 id="toc_17">02：检查共享目录信息是否存在</h5>

<pre><code>showmount -e 172.16.1.31
</code></pre>

<h5 id="toc_18">03：测试远程共享目录挂载</h5>

<pre><code>mount -t nfs 172.16.1.31:/data /mnt
</code></pre>

<h1 id="toc_19">NFS共享存储服务扩展说明：</h1>

<h2 id="toc_20">01：NFS服务端配置文件</h2>

<pre><code>配置文件分为三个部分：共享目录信息  允许进行挂载共享目录的客户端网络地址信息(共享目录的权限与参数信息)
共享目录权限设置：
①. 与共享目录本身的权限有关
②. 与NFS服务端配置文件中权限参数设置有关
PS：超级root无视共享目录权限设置

  企业中配置文件的常用案例
  遗留：修改NFS默认映射用户（nfsnobody）的信息（实践操作）
</code></pre>

<h2 id="toc_21">02：NFS服务端权限参数信息：</h2>

<p><strong>all_squash参数实践</strong></p>

<h3 id="toc_22">01:实验all_squash</h3>

<pre><code>  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.7/32(rw,sync)
  [root@nfs01 ~]# sed -i &#39;s#sync#sync,all_squash#g&#39; /etc/exports
  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.7/32(rw,sync,all_squash)
  [root@nfs01 ~]# /etc/init.d/nfs reload
  [root@nfs01 ~]# sed -ri &#39;s#7/32#0/24#g&#39; /etc/exports
  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.0/24(rw,sync,all_squash)
  [root@nfs01 ~]# /etc/init.d/nfs reload
  [root@nfs01 ~]# ll /data/
  total 4
  -rw-r--r-- 1 nfsnobody nfsnobody 7 Jul 31 10:27 test01.txt
  [root@nfs01 ~]# ll /data/
  total 8
  -rw-r--r-- 1 nfsnobody nfsnobody 7 Jul 31 10:27 test01.txt
  -rw-rw-r-- 1 nfsnobody nfsnobody 8 Jul 31 10:29 test02.txt
</code></pre>

<h3 id="toc_23">客户端测试all_squash参数</h3>

<pre><code>  [root@backup /]# df -h
  Filesystem      Size  Used Avail Use% Mounted on
  /dev/sda3       8.8G  1.8G  6.7G  21% /
  tmpfs           931M     0  931M   0% /dev/shm
  /dev/sda1       190M   40M  141M  22% /boot
  [root@backup /]# mount -t nfs 172.16.1.31:/data /mnt
  mount.nfs: access denied by server while mounting 172.16.1.31:/data
</code></pre>

<p>说明：出现此错误，是配置文件客户端地址信息设置问题；修改配置文件信息后即可进行映射</p>

<pre><code>  [root@backup /]# mount -t nfs 172.16.1.31:/data /mnt
  [root@backup /]# df -h
  Filesystem         Size  Used Avail Use% Mounted on
  /dev/sda3          8.8G  1.8G  6.7G  21% /
  tmpfs              931M     0  931M   0% /dev/shm
  /dev/sda1          190M   40M  141M  22% /boot
  172.16.1.31:/data  8.8G  1.5G  6.9G  18% /mnt
  [root@backup /]# cd /mnt
  [root@backup mnt]# rm ./* -rf
</code></pre>

<h4 id="toc_24">以root用户进行数据创建</h4>

<pre><code>  [root@backup mnt]# echo &quot;oldboy&quot; &gt;test01.txt
  [root@backup mnt]# ll test01.txt 
  -rw-r--r-- 1 nfsnobody nfsnobody 7 Jul 31 10:27 test01.txt
  [root@backup mnt]# 
</code></pre>

<h4 id="toc_25">以oldboy用户进行数据创建</h4>

<pre><code>  [root@backup mnt]# id oldboy
  uid=501(oldboy) gid=501(oldboy) groups=501(oldboy)
  [root@backup mnt]# su - oldboy
  su: warning: cannot change directory to /home/oldboy: No such file or directory
  This account is currently not available.
  [root@backup mnt]# userdel -r oldboy
  userdel: oldboy home directory (/home/oldboy) not found
  [root@backup mnt]# userdel -r oldboy
  userdel: user &#39;oldboy&#39; does not exist
  [root@backup mnt]# useradd oldboy
  [root@backup mnt]# su - oldboy
  [oldboy@backup ~]$ cd /mnt/
  [oldboy@backup mnt]$ echo oldgirl &gt;test02.txt
  [oldboy@backup mnt]$ ll
  total 8
  -rw-r--r-- 1 nfsnobody nfsnobody 7 Jul 31 10:27 test01.txt
  -rw-rw-r-- 1 nfsnobody nfsnobody 8 Jul 31 10:29 test02.txt
</code></pre>

<h4 id="toc_26">root_squash,no_all_squash参数实践</h4>

<pre><code>  umount参数说明：（-lf）
  -l     Lazy unmount. Detach the filesystem from the filesystem hierarchy now, and cleanup  all
          references  to  the  filesystem  as  soon  as it is not busy anymore.  (Requires kernel
          2.4.11 or later.)
         不用退出目录卸载
  -f     Force  unmount  (in  case  of  an unreachable NFS system).  (Requires kernel 2.1.116 or
          later.)       
</code></pre>

<h4 id="toc_27">root_squash,no_all_squash参数实践</h4>

<pre><code>  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.0/24(rw,sync,all_squash)
  [root@nfs01 ~]# sed -i &#39;s#all_squash#root_squash,no_all_squash#g&#39; /etc/exports
  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.0/24(rw,sync,root_squash,no_all_squash)
  [root@nfs01 ~]# /etc/init.d/nfs reload
  [root@nfs01 ~]# 
  [root@nfs01 ~]# ll /data/
  total 8
  -rw-r--r-- 1 nfsnobody nfsnobody 0 Jul 31 10:39 rootinfo.txt
  -rw-r--r-- 1 nfsnobody nfsnobody 7 Jul 31 10:27 test01.txt
  -rw-rw-r-- 1 nfsnobody nfsnobody 8 Jul 31 10:29 test02.txt
</code></pre>

<h3 id="toc_28">客户端测试root_squash,no_all_squash参数作用</h3>

<pre><code>  [oldboy@backup mnt]$ cd ..
  [oldboy@backup /]$ umount /mnt
  umount: /mnt is not in the fstab (and you are not root)
  [oldboy@backup /]$ exit
  logout
  [root@backup mnt]# umount /mnt
  umount.nfs: /mnt: device is busy
  umount.nfs: /mnt: device is busy
</code></pre>

<p>01: 退出挂载目录,进行卸载<br/>
02: 强制进行目录的卸载</p>

<pre><code>  [root@backup mnt]# umount -lf /mnt
  [root@backup mnt]# df -h
  Filesystem      Size  Used Avail Use% Mounted on
  /dev/sda3       8.8G  1.8G  6.7G  21% /
  tmpfs           931M     0  931M   0% /dev/shm
  /dev/sda1       190M   40M  141M  22% /boot

  [root@backup mnt]# cd ..
  [root@backup /]# mount -t nfs 172.16.1.31:/data /mnt
  [root@backup /]# df -h
  Filesystem         Size  Used Avail Use% Mounted on
  /dev/sda3          8.8G  1.8G  6.7G  21% /
  tmpfs              931M     0  931M   0% /dev/shm
  /dev/sda1          190M   40M  141M  22% /boot
  172.16.1.31:/data  8.8G  1.5G  6.9G  18% /mnt
</code></pre>

<h4 id="toc_29">以root权限创建信息</h4>

<pre><code>  [root@backup /]# touch /mnt/rootinfo.txt
  [root@backup /]# ll /mnt/
  total 8
  -rw-r--r-- 1 nfsnobody nfsnobody 0 Jul 31 10:39 rootinfo.txt
  -rw-r--r-- 1 nfsnobody nfsnobody 7 Jul 31 10:27 test01.txt
  -rw-rw-r-- 1 nfsnobody nfsnobody 8 Jul 31 10:29 test02.txt
  [root@backup /]# 
</code></pre>

<h4 id="toc_30">以oldboy权限创建信息</h4>

<pre><code>  [root@backup /]# su - oldboy
  [oldboy@backup ~]$ cd /mnt/
  [oldboy@backup mnt]$ touch oldboyinfo.txt
  touch: cannot touch `oldboyinfo.txt&#39;: Permission denied


  [root@nfs01 ~]# /etc/init.d/nfs reload
  [root@nfs01 ~]# ll /data/
  total 8
  -rw-r--r-- 1 root      root      0 Jul 31 10:51 root_info.txt
  -rw-r--r-- 1 nfsnobody nfsnobody 0 Jul 31 10:39 rootinfo.txt
  -rw-r--r-- 1 nfsnobody nfsnobody 7 Jul 31 10:27 test01.txt
  -rw-rw-r-- 1 nfsnobody nfsnobody 8 Jul 31 10:29 test02.txt
  [root@nfs01 ~]# id nfsnobody
  uid=65534(nfsnobody) gid=65534(nfsnobody) groups=65534(nfsnobody)
  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.0/24(rw,sync,no_root_squash)
</code></pre>

<h4 id="toc_31">nfs服务端默认权限参数设置文件</h4>

<pre><code>  [root@nfs01 ~]# cat /var/lib/nfs/etab 
  /data 172.16.1.0/24(rw,sync,wdelay,hide,nocrossmnt,secure,no_root_squash,no_all_squash,no_subtree_check,secure_locks,acl,anonuid=65534,anongid=65534,sec=sys,rw,no_root_squash,no_all_squash)
  [root@nfs01 ~]# # 修改默认的映射用户
  [root@nfs01 ~]# 
  [root@nfs01 ~]# # 01: 确认修改后映射用户存在
  [root@nfs01 ~]# id www
  id: www: No such user
  [root@nfs01 ~]# useradd www
  [root@nfs01 ~]# id www
  uid=500(www) gid=500(www) groups=500(www)
  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.0/24(rw,sync,no_root_squash)
  [root@nfs01 ~]# sed -i &#39;s#no_root_squash#all_squash,anonuid=500,anongid=500#g&#39; /etc/exports
  [root@nfs01 ~]# cat /etc/exports 
  #share /data by oldboy for share at 20170220
  /data 172.16.1.0/24(rw,sync,all_squash,anonuid=500,anongid=500)
  [root@nfs01 ~]# /etc/init.d/nfs reload
  [root@nfs01 ~]# 
  [root@nfs01 ~]# ll /data/ -d
  drwxr-xr-x 2 nfsnobody nfsnobody 4096 Jul 31 10:51 /data/
  [root@nfs01 ~]# chown -R www.www /data/
  [root@nfs01 ~]# ll /data/ -d
  drwxr-xr-x 2 www www 4096 Jul 31 10:51 /data/
  [root@nfs01 ~]# cd /data/
  [root@nfs01 data]# ll
  total 8
  -rw-r--r-- 1 www www 0 Jul 31 10:51 root_info.txt
  -rw-r--r-- 1 www www 0 Jul 31 10:39 rootinfo.txt
  -rw-r--r-- 1 www www 7 Jul 31 10:27 test01.txt
  -rw-rw-r-- 1 www www 8 Jul 31 10:29 test02.txt
  -rw-r--r-- 1 www www 0 Jul 31 11:03 www_info.txt
  [root@nfs01 data]# id www
  uid=500(www) gid=500(www) groups=500(www)
  [root@nfs01 data]# /etc/init.d/rpc
  rpcbind     rpcgssd     rpcidmapd   rpcsvcgssd  
  [root@nfs01 data]# /etc/init.d/rpcidmapd reload
  Shutting down RPC idmapd:                                  [  OK  ]
  Starting RPC idmapd:                                       [  OK  ]
  [root@nfs01 data]# /etc/init.d/nfs reload
  [root@nfs01 data]# id nfsnobody
  uid=65534(nfsnobody) gid=65534(nfsnobody) groups=65534(nfsnobody)
</code></pre>

<h5 id="toc_32">客户端需要安装rpcbind和nfs-utils软件，但可以不用启动</h5>

<pre><code>  [root@backup mnt]# rpm -qf `which rpcinfo` 
  rpcbind-0.2.0-13.el6_9.1.x86_64
  [root@backup mnt]# rpm -qf `which showmount` 
  nfs-utils-1.2.3-75.el6.x86_64
</code></pre>

<h3 id="toc_33">重要的配置文件或目录信息</h3>

<pre><code>  /etc/exports        ---NFS服务配置文件
  /usr/sbin/exportfs  ---NFS服务的重要管理命令
                         /usr/sbin/exportfs -rv  == /etc/init.d/nfs reload

  /var/lib/nfs/etab   ---只是一个配置信息查看文件，不能进行参数的设置修改
                         文件中的信息生成或取消，取决于/etc/exports配置文件
</code></pre>

<h4 id="toc_34">NFS客户端开机自启动挂载</h4>

<pre><code>  01：将挂载命令放在/etc/rc.local里
  02：将挂载命令在/etc/fstab里
      需要将netfs服务也开机启动，才能正常识别/etc/fstab文件中的网络挂载信息
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-29T16:05:59+08:00" itemprop="datePublished">2017/7/29</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15013155594594.html" itemprop="url">
		十八、全网备份</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">工作接收到领导对你的一个任务安排</a>
</li>
<li>
<a href="#toc_1">全网备份项目需求</a>
</li>
<li>
<a href="#toc_2">全网备份实践过程</a>
<ul>
<li>
<a href="#toc_3">第一个里程碑：确认服务端与客户端身份</a>
</li>
<li>
<a href="#toc_4">第二个里程碑：进行服务端与客户端部署</a>
<ul>
<li>
<a href="#toc_5">服务端部署步骤：</a>
<ul>
<li>
<a href="#toc_6">参见之前发的rsync部署表格</a>
</li>
</ul>
</li>
<li>
<a href="#toc_7">客户端部署步骤：</a>
<ul>
<li>
<a href="#toc_8">参见之前发的rsync部署表格</a>
</li>
</ul>
</li>
<li>
<a href="#toc_9">实现客户端到服务数据推送完成</a>
</li>
</ul>
</li>
<li>
<a href="#toc_10">第三个里程碑：备份脚本信息编写</a>
<ul>
<li>
<a href="#toc_11">客户端编写备份脚本：</a>
<ul>
<li>
<a href="#toc_12">01 创建本地备份目录（所有客户端）</a>
</li>
<li>
<a href="#toc_13">02 客户端本地打包备份数据信息（所有客户端）</a>
<ul>
<li>
<a href="#toc_14">web客户端</a>
<ul>
<li>
<a href="#toc_15">打包后检查</a>
</li>
</ul>
</li>
<li>
<a href="#toc_16">nfs客户端</a>
<ul>
<li>
<a href="#toc_17">打包后检查</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_18">03 将客户端打包数据推送到服务器端（所有客户端）</a>
</li>
<li>
<a href="#toc_19">04 将客户端7天以前的数据进行删除</a>
</li>
<li>
<a href="#toc_20">05 生成备份数据的指纹文件</a>
<ul>
<li>
<a href="#toc_21">进行客户端脚本编写</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_22">第四个里程碑：编写定时任务</a>
</li>
<li>
<a href="#toc_23">第五个里程碑：服务端进行编写脚本</a>
<ul>
<li>
<a href="#toc_24">01. 实现服务端验证数据完成性</a>
</li>
<li>
<a href="#toc_25">02. 进行邮件发送(邮件服务配置好)</a>
</li>
<li>
<a href="#toc_26">03. 删除180天前的数据，但是保留周一的</a>
<ul>
<li>
<a href="#toc_27">编写服务端脚本</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_28">第六个里程碑：编写定时任务</a>
</li>
</ul>
</li>
<li>
<a href="#toc_29">vim操作说明：</a>
</li>
<li>
<a href="#toc_30">rsync异常问题记录</a>
</li>
</ul>


<h1 id="toc_0">工作接收到领导对你的一个任务安排</h1>

<pre><code>01. 编写一个项目需求文档，发送给领导和相关部门经理
02. 编写一个项目部署文档，发送给领导最终确认
03. 进行项目实施的推进
</code></pre>

<h1 id="toc_1">全网备份项目需求</h1>

<pre><code>01：所有服务器的备份目录必须都为/backup  
02：要备份的系统配置文件包括但不限于：  
    a)  定时任务服务的配置文件     (/var/spool/cron/root)  （适合web和nfs服务器）。  
    b)  开机自启动的配置文件      (/etc/rc.local)         （适合web和nfs服务器）。  
    c)  日常脚本的目录                 (/server/scripts)。  
    d)  防火墙iptables的配置文件    (/etc/sysconfig/iptables)。  
    e)  自己思考下还有什么需要备份呢？  
03：Web服务器站点目录假定为(/var/html/www)。    
04：Web服务器访问日志路径假定为（/app/logs）    
05：Web服务器保留打包后的7天的备份数据即可(本地留存不能多于7天，因为太多硬盘会满)   
06：备份服务器上,保留最近7天的备份数据，同时保留6个月内每周一的所有数据副本  
07：备份服务器上,要按照备份数据服务器的内网IP为目录保存备份，备份的文件按照时间名字保存。    
08：需要确保备份的数据尽量完整正确，在备份服务器上对备份的数据进行检查，把备份的成功及失败结果信息发给系统管理员邮箱中  
</code></pre>

<h1 id="toc_2">全网备份实践过程</h1>

<h2 id="toc_3">第一个里程碑：确认服务端与客户端身份</h2>

<pre><code>nfs01为服务端
</code></pre>

<h2 id="toc_4">第二个里程碑：进行服务端与客户端部署</h2>

<h3 id="toc_5">服务端部署步骤：</h3>

<h4 id="toc_6">参见之前发的rsync部署表格</h4>

<h3 id="toc_7">客户端部署步骤：</h3>

<h4 id="toc_8">参见之前发的rsync部署表格</h4>

<h3 id="toc_9">实现客户端到服务数据推送完成</h3>

<pre><code>rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password 
</code></pre>

<h2 id="toc_10">第三个里程碑：备份脚本信息编写</h2>

<h3 id="toc_11">客户端编写备份脚本：</h3>

<h4 id="toc_12">01 创建本地备份目录（所有客户端）</h4>

<pre><code>mkdir /backup -p
</code></pre>

<h4 id="toc_13">02 客户端本地打包备份数据信息（所有客户端）</h4>

<h5 id="toc_14">web客户端</h5>

<pre><code class="language-bash">mkdir /server/scripts -p
mkdir /var/html/www/ /app/logs/ -p
cd /
tar -zcvhf /backup/sys_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz var/spool/cron/root etc/rc.local server/scripts/ etc/sysconfig/iptables
tar -zcvhf /backup/web_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz var/html/www/ app/logs/
</code></pre>

<h6 id="toc_15">打包后检查</h6>

<pre><code class="language-bash">ll /backup/
 total 8
 -rw-r--r-- 1 root root 571 Jul 27 10:10 sys_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz
 -rw-r--r-- 1 root root 137 Jul 27 10:12 web_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz
</code></pre>

<h5 id="toc_16">nfs客户端</h5>

<pre><code class="language-bash">mkdir /server/scripts -p
    
cd /
tar -zcvhf /backup/sys_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz var/spool/cron/root etc/rc.local server/scripts/ etc/sysconfig/iptables
</code></pre>

<h6 id="toc_17">打包后检查</h6>

<pre><code class="language-bash">ll /backup/
 total 8
 -rw-r--r-- 1 root root 571 Jul 27 10:10 sys_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz
</code></pre>

<h4 id="toc_18">03 将客户端打包数据推送到服务器端（所有客户端）</h4>

<pre><code class="language-bash">rsync -avz /backup/ rsync_backup@172.16.1.41::backup/172.16.1.7/ --password-file=/etc/rsync.password    web01
rsync -avz /backup/ rsync_backup@172.16.1.41::backup/172.16.1.31/ --password-file=/etc/rsync.password   nfs
</code></pre>

<h4 id="toc_19">04 将客户端7天以前的数据进行删除</h4>

<pre><code class="language-bash">find /backup/ -name &quot;*.$(date +%F_%w -d &quot;-1day&quot;).tar.gz&quot; -mtime +7 -delete
</code></pre>

<h4 id="toc_20">05 生成备份数据的指纹文件</h4>

<pre><code class="language-bash">find /backup/ -type f -name &quot;*.$(date +%F_%w -d &quot;-1day&quot;).tar.gz&quot; |xargs md5sum &gt;/backup/finger.txt
</code></pre>

<h5 id="toc_21">进行客户端脚本编写</h5>

<pre><code class="language-bash">vim /server/scripts/web01_backup.sh
#!/bin/bash
# name: web01_backup.sh
# date: 2017 7 27
# author: HQ
# desc: nfs server data backup

HostAddress=$(hostname -i)
Backup_dir=/backup

# create backup dir
mkdir /backup -p

# tar data info &amp;&amp; cp to backup dir
mkdir /server/scripts -p
mkdir /var/html/www/ /app/logs/ -p
cd /
tar -zcvhf /backup/sys_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz var/spool/cron/root etc/rc.local server/scripts/ etc/sysconfig/iptables
tar -zcvhf /backup/web_backup.$(date +%F_%w -d &quot;-1day&quot;).tar.gz var/html/www/ app/logs/

# create finger file
cd $Backup_dir
find ./ -type f -name &quot;*.$(date +%F_%w).tar.gz&quot; |xargs md5sum &gt;$Backup_dir/finger.txt

# push data to backup_server
rsync -avz /backup/ rsync_backup@172.16.1.41::backup/172.16.1.7/ --password-file=/etc/rsync.password

# delete 7 day ago
find /backup/ -name &quot;*.tar.gz&quot; -mtime +7 -delete
</code></pre>

<h2 id="toc_22">第四个里程碑：编写定时任务</h2>

<pre><code class="language-bash"># cornd: backup data 
00 00 * * * /bin/sh /server/scripts/web01_backup.sh &amp;&gt;/dev/null 
</code></pre>

<h2 id="toc_23">第五个里程碑：服务端进行编写脚本</h2>

<h3 id="toc_24">01. 实现服务端验证数据完成性</h3>

<pre><code class="language-bash">find /backup/ -type f -name &quot;finger.txt&quot;|xargs md5sum -c &gt;/backup/check.info
</code></pre>

<h3 id="toc_25">02. 进行邮件发送(邮件服务配置好)</h3>

<pre><code class="language-bash">mail -s &quot;$(date +%F_%w_%T) backup data error&quot;  邮箱地址信息 &lt;/backup/check.info
</code></pre>

<h3 id="toc_26">03. 删除180天前的数据，但是保留周一的</h3>

<pre><code class="language-bash">find /backup/ -name &quot;*.tar.gz&quot; -mtime +180 ! -name &quot;1.tar.gz&quot; |xargs rm 
</code></pre>

<h4 id="toc_27">编写服务端脚本</h4>

<pre><code class="language-bash">vim /server/scripts/backup.sh   
# check data info   
find /backup/ -type f -name &quot;finger.txt&quot;|xargs md5sum -c &gt;/backup/check.info 

# send mail info
mail -s &quot;$(date +%F_%w_%T) backup data error&quot;  邮箱地址信息 &lt;/backup/check.info

# delete 180 day ago
find /backup/ -name &quot;*.tar.gz&quot; -mtime +180 ! -name &quot;*_1.tar.gz&quot; |xargs rm
</code></pre>

<h2 id="toc_28">第六个里程碑：编写定时任务</h2>

<pre><code>00 02 * * * /bin/sh /server/scripts/backup.sh &amp;&gt;/dev/null 
</code></pre>

<hr/>

<h1 id="toc_29">vim操作说明：</h1>

<blockquote>
<p>①. 利用vim实现批量操作功能<br/><br/>
       批量添加<br/><br/>
       ctrl+v --- &gt;&gt;  -- VISUAL BLOCK --<br/><br/>
       上下移动光标，可以选中多行<br/><br/>
       shift+i，光标自动移到多行选中第一行，进行闪烁提示<br/><br/>
       输入你要多行添加的内容<br/><br/>
       内容输入完毕，按ESC进行退出，多行即可实现批量插入信息<br/><br/>
       批量删除<br/><br/>
       ctrl+v --- &gt;&gt;  -- VISUAL BLOCK --<br/><br/>
       左右移动关表，可以选中多列；上下移动光标，可以选中多行<br/><br/>
       按D 或者 x进行批量删除<br/><br/>
   ②. 利用vim命令模式，实现多行内容移动功能<br/><br/>
       23,30move16  ---从23到30行内容移动到16行后面    </p>
</blockquote>

<hr/>

<h1 id="toc_30">rsync异常问题记录</h1>

<p>问题一<br/>
<code>bash<br/>
[root@web01 etc]# rsync -avz /backup/ rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password <br/>
@ERROR: invalid uid rsync<br/>
rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6] <br/>
</code><br/>
解决：  </p>

<pre><code>服务端不存在管理rsync进程用户；需要进行useradd创建
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-28T19:48:25+08:00" itemprop="datePublished">2017/7/28</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15012425054241.html" itemprop="url">
		十七、rsync课程讲解</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">一、rsync原理</a>
<ul>
<li>
<a href="#toc_1">1. 数据备份方式：</a>
</li>
<li>
<a href="#toc_2">2. 企业备份实践方式：</a>
</li>
<li>
<a href="#toc_3">3. rsync服务是什么</a>
</li>
<li>
<a href="#toc_4">4. rsync服务的由来</a>
</li>
<li>
<a href="#toc_5">5. rsync服务的特征</a>
<ul>
<li>
<a href="#toc_6">Rsync的特性如下（7个特性信息说明）：</a>
<ul>
<li>
<a href="#toc_7">01 支持拷贝普通文件与特殊文件如链接文件，设备等。</a>
</li>
<li>
<a href="#toc_8">02 可以有排除指定文件或目录同步的功能，相当于打包命令tar的排除功能。</a>
</li>
<li>
<a href="#toc_9">03 可以做到保持原文件或目录的权限、时间、软硬链接、属主、组等所有属性均不改变-p。</a>
</li>
<li>
<a href="#toc_10">04 可实现增量同步，既只同步发生变化的数据，因此数据传输效率很高（tar -N）。</a>
</li>
<li>
<a href="#toc_11">05 可以使用rcp,rsh,ssh等方式来配合进行隧道加密传输文件（rsync本身不对数据加密）</a>
</li>
<li>
<a href="#toc_12">06 可以通过socket(进程方式)传输文件和数据（服务端和客户端）*****。重点掌握</a>
</li>
<li>
<a href="#toc_13">07 支持匿名的或认证（无需系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像。</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_14">6. rsync复制的原理</a>
</li>
<li>
<a href="#toc_15">7. rsync服务工作方式</a>
<ul>
<li>
<a href="#toc_16">①. 单个主机本地之间的数据传输（此时类似于cp命令的功能）。</a>
<ul>
<li>
<a href="#toc_17">rsync本地复制类似于cp命令</a>
</li>
<li>
<a href="#toc_18">总结：</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_19">02 当复制目录时，目录后不接 /，表示复制目录下面的内容及目录本身</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_20">②. 借助rcp,ssh等通道来传输数据（此时类似于scp命令的功能）。</a>
<ul>
<li>
<a href="#toc_21">rsync远程复制数据方式类似于scp</a>
</li>
<li>
<a href="#toc_22">初识scp命令使用</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_23">02 scp命令--恏</a>
</li>
</ul>
</li>
<li>
<a href="#toc_24">利用rsync命令实现---推</a>
<ul>
<li>
<a href="#toc_25">利用rsync命令实现---恏</a>
</li>
<li>
<a href="#toc_26">通过rsync命令与scp命令进行比对，了解增量与全量</a>
</li>
<li>
<a href="#toc_27">进行scp命令全量复制</a>
</li>
<li>
<a href="#toc_28">进行rsync命令全量复制</a>
</li>
<li>
<a href="#toc_29">测试远程复制命令增量功能</a>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<a href="#toc_30">③. 以守护进程（socket）的方式传输数据（这个是rsync自身的重要的功能）。重点掌握</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_31">rsync服务的部署</a>
<ul>
<li>
<a href="#toc_32">rsync服务端</a>
<ul>
<li>
<a href="#toc_33">第一个里程碑：确认服务软件是否存在</a>
<ul>
<li>
<a href="#toc_34">如何确认rsync这个软件安装了什么？</a>
</li>
<li>
<a href="#toc_35">查看一个命令属于哪个软件大礼包</a>
</li>
</ul>
</li>
<li>
<a href="#toc_36">第二个里程碑：对软件服务进行配置（编写配置文件）</a>
</li>
<li>
<a href="#toc_37">第三个里程碑：添加管理程序的虚拟用户</a>
</li>
<li>
<a href="#toc_38">第四个里程碑：创建服务端备份数据目录</a>
</li>
<li>
<a href="#toc_39">第五个里程碑：创建密码认证文件</a>
<ul>
<li>
<a href="#toc_40"><strong>只要涉及到有密码（明文）信息，都需要将密码文件权限设置为600</strong></a>
</li>
</ul>
</li>
<li>
<a href="#toc_41">第六个里程碑：rsync服务需要进行启动</a>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<a href="#toc_42">至此：服务端配置完成</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_43">rsync客户端</a>
<ul>
<li>
<a href="#toc_44">第一个里程碑：确认服务软件是否存在</a>
</li>
<li>
<a href="#toc_45">第二步里程碑：实现客户端免秘钥传输数据</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_46">rsync服务的排错</a>
<ul>
<li>
<a href="#toc_47">问题一：</a>
</li>
<li>
<a href="#toc_48">解决：</a>
</li>
<li>
<a href="#toc_49">问题二：</a>
</li>
<li>
<a href="#toc_50">解决：</a>
</li>
<li>
<a href="#toc_51">问题三：</a>
</li>
<li>
<a href="#toc_52">解决：</a>
</li>
<li>
<a href="#toc_53">rsync服务的扩展</a>
<ul>
<li>
<a href="#toc_54">①. 守护进程多模块功能</a>
<ul>
<li>
<ul>
<li>
<a href="#toc_55">在配置文件中添加多模块信息</a>
</li>
<li>
<a href="#toc_56">多模块信息添加完毕，创建多模块指定的目录</a>
</li>
<li>
<a href="#toc_57">多模块配置完毕后，需要重启rsync服务，使配置生效</a>
</li>
<li>
<a href="#toc_58">rsync无法创建多级目录，即没有-p参数功能</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_59">②. 守护进程排除文件功能</a>
<ul>
<li>
<a href="#toc_60">rsync实现排除功能</a>
</li>
<li>
<a href="#toc_61">服务端进行测试验证</a>
</li>
</ul>
</li>
<li>
<a href="#toc_62">③ rsync守护进程访问控制功能</a>
<ul>
<li>
<a href="#toc_63">rsync服务的应用（实践案例）</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_64">异常问题大招：</a>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<a href="#toc_65">遗留知识点：</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">一、rsync原理</h2>

<h3 id="toc_1">1. 数据备份方式：</h3>

<pre><code>定时的备份方式：主要备份的网站内部人员所创建数据信息，采用定时备份 
实时的备份方式：主要备份的网站外部人员所创建数据信息，采用实时备份
</code></pre>

<hr/>

<h3 id="toc_2">2. 企业备份实践方式：</h3>

<pre><code>①. 相同IDC中心，会对备份服务，再次进行备份；同一机房多台备份服务器
②. 不同IDC中心，会对备份服务，再次进行备份；不同机房多台备份服务器
③. 不同区域中心，会对备份服务，再次进行备份；不同区域多台备份服务器
以上企业备份方案成为两地三中心
</code></pre>

<hr/>

<h3 id="toc_3">3. rsync服务是什么</h3>

<pre><code>a fast, versatile, remote (and local) file-copying tool
Rsync是一款开源的、快速的、多功能的、可实现&quot;全量及增量&quot; 的本地或远程数据同步备份的优秀工具
rsync命令非常强大：cp（本地复制命令） scp（远程复制命令） rm（删除命令） ls（查看文件命令）
</code></pre>

<hr/>

<h3 id="toc_4">4. rsync服务的由来</h3>

<pre><code>01 rsync命令就是最常用的数据备份服务命令，rsync通过算法实现了增量备份
02 rsync相应算法方式需要理解
</code></pre>

<hr/>

<h3 id="toc_5">5. rsync服务的特征</h3>

<hr/>

<h4 id="toc_6">Rsync的特性如下（7个特性信息说明）：</h4>

<hr/>

<h5 id="toc_7">01 支持拷贝普通文件与特殊文件如链接文件，设备等。</h5>

<hr/>

<h5 id="toc_8">02 可以有排除指定文件或目录同步的功能，相当于打包命令tar的排除功能。</h5>

<pre><code>#tar zcvf backup_1.tar.gz/opt/data-exclude=oldboy
</code></pre>

<blockquote>
<p>说明：在打包/opt/data时就排除了oldboy命名的目录和文件。</p>
</blockquote>

<hr/>

<h5 id="toc_9">03 可以做到保持原文件或目录的权限、时间、软硬链接、属主、组等所有属性均不改变-p。</h5>

<hr/>

<h5 id="toc_10">04 可实现增量同步，既只同步发生变化的数据，因此数据传输效率很高（tar -N）。</h5>

<pre><code>将备份/home 目录自 2008-01-29 以来修改过的文件
tar -N 2008-01-29 -zcvf /backups/inc-backup_$(date +%F).tar.gz /home
将备份 /home 目录昨天以来修改过的文件
tar -N $(date -d yesterday &quot;+%F&quot;) -zcvf /backups/inc-backup_$(date +%F).tar.gz /home
添加文件到已经打包的文件
tar -rf all.tar *.gif
</code></pre>

<blockquote>
<p>说明：这条命令是将所有.gif的文件增加到all.tar的包里面去。-r是表示增加文件的意思。</p>
</blockquote>

<hr/>

<h5 id="toc_11">05 可以使用rcp,rsh,ssh等方式来配合进行隧道加密传输文件（rsync本身不对数据加密）</h5>

<hr/>

<h5 id="toc_12">06 可以通过socket(进程方式)传输文件和数据（服务端和客户端）*****。重点掌握</h5>

<hr/>

<h5 id="toc_13">07 支持匿名的或认证（无需系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像。</h5>

<hr/>

<h3 id="toc_14">6. rsync复制的原理</h3>

<p><code>当A主机有数据信息，B主机没有数据信息时，采用全量复制方式<br/>
当A主机有数据信息，B主机也有数据信息时，进行数据信息比对，从而判断是否采用增量方式或是不进行复制</code></p>

<hr/>

<h3 id="toc_15">7. rsync服务工作方式</h3>

<hr/>

<h4 id="toc_16">①. 单个主机本地之间的数据传输（此时类似于cp命令的功能）。</h4>

<hr/>

<h5 id="toc_17">rsync本地复制类似于cp命令</h5>

<p><code>#回顾cp命令如何使用</code></p>

<pre><code>[root@backup ~]# mkdir /tmp/{cp,rsync} -p
[root@backup ~]# cp -a /etc/hosts /tmp/cp/
[root@backup ~]# ll /tmp/cp/
total 4
-rw-r--r--. 1 root root 349 Jul 26 10:18 hosts
</code></pre>

<p><code># 以上利用cp命令复制文件信息</code></p>

<hr/>

<p><code>#应用rsync命令进行复制</code></p>

<pre><code>[root@backup ~]# rsync -a /etc/hosts /tmp/rsync/
[root@backup ~]# ll /tmp/rsync/
total 4
-rw-r--r-- 1 root root 349 Jul 26 10:18 hosts
[root@backup ~]# # 以上利用rsync命令复制文件信息
[root@backup ~]# 
[root@backup ~]# # 以下利用cp命令复制目录信息
[root@backup ~]# cp -a /etc/selinux/ /tmp/cp/
[root@backup ~]# ll -d /tmp/cp/selinux/
drwxr-xr-x. 3 root root 4096 Jun9 18:56 /tmp/cp/selinux/
</code></pre>

<hr/>

<p><code>#以下利用rsync命令复制目录信息</code></p>

<pre><code>[root@backup ~]# rsync -a /etc/selinux/ /tmp/rsync/
[root@backup ~]# ll/tmp/rsync/
total 28
-rw-r--r-- 1 root root457 Jun9 18:56 config
-rw-r--r-- 1 root root458 Jun9 16:53 config.bak
-rw-r--r-- 1 root root349 Jul 26 10:18 hosts
-rw-r--r-- 1 root root113 Nov 182016 restorecond.conf
-rw-r--r-- 1 root root 76 Nov 182016 restorecond_user.conf
-rw-r--r-- 1 root root 2271 Jul 242015 semanage.conf
drwxr-xr-x 6 root root 4096 Jun9 16:54 targeted
</code></pre>

<p><code>#说明：没有将selinux目录进行复制到rsync目录中，而是将selinux目录下面的文件复制到了rsync目录中</code></p>

<pre><code>[root@backup ~]# rsync -a /etc/selinux /tmp/rsync/
[root@backup ~]# ll -d /tmp/rsync/selinux/
drwxr-xr-x 3 root root 4096 Jun9 18:56 /tmp/rsync/selinux/
</code></pre>

<hr/>

<h5 id="toc_18">总结：</h5>

<p>01 当复制目录时，目录后接上 /，表示只复制目录下面的内容信息</p>

<h2 id="toc_19">02 当复制目录时，目录后不接 /，表示复制目录下面的内容及目录本身</h2>

<h4 id="toc_20">②. 借助rcp,ssh等通道来传输数据（此时类似于scp命令的功能）。</h4>

<hr/>

<h5 id="toc_21">rsync远程复制数据方式类似于scp</h5>

<hr/>

<h5 id="toc_22">初识scp命令使用</h5>

<p>01 scp命令--推</p>

<pre><code>[root@backup ~]# scp -rp /etc/hosts 172.16.1.31:/tmp/scp/
The authenticity of host &#39;172.16.1.31 (172.16.1.31)&#39; can&#39;t be established.
RSA key fingerprint is 82:d7:80:62:c0:db:c9:9a:d5:d0:8f:66:94:53:8b:9f.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;172.16.1.31&#39; (RSA) to the list of known hosts.
root@172.16.1.31&#39;s password: 
hosts100%349 0.3KB/s 00:00
</code></pre>

<h2 id="toc_23">02 scp命令--恏</h2>

<pre><code>[root@backup ~]# mv /etc/hosts /tmp/
[root@backup ~]# ll /etc/host
host.confhosts.allowhosts.bakhosts.deny 
[root@backup ~]# ll /etc/host
host.confhosts.allowhosts.bakhosts.deny 
[root@backup ~]# scp -rp 172.16.1.31:/tmp/scp/hosts /etc/
root@172.16.1.31&#39;s password: 
hosts100%349 0.3KB/s 00:00
[root@backup ~]# ll /etc/hosts
-rw-r--r-- 1 root root 349 Jul 26 10:18 /etc/hosts
</code></pre>

<h1 id="toc_24">利用rsync命令实现---推</h1>

<pre><code>[root@backup ~]# rsync -rp /etc/hosts 172.16.1.31:/tmp/rsync/
root@172.16.1.31&#39;s password: 
</code></pre>

<h1 id="toc_25">利用rsync命令实现---恏</h1>

<pre><code>[root@backup ~]# mv /etc/hosts /tmp/
mv: overwrite `/tmp/hosts&#39;? y
[root@backup ~]# ll /etc/hosts
ls: cannot access /etc/hosts: No such file or directory
[root@backup ~]# rsync -rp 172.16.1.31:/tmp/rsync/hosts /etc/
root@172.16.1.31&#39;s password: 
[root@backup ~]# ll /etc/hosts
-rw-r--r-- 1 root root 349 Jul 26 10:54 /etc/hosts
</code></pre>

<h1 id="toc_26">通过rsync命令与scp命令进行比对，了解增量与全量</h1>

<pre><code>[root@backup ~]# mkdir /tmp/{scp,rsync}/{1..5} -p
[root@backup ~]# ll /tmp/rsync/
total 52
drwxr-xr-x 2 root root 4096 Jul 26 11:15 1
drwxr-xr-x 2 root root 4096 Jul 26 11:15 2
drwxr-xr-x 2 root root 4096 Jul 26 11:15 3
drwxr-xr-x 2 root root 4096 Jul 26 11:15 4
drwxr-xr-x 2 root root 4096 Jul 26 11:15 5
[root@backup ~]# ll /tmp/scp/
total 20
drwxr-xr-x 2 root root 4096 Jul 26 11:15 1
drwxr-xr-x 2 root root 4096 Jul 26 11:15 2
drwxr-xr-x 2 root root 4096 Jul 26 11:15 3
drwxr-xr-x 2 root root 4096 Jul 26 11:15 4
drwxr-xr-x 2 root root 4096 Jul 26 11:15 5
</code></pre>

<h1 id="toc_27">进行scp命令全量复制</h1>

<pre><code>[root@backup ~]# scp -rp /tmp/scp/* 172.16.1.31:/tmp/scp/
root@172.16.1.31&#39;s password: 
</code></pre>

<h1 id="toc_28">进行rsync命令全量复制</h1>

<pre><code>[root@backup ~]# rsync -rpv /tmp/rsync/* 172.16.1.31:/tmp/rsync
root@172.16.1.31&#39;s password: 
sending incremental file list
config
config.bak
hosts
restorecond.conf
restorecond_user.conf
semanage.conf
---省略部分---
</code></pre>

<h1 id="toc_29">测试远程复制命令增量功能</h1>

<pre><code>[root@backup ~]# mkdir /tmp/{scp,rsync}/{6..10} -p
[root@backup ~]# scp -rp /tmp/scp/ 172.16.1.31:/tmp/scp/
root@172.16.1.31&#39;s password: 
说明：scp采用全量复制

[root@backup ~]# rsync -avzP /tmp/rsync/ 172.16.1.31:/tmp/rsync/
root@172.16.1.31&#39;s password: 
sending incremental file list
./
6/
7/
8/
9/
10/

sent 12700 bytesreceived 64 bytes3646.86 bytes/sec
total size is 43123143speedup is 3378.50
说明：rsync采用增量复制
</code></pre>

<hr/>

<h4 id="toc_30">③. 以守护进程（socket）的方式传输数据（这个是rsync自身的重要的功能）。重点掌握</h4>

<p>优势：<br/><br/>
①. 通过自身服务配置，即可实现远程访问免秘钥备份数据<br/><br/>
②. 由于存在守护进程，数据备份传输效率会更高一些</p>

<pre><code>补充知识：
rsync可以实现增量与全量
全量：第一次备份数据的时候
rsync -avz /tmp/rsync/* /tmp/---有星号存在时，也会出现全量备份的效果
增量：rsync -avz /tmp/rsync/ /tmp/ ---无星号存在时，便会出现增量备份的效果
</code></pre>

<h1 id="toc_31">rsync服务的部署</h1>

<h2 id="toc_32">rsync服务端</h2>

<h3 id="toc_33">第一个里程碑：确认服务软件是否存在</h3>

<pre><code>[root@backup ~]# rpm -qa rsync
rsync-3.0.6-12.el6.x86_64
[root@backup ~]# rpm -qa |grep rsyn
rsync-3.0.6-12.el6.x86_64
</code></pre>

<h4 id="toc_34">如何确认rsync这个软件安装了什么？</h4>

<pre><code>[root@backup ~]# rpm -ql rsync
/etc/xinetd.d/rsync
/usr/bin/rsync

[root@backup ~]# rpm -qa ssh
[root@backup ~]# ss
ss ssh-addssh-copy-idssh-keygen ssltap 
sshssh-agentsshd ssh-keyscan 
</code></pre>

<h4 id="toc_35">查看一个命令属于哪个软件大礼包</h4>

<pre><code>[root@backup ~]# rpm -qf ssh
error: file /root/ssh: No such file or directory
[root@backup ~]# rpm -qf `which ssh`
openssh-clients-5.3p1-122.el6.x86_64
</code></pre>

<h3 id="toc_36">第二个里程碑：对软件服务进行配置（编写配置文件）</h3>

<pre><code>cat &gt;&gt;/etc/rsyncd.conf&lt;&lt;EOF 
#rsync_config
#created by HQ at 2017
##rsyncd.conf start## 
uid = rsync
gid = rsync
use chroot = no
max connections = 200
timeout = 300
pid file = /var/run/rsyncd.pid
lock file = /var/run/rsync.lock
log file = /var/log/rsyncd.log
ignore errors
read only = false
list = false
hosts allow = 172.16.1.0/24
hosts deny = 0.0.0.0/32
auth users = rsync_backup
secrets file = /etc/rsync.password
[backup]
comment = &quot;backup dir by oldboy&quot;
path = /backup
EOF
</code></pre>

<h3 id="toc_37">第三个里程碑：添加管理程序的虚拟用户</h3>

<pre><code>[root@backup ~]# useradd -s /sbin/nologin -M rsync
[root@backup ~]# id rsync
uid=500(rsync) gid=500(rsync) groups=500(rsync)
</code></pre>

<h3 id="toc_38">第四个里程碑：创建服务端备份数据目录</h3>

<pre><code>[root@backup ~]# mkdir /backup
[root@backup ~]# ll -d /backup/
drwxr-xr-x 2 root root 4096 Jul 26 15:02 /backup/
[root@backup ~]# chown -R rsync.rsync /backup/
</code></pre>

<h3 id="toc_39">第五个里程碑：创建密码认证文件</h3>

<pre><code>echo &quot;rsync_backup:oldboy123&quot; &gt; /etc/rsync.password

ll /etc/rsync.password 
-rw-r--r-- 1 root root 23 Jul 26 15:09 /etc/rsync.password
</code></pre>

<h4 id="toc_40"><strong>只要涉及到有密码（明文）信息，都需要将密码文件权限设置为600</strong></h4>

<pre><code>chmod 600 /etc/rsync.password 
</code></pre>

<h3 id="toc_41">第六个里程碑：rsync服务需要进行启动</h3>

<pre><code class="language-bash">    rsync --daemon
</code></pre>

<blockquote>
<p>说明：rsync服务的端口号为873</p>
</blockquote>

<h6 id="toc_42">至此：服务端配置完成</h6>

<h2 id="toc_43">rsync客户端</h2>

<h3 id="toc_44">第一个里程碑：确认服务软件是否存在</h3>

<pre><code>[root@backup ~]# rpm -qa rsync
rsync-3.0.6-12.el6.x86_64
</code></pre>

<h3 id="toc_45">第二步里程碑：实现客户端免秘钥传输数据</h3>

<pre><code>[root@nfs01 data]# # 客户端第二里程：实现免秘钥
[root@nfs01 data]# ## 需要一个告知服务端密码信息文件
[root@nfs01 data]# echo &quot;oldboy123&quot; &gt;/etc/rsync.password
[root@nfs01 data]# chmod 600 /etc/rsync.password 
[root@nfs01 data]# ## 在执行备份数据命令时，告知密码文件信息
[root@nfs01 data]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password 
sending incremental file list
hosts

sent 196 bytesreceived 27 bytes446.00 bytes/sec
total size is 349speedup is 1.57
</code></pre>

<h1 id="toc_46">rsync服务的排错</h1>

<h2 id="toc_47">问题一：</h2>

<pre><code>[root@backup ~]# scp -rp /etc/hosts 172.16.1.31:tmp/scp
ssh: connect to host 172.16.1.31 port 22: Connection refused
lost connection
</code></pre>

<h2 id="toc_48">解决：</h2>

<p>①. 确然链路是否通畅ping<br/><br/>
②. 确认端口是否通畅telnet<br/>
01. 服务端口没有开启<br/>
02. 防火墙进行链路阻止<br/>
03. sshd配置文件信息有问题</p>

<h2 id="toc_49">问题二：</h2>

<pre><code># rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup
rsync: failed to connect to 172.16.1.41: Connection refused (111)
rsync error: error in socket IO (code 10) at clientserver.c(124) [sender=3.0.6]
</code></pre>

<h2 id="toc_50">解决：</h2>

<pre><code>rsync服务端的程序没有启动
</code></pre>

<h2 id="toc_51">问题三：</h2>

<pre><code># rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup
Password: 
sending incremental file list
hosts
rsync: mkstemp &quot;.hosts.3LfwwJ&quot; (in backup) failed: Permission denied (13)

sent 196 bytesreceived 27 bytes10.88 bytes/sec
total size is 349speedup is 1.57
rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6
</code></pre>

<h2 id="toc_52">解决：</h2>

<p>备份目录权限没有设置为rsync</p>

<h2 id="toc_53">rsync服务的扩展</h2>

<h3 id="toc_54">①. 守护进程多模块功能</h3>

<h5 id="toc_55">在配置文件中添加多模块信息</h5>

<pre><code>[root@backup ~]# cat /etc/rsyncd.conf 
#rsync_config
#created by HQ at 2017
##rsyncd.conf start##

uid = rsync
gid = rsync
use chroot = no
max connections = 200
timeout = 300
pid file = /var/run/rsyncd.pid
lock file = /var/run/rsync.lock
log file = /var/log/rsyncd.log
ignore errors
read only = false
list = false
hosts allow = 172.16.1.0/24
hosts deny = 0.0.0.0/32
auth users = rsync_backup
secrets file = /etc/rsync.password
[backup]
comment = &quot;backup dir by oldboy&quot;
path = /backup
[nfsbackup]
comment = &quot;nfsbackup dir by oldboy&quot;
path = /nfsbackup
</code></pre>

<h5 id="toc_56">多模块信息添加完毕，创建多模块指定的目录</h5>

<pre><code>[root@backup ~]# mkdir /nfsbackup;chown -R rsync.rsync /nfsbackup
[root@backup ~]# ll /nfsbackup/ -d
drwxr-xr-x 2 rsync rsync 4096 Jul 26 16:43 /nfsbackup/
</code></pre>

<h5 id="toc_57">多模块配置完毕后，需要重启rsync服务，使配置生效</h5>

<pre><code>root@backup ~]# /etc/init.d/xinetd
Usage: /etc/init.d/xinetd {start|stop|status|restart|condrestart|reload}
[root@backup ~]# /etc/init.d/xinetd restart
Stopping xinetd: [FAILED]
Starting xinetd: [OK]
[root@backup ~]# netstat -lntup|grep xinetd
tcp00 :::873:::*LISTEN2351/xinetd 

[root@nfs01 data]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::nfsbackup/dba/01/02/03/04/ --password-file=/etc/rsync.password 
sending incremental file list
rsync: mkdir &quot;dba/01/02/03/04&quot; (in nfsbackup) failed: No such file or directory (2)
rsync error: error in file IO (code 11) at main.c(576) [receiver=3.0.6]
rsync: connection unexpectedly closed (5 bytes received so far) [sender]
rsync error: error in rsync protocol data stream (code 12) at io.c(600) [sender=3.0.6]
</code></pre>

<h5 id="toc_58">rsync无法创建多级目录，即没有-p参数功能</h5>

<h3 id="toc_59">②. 守护进程排除文件功能</h3>

<h4 id="toc_60">rsync实现排除功能</h4>

<pre><code>[root@nfs01 rsync]# cd /tmp/rsync/
[root@nfs01 rsync]# ll
total 0
[root@nfs01 rsync]# mkdir {a..d}
[root@nfs01 rsync]# touch {a..d}/{1..3}
[root@nfs01 rsync]# rsync -avz --exclude=a --exclude=b/2 /tmp/rsync/ rsync_backup@172.16.1.41::nfsbackup --password-file=/etc/rsync.password 
sending incremental file list
./
b/
b/1
b/3
c/
c/1
c/2
c/3
d/
d/1
d/2
d/3

sent 423 bytesreceived 175 bytes1196.00 bytes/sec
total size is 0speedup is 0.00
</code></pre>

<h4 id="toc_61">服务端进行测试验证</h4>

<pre><code>[root@backup nfsbackup]# tree
.
├── b
│   ├── 1
│   └── 3
├── c
│   ├── 1
│   ├── 2
│   └── 3
└── d
├── 1
├── 2
└── 3
</code></pre>

<h3 id="toc_62">③ rsync守护进程访问控制功能</h3>

<h4 id="toc_63">rsync服务的应用（实践案例）</h4>

<h2 id="toc_64">异常问题大招：</h2>

<p>①. 重启（服务重启 服务器重启）<br/>
②. 重配（所有配置信息重新配置）<br/>
③. 重装（系统重装 服务架构重装）</p>

<hr/>

<h5 id="toc_65">遗留知识点：</h5>

<pre><code>企业备份方案实践说明：   
借助cron+rsync把所有客户服务器数据同步到备份服务器     
全网服务器数据备份解决方案提出及负责实施 200x.03 – 200x.09     

01. 针对公司重要数据备份混乱状况向领导提出备份全网数据的解决方案。     
02. 通过本地打包备份，然后rsync结合inotify应用把全网数据统一备份到一个固定存储服务器，然后在存储服务器上通过脚本检查并报警管理员备份结果。     
03. 定期将IDC机房的数据备份到公司的内部服务器，防止机房地震及火灾问题导致数据丢失。
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-28T18:13:48+08:00" itemprop="datePublished">2017/7/28</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15012368281486.html" itemprop="url">
		十六、期中架构</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">一、期中架构组成部分，与实现技术</a>
<ul>
<li>
<a href="#toc_1">01. 用户---顾客</a>
</li>
<li>
<a href="#toc_2">02. 防火墙---保安</a>
</li>
<li>
<a href="#toc_3">03. 交换机（网络架构）---对讲机</a>
</li>
<li>
<a href="#toc_4">04. 负载均衡---迎宾</a>
</li>
<li>
<a href="#toc_5">05. Web服务器---服务员</a>
</li>
<li>
<a href="#toc_6">06. 数据库---厨师01</a>
</li>
<li>
<a href="#toc_7">07. 存储---厨师02</a>
</li>
<li>
<a href="#toc_8">08. 备份服务---厨师03</a>
</li>
<li>
<a href="#toc_9">09. 缓存服务---厨师04</a>
</li>
</ul>
</li>
<li>
<a href="#toc_10">二、期中架构扩展部分</a>
<ul>
<li>
<a href="#toc_11">01. 运维人员---内部员工</a>
</li>
<li>
<a href="#toc_12">02. vpn---秘密通道</a>
</li>
<li>
<a href="#toc_13">03. 监管---跳板机</a>
</li>
<li>
<a href="#toc_14">04. 批量管理设备</a>
</li>
<li>
<a href="#toc_15">05. 监控设备---经理</a>
</li>
</ul>
</li>
<li>
<a href="#toc_16">三、架构部署过程</a>
<ul>
<li>
<a href="#toc_17">01. 搞定备份服务器</a>
</li>
<li>
<a href="#toc_18">02. 搞定存储服务器</a>
</li>
<li>
<a href="#toc_19">03. 进行数据备份的方法</a>
</li>
<li>
<a href="#toc_20">04. 批量管理服务器</a>
</li>
<li>
<a href="#toc_21">05. 服务员-Web服务器</a>
</li>
<li>
<a href="#toc_22">06. LNMP架构</a>
</li>
<li>
<a href="#toc_23">07. 负载均衡服务器</a>
</li>
</ul>
</li>
<li>
<a href="#toc_24">四、架构部署虚拟环境准备</a>
<ul>
<li>
<a href="#toc_25">01. 确认网络情况</a>
</li>
<li>
<a href="#toc_26">02. 虚拟主机当中设置IP地址信息</a>
</li>
<li>
<a href="#toc_27">03. 测试虚拟模板机能正常访问外网</a>
</li>
</ul>
</li>
<li>
<a href="#toc_28">五、系统优化介绍：（模板机配置）</a>
<ul>
<li>
<a href="#toc_29">01. 模板机优化配置---hosts文件配置</a>
</li>
<li>
<a href="#toc_30">02. 模板机优化配置---更改yum源</a>
</li>
<li>
<a href="#toc_31">03. 模板机优化配置---关闭selinux</a>
</li>
<li>
<a href="#toc_32">04. 模板机优化配置---关闭iptables</a>
</li>
<li>
<a href="#toc_33">05. 模板机优化配置---精简开机自启动服务</a>
</li>
<li>
<a href="#toc_34">06. 模板机优化配置---提权oldboy可以sudo</a>
</li>
<li>
<a href="#toc_35">07. 模板机优化配置---英文字符集</a>
</li>
<li>
<a href="#toc_36">08. 模板机优化配置---时间同步</a>
</li>
<li>
<a href="#toc_37">09. 模板机优化配置---命令行安全（可不设置）</a>
</li>
<li>
<a href="#toc_38">10. 模板机优化配置---加大文件描述</a>
</li>
<li>
<a href="#toc_39">11. 模板机优化配置---内核优化</a>
</li>
<li>
<a href="#toc_40">12. 模板机优化配置---安装其他小软件</a>
</li>
<li>
<a href="#toc_41">13. 模板机优化配置---ssh连接速度慢优化</a>
</li>
</ul>
</li>
<li>
<a href="#toc_42">六、系统优化总结：</a>
</li>
<li>
<a href="#toc_43">七、模板机优化完毕后检查</a>
</li>
</ul>


<hr/>

<h2 id="toc_0">一、期中架构组成部分，与实现技术</h2>

<h3 id="toc_1">01. 用户---顾客</h3>

<pre><code>进行访问网站信息
</code></pre>

<h3 id="toc_2">02. 防火墙---保安</h3>

<pre><code>对访问的请求或者数据流量，进行策略的控制，正常的访问流量放行通过，异常的访问流量阻止通行
</code></pre>

<h3 id="toc_3">03. 交换机（网络架构）---对讲机</h3>

<pre><code>实现多台主机之间的互连通讯
</code></pre>

<h3 id="toc_4">04. 负载均衡---迎宾</h3>

<pre><code>对访问的请求，进行相应的调度或分配，调度或分配给后端的设备（服务员）
为了避免单点故障，需要实现主备互联功能，由主设备提供服务；决定主设备身份，利用标记心得方法
主备互联的线称为心跳线；
通过利用心标记的方式，进行主备切换，对用户访问来说没有任何变化
</code></pre>

<h3 id="toc_5">05. Web服务器---服务员</h3>

<pre><code>对用户提出的请求，进行相应的处理
相同的服务器完成相同的工作，就成为是一个集群；需要有多台web服务器，即成为web集群
</code></pre>

<h3 id="toc_6">06. 数据库---厨师01</h3>

<pre><code>网站上面字符串信息，主要就是存储在数据库当中（网站本身字符信息，用户创建出来的字符信息）
存储到数据库当中的数据信息，是不能丢失的
</code></pre>

<h3 id="toc_7">07. 存储---厨师02</h3>

<pre><code>网站上面图片 视频 附件等等，主要就是存储在存储设备中（网站本身图片信息，用户创建出来的图片信息）
存储到存储设备当中的数据信息，也是不能丢失的
</code></pre>

<h3 id="toc_8">08. 备份服务---厨师03</h3>

<pre><code>对网站服务器中重要数据进行统一备份管理
</code></pre>

<h3 id="toc_9">09. 缓存服务---厨师04</h3>

<pre><code>将数据信息存储到内存中；内存的读写速率要比硬盘的读写速率快，对高并发访问能够提升效率。
内存中主要存储的数据为经常需要读取访问的热点数据
</code></pre>

<hr/>

<h2 id="toc_10">二、期中架构扩展部分</h2>

<h3 id="toc_11">01. 运维人员---内部员工</h3>

<h3 id="toc_12">02. vpn---秘密通道</h3>

<pre><code>通过内部运维人员可以通行进入架构中，管理服务器
</code></pre>

<h3 id="toc_13">03. 监管---跳板机</h3>

<pre><code> 1. 记录登录到架构中的人员信息
 2. 记录登录人员所操作的命令配置信息（日志历史命令 录屏功能 实时监控屏幕功能） 
</code></pre>

<h3 id="toc_14">04. 批量管理设备</h3>

<pre><code>对架构中服务设备进行统一批量操作管理（实现自动化）
</code></pre>

<h3 id="toc_15">05. 监控设备---经理</h3>

<pre><code>监控架构服务器设备的异常情况，进行及早报警并进行修复
</code></pre>

<hr/>

<h2 id="toc_16">三、架构部署过程</h2>

<h3 id="toc_17">01. 搞定备份服务器</h3>

<pre><code> rsync备份软件
</code></pre>

<h3 id="toc_18">02. 搞定存储服务器</h3>

<pre><code> NFS存储服务软件
</code></pre>

<h3 id="toc_19">03. 进行数据备份的方法</h3>

<pre><code> 定时任务进行数据备份：rsync+crond
 实时任务进行数据备份：rsync+inotify/sersync
</code></pre>

<h3 id="toc_20">04. 批量管理服务器</h3>

<pre><code> ssh+key（免秘钥） ansible saltstack
</code></pre>

<h3 id="toc_21">05. 服务员-Web服务器</h3>

<pre><code> nginx（web功能） apache（视频）
</code></pre>

<h3 id="toc_22">06. LNMP架构</h3>

<pre><code> Linux nginx MySQL PHP
</code></pre>

<h3 id="toc_23">07. 负载均衡服务器</h3>

<pre><code> nginx（负载&amp;&amp;反向代理功能）
</code></pre>

<hr/>

<h2 id="toc_24">四、架构部署虚拟环境准备</h2>

<h3 id="toc_25">01. 确认网络情况</h3>

<pre><code>eth0(外网网卡)---网卡1（NAT-VMnet8）---10.0.0.0/24网关设置为：10.0.0.254
eth1（内网网卡）---网卡2（LAN区段） --172.16.1.0/24
</code></pre>

<h3 id="toc_26">02. 虚拟主机当中设置IP地址信息</h3>

<pre><code>eth0 10.0.0.200/2410.0.0.254
eth1 172.16.1.200/24
</code></pre>

<h3 id="toc_27">03. 测试虚拟模板机能正常访问外网</h3>

<pre><code>[root@oldboyedu38 ~]# ping www.baidu.com 
2 packets transmitted, 2 received, 0% packet loss, time 1666ms
rtt min/avg/max/mdev = 3.767/4.765/5.764/1.000 ms
</code></pre>

<hr/>

<h2 id="toc_28">五、系统优化介绍：（模板机配置）</h2>

<h3 id="toc_29">01. 模板机优化配置---hosts文件配置</h3>

<pre><code>\cp /etc/hosts{,.bak}
cat &gt;/etc/hosts&lt;&lt;EOF
127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4
::1 localhost localhost.localdomain localhost6 localhost6.localdomain6
172.16.1.5lb01
172.16.1.6lb02
172.16.1.7web01
172.16.1.8web02
172.16.1.51 db01 db01.etiantian.org
172.16.1.31 nfs01
172.16.1.41 backup
172.16.1.61 m01
EOF
</code></pre>

<h3 id="toc_30">02. 模板机优化配置---更改yum源</h3>

<pre><code>#更改yum源

[ -f /etc/yum.repos.d/CentOS-Base.repo ] &amp;&amp; mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup &amp;&amp;\
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
[ -f /etc/yum.repos.d/epel.repo ] &amp;&amp; mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup
[ -f /etc/yum.repos.d/epel-testing.repo ] &amp;&amp;mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
</code></pre>

<p>PS：yum repolist 列出yum源信息；讲解什么是epel源</p>

<h3 id="toc_31">03. 模板机优化配置---关闭selinux</h3>

<pre><code>#关闭selinux

sed -i.bak &#39;s/SELINUX=enforcing/SELINUX=disabled/&#39; /etc/selinux/config
grep SELINUX=disabled /etc/selinux/config 
setenforce 0
getenforce
</code></pre>

<h3 id="toc_32">04. 模板机优化配置---关闭iptables</h3>

<pre><code>#关闭iptables 

/etc/init.d/iptables stop
/etc/init.d/iptables stop
chkconfig iptables off
</code></pre>

<h3 id="toc_33">05. 模板机优化配置---精简开机自启动服务</h3>

<pre><code>#精简开机自启动服务

export LANG=en
chkconfig|egrep -v &quot;crond|sshd|network|rsyslog|sysstat&quot;|awk &#39;{print &quot;chkconfig&quot;,$1,&quot;off&quot;}&#39;|bash
chkconfig --list|grep 3:on
</code></pre>

<h3 id="toc_34">06. 模板机优化配置---提权oldboy可以sudo</h3>

<pre><code>#提权oldboy可以sudo(可选配置)

useradd oldboy
echo 123456|passwd --stdin oldboy
\cp /etc/sudoers /etc/sudoers.ori
echo &quot;oldboyALL=(ALL) NOPASSWD: ALL &quot; &gt;&gt;/etc/sudoers
tail -1 /etc/sudoers
visudo -c
</code></pre>

<h3 id="toc_35">07. 模板机优化配置---英文字符集</h3>

<pre><code>#英文字符集

cp /etc/sysconfig/i18n /etc/sysconfig/i18n.ori
echo &#39;LANG=&quot;en_US.UTF-8&quot;&#39;&gt;/etc/sysconfig/i18n 
source /etc/sysconfig/i18n
echo $LANG
</code></pre>

<h3 id="toc_36">08. 模板机优化配置---时间同步</h3>

<pre><code>#时间同步

echo &#39;#time sync by lidao at 2017-03-08&#39; &gt;&gt;/var/spool/cron/root
echo &#39;*/5 * * * * /usr/sbin/ntpdate pool.ntp.org &gt;/dev/null 2&gt;&amp;1&#39; &gt;&gt;/var/spool/cron/root
crontab -l
</code></pre>

<h3 id="toc_37">09. 模板机优化配置---命令行安全（可不设置）</h3>

<pre><code>#命令行安全（可不设置）

echo &#39;export TMOUT=300&#39; &gt;&gt;/etc/profile
echo &#39;export HISTSIZE=5&#39; &gt;&gt;/etc/profile
echo &#39;export HISTFILESIZE=5&#39; &gt;&gt;/etc/profile
tail -3 /etc/profile
. /etc/profile
</code></pre>

<h3 id="toc_38">10. 模板机优化配置---加大文件描述</h3>

<pre><code>#加大文件描述

echo &#39;* - nofile65535 &#39; &gt;&gt;/etc/security/limits.conf 
tail -1 /etc/security/limits.conf 
</code></pre>

<h3 id="toc_39">11. 模板机优化配置---内核优化</h3>

<pre><code>#内核优化

cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF
net.ipv4.tcp_fin_timeout = 2
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.ip_local_port_range = 400065000
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.route.gc_timeout = 100
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_synack_retries = 1
net.core.somaxconn = 16384
net.core.netdev_max_backlog = 16384
net.ipv4.tcp_max_orphans = 16384

#以下参数是对iptables防火墙的优化，防火墙不开会提示，可以忽略不理。

net.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_tcp_timeout_established = 180
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
EOF
sysctl -p
</code></pre>

<h3 id="toc_40">12. 模板机优化配置---安装其他小软件</h3>

<pre><code>#安装其他小软件

yum install lrzsz nmap tree dos2unix nc telnet sl -y
</code></pre>

<h3 id="toc_41">13. 模板机优化配置---ssh连接速度慢优化</h3>

<pre><code>#ssh连接速度慢优化

sed -i.bak &#39;s@#UseDNS yes@UseDNS no@g;s@^GSSAPIAuthentication yes@GSSAPIAuthentication no@g&#39;/etc/ssh/sshd_config
/etc/init.d/sshd reload
</code></pre>

<hr/>

<h2 id="toc_42">六、系统优化总结：</h2>

<pre><code>01. 不用root登录管理系统，而以普通用户登录通过sudo授权管理。
02. 更改默认的远程连接SSH服务端口，禁止root用户远程连接，甚至要更改SSH服务只监听内网IP。
03. 定时自动更新服务器的时间，使其和互联网时间同步。
04. 配置yum更新源，从国内更新源下载安装软件包。
05. 关闭SELinux及iptables（在工作场景中，如果有外部IP一般要打开iptables，高并发高流量的服务器可能无法开启）。
06. 调整文件描述符的数量，进程及文件的打开都会消耗文件描述符数量。
07. 定时自动清理邮件临时目录垃圾文件，防止磁盘的inodes数被小文件占满（注意Centos6和Centos5要清除的目录不同）。
08. 精简并保留必要的开机自启动服务（如crond、sshd、network、rsyslog、sysstat）。
09. Linux内核参数优化/etc/sysctl.conf，执行sysctl -p生效。
10. 更改系统字符集为“zh_CN.UTF-8”，使其支持中文，防止出现乱码问题。
11. 锁定关键系统文件如/etc/passwd、/etc/shadow、/etc/group、/etc/gshadow、/etc/inittab， 处理以上内容后把chattr、lsattr改名为oldboy，转移走，这样就安全多了。
12. 清空/etc/issue、/etc/issue.net，去除系统及内核版本登录前的屏幕显示。
13. 清除多余的系统虚拟用户账号。
14. 为grub引导菜单加密码。
15. 禁止主机被ping。
16. 打补丁并升级有已知漏洞的软件。
</code></pre>

<hr/>

<h2 id="toc_43">七、模板机优化完毕后检查</h2>

<pre><code>1. cat /etc/udev/rules.d/70-persistent-net.rules 
2. 检查selinux是否关闭
3. 检查防火墙是否关闭
4. 查看网卡信息
5. 查看ssh连接是否正确
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-27T01:03:22+08:00" itemprop="datePublished">2017/7/27</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010886029579.html" itemprop="url">
		全网备份案例</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h2 id="toc_0">备份全网服务器数据生产架构方案案例模型</h2>

<pre><code>做一个周期性定时备份,要求如下:
每天网上00点整在web服务器A(web01)上打包备份网站程序目录,并通过rsync命令推送到服务器B(backup)上备份保留(备份思路:可以是先在本地按日期打包,然后再利用rsync推送到备份服务器上)
</code></pre>

<pre><code>具体要求如下:
1)web服务器A和备份服务器B的备份目录必须都为/backup
2)web服务器A站点目录假定为(/var/www/html)
3)web服务器A本地仅保留7天内的备份
4)备份服务器上[每周六的数据都保留],其他备份仅保留180天备份
5)备份服务器上检查备份结果是否正常,并将每天的备份结果发给管理员信箱
</code></pre>

<hr/>

<h2 id="toc_1">backup+web01</h2>

<h3 id="toc_2">一 backup是服务端</h3>

<pre><code>谁是rsync的服务端和客户端
</code></pre>

<hr/>

<h3 id="toc_3">二 搭建好rsync服务端和客户端,并且测试</h3>

<pre><code>服务端 -- backup   172.16.1.41
客户端 -- web01    172.16.1.8
</code></pre>

<hr/>

<h4 id="toc_4">服务端</h4>

<p>1.检查是否安装</p>

<pre><code>rpm -qa rsync
</code></pre>

<p>2.添加虚拟用户 rsync</p>

<pre><code>useradd -s /sbin/nologin -M rsync
id rsync        #检查是否添加成功
</code></pre>

<p>3.创建目录,并修改目录的属主与属组</p>

<pre><code>mkdir /backup
chown rsync.rsync /backup
</code></pre>

<p>4.创建密码文件并修改权限</p>

<pre><code>echo &#39;rsync_backup:123456&#39; &gt;/etc/rsync.password
chmod 600 /etc/rsync.password
</code></pre>

<p>5.创建配置文件</p>

<pre><code>cat /etc/rsyncd.conf
</code></pre>

<h4 id="toc_5">客户端</h4>

<p>创建密码文件并修改权限</p>

<pre><code>echo &#39;123456&#39; &gt;/etc/rsync.password
chmod 600 /etc/rsync.password
</code></pre>

<h3 id="toc_6">三 打包备份web01上面的数据</h3>

<blockquote>
<p>/var/www/html<br/>
/etc/rc.local<br/>
/etc/hosts<br/>
/var/spool/cron/</p>
</blockquote>

<p><code>创建本机备份目录</code></p>

<pre><code>mkdir -p /var/www/heml/ /backup
</code></pre>

<h4 id="toc_7">web01上面的备份命令</h4>

<pre><code>tar zchf /backup/conf-$(date +%F -d &quot;-1day&quot;).tar.gz /etc/rc.local
tar zchf /backup/html-$(date +%F -d &quot;-1day&quot;).tar.gz /var/www/html
</code></pre>

<h3 id="toc_8">四 验证web01-md5sum-给压缩包加上指纹</h3>

<p><code>手动指定文件 创建指纹</code></p>

<pre><code>md5sum conf-$(date +%F-d &quot;-1day&quot;).tar.gz
</code></pre>

<p><code>根据find命令找到的文件 创建指纹</code></p>

<pre><code>find /backup/ -type f -name &quot;*.tar.gz&quot;

</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T21:54:13+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010772533002.html" itemprop="url">
		六、目录结构</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">前言</a>
<ul>
<li>
<a href="#toc_1">1.1 Linux系统目录结构的基本特点介绍</a>
</li>
<li>
<a href="#toc_2">1.2 挂载过程</a>
</li>
<li>
<a href="#toc_3">1.3 相对路径与绝对路径</a>
</li>
<li>
<a href="#toc_4">1.4 目录结构记录</a>
</li>
<li>
<a href="#toc_5">1.6 相关文件说明</a>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">前言</h2>

<pre><code>    linux 目录结构
        一切从跟开始
    其实,Linux系统的目录结构知识是很简单的, Linux的系统的目录结构却是很有规律性\组织性的。
</code></pre>

<h3 id="toc_1">1.1 Linux系统目录结构的基本特点介绍</h3>

<ul>
<li>Linux目录：  一切从&quot;根&quot;开始,&quot;/&quot;是所有目录的起点(顶点):相对路径(目录)和绝对路径(目录)?</li>
<li>Linux根下面的目录是一个有层次的树状结构</li>
<li>倒挂的一棵树</li>
<li>Linux每个目录可以挂在在不同的设备(磁盘)上。</li>
<li>在逻辑上所有的目录(包括目录下的子目录)都在最高级别的目录&quot;/&quot;都在最高级别的目录&quot;/&quot;下</li>
<li>Linux 下面设备不挂载是看不到入口的,没有窗口没有门店额监狱,如果要设备被访问就必须有个入口,这个入口就是挂载点,挂载点实质就是目录</li>
</ul>

<pre><code>下面以光驱设备=====&gt;/cd/cdrom 为例.
</code></pre>

<h3 id="toc_2">1.2 挂载过程</h3>

<pre><code>什么是挂载----给磁盘/光盘开门
</code></pre>

<ul>
<li>mount /dev/cdrom  /mnt </li>
<li>linux每个目录可以挂载在不同的设备（磁盘）上。</li>
<li>对于linux来说每个设备（硬盘 光盘）不挂载不能使用。</li>
<li><p>linux 下面光盘 磁盘（设备） 不挂载 不能使用</p></li>
<li><p>光盘挂载过程</p></li>
</ul>

<pre><code>[root@oldboyedu38 ~]# ##光盘----/dev/cdrom
[root@oldboyedu38 ~]# ll /dev/cdrom
lrwxrwxrwx 1 root root 3 Jun 10 12:58 /dev/cdrom -&gt; sr0
[root@oldboyedu38 ~]# cd /dev/cdrom
-bash: cd: /dev/cdrom: Not a directory
[root@oldboyedu38 ~]# cat /dev/cdrom 
3??|?f1?SfQW?ē?|?1樫R′A?aU1??r鳐?
                               f?φ′B閫ZQ??Q??P?P?|1f?°焂f@??&gt;@|篵  ?D|肩solinux.bin missing or corrupt.
f`f1???Sjj姷6缀??x?dfa?Operating system load error.
^?′&gt;b3?&lt;
u??
                  CentOS Project                                                                                                                  CentOS                                                                                                                          CentOS_6.9_Final   
</code></pre>

<pre><code>给光盘开一个门 让我们进去
</code></pre>

<ul>
<li>挂载</li>
</ul>

<pre><code>[root@oldboyedu38 ~]#mount /dev/cdrom /mnt/
mount: block device /dev/sr0 is write-protected, mounting read-only
</code></pre>

<ul>
<li>你只有对这个光盘进行查看的权限 (只读权限)</li>
</ul>

<pre><code>[root@oldboyedu38 ~]# cd /mnt/
[root@oldboyedu38 mnt]# ls -l
</code></pre>

<h3 id="toc_3">1.3 相对路径与绝对路径</h3>

<ul>
<li><p>相对路径</p>

<pre><code>相对于哪里?
相对于你当前的位置
</code></pre></li>
</ul>

<h3 id="toc_4">1.4 目录结构记录</h3>

<table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>* /bin</td>
<td>常用二进制命令</td>
</tr>
<tr>
<td>* /boot</td>
<td>引导+内核</td>
</tr>
<tr>
<td>* /dev</td>
<td>硬件设备</td>
</tr>
<tr>
<td>* /etc</td>
<td>二进制软件包配置文件默认路径</td>
</tr>
<tr>
<td>* /etc/sysconfig</td>
<td></td>
</tr>
<tr>
<td>* /etc/sysconfig/network-scripts/ifcfg-eth0</td>
<td>第一块网卡</td>
</tr>
<tr>
<td>* /etc/sysconfig/network</td>
<td>主机名配置文件</td>
</tr>
<tr>
<td>* /etc/sysconfig/i18n</td>
<td>字符集配置文件</td>
</tr>
<tr>
<td>* /etc/init.d</td>
<td>系统的软件/服务的管理命令</td>
</tr>
<tr>
<td>* /etc/init.d/iptables</td>
<td>防火墙</td>
</tr>
<tr>
<td>* /etc/profile</td>
<td>系统环境变量别名</td>
</tr>
<tr>
<td>* /etc/selinux/config</td>
<td>SElinux 配置文件</td>
</tr>
<tr>
<td>* /etc/inittab</td>
<td>运行界别的配置文件</td>
</tr>
<tr>
<td>* /etc/resolv.conf</td>
<td>DNS配置文件</td>
</tr>
<tr>
<td>* /etc/bashrc</td>
<td>别名的存放位置</td>
</tr>
<tr>
<td>* /etc/fstab</td>
<td>开机自动挂在分区/磁盘</td>
</tr>
<tr>
<td>* /etc/rc.local</td>
<td>存放开机自启动的程序或命令</td>
</tr>
<tr>
<td>* /etc/hosts</td>
<td>ip 与主机名解析关系</td>
</tr>
<tr>
<td>* /home</td>
<td>普通用户的家目录</td>
</tr>
<tr>
<td>* /lib</td>
<td>libary库 库文件</td>
</tr>
<tr>
<td>* /lib64</td>
<td>64位系统 64位库文件</td>
</tr>
<tr>
<td>* /lost + found</td>
<td>文件碎片，临时文件</td>
</tr>
<tr>
<td>* /media</td>
<td>可移动媒体设备</td>
</tr>
<tr>
<td>* /mnt</td>
<td>临时挂载点</td>
</tr>
<tr>
<td>* /opt（option）</td>
<td>可选择的软件包安装目录</td>
</tr>
<tr>
<td>* /proc</td>
<td>进程与系统内核信息</td>
</tr>
<tr>
<td>* /proc/mounts</td>
<td>系统挂在信息</td>
</tr>
<tr>
<td>* /proc/loadavg</td>
<td>系统负载信息</td>
</tr>
<tr>
<td>* /proc/meminfo</td>
<td>系统内存信息</td>
</tr>
<tr>
<td>* /proc/cpuinfo</td>
<td>系统 CPU信息</td>
</tr>
<tr>
<td>* /root</td>
<td>root 用户的家目录</td>
</tr>
<tr>
<td>* /sbin</td>
<td>系统级命令</td>
</tr>
<tr>
<td>* /selinux</td>
<td>SElinux 及他的配置文件</td>
</tr>
<tr>
<td>* /srv</td>
<td>服务数据</td>
</tr>
<tr>
<td>* /sys</td>
<td>虚拟目录,内存信息</td>
</tr>
<tr>
<td>* /tmp</td>
<td>临时文件</td>
</tr>
<tr>
<td>* /usr</td>
<td>官方软件包安装目录</td>
</tr>
<tr>
<td>* /usr/local</td>
<td>编译安装时候默认的安装位置</td>
</tr>
<tr>
<td>* /var</td>
<td>日志与操作信息</td>
</tr>
<tr>
<td>* /var/log/message</td>
<td>系统普通的日志</td>
</tr>
<tr>
<td>* /var/log/secure</td>
<td>用户登录的信息</td>
</tr>
</tbody>
</table>

<p>思维导图<br/>
<img src="media/15010772533002/15010774417030.jpg" alt=""/></p>

<h3 id="toc_5">1.6 相关文件说明</h3>

<ul>
<li>网卡配置文件说明</li>
</ul>

<pre><code>DEVICE=eth0                     #&lt;==物理设备名，eth0表示第1块网卡
**HWADDR=00:0c:29:ba:8e:8f      #&lt;==网卡的MAC地址(网卡的身份证号码)，48位，网卡的物理地址。
**ONBOOT=yes                    #&lt;==重启网卡或者服务器之后控制网卡是不是自动启动
**BOOTPROTO=none                #&lt;==你获取ip地址的方法或途径,其中，proto取下列值之一：none，引导时不使用协议；
static                          #&lt;==静态分配地址；你使用的是固定的ip地址。
dhcp                            #&lt;==使用DHCP协议  你使用的ip地址是自动获取的。
***IPADDR=10.0.0.200            #&lt;==addr是IP地址。10.0.0.0/24
NETMASK=255.255.255.0           #&lt;==子网掩码，划分网络位和主机位。
***DNS1=10.0.0.2                #&lt;==DNS1
DNS2=223.5.5.5                  #&lt;==DNS把baidu.com变成了baidu服务器IP。DNS就是域名和IP的解析工具。
GATEWAY=10.0.0.2                #&lt;==默认的出口，网关地址，路由器的地址。
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T21:39:14+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010763542152.html" itemprop="url">
		四、远程连接排错</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">第一章 课前思想</a>
</li>
<li>
<a href="#toc_1">第二章 基本信息</a>
</li>
<li>
<a href="#toc_2">第三章 远程连接排错方法</a>
<ul>
<li>
<a href="#toc_3">1. 看路是否畅通</a>
</li>
<li>
<a href="#toc_4">2. 是否有人打劫</a>
</li>
<li>
<a href="#toc_5">3. 是否有人提供服务</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">流程图</a>
</li>
</ul>


<h2 id="toc_0">第一章 课前思想</h2>

<blockquote>
<p>说出来<br/>
  写出来<br/>
  张开嘴，勤动手</p>
</blockquote>

<h2 id="toc_1">第二章 基本信息</h2>

<blockquote>
<p>ip              ip地址<br/>
  port                端口<br/>
  protocol            协议</p>
</blockquote>

<h2 id="toc_2">第三章 远程连接排错方法</h2>

<h3 id="toc_3">1. 看路是否畅通</h3>

<pre><code>ping 10.0.0.200
</code></pre>

<h3 id="toc_4">2. 是否有人打劫</h3>

<p>防火墙与 SElinux拦截(目前直接关闭防火墙,后期更新)</p>

<pre><code>[root@oldboy ~]# /etc/init.d/iptables status    #&lt;==检查防火墙是否关闭
iptables: Firewall is not running.          #&lt;==防火墙未运行
[root@oldboy ~]# getenforce             #&lt;==检查 SElinux 是否关闭
Disabled                                #&lt;==关闭状态
</code></pre>

<hr/>

<h3 id="toc_5">3. 是否有人提供服务</h3>

<pre><code>    询问服务器是否提供SSHD服务
    telnet 10.0.0.200 22                #&lt;===在 ssh 客户端或 Windows命令行中
</code></pre>

<h2 id="toc_6">流程图</h2>

<p><img src="media/15010763542152/15010771296061.jpg" alt=""/></p>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T20:30:57+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010722570462.html" itemprop="url">
		三、虚拟机安装与CentOS的环境部署</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">第1章 在虚拟机中部署CentOS环境</a>
<ul>
<li>
<a href="#toc_1">1.1 安装VMware虚拟机</a>
</li>
<li>
<a href="#toc_2">1.2 在VMware中建立CentOS虚拟机环境</a>
<ul>
<li>
<a href="#toc_3">1.2.1 打开VMware点新建虚拟机.&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_4">1.2.2 选择自定义；然后点下一步。</a>
</li>
<li>
<a href="#toc_5">1.2.3 硬件兼容选择默认&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_6">1.2.4 操作系统选择稍后安装&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_7">1.2.5 选择Linux（L）&lt;如图 &gt;</a>
</li>
<li>
<a href="#toc_8">1.2.6 为虚拟机命名和选择保存途径和位置&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_9">1.2.7 为虚拟机配置CPU默认即可&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_10">1.2.8 为虚拟机配置内存.够用即可，虚拟内存不得超过本机。</a>
</li>
<li>
<a href="#toc_11">1.2.9 网络类型选择，在这里我们选择NAT 方便后面Xshell连接 因为NAT模式ip不会变动&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_12">1.2.10 I/O控制类型和磁盘选择默认就好&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_13">1.2.11 磁盘容量分配 将磁盘拆分成多个文件</a>
</li>
<li>
<a href="#toc_14">1.2.12 磁盘储存选择默认；保存到前面创的途径即可,&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_15">1.2.13 看好配置；点完成即可&lt;如图&gt;</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_16">第2章 CentOS的安装</a>
<ul>
<li>
<a href="#toc_17">2.1 选中你创建的虚拟机 点击右侧设备界面双击CD/DVD(IDE)&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_18">2.2 选择我们要安装Centos系统镜像 选择完成并点击确定&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_19">2.3 打开虚拟机&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_20">2.4 虚拟机开启后 进入到系统安装界面 选择第一项（全新安装或升级安装） 然后回车,&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_21">2.5 系统测试提示 点击skip&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_22">2.6 点击下一步<next>如果没有next也可f12；但f12只限于装系统才代表下一步</a>
</li>
<li>
<a href="#toc_23">2.7 语言与键盘选择默认英文默认美式键盘&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_24">2.8 磁盘类型选择默认&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_25">2.9 提示是否保存磁盘以前的数据 点击Yes，discard any data格式化不保留数据 因为我们以前没有数据&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_26">2.10 给系统起个名字 如：oldboyedu-01&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_27">2.11 地区选择上海 下面的勾去掉不同步 要不时间会差8个小时的 然后下一步</a>
</li>
<li>
<a href="#toc_28">2.12 为root用户设置密码（root是系统最高管理员）</a>
</li>
<li>
<a href="#toc_29">2.13 选择自己最后一个Create Custom Layout 自定义创建布局 再下一步&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_30">2.14 磁盘的分区&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_31">2.15 在这里 我们给/boot 分区200M /swap交换分区768剩余的都给到/ 根分区（内存的</a>
</li>
<li>
<a href="#toc_32">2.16 提示是否格式化 点击确定&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_33">2.17 在这里选择mini 下面选择的现在定制&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_34">2.18 选择需要安装的软件包&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_35">2.19 点击下一步 系统开始安装&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_36">2.20 安装完成</a>
</li>
</ul>
</li>
<li>
<a href="#toc_37">第3章 配置CentOS</a>
<ul>
<li>
<a href="#toc_38">3.1 系统登录 然后输入setup回车显示以下界面</a>
</li>
<li>
<a href="#toc_39">3.2 选择Network conf iguration 再按回车&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_40">3.3 选择Device configuration回车&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_41">3.4 选择网卡 eth0&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_42">3.5 按照上图配置网卡</a>
</li>
<li>
<a href="#toc_43">3.6 点击Save保存&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_44">3.7 选择Save&amp;quit保存并退出&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_45">3.8 Quit退出</a>
</li>
<li>
<a href="#toc_46">3.9 启动网卡</a>
</li>
</ul>
</li>
<li>
<a href="#toc_47">第4章 Xshell配置</a>
<ul>
<li>
<a href="#toc_48">4.1 xshell的优化</a>
<ul>
<li>
<a href="#toc_49">4.1.1 选择终端 终端类型选择linux 缓冲区大小改为200000&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_50">4.1.2 选择高级 禁用更改终端标题&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_51">4.1.3 选择外观 游标300-400合适即可 字体大小调整14 可根据个人选择&lt;如图&gt;</a>
</li>
<li>
<a href="#toc_52">4.1.4 VT模式键盘设置为普通 这样才能使用小键盘&lt;如图&gt;</a>
</li>
</ul>
</li>
<li>
<a href="#toc_53">4.2 Xshell的连接配置</a>
<ul>
<li>
<a href="#toc_54">4.2.1 给这个连接起个名称</a>
</li>
<li>
<a href="#toc_55">4.2.2 输入这个服务器的地址 设置完成后点击连接 中途提示输入用户名帐号与密码确认</a>
</li>
<li>
<a href="#toc_56">4.2.3 此图为连接成功后</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">第1章 在虚拟机中部署CentOS环境</h2>

<h3 id="toc_1">1.1 安装VMware虚拟机</h3>

<h3 id="toc_2">1.2 在VMware中建立CentOS虚拟机环境</h3>

<h4 id="toc_3">1.2.1 打开VMware点新建虚拟机.&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010754168907.jpg" alt=""/></p>

<h4 id="toc_4">1.2.2 选择自定义；然后点下一步。</h4>

<p><img src="media/15010722570462/15010754866487.jpg" alt=""/></p>

<h4 id="toc_5">1.2.3 硬件兼容选择默认&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010754963301.jpg" alt=""/></p>

<h4 id="toc_6">1.2.4 操作系统选择稍后安装&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010755678758.jpg" alt=""/></p>

<h4 id="toc_7">1.2.5 选择Linux（L）&lt;如图 &gt;</h4>

<p><img src="media/15010722570462/15010755742521.jpg" alt=""/></p>

<h4 id="toc_8">1.2.6 为虚拟机命名和选择保存途径和位置&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010755888470.jpg" alt=""/></p>

<h4 id="toc_9">1.2.7 为虚拟机配置CPU默认即可&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010755971002.jpg" alt=""/></p>

<h4 id="toc_10">1.2.8 为虚拟机配置内存.够用即可，虚拟内存不得超过本机。</h4>

<p><img src="media/15010722570462/15010756048810.jpg" alt=""/></p>

<h4 id="toc_11">1.2.9 网络类型选择，在这里我们选择NAT 方便后面Xshell连接 因为NAT模式ip不会变动&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010756116179.jpg" alt=""/></p>

<h4 id="toc_12">1.2.10 I/O控制类型和磁盘选择默认就好&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010756329062.jpg" alt=""/><br/>
<img src="media/15010722570462/15010756388072.jpg" alt=""/></p>

<h4 id="toc_13">1.2.11 磁盘容量分配 将磁盘拆分成多个文件</h4>

<p><img src="media/15010722570462/15010756494776.jpg" alt=""/></p>

<h4 id="toc_14">1.2.12 磁盘储存选择默认；保存到前面创的途径即可,&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010756903553.jpg" alt=""/></p>

<h4 id="toc_15">1.2.13 看好配置；点完成即可&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010756962605.jpg" alt=""/></p>

<h2 id="toc_16">第2章 CentOS的安装</h2>

<h3 id="toc_17">2.1 选中你创建的虚拟机 点击右侧设备界面双击CD/DVD(IDE)&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757037378.jpg" alt=""/></p>

<h3 id="toc_18">2.2 选择我们要安装Centos系统镜像 选择完成并点击确定&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757104735.jpg" alt=""/></p>

<h3 id="toc_19">2.3 打开虚拟机&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757160077.jpg" alt=""/></p>

<h3 id="toc_20">2.4 虚拟机开启后 进入到系统安装界面 选择第一项（全新安装或升级安装） 然后回车,&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757226820.jpg" alt=""/><br/>
<img src="media/15010722570462/15010757272470.jpg" alt=""/></p>

<h3 id="toc_21">2.5 系统测试提示 点击skip&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757335401.jpg" alt=""/></p>

<h3 id="toc_22">2.6 点击下一步<next>如果没有next也可f12；但f12只限于装系统才代表下一步</h3>

<h3 id="toc_23">2.7 语言与键盘选择默认英文默认美式键盘&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757406529.jpg" alt=""/><br/>
<img src="media/15010722570462/15010757462669.jpg" alt=""/></p>

<h3 id="toc_24">2.8 磁盘类型选择默认&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757519291.jpg" alt=""/></p>

<h3 id="toc_25">2.9 提示是否保存磁盘以前的数据 点击Yes，discard any data格式化不保留数据 因为我们以前没有数据&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757607190.jpg" alt=""/></p>

<h3 id="toc_26">2.10 给系统起个名字 如：oldboyedu-01&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757667824.jpg" alt=""/></p>

<h3 id="toc_27">2.11 地区选择上海 下面的勾去掉不同步 要不时间会差8个小时的 然后下一步</h3>

<p><img src="media/15010722570462/15010757724120.jpg" alt=""/></p>

<h3 id="toc_28">2.12 为root用户设置密码（root是系统最高管理员）</h3>

<p><img src="media/15010722570462/15010757788571.jpg" alt=""/></p>

<h3 id="toc_29">2.13 选择自己最后一个Create Custom Layout 自定义创建布局 再下一步&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757843807.jpg" alt=""/></p>

<h3 id="toc_30">2.14 磁盘的分区&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010757902577.jpg" alt=""/></p>

<h3 id="toc_31">2.15 在这里 我们给/boot 分区200M /swap交换分区768剩余的都给到/ 根分区（内存的</h3>

<p>1.5倍 因为安装完成将内存更改为512M）&lt;如图&gt;<br/>
<img src="media/15010722570462/15010757966670.jpg" alt=""/></p>

<h3 id="toc_32">2.16 提示是否格式化 点击确定&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758019847.jpg" alt=""/></p>

<h3 id="toc_33">2.17 在这里选择mini 下面选择的现在定制&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758072345.jpg" alt=""/></p>

<h3 id="toc_34">2.18 选择需要安装的软件包&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758122805.jpg" alt=""/><br/>
<img src="media/15010722570462/15010758160792.jpg" alt=""/></p>

<h3 id="toc_35">2.19 点击下一步 系统开始安装&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758221787.jpg" alt=""/></p>

<h3 id="toc_36">2.20 安装完成</h3>

<p><img src="media/15010722570462/15010758307932.jpg" alt=""/></p>

<h2 id="toc_37">第3章 配置CentOS</h2>

<h3 id="toc_38">3.1 系统登录 然后输入setup回车显示以下界面</h3>

<p><img src="media/15010722570462/15010758364058.jpg" alt=""/></p>

<h3 id="toc_39">3.2 选择Network conf iguration 再按回车&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758409857.jpg" alt=""/></p>

<h3 id="toc_40">3.3 选择Device configuration回车&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758467946.jpg" alt=""/></p>

<h3 id="toc_41">3.4 选择网卡 eth0&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758518600.jpg" alt=""/></p>

<h3 id="toc_42">3.5 按照上图配置网卡</h3>

<p><img src="media/15010722570462/15010758567814.jpg" alt=""/></p>

<h3 id="toc_43">3.6 点击Save保存&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758614615.jpg" alt=""/></p>

<h3 id="toc_44">3.7 选择Save&amp;quit保存并退出&lt;如图&gt;</h3>

<p><img src="media/15010722570462/15010758667246.jpg" alt=""/></p>

<h3 id="toc_45">3.8 Quit退出</h3>

<p><img src="media/15010722570462/15010758711070.jpg" alt=""/></p>

<h3 id="toc_46">3.9 启动网卡</h3>

<p>输入命令: <br/>
 #开启网卡<br/>
<code>ifup eth0</code><br/>
 #重启网卡<br/>
<code>ifdown eth0 &amp;&amp; ifup eth0</code> <br/>
 #查看网卡信息<br/>
 <code>ifconfig</code></p>

<h2 id="toc_47">第4章 Xshell配置</h2>

<h3 id="toc_48">4.1 xshell的优化</h3>

<p><img src="media/15010722570462/15010758825224.jpg" alt=""/></p>

<h4 id="toc_49">4.1.1 选择终端 终端类型选择linux 缓冲区大小改为200000&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010761295527.jpg" alt=""/></p>

<h4 id="toc_50">4.1.2 选择高级 禁用更改终端标题&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010761371706.jpg" alt=""/></p>

<h4 id="toc_51">4.1.3 选择外观 游标300-400合适即可 字体大小调整14 可根据个人选择&lt;如图&gt;</h4>

<p><img src="media/15010722570462/15010761436739.jpg" alt=""/></p>

<h4 id="toc_52">4.1.4 VT模式键盘设置为普通 这样才能使用小键盘&lt;如图&gt;</h4>

<h3 id="toc_53">4.2 Xshell的连接配置</h3>

<p><img src="media/15010722570462/15010761504457.jpg" alt=""/></p>

<h4 id="toc_54">4.2.1 给这个连接起个名称</h4>

<h4 id="toc_55">4.2.2 输入这个服务器的地址 设置完成后点击连接 中途提示输入用户名帐号与密码确认</h4>

<p>即可&lt;如图&gt;<br/>
<img src="media/15010722570462/15010761687034.jpg" alt=""/></p>

<h4 id="toc_56">4.2.3 此图为连接成功后</h4>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T20:14:42+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010712824389.html" itemprop="url">
		一、计算机系统硬件核心知识</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">1. 硬件</a>
<ul>
<li>
<a href="#toc_1">a. 优化硬盘是运维人员的最重要的手段之一</a>
<ul>
<li>
<a href="#toc_2">i. 机械硬盘</a>
<ul>
<li>
<a href="#toc_3">1. IDE</a>
</li>
<li>
<a href="#toc_4">2. SCSI</a>
</li>
<li>
<a href="#toc_5">3. SAS</a>
</li>
<li>
<a href="#toc_6">4. SATA</a>
</li>
</ul>
</li>
<li>
<a href="#toc_7">ii. 固态硬盘(电子器械)</a>
<ul>
<li>
<a href="#toc_8">1. SSD</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_9">b. 优化时尽量不用硬盘,不找硬盘</a>
</li>
<li>
<a href="#toc_10">c. 我们在做运维工程师的时候,我们会尽量做优化,让所有的数据都放到内存里面,在给用户提供服务</a>
</li>
</ul>
</li>
<li>
<a href="#toc_11">2. 运维职责</a>
<ul>
<li>
<a href="#toc_12"><mark>a. 网站不当机</mark></a>
</li>
<li>
<a href="#toc_13"><mark>b. 数据不能丢</mark></a>
</li>
<li>
<a href="#toc_14"><mark>c. 用户体验尽量好——加快访问速度</mark></a>
</li>
</ul>
</li>
<li>
<a href="#toc_15">3. 服务器</a>
<ul>
<li>
<a href="#toc_16">a. 服务器体型</a>
<ul>
<li>
<a href="#toc_17">i. 长度与宽度统一</a>
</li>
<li>
<a href="#toc_18">ii. 高度单位为U（1U = 4.45cm）</a>
</li>
</ul>
</li>
<li>
<a href="#toc_19">b. 服务器分类</a>
<ul>
<li>
<a href="#toc_20">i. 机架式服务器（最常用的服务器）</a>
</li>
<li>
<a href="#toc_21">ii. 刀片式服务器</a>
</li>
<li>
<a href="#toc_22">iii. 塔式服务器</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_23">4. 互联网公司常见服务器介绍</a>
<ul>
<li>
<a href="#toc_24">a. 互联网公司常见服务器品牌</a>
<ul>
<li>
<a href="#toc_25"><mark>i. Dell服务器（大果蔬公司，常用）</mark></a>
</li>
<li>
<a href="#toc_26">ii. IBM服务器（土豪专用，如百度）</a>
</li>
<li>
<a href="#toc_27">iii. HP服务器</a>
</li>
<li>
<a href="#toc_28">iv. 浪潮</a>
</li>
<li>
<a href="#toc_29">v. 联想</a>
</li>
<li>
<a href="#toc_30">vi. 航天联志</a>
</li>
</ul>
</li>
<li>
<a href="#toc_31">b. Dell服务器的常用型号</a>
</li>
<li>
<a href="#toc_32">c. 电脑和服务器的主要构成与主要零部件</a>
<ul>
<li>
<a href="#toc_33">i. 电源</a>
<ul>
<li>
<a href="#toc_34">1. 重要服务器可上AB路双电源</a>
</li>
</ul>
</li>
<li>
<a href="#toc_35">ii. CPU处理器</a>
</li>
<li>
<a href="#toc_36">iii. 内存</a>
<ul>
<li>
<a href="#toc_37">1. 临时存储器——断电后数据消失</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_38">d. 企业案例：</a>
<ul>
<li>
<a href="#toc_39">i. 磁盘</a>
<ul>
<li>
<a href="#toc_40">1. 高并发写入——应把数据优先写入到内存，积累一定的量或时间后，再定时或定量的写入到磁盘（减轻磁盘压力，减少磁盘IO（Input/Output）磁盘读写），最终还是会把数据加载到内存中再对外提供访问。</a>
<ul>
<li>
<a href="#toc_41">1、在服务器主板安装蓄电池，能在断电瞬间把内存数据回写到磁盘</a>
</li>
<li>
<a href="#toc_42">2、配备UPS（一组蓄电池）不间断电源（可以持续供电10分钟到1小时左右）。</a>
</li>
</ul>
</li>
<li>
<a href="#toc_43">2. 中小企业案例——高并发读取时，应先通过程序把数据读入到内存里，再对外提供访问服务</a>
</li>
</ul>
</li>
<li>
<a href="#toc_44">ii. 内存</a>
</li>
<li>
<a href="#toc_45">iii. 小结</a>
</li>
<li>
<a href="#toc_46">iv. Dell阵列卡（raid卡）</a>
</li>
<li>
<a href="#toc_47">v. 光驱</a>
</li>
<li>
<a href="#toc_48">vi. 主板</a>
</li>
<li>
<a href="#toc_49">vii. 机房机柜里的服务器摆放</a>
</li>
<li>
<a href="#toc_50">viii. 远程管理卡</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">1. 硬件</h2>

<h3 id="toc_1">a. 优化硬盘是运维人员的最重要的手段之一</h3>

<h4 id="toc_2">i. 机械硬盘</h4>

<h5 id="toc_3">1. IDE</h5>

<h5 id="toc_4">2. SCSI</h5>

<h5 id="toc_5">3. SAS</h5>

<h5 id="toc_6">4. SATA</h5>

<h4 id="toc_7">ii. 固态硬盘(电子器械)</h4>

<h5 id="toc_8">1. SSD</h5>

<h3 id="toc_9">b. 优化时尽量不用硬盘,不找硬盘</h3>

<h3 id="toc_10">c. 我们在做运维工程师的时候,我们会尽量做优化,让所有的数据都放到内存里面,在给用户提供服务</h3>

<p><img src="media/15010712824389/15010716729571.jpg" alt=""/></p>

<h2 id="toc_11">2. 运维职责</h2>

<h3 id="toc_12"><mark>a. 网站不当机</mark></h3>

<h3 id="toc_13"><mark>b. 数据不能丢</mark></h3>

<h3 id="toc_14"><mark>c. 用户体验尽量好——加快访问速度</mark></h3>

<h2 id="toc_15">3. 服务器</h2>

<h3 id="toc_16">a. 服务器体型</h3>

<h4 id="toc_17">i. 长度与宽度统一</h4>

<p><img src="media/15010712824389/15010720947200.jpg" alt=""/></p>

<h4 id="toc_18">ii. 高度单位为U（1U = 4.45cm）</h4>

<h3 id="toc_19">b. 服务器分类</h3>

<h4 id="toc_20">i. 机架式服务器（最常用的服务器）</h4>

<p><img src="media/15010712824389/15010721110149.jpg" alt=""/><br/>
默认放在尺寸为19英寸机柜里面</p>

<h4 id="toc_21">ii. 刀片式服务器</h4>

<p><img src="media/15010712824389/15010721370207.jpg" alt=""/></p>

<h4 id="toc_22">iii. 塔式服务器</h4>

<p><img src="media/15010712824389/15010721429180.jpg" alt=""/></p>

<h2 id="toc_23">4. 互联网公司常见服务器介绍</h2>

<h3 id="toc_24">a. 互联网公司常见服务器品牌</h3>

<h4 id="toc_25"><mark>i. Dell服务器（大果蔬公司，常用）</mark></h4>

<h4 id="toc_26">ii. IBM服务器（土豪专用，如百度）</h4>

<h4 id="toc_27">iii. HP服务器</h4>

<h4 id="toc_28">iv. 浪潮</h4>

<h4 id="toc_29">v. 联想</h4>

<h4 id="toc_30">vi. 航天联志</h4>

<h3 id="toc_31">b. Dell服务器的常用型号</h3>

<p><img src="media/15010712824389/15010721720634.jpg" alt=""/></p>

<p><a href="http://china.dell.com/cn/business/p/servers">Dell 服务器官网：</a><br/>
去IOE运动————IBM        Oracle        Emc</p>

<h3 id="toc_32">c. 电脑和服务器的主要构成与主要零部件</h3>

<p><img src="media/15010712824389/15010721811444.jpg" alt=""/></p>

<h4 id="toc_33">i. 电源</h4>

<h5 id="toc_34">1. 重要服务器可上AB路双电源</h5>

<h4 id="toc_35">ii. CPU处理器</h4>

<h4 id="toc_36">iii. 内存</h4>

<h5 id="toc_37">1. 临时存储器——断电后数据消失</h5>

<p>程序——在磁盘中的静态文件<br/>
进程——在内存中运行的文件<br/>
守护进程（daemon）——持续保持运行的程序</p>

<h3 id="toc_38">d. 企业案例：</h3>

<p>——提升用户体验的网站解决方案</p>

<h4 id="toc_39">i. 磁盘</h4>

<h5 id="toc_40">1. 高并发写入——应把数据优先写入到内存，积累一定的量或时间后，再定时或定量的写入到磁盘（减轻磁盘压力，减少磁盘IO（Input/Output）磁盘读写），最终还是会把数据加载到内存中再对外提供访问。</h5>

<p>优点：写数据到内存，性能高速度快（微博，微信，秒杀）<br/>
缺点：肯能会丢失一部分在内存中还没有来得及存入磁盘的数据<br/>
解决方法：</p>

<h6 id="toc_41">1、在服务器主板安装蓄电池，能在断电瞬间把内存数据回写到磁盘</h6>

<h6 id="toc_42">2、配备UPS（一组蓄电池）不间断电源（可以持续供电10分钟到1小时左右）。</h6>

<p>UPS（UNinterruptible Power System）</p>

<h5 id="toc_43">2. 中小企业案例——高并发读取时，应先通过程序把数据读入到内存里，再对外提供访问服务</h5>

<p>网站优化核心  就是想办法把数据放入内存提供服务，或者让用户写数据到内存<br/>
（尽量让用户直接对接内存，减少对接磁盘概率）<br/>
这里提到的内存和磁盘，是由多台机器组成的集群架构环境<br/>
memcahced（纯内存）/redis（内存加磁盘）。</p>

<h4 id="toc_44">ii. 内存</h4>

<p>buffer——存储写入内存数据的空间称为缓冲区（buffer），写入到内存缓冲区<br/>
cache——存储读取内存数据的空间称为缓存区（cache），从内存读取缓存</p>

<p>由于99%的网站都是以读取为主，写入为辅，读写比例至少10:1，所以并发写入一般不是问题</p>

<p>了解: memcached / redis <br/>
U 盘安装系统，网络安装（ ftp,http），无人值守批量安装系统（ pxe+kickstart）。<br/>
参考文档：<br/>
<a href="http://blog.oldboyedu.com/autoinstall-kickstart">KICKSTART无人值守安装</a><br/>
<a href="http://blog.oldboyedu.com/autoinstall-cobbler">COBBLER无人值守安装</a></p>

<h4 id="toc_45">iii. 小结</h4>

<h4 id="toc_46">iv. Dell阵列卡（raid卡）</h4>

<h4 id="toc_47">v. 光驱</h4>

<h4 id="toc_48">vi. 主板</h4>

<h4 id="toc_49">vii. 机房机柜里的服务器摆放</h4>

<h4 id="toc_50">viii. 远程管理卡</h4>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:58:15+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702959683.html" itemprop="url">
		15. 描述你维护过的大规模集群网站架构的设计原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:58:05+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702850667.html" itemprop="url">
		14. 详细描述Linux权限管理体系</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:57:57+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702778892.html" itemprop="url">
		13. 描述Linux下磁盘读写数据的原理，磁盘分区原理，默认文件系统工作原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:57:49+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702692268.html" itemprop="url">
		12. 一致性哈西算法作用及原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:57:41+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702612275.html" itemprop="url">
		11. RAID 0 1 5 10原理、特点、性能区别，集群各角色如何选择</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:57:35+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702550739.html" itemprop="url">
		10. Linux默认文件系统,文件删除原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:57:28+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702488190.html" itemprop="url">
		09. 详细描述CDN工作原理以及购买服务后解析操作步骤</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:57:22+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702422822.html" itemprop="url">
		08. keepalive高可用服务工作原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:57:00+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702209182.html" itemprop="url">
		07. memcached工作原理(内存管理机制)</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:56:55+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702152705.html" itemprop="url">
		06. lvs的4种模式工作原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:56:48+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010702085430.html" itemprop="url">
		05. Nginx配合PHP工作fastcgi工作原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:56:39+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010701999479.html" itemprop="url">
		04. MySQL主从同步原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:56:33+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010701936255.html" itemprop="url">
		03. TCP/IP的三次握手和四次挥手原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h2 id="toc_0">TCP/IP三次握手过程</h2>

<h3 id="toc_1">理解seq和ACK</h3>

<ol>
<li>主机之间通讯都是有数据data信息的,只要有数据信息,就会有seq ACK存在</li>
<li>作为发送数据的一方,只发送seq数据序列号信息+拆分的数据信息</li>
<li><p>作为接收数据的一方,只发送ACK确认号信息,并且ACK确认号信息=接收到的seq信息数值+1</p>

<h3 id="toc_2">TCP三次握手状态转换简单说明:</h3></li>
<li><p>首先,建立连接之前,服务器和客户端的状态都为CLOSED</p></li>
<li><p>服务器创建socket后开始监听,变为LISTEN状态<br/>
客户端请求建立连接,向服务器发送SYN报文，客户端的状态变为SYN_SENT。</p></li>
<li><p>服务器收到客户端的报文后，向客户端发送ACK和SYN报文，此时服务器的状态变为SYN_RCVD。</p></li>
<li><p>然后，客户端收到ACK、SYN，就向服务器发送ACK，客户端状态变为ESTABLISHED。</p></li>
<li><p>服务器收到客户端的ACK后也变为ESTABLISHED。<br/>
此时三次握手完成，连接建立。</p></li>
</ol>

<h2 id="toc_3">TCP/IP四次挥手过程</h2>

<blockquote>
<p>由于TCP连接是全双工的，断开连接会比建立连接麻烦一点点。</p>
</blockquote>

<ol>
<li>客户端现象服务器发送FIN报文，请求断开连接，其状态变为FIN_WAIT1。</li>
<li>服务器收到FIN后向客户端发送ACK，服务器状态变为CLOSE_WAIT。</li>
<li>客户端收到ACK后就进入FIN_WAIT2状态。此时连接已经断开了一半了，如果服务器还有数据要发给客户端，就会继续发送。</li>
<li>直到发送完成，就发送FIN报文，此时服务器进入LAST_ACK状态。</li>
<li>客户端收到服务器的FIN后，马上发送ACK给服务器，此时客户端进入TIME_WAIT状态，再过了2MSL长的时间后进入CLOSED状态，服务器收到客户端的ACK就进入CLOSED状态。</li>
</ol>

<blockquote>
<p>至此，还有一个状态没有提及：CLOSING状态<br/>
CLOSING状态表示：<br/>
客户端发生了FIN，但FIN_WAIT1状态时没有收到服务器的ACK确认字段，却收到了服务器的FIN字段，这种情况发生在服务器发送的ACK丢包的时候，因为网络传输有时会有意外。</p>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:56:26+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010701867065.html" itemprop="url">
		02. http协议通信原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:56:15+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='2.%E5%8D%81%E4%BA%94%E4%B8%AA%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86.html'>2.十五个必会的原理知识</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010701752650.html" itemprop="url">
		01. DNS系统架构与解析原理</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			

			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T19:49:38+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='1.%E8%80%81%E7%94%B7%E5%AD%A9%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html'>1.老男孩学习笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010697787307.html" itemprop="url">
		二、Linux的发展过程与核心知识</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">第一章 Linux的发展过程</a>
<ul>
<li>
<a href="#toc_1">1.1 unix诞(蛋)生于；1969年的贝尔实验室</a>
</li>
<li>
<a href="#toc_2">1.2 Andrew S. Tanenbaum(谭宁邦)</a>
</li>
<li>
<a href="#toc_3">1.3 Richard Stallman（斯托曼1984年）自由软件（FSF）与（GNU=GNU is not unix）项目发起人</a>
<ul>
<li>
<a href="#toc_4">1.3.1 GNU：GNU is not unix</a>
<ul>
<li>
<a href="#toc_5">1. 没有Linux内核</a>
</li>
<li>
<a href="#toc_6">2. 命令解释器与外围软件bash gawk emacs gcc(优秀的软件)</a>
</li>
<li>
<a href="#toc_7">3. 缺少内核的Linux</a>
</li>
</ul>
</li>
<li>
<a href="#toc_8">1.3.2 GPL（general public license）：&lt;通用公共许可&gt;协议</a>
<ul>
<li>
<a href="#toc_9">1.（开放源代码）</a>
</li>
<li>
<a href="#toc_10">2.（如果你修改了源代码就必须要把修改过的源代码发出来）</a>
</li>
<li>
<a href="#toc_11">3.（GNU缺少内核）</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_12">1.4 Linus Torvalds   Linux之父  Linux内核  1991年</a>
</li>
</ul>
</li>
<li>
<a href="#toc_13">第二章 linux的组成&lt;如图&gt;</a>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<a href="#toc_14">1. 外围应用程序</a>
</li>
<li>
<a href="#toc_15">2. 命令解释器(shell)</a>
</li>
<li>
<a href="#toc_16">3.系统核心(kernellib  APl)</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_17">![](media/15010697787307/15010699314593.jpg)</a>
</li>
<li>
<a href="#toc_18">第三章 Linux的发行版本选择</a>
<ul>
<li>
<a href="#toc_19">3.1 Linux的桌面系统</a>
</li>
<li>
<a href="#toc_20">3.2 服务器端Linux系统</a>
</li>
<li>
<a href="#toc_21">3.3 如果对于安全要求很高</a>
</li>
<li>
<a href="#toc_22">3.4 使用数据库或电子邮件网络用户</a>
</li>
<li>
<a href="#toc_23">3.5 想新技术.新功能是rhel和CentOS的测试版或预发布版</a>
</li>
<li>
<a href="#toc_24">3.6 中文</a>
</li>
</ul>
</li>
<li>
<a href="#toc_25">红旗Linux  麒麟；Linux（类Ubuntu）</a>
<ul>
<li>
<a href="#toc_26"><mark>*Redhat&amp;CentOS&amp;Fdeora的区别</mark></a>
</li>
<li>
<a href="#toc_27"><mark>*Fdeora = 稳定之后 = RedHat = 去logo &amp; 去除收费 = CentOS</mark></a>
</li>
</ul>
</li>
</ul>


<h2 id="toc_0">第一章 Linux的发展过程</h2>

<h3 id="toc_1">1.1 unix诞(蛋)生于；1969年的贝尔实验室</h3>

<h3 id="toc_2">1.2 Andrew S. Tanenbaum(谭宁邦)</h3>

<h3 id="toc_3">1.3 Richard Stallman（斯托曼1984年）自由软件（FSF）与（GNU=GNU is not unix）项目发起人</h3>

<h4 id="toc_4">1.3.1 GNU：GNU is not unix</h4>

<h5 id="toc_5">1. 没有Linux内核</h5>

<h5 id="toc_6">2. 命令解释器与外围软件bash gawk emacs gcc(优秀的软件)</h5>

<h5 id="toc_7">3. 缺少内核的Linux</h5>

<h4 id="toc_8">1.3.2 GPL（general public license）：&lt;通用公共许可&gt;协议</h4>

<h5 id="toc_9">1.（开放源代码）</h5>

<h5 id="toc_10">2.（如果你修改了源代码就必须要把修改过的源代码发出来）</h5>

<h5 id="toc_11">3.（GNU缺少内核）</h5>

<h3 id="toc_12">1.4 Linus Torvalds   Linux之父  Linux内核  1991年</h3>

<hr/>

<h2 id="toc_13">第二章 linux的组成&lt;如图&gt;</h2>

<h5 id="toc_14">1. 外围应用程序</h5>

<h5 id="toc_15">2. 命令解释器(shell)</h5>

<h5 id="toc_16">3.系统核心(kernellib  APl)</h5>

<h2 id="toc_17"><img src="media/15010697787307/15010699314593.jpg" alt=""/></h2>

<h2 id="toc_18">第三章 Linux的发行版本选择</h2>

<h3 id="toc_19">3.1 Linux的桌面系统</h3>

<p>Ubuntu（有图形开发需求）</p>

<h3 id="toc_20">3.2 服务器端Linux系统</h3>

<p>Redhat（免费下载和使用.更新.升级）（有钱任性）<br/>
CentOS（完全免费）（与redhat一模一样）</p>

<h3 id="toc_21">3.3 如果对于安全要求很高</h3>

<p>Debian或FreeBSD</p>

<h3 id="toc_22">3.4 使用数据库或电子邮件网络用户</h3>

<p>SUSE（德国多）</p>

<h3 id="toc_23">3.5 想新技术.新功能是rhel和CentOS的测试版或预发布版</h3>

<p>Fedora</p>

<h3 id="toc_24">3.6 中文</h3>

<h2 id="toc_25">红旗Linux  麒麟；Linux（类Ubuntu）</h2>

<h3 id="toc_26"><mark>*Redhat&amp;CentOS&amp;Fdeora的区别</mark></h3>

<h3 id="toc_27"><mark>*Fdeora = 稳定之后 = RedHat = 去logo &amp; 去除收费 = CentOS</mark></h3>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T16:31:38+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010578989827.html" itemprop="url">
		xinetd服务管理器</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<blockquote>
<p>xinetd服务，这个就相当于一个大管家<br/>
```<br/>
[root@backup ~]# cat /etc/xinetd.d/rsync </p>

<h1 id="toc_0">default: off</h1>

<h1 id="toc_1">description: The rsync server is a good addition to an ftp server, as it \</h1>

<h1 id="toc_2">allows crc checksumming etc.</h1>

<p>service rsync<br/>
{<br/>
    disable = yes<br/>
    flags       = IPv6<br/>
    socket_type     = stream<br/>
    wait            = no<br/>
    user            = root<br/>
    server          = /usr/bin/rsync<br/>
    server_args     = --daemon<br/>
    log_on_failure  += USERID<br/>
}<br/>
[root@backup ~]# sed -i &#39;s#yes#no#g&#39; /etc/xinetd.d/rsync<br/>
[root@backup ~]# cat /etc/xinetd.d/rsync </p>

<h1 id="toc_3">default: off</h1>

<h1 id="toc_4">description: The rsync server is a good addition to an ftp server, as it \</h1>

<h1 id="toc_5">allows crc checksumming etc.</h1>

<p>service rsync<br/>
{<br/>
    disable = no<br/>
    flags       = IPv6<br/>
    socket_type     = stream<br/>
    wait            = no<br/>
    user            = root<br/>
    server          = /usr/bin/rsync<br/>
    server_args     = --daemon<br/>
    log_on_failure  += USERID<br/>
}<br/>
[root@backup ~]# killall rsync<br/>
rsync: no process killed<br/>
[root@backup ~]# netstat -lntup|grep 873<br/>
[root@backup ~]# yum install xinetd -y<br/>
[root@backup ~]# /etc/init.d/xinetd start<br/>
Starting xinetd:                                           [  OK  ]<br/>
[root@backup ~]# netstat -lntup|grep 873<br/>
tcp        0      0 :::873                      :::*                        LISTEN      2296/xinetd<br/><br/>
[root@backup ~]# /etc/init.d/xinetd stop<br/>
Stopping xinetd:                                           [  OK  ]<br/>
[root@backup ~]# netstat -lntup|grep 873<br/>
[root@backup ~]# <br/>
```</p>
</blockquote>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-07-26T14:46:58+08:00" itemprop="datePublished">2017/7/26</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0.html'>零散笔记</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15010516186972.html" itemprop="url">
		服务器简单优化</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ul>
<li>
<a href="#toc_0">调试模板机</a>
<ul>
<li>
<a href="#toc_1">优化</a>
<ul>
<li>
<a href="#toc_2">优化开机启动项(包括防火墙)</a>
</li>
<li>
<a href="#toc_3">关闭SELinux</a>
</li>
<li>
<a href="#toc_4"><mark>一个清空两个删除</mark></a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_5">克隆模板机</a>
<ul>
<li>
<a href="#toc_6">八台服务器名称</a>
</li>
</ul>
</li>
<li>
<a href="#toc_7">整体优化</a>
<ul>
<li>
<a href="#toc_8">hosts</a>
</li>
<li>
<a href="#toc_9">0、更改yum源</a>
</li>
<li>
<a href="#toc_10">1、关闭selinux</a>
</li>
<li>
<a href="#toc_11">2、关闭iptables</a>
</li>
<li>
<a href="#toc_12">3、精简开机自启动服务</a>
</li>
<li>
<a href="#toc_13">4、提权oldboy可以sudo</a>
</li>
<li>
<a href="#toc_14">5、英文字符集</a>
</li>
<li>
<a href="#toc_15">6、时间同步</a>
</li>
<li>
<a href="#toc_16">7、命令行安全（可不设置）</a>
</li>
<li>
<a href="#toc_17">8、加大文件描述</a>
</li>
<li>
<a href="#toc_18">9、内核优化</a>
</li>
<li>
<a href="#toc_19">10、安装其他小软件</a>
</li>
<li>
<a href="#toc_20">11、ssh连接速度慢优化</a>
</li>
</ul>
</li>
<li>
<a href="#toc_21">克隆机调试</a>
</li>
<li>
<a href="#toc_22">设置提示符颜色信息</a>
</li>
</ul>


<h2 id="toc_0">调试模板机</h2>

<h3 id="toc_1">优化</h3>

<h4 id="toc_2">优化开机启动项(包括防火墙)</h4>

<pre><code>chkconfig |egrep -v &#39;crond|sshd|rsyslog|sysstat|network&#39; |awk &#39;{print &quot;chkconfig &quot; $1 &quot; --level 0123456 off&quot;}&#39; |bash
</code></pre>

<h4 id="toc_3">关闭SELinux</h4>

<pre><code>sed -i &#39;7s/enforcing/disabled/&#39; /etc/selinux/config
</code></pre>

<h4 id="toc_4"><mark>一个清空两个删除</mark></h4>

<pre><code>sed -ri &#39;/UUID|HWADDR/d&#39; /etc/sysconfig/network-scripts/ifcfg-eth*
&gt;/etc/udev/rules.d/70-persistent-net.rules
</code></pre>

<h2 id="toc_5">克隆模板机</h2>

<h3 id="toc_6">八台服务器名称</h3>

<table>
<thead>
<tr>
<th>服务器名称</th>
<th>外网IP地址</th>
<th>内网IP地址</th>
<th>主机名</th>
</tr>
</thead>

<tbody>
<tr>
<td>A1-nginx 负载服务器 01</td>
<td>10.0.0.5/24</td>
<td>172.16.1.5/24</td>
<td>lb01</td>
</tr>
<tr>
<td>A1-nginx 负载服务器 02</td>
<td>10.0.0.6/24</td>
<td>172.16.1.6/24</td>
<td>lb02</td>
</tr>
<tr>
<td>B2-apache web 服务器</td>
<td>10.0.0.7/24</td>
<td>172.16.1.7/24</td>
<td>web02</td>
</tr>
<tr>
<td>B2-nginx web 服务器</td>
<td>10.0.0.8/24</td>
<td>172.16.1.8/24</td>
<td>web01</td>
</tr>
<tr>
<td>C3-mysql 数据库服务器</td>
<td>10.0.0.51/24</td>
<td>172.16.1.51/24</td>
<td>db01</td>
</tr>
<tr>
<td>C1-NFS 存储服务器</td>
<td>10.0.0.31/24</td>
<td>172.16.1.31/24</td>
<td>nfs01</td>
</tr>
<tr>
<td>C2-rsync 存储服务器</td>
<td>10.0.0.41/24</td>
<td>172.16.1.41/24</td>
<td>backup</td>
</tr>
<tr>
<td>X-管理服务器</td>
<td>10.0.0.61/24</td>
<td>172.16.1.61/24</td>
<td>m01</td>
</tr>
</tbody>
</table>

<hr/>

<h2 id="toc_7">整体优化</h2>

<h3 id="toc_8">hosts</h3>

<pre><code>\cp /etc/hosts{,.bak}
cat &gt;/etc/hosts&lt;&lt;EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
172.16.1.5      lb01
172.16.1.6      lb02
172.16.1.7      web02
172.16.1.8      web01
172.16.1.51     db01 db01.etiantian.org
172.16.1.31     nfs01
172.16.1.41     backup
172.16.1.61     m01
EOF
</code></pre>

<h3 id="toc_9">0、更改yum源</h3>

<pre><code>mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup &amp;&amp;\
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup
mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo

#yum makecache
</code></pre>

<h3 id="toc_10">1、关闭selinux</h3>

<pre><code>sed -i.bak &#39;s/SELINUX=enforcing/SELINUX=disabled/&#39; /etc/selinux/config
grep SELINUX=disabled /etc/selinux/config 
setenforce 0
getenforce
</code></pre>

<h3 id="toc_11">2、关闭iptables</h3>

<pre><code>/etc/init.d/iptables stop
/etc/init.d/iptables stop
chkconfig iptables off
</code></pre>

<h3 id="toc_12">3、精简开机自启动服务</h3>

<pre><code>export LANG=en
chkconfig|egrep -v &quot;crond|sshd|network|rsyslog|sysstat&quot;|awk &#39;{print &quot;chkconfig&quot;,$1,&quot;off&quot;}&#39;|bash

chkconfig --list|grep 3:on
</code></pre>

<h3 id="toc_13">4、提权oldboy可以sudo</h3>

<pre><code>useradd oldboy
echo 123456|passwd --stdin oldboy
\cp /etc/sudoers /etc/sudoers.ori
echo &quot;oldboy  ALL=(ALL) NOPASSWD: ALL &quot; &gt;&gt;/etc/sudoers
tail -1 /etc/sudoers
visudo -c
</code></pre>

<h3 id="toc_14">5、英文字符集</h3>

<pre><code>cp /etc/sysconfig/i18n /etc/sysconfig/i18n.ori
echo &#39;LANG=&quot;en_US.UTF-8&quot;&#39;  &gt;/etc/sysconfig/i18n 
source /etc/sysconfig/i18n
echo $LANG
</code></pre>

<h3 id="toc_15">6、时间同步</h3>

<pre><code>echo &#39;#time sync by lidao at 2017-03-08&#39; &gt;&gt;/var/spool/cron/root
echo &#39;*/5 * * * * /usr/sbin/ntpdate pool.ntp.org &gt;/dev/null 2&gt;&amp;1&#39; &gt;&gt;/var/spool/cron/root
crontab -l
</code></pre>

<h3 id="toc_16">7、命令行安全（可不设置）</h3>

<pre><code>#echo &#39;export TMOUT=300&#39; &gt;&gt;/etc/profile
#echo &#39;export HISTSIZE=5&#39; &gt;&gt;/etc/profile
#echo &#39;export HISTFILESIZE=5&#39; &gt;&gt;/etc/profile
#tail -3 /etc/profile
#. /etc/profile
</code></pre>

<h3 id="toc_17">8、加大文件描述</h3>

<pre><code>echo &#39;*               -       nofile          65535 &#39; &gt;&gt;/etc/security/limits.conf 
tail -1 /etc/security/limits.conf 
</code></pre>

<h3 id="toc_18">9、内核优化</h3>

<pre><code>cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF
net.ipv4.tcp_fin_timeout = 2
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.ip_local_port_range = 4000    65000
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.route.gc_timeout = 100
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_synack_retries = 1
net.core.somaxconn = 16384
net.core.netdev_max_backlog = 16384
net.ipv4.tcp_max_orphans = 16384
#以下参数是对iptables防火墙的优化，防火墙不开会提示，可以忽略不理。
net.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_tcp_timeout_established = 180
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
EOF
sysctl -p
</code></pre>

<h3 id="toc_19">10、安装其他小软件</h3>

<pre><code>yum install lrzsz nmap tree dos2unix nc telnet sl -y
</code></pre>

<h3 id="toc_20">11、ssh连接速度慢优化</h3>

<pre><code>sed -i.bak &#39;s@#UseDNS yes@UseDNS no@g;s@^GSSAPIAuthentication yes@GSSAPIAuthentication no@g&#39;  /etc/ssh/sshd_config
/etc/init.d/sshd reload
##eth0
DEVICE=eth1
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
</code></pre>

<h2 id="toc_21">克隆机调试</h2>

<pre><code>ssh root@10.0.0.200 &amp;&amp;123456
sed -i &#39;s/back01/m01/&#39; /etc/sysconfig/network &amp;&amp; hostname lb01 &amp;&amp; sed -i &#39;s/200/61/&#39; /etc/sysconfig/network-scripts/ifcfg-eth* &amp;&amp; echo &quot;PS1=&#39;\[\e[32;1m\][\u@\h \W]\$ \[\e[0m\]&#39;&quot;&gt;&gt;/etc/profile &amp;&amp; service network restart
</code></pre>

<h2 id="toc_22">设置提示符颜色信息</h2>

<pre><code>echo &quot;PS1=&#39;\[\e[32;1m\][\u@\h \W]\$ \[\e[0m\]&#39;&quot;&gt;&gt;/etc/profile
</code></pre>


			
			
		</div>

	</article>
  

</div>
<nav id="pagenavi">
	 
	
	<div class="center"><a href="archives.html">Blog Archives</a></div>

</nav>

</div>



        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>

  
    



</body>
</html>