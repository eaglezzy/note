<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	廿七、单台服务器LNMP搭建 - 笔记仓库
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="笔记仓库" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}
	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
					
					<h1><a href="index.html">笔记仓库</a></h1>
					<p class="subtitle"></p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="archives.html">Archives</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">













								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">

	<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
		<h1 class="title" itemprop="name">廿七、单台服务器LNMP搭建</h1>
		<div class="entry-content" itemprop="articleBody">
			<ol>
<li><p>LNMP架构与部署流程图<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/54209317.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/79629399.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/50069384.jpg" alt=""/></p></li>
<li><p>Linux部署</p>

<ol>
<li><p>网络配置</p>

<blockquote>
<p>Linux网卡配置: ---------- vm网络编辑器的配置<br/>
eth0:10.0.0.X ----------- NAT<br/>
eth1:172.16.1.X  -------- 虚拟LAN区段: 172.16.1.0/24<br/>
网关设置:NAT 10.0.0.254<br/>
DNS配置:NAT 223.5.5.5 223.6.6.6</p>
</blockquote></li>
<li><p>确认系统环境</p>

<pre><code>[root@web01 ~]# cat /etc/centos-release
CentOS release 6.9 (Final)
[root@web01 ~]# uname -a
Linux web01 2.6.32-696.el6.x86_64 #1 SMP Tue Mar 21 19:29:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></li>
<li><p>虚拟机优化</p>

<blockquote>
<p>iptables防火墙关闭<br/>
selinux关闭<br/>
/tmp目录权限 1777<br/>
epel源下载</p>

<pre><code>wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
</code></pre>
</blockquote></li>
</ol></li>
<li><p>Nginx部署</p>

<ol>
<li><p>统一安装包路径, 下载解压nginx软件包</p>

<pre><code>mkdir -p /server/tools/
cd /server/tools/
wget http://nginx.org/download/nginx-1.10.3.tar.gz
</code></pre></li>
<li><p>创建nginx虚拟用户用户---www</p>

<pre><code>useradd -s /sbin/nologin -M www
</code></pre></li>
<li><p>依赖包安装：pcre-devel openssl-devel</p>

<pre><code>yum install pcre-devel openssl-devel gcc -y
rpm -qa pcre* openssl* gcc
</code></pre></li>
<li><p>编译安装nginx软件服务</p>

<pre><code>tar xf nginx-1.10.3.tar.gz
cd nginx-1.10.3/
./configure --prefix=/application/nginx-1.10.3 --user=www --group=www --with-http_stub_status_module --with-http_ssl_module
make &amp;&amp; make install
</code></pre></li>
<li><p>创建服务程序的软链接</p>

<pre><code>ln -s /application/nginx-1.10.3 /application/nginx
ln -s /application/nginx/sbin/nginx /usr/local/sbin/
</code></pre></li>
<li><p>配置文件进行编辑修改</p>

<blockquote>
<pre><code>cd /application/nginx/conf/
mkdir /application/nginx/conf/extra
egrep -v &#39;#|^$&#39; nginx.conf.default
egrep -v &#39;#|^$&#39; nginx.conf.default &gt;nginx.conf
for i in www bbs blog status;do touch extra/${i}.conf;done
tree extra/
</code></pre>

<p>extra/<a href="http://www.conf">www.conf</a></p>

<pre><code>cat &gt;&gt; extra/www.conf&lt;&lt;EOF
server {
    listen       80;
    server_name  www.etiantian.org;
    location / {
        root   html/www;
        index  index.html index.htm;
    }
}
EOF
</code></pre>

<p>extra/bbs.conf</p>

<pre><code>cat &gt;&gt; extra/bbs.conf&lt;&lt;EOF
server {
    listen       80;
    server_name  bbs.etiantian.org;
    location / {
        root   html/blog;
        index  index.html index.htm;
    }
}
EOF
</code></pre>

<p>extra/blog.conf</p>

<pre><code>cat &gt;&gt; extra/blog.conf&lt;&lt;EOF
server {
    listen       80;
    server_name  blog.etiantian.org;
    location / {
        root   html/bbs;
        index  index.html index.htm;
    }
}
EOF
</code></pre>

<p>extra/status.conf</p>

<pre><code>cat &gt;&gt; extra/status.conf&lt;&lt;EOF
server{
    listen  80;
    server_name  status.etiantian.org;
    location / {
      stub_status on;
      access_log   off;
    }
  }
EOF
</code></pre>

<p>extra/nginx.conf</p>

<pre><code>cat&gt;nginx.conf&lt;&lt;EOF
worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
    access_log  logs/access.log  main;
    include extra/www.conf;
    include extra/bbs.conf;
    include extra/blog.conf;
    include extra/status.conf;
}
EOF
</code></pre>

<pre><code>cd /application/nginx/html/
mkdir /application/nginx/html/{www,bbs,blog}
echo &#39;www web01&#39; &gt;www/index.html
echo &#39;bbs web01&#39; &gt;bbs/index.html
echo &#39;blog web01&#39; &gt;blog/index.html
</code></pre>
</blockquote></li>
<li><p>测试配置文件语法，启动nginx服务并检查</p>

<pre><code>nginx -t
nginx
lsof -i:80
</code></pre></li>
<li><p>修改Windows的hosts并在浏览器中测试</p>

<blockquote>
<p>C:\Windows\System32\drivers\etc\hosts<br/>
使用管理员权限编辑, 加入一行新内容:</p>
</blockquote>

<pre><code>10.0.0.8 www.etiantian.org bbs.etiantian.org blog.etiantian.org status.etiantian.org etiantian.org
</code></pre></li>
</ol></li>
<li><p>MySQL部署</p>

<ol>
<li><p>添加系统虚拟用户mysql</p>

<pre><code>groupadd -g 555 mysql
useradd -s /sbin/nologin -u 555 -g 555 -M mysql
</code></pre></li>
<li><p>下载解压mysql二进制软件包</p>

<pre><code>cd /server/tools/
tar xf mysql-5.6.34-linux-glibc2.5-x86_64.tar.gz
</code></pre></li>
<li><p>将mysql解压后的目录转移(重命名)并创建软连接</p>

<pre><code>\cp -r /server/tools/mysql-5.6.34-linux-glibc2.5-x86_64 /application/mysql-5.6.34
ln -s /application/mysql-5.6.34/ /application/mysql
</code></pre></li>
<li><p>让mysql用户管理 /application/mysql/</p>

<pre><code>chown -R mysql.mysql /application/mysql/data/
</code></pre></li>
<li><p>初始化数据库</p>

<pre><code>/application/mysql-5.6.34/scripts/mysql_install_db --basedir=/application/mysql-5.6.34/ --datadir=/application/mysql-5.6.34/data --user=mysql
# 说明信息: 初始化成功，会看到输出信息中有两个OK
# mysql启动脚本 默认放在support-files/mysql.server
</code></pre></li>
<li><p>复制默认的配置文件</p>

<pre><code>\cp /application/mysql/support-files/my-default.cnf /etc/my.cnf
</code></pre></li>
<li><p>修改mysqld 和 mysqld_safe两个脚本中的相关路径<mark>(注意先复制再修改,顺序不要错)</mark></p>

<pre><code>sed -i &#39;s#/usr/local/mysql#/application/mysql#g&#39; /application/mysql/bin/mysqld_safe /etc/init.d/mysqld
</code></pre></li>
<li><p>复制启动脚本到/etc/init.d/, 授与x权限, 并设置开机自启动</p>

<pre><code>cp /application/mysql/support-files/mysql.server  /etc/init.d/mysqld
chmod +x /etc/init.d/mysqld
chkconfig --add mysqld
chkconfig mysqld on
</code></pre></li>
<li><p>启动MySQL</p>

<pre><code>/etc/init.d/mysqld start   #启动后提示 Starting MySQL....... SUCCESS!
lsof -i:3306                #MySQL使用的端口3306
</code></pre></li>
<li><p>扩展知识：将数据库命令集目录追加到PATH中</p>

<pre><code>ln -s /application/mysql/bin/* /usr/local/bin/
which mysql
</code></pre></li>
<li><p>给MySQL添加管理员并设置密码</p>

<pre><code>/application/mysql/bin/mysqladmin -u root password &#39;oldboy123&#39;
</code></pre></li>
<li><p>测试数据库能否使用, 进入和退出</p>

<pre><code>mysql -uroot -poldboy123     #使用用户名和密码安全进入数据库
quit #退出数据库
</code></pre></li>
</ol></li>
<li><p>PHP部署</p>

<ol>
<li><p>解压PHP软件</p>

<pre><code>cd /server/tools/
tar xf php-5.5.32.tar.gz
</code></pre></li>
<li><p>准备两个文件和依赖包</p>

<pre><code>## ln -s /application/mysql/lib/libmysqlclient.so.18  /usr/lib64/  #如果未安装MySQL,可省略. 此处有隐患, 如果以后删除mysql会导致软链接失效, 建议使用以下命令
cp /application/mysql/lib/libmysqlclient.so.18.1.0 /usr/lib64/libmysqlclient.so.18 
</code></pre>

<pre><code>touch /server/tools/php-5.5.32/ext/phar/phar.phar
yum install zlib-devel libxml2-devel libjpeg-devel libjpeg-turbo-devel freetype-devel libpng-devel gd-devel libcurl-devel libxslt-devel libmcrypt-devel mhash mcrypt -y
</code></pre></li>
<li><p>安装依赖包libiconv-devel</p>

<pre><code>tar xf libiconv-1.14.tar.gz
cd libiconv-1.14
./configure --prefix=/application/libiconv

make &amp;&amp; make install
</code></pre></li>
<li><p>PHP编译安装</p>

<blockquote>
<p>#如果未安装MySQL,要修改为--with-mysql==mysqlnd --with-pdo-mysql=mysqlnd, 建议这两个编译参数直接指定mysqlnd, php就会使用</p>
</blockquote>

<pre><code>cd /server/tools/php-5.5.32
./configure \
--prefix=/application/php-5.5.32 \
--with-mysql=/application/mysql/ \    
--with-pdo-mysql=/application/mysql/ \ 
--with-freetype-dir \
--with-jpeg-dir \
--with-png-dir \
--with-zlib \
--with-libxml-dir=/usr \
--enable-xml \
--disable-rpath \
--enable-bcmath \
--enable-shmop \
--enable-sysvsem \
--enable-inline-optimization \
--with-curl \
--enable-mbregex \
--enable-fpm \
--enable-mbstring \
--with-mcrypt \
--with-gd \
--enable-gd-native-ttf \
--with-openssl \
--with-mhash \
--enable-pcntl \
--enable-sockets \
--with-xmlrpc \
--enable-soap \
--enable-short-tags \
--enable-static \
--with-xsl \
--with-fpm-user=www \
--with-fpm-group=www \
--enable-ftp \
--enable-opcache=no

make &amp;&amp; make install
</code></pre></li>
<li><p>创建PHP软件目录的软链接</p>

<pre><code>ln -s /application/php-5.5.32/ /application/php
</code></pre></li>
<li><p>配置php解析文件  配置php-fpm配置文件</p>

<pre><code>cp /server/tools/php-5.5.32/php.ini-production /application/php/lib/php.ini
cp /application/php/etc/php-fpm.conf.default /application/php/etc/php-fpm.conf
</code></pre>

<blockquote>
<p>#扩展: php.ini-production 与 php.ini-development 两个文件的区别和关系<br/>
#扩展：文件比较命令 diff zdiff vimdiff windows上的文件比较</p>
</blockquote></li>
<li><p>启动php-fpm程序</p>

<pre><code>/application/php/sbin/php-fpm
</code></pre></li>
<li><p>确认php 9000端口是否正确启动</p>

<pre><code>lsof -i:9000
ps -ef|grep php-fpm
</code></pre></li>
<li><p>创建PHP测试页面</p>

<pre><code>cd /application/nginx/html/blog/
mv index.html index.html.bak
echo &#39;&lt;?php phpinfo(); ?&gt;&#39; &gt;/application/nginx/html/blog/test_info.php
</code></pre></li>
</ol></li>
<li><p>实现nginx与PHP配合</p>

<ol>
<li><p>修改blog配置文件</p>

<pre><code>vim /application/nginx/conf/extra/blog.conf
    server {
        listen       80;
        server_name  blog.etiantian.org;
        root   html/blog;
        location / {
#index.php不加或者不放在第一个, 都会导致主页定向到index.html
            index index.php index.html index.htm;
        }

        location ~* .*\.(php|php5)?$ {
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index index.php;
            include /application/nginx/conf/fastcgi.conf;
        }

}
</code></pre>

<blockquote>
<p>说明：利用nginx的location区块实现动态请求与静态请求的分别处理</p>
</blockquote></li>
<li><p>站点测试</p>

<pre><code>curl  http://blog.etiantian.org/index.html       # 静态请求站点文件信息测试
curl  http://blog.etiantian.org/test_info.php    # 动态请求站点文件信息测试
</code></pre>

<blockquote>
<p>说明：当php服务停止时，9000端口信息消失，即停止PHP错误报502错误<br/>
linux系统测试完毕后，建议利用浏览器进行最终测试，测试效果更明显些</p>
</blockquote>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/63563084.jpg" alt=""/></p></li>
</ol></li>
<li><p>实现php与MySQL连通</p>

<ol>
<li><p>创建WordPress数据库</p>

<pre><code>mysql -uroot -poldboy123
show databases;              #查看当前数据库信息
create database wordpress;
</code></pre></li>
<li><p>添加WordPress用户并授权管理</p>

<pre><code>WordPress库
grant all on wordpress.* to &#39;wordpress&#39;@&#39;localhost&#39; identified by &#39;123456&#39;;
grant all on wordpress.* to &#39;wordpress&#39;@&#39;172.16.1.0/255.255.255.0&#39; identified by &#39;123456&#39;;
flush privileges;
</code></pre>

<blockquote>
<p>注意: 每次修改用户授权, 都要刷新权限配置</p>
</blockquote></li>
<li><p>数据库WordPress登录测试</p>

<pre><code>mysql -uwordpress -p123456
</code></pre></li>
<li><p>编辑php与mysql连通性测试文件</p>

<pre><code>vim /application/nginx/html/blog/test_mysql.php
</code></pre>

<pre><code>&lt;?php
     //$link_id=mysql_connect(&#39;主机名&#39;,&#39;用户&#39;,&#39;密码&#39;);
     $link_id=mysql_connect(&#39;localhost&#39;,&#39;wordpress&#39;,&#39;123456&#39;) or mysql_error();
     if($link_id){
         echo &quot;Connect mysql success !\n&quot;;
      }else{
         echo mysql_error();
       }
?&gt;
</code></pre></li>
</ol></li>
<li><p>WordPress部署</p>

<ol>
<li><p>下载部署wordpress博客程序</p>

<pre><code>cd /server/tools/
wget https://cn.wordpress.org/wordpress-4.7.3-zh_CN.tar.gz
tar xf wordpress-4.7.3-zh_CN.tar.gz
\mv wordpress/* /application/nginx/html/blog/    # 强制覆盖index.html重名文件
</code></pre></li>
<li><p>文件目录权限设置<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/1583708.jpg" alt=""/></p>

<pre><code>chown -R www.www /application/nginx/html/blog/
chown -R www.www /application/nginx/html/blog/wp-content/uploads/ #用户上传数据目录属主修改为www
</code></pre>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/81176698.jpg" alt=""/></p>

<blockquote>
<p>说明: 编辑wp-config.php文件可以修改wordpress上的数据库连接参数信息</p>
</blockquote></li>
<li><p>用浏览器进行wordpress部署<br/>
<a href="http://blog.etiantian.org/wp-admin/setup-config.php">http://blog.etiantian.org/wp-admin/setup-config.php</a><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/81433116.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/55472707.jpg" alt=""/><br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-11/64668274.jpg" alt=""/></p></li>
</ol></li>
<li><p>补充知识</p>

<ol>
<li><p>502和504错误</p>

<p><a href="15051451335516.html">附录: 502和504错误</a></p></li>
<li><p>排错--数据库连接问题</p>

<p><img src="http://ovt17vn7k.bkt.clouddn.com/17-9-12/55569117.jpg" alt=""/></p>

<blockquote>
<p>检查网络连接<br/>
检查数据库服务<br/>
检查数据库授权</p>
</blockquote></li>
<li><p>排错mysql---启动脚本没有修改成功(可能是因为复制和修改这两个操作顺序错了)</p>

<pre><code>[root@oldboy38 ~]# /etc/init.d/mysqld start
/etc/init.d/mysqld: line 256: my_print_defaults: command not found
/etc/init.d/mysqld: line 276: cd: /application/mysql: No such file or directory
Starting MySQL ERROR! Couldn&#39;t find MySQL server (/application/mysql/bin/mysqld_safe)
</code></pre></li>
<li><p>排错: 博客发布后的链接会错误定位到blog/index.php<br/>
<img src="http://ovt17vn7k.bkt.clouddn.com/17-9-12/19982.jpg" alt=""/></p>

<blockquote>
<p>blog目录下先有了一个测试的index.php<br/>
转移解压后的wordpress内容的时候, 因为两个index.php重名了, 没有被替换掉<br/>
解决:</p>

<pre><code>\mv /server/tools/wordpress/index.php /application/nginx/html/blog/
</code></pre>
</blockquote></li>
<li><p>在数据库中查看博客中的内容</p>

<pre><code># mysql -uwordpress -p123456
mysql&gt; use wordpress;
mysql&gt; show tables;
select * from wp_posts\G           # \G 竖列显示,不接&#39;;&#39;
</code></pre></li>
<li><p>限制用户上传的文件大小</p>

<blockquote>
<p>注意: lb集群和web集群的nginx.conf都要加入以下代码才能有效</p>

<pre><code>http {
client_max_body_size 10m;
...
}
</code></pre>
</blockquote></li>
<li><p>/application/php-5.5.32/lib/php.ini</p>

<blockquote>
<p>file_uploads = On ;打开文件上传选项<br/>
upload_max_filesize = 500M ;上传文件上限<br/>
如果要上传比较大的文件，仅仅以上两条还不够，必须把服务器缓存上限调大，把脚本最大执行时间变长<br/>
post_max_size = 500M ;post上限<br/>
max_execution_time = 1800 ; Maximum execution time of each script, in seconds脚本最大执行时间<br/>
max_input_time = 1800 ; Maximum amount of time each script may spend parsing request data<br/>
memory_limit = 128M ; Maximum amount of memory a script may consume (128MB)内存上限</p>
</blockquote></li>
</ol></li>
</ol>

		</div>
	</article>
	<div class="share-comment">
	 

	  

	  

	</div>
</div>        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>

  
    



</body>
</html>